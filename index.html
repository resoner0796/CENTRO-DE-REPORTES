<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Reportes</title>

    <meta name="theme-color" content="#22252a">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    
   <style>
:root {}

body.dark-theme {
    --bg-gradient: radial-gradient(ellipse at center top, #22252a 0%, #0a0a0a 70%);
    --surface-color: rgba(35, 38, 43, 0.6);
    --surface-hover-color: rgba(55, 58, 63, 0.7);
    --border-color: rgba(255, 255, 255, 0.1);
    --primary-color: #E5E7EB;
    --primary-text-color: #0A0A0A;
    --danger-color: #FB7185;
    --danger-hover-color: #f43f5e;
    --text-primary: #F1F5F9;
    --text-secondary: #94A3B8;
    --text-dark: #64748B;
    --thead-bg: rgba(55, 65, 81, 0.8);
    --sticky-col-bg: #2a2d32;
    --success-color: #4ade80;
    --row-today-bg: rgba(74, 222, 128, 0.1);
    --row-yesterday-bg: rgba(251, 191, 36, 0.1);
    --row-past-bg: rgba(244, 63, 94, 0.1);
    --chart-grid-color: rgba(255, 255, 255, 0.1);
    --chart-tick-color: #94A3B8;
    --glow-green: rgba(74, 222, 128, 0.9);
    --glow-red: rgba(251, 113, 133, 0.9);
}

body.light-theme {
    --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
    --surface-color: rgba(255, 255, 255, 0.5);
    --surface-hover-color: rgba(243, 244, 246, 0.7);
    --border-color: rgba(0, 0, 0, 0.1);
    --primary-color: #1F2937;
    --primary-text-color: #FFFFFF;
    --danger-color: #EF4444;
    --danger-hover-color: #dc2626;
    --text-primary: #111827;
    --text-secondary: #4B5563;
    --text-dark: #9CA3AF;
    --branding-color: #0055A5;
    --thead-bg: rgba(229, 231, 235, 0.8);
    --sticky-col-bg: #f1f5f9;
    --success-color: #22c55e;
    --row-today-bg: rgba(34, 197, 94, 0.1);
    --row-yesterday-bg: rgba(245, 158, 11, 0.1);
    --row-past-bg: rgba(239, 68, 68, 0.1);
    --chart-grid-color: rgba(0, 0, 0, 0.1);
    --chart-tick-color: #4B5563;
    --glow-green: rgba(34, 197, 94, 0.9);
    --glow-red: rgba(239, 68, 68, 0.9);
}

@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
html { min-height: 100%; background-color: #0a0a0a; }
body {
    font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--text-primary); margin: 0; min-height: 100vh;
    display: flex; justify-content: center; transition: background 0.3s ease-in-out;
    background-attachment: fixed; padding: 16px; box-sizing: border-box; overflow-x: hidden;
}
.app-container { width: 100%; }
#menuView, #view901, #viewTerminaciones, #viewProduccionHora, #viewProduccion20, #viewProduccionDaily, #viewProduccionCalidad, #viewTarimasConfirmadas, #viewBoxID, #viewLiveDashboard {
    transition: opacity 0.3s ease-in-out, display 0.3s;
}
/* --- AJUSTES A #menuView --- */
#menuView {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 32px 16px;
    box-sizing: border-box;
}
/* -------------------------- */
.menu-wrapper {
    width: 100%;
    max-width: 700px;
    text-align: center;
}
.animated-startup {
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
}
.app-header {
    text-align: center;
    margin-bottom: 32px;
}
.app-branding {
    font-family: 'Tinos', 'Times New Roman', serif;
    font-weight: 400;
    font-size: 2.5rem;
    color: var(--text-primary);
    letter-spacing: 2px;
    margin: 0;
    transition: color 0.3s ease-in-out;
}
body.light-theme .app-branding { color: var(--branding-color); }
.app-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin: 4px 0 0;
}
.card, .modal-content {
    background-color: var(--surface-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 16px; padding: 24px; border-top: 1px solid rgba(255, 255, 255, 0.15); border-left: 1px solid rgba(255, 255, 255, 0.1);
    border-bottom: 2px solid rgba(0, 0, 0, 0.3); border-right: 2px solid rgba(0, 0, 0, 0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}
body.light-theme .card, body.light-theme .modal-content {
    border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
    border-bottom: 2px solid rgba(0, 0, 0, 0.1); border-right: 2px solid rgba(0, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}
.menu-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: stretch; }
.btn { padding: 16px 24px; border-radius: 12px; cursor: pointer; background-color: var(--primary-color); border: none; color: var(--primary-text-color); font-weight: 700; font-size: 1.1rem; text-align: center; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-glass {
    background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary);
    padding: 12px 20px; font-size: 0.95rem; font-weight: 600;
}
.btn-glass:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); }
#view901, #viewTerminaciones, #viewProduccionHora, #viewProduccion20, #viewProduccionDaily, #viewLiveDashboard { display: none; width: 100%; }
.main-container { display: grid; grid-template-columns: 320px 1fr; gap: 16px; width: 100%; height: calc(100vh - 32px); }
.sidebar { display: flex; flex-direction: column; gap: 16px; }
.sidebar-header { display: flex; justify-content: space-between; align-items: center; }
.icon-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.icon-btn:hover { color: var(--text-primary); background-color: var(--surface-hover-color); }
.main-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-width: 0;
    min-height: auto;
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 16px;
    box-sizing: border-box;
}
#summaryContainer { flex-shrink: 0; padding: 16px; }
.summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.summary-header .title-wrapper { flex-grow: 1; text-align: center; }
.summary-header h3 { margin: 0; }
.table-container { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
.table-container h5 { margin: 0 0 12px 0; text-align: center; font-size: 1.1rem; color: var(--text-secondary); }
.table-wrapper { overflow: auto; height: 100%; border-radius: 12px; border: 1px solid var(--border-color); }
#summaryContainer .table-wrapper { border: none; }
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}
th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem; }
thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; vertical-align: top; }
.copyable { cursor: pointer; transition: color 0.2s; }
.copyable:hover { color: var(--success-color); }
.filter-input, .control-group input, .control-group select {
    display: block; width: 100%; box-sizing: border-box; background-color: var(--surface-color);
    border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px;
    padding: 8px 12px; font-size: 0.9rem;
}
.filter-input { border-radius: 4px; padding: 4px 6px; margin-top: 4px; font-size: 0.8rem; }
.control-group { margin-bottom: 16px; }
.control-group label { display: block; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; font-size: 0.9rem; }
.file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-top: 16px; }
.file-drop-area p { margin: 0; color: var(--text-dark); }
.file-drop-area h4 { margin: 0 0 8px 0; color: var(--text-secondary); }
#summaryContainer table th, #summaryContainer table td { text-align: right; }
#summaryContainer table th:first-child, #summaryContainer table td:first-child {
    text-align: left; font-weight: bold; position: sticky; left: 0; z-index: 1;
    background-color: var(--sticky-col-bg);
}
#summaryContainer table .grand-total { font-weight: bold; border-top: 2px solid var(--border-color); }
.row-today { background-color: var(--row-today-bg) !important; }
.row-yesterday { background-color: var(--row-yesterday-bg) !important; }
.row-past { background-color: var(--row-past-bg) !important; }
#chartContainer, #fibraReportContainer, #chartContainer20, #chartContainerDaily { position: relative; padding: 16px; display: flex; flex-direction: column; flex-shrink: 0; }
#produccionChart, #produccion20Chart, #produccionDailyChart, #produccionCalidadChart { max-height: 250px; }
.pie-chart-container { max-height: 180px; margin-bottom: 16px; }
#chartSummary, #chartSummary20, #chartSummaryDaily, #chartSummaryCalidad { text-align: center; padding-top: 10px; font-weight: 600; color: var(--text-secondary); }
#chartSummary strong, #chartSummary20 strong, #chartSummaryDaily strong { color: var(--text-primary); }
#fibraReportContainer .fibra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; }
#fibraReportContainer h4, #fibraReportContainer h5 { margin-top: 0; text-align: center; }
.table-grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    flex-grow: 1;
    min-height: 0;
}
.table-grid-container table th,
.table-grid-container table td {
    white-space: normal;
    overflow-wrap: break-word;
    font-size: 0.8rem;
    padding: 8px 5px;
    text-align: center;
}
/* --- AJUSTE PARA TABLAS DE PRODUCCIÓN POR FIBRA --- */
#fibraReportContainer .sub-table {
    width: 100%;
    table-layout: fixed; /* Mantiene las columnas estables */
    font-size: 0.75rem;  /* Letra un poco más chica para que quepa todo */
}

#fibraReportContainer .sub-table th,
#fibraReportContainer .sub-table td {
    padding: 4px 6px;   /* Menos relleno para ahorrar espacio */
    overflow: hidden;
    text-overflow: ellipsis; /* Puntos suspensivos si el texto es muy largo */
    white-space: nowrap;    /* Evita que el texto se rompa en varias líneas a lo pendejo */
}

/* Específico para la columna de Catálogo (la segunda) */
#fibraReportContainer .sub-table th:nth-child(2),
#fibraReportContainer .sub-table td:nth-child(2) {
    width: 55%; /* Dale más espacio al catálogo */
    white-space: normal; /* Permite que el catálogo se divida en 2 líneas si es necesario */
    word-break: break-word;
}

/* Específico para la columna de Piezas (la tercera) */
#fibraReportContainer .sub-table th:nth-child(3),
#fibraReportContainer .sub-table td:nth-child(3) {
    width: 20%;
    text-align: center;
}

.table-grid-container table th:nth-child(1), .table-grid-container table td:nth-child(1),
.table-grid-container table th:nth-child(2), .table-grid-container table td:nth-child(2),
.table-grid-container table th:nth-child(3), .table-grid-container table td:nth-child(3) {
    text-align: left;
}
#dataTableTerminaciones, #dataTableProduccion20, #dataTableProduccionDaily {
    table-layout: auto;
    width: 100%;
}
#dataTableTerminaciones th,
#dataTableTerminaciones td,
#dataTableProduccion20 th,
#dataTableProduccion20 td,
#dataTableProduccionDaily th,
#dataTableProduccionDaily td {
    white-space: nowrap;
    text-align: center;
    vertical-align: middle;
}
#dataTable901 {
    table-layout: auto;
}
#dataTable901 th,
#dataTable901 td {
    white-space: normal;
    word-wrap: break-word;
    vertical-align: top;
}
/* Estilos para la tabla de ProducciÃ³n Calidad */
#dataTableProduccionCalidad {
    table-layout: fixed;
    width: 100%;
}

#dataTableProduccionCalidad th,
#dataTableProduccionCalidad td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
}

#dataTableProduccionCalidad th:nth-child(1),
#dataTableProduccionCalidad td:nth-child(1) {
    width: 150px;
}

#dataTableProduccionCalidad th:nth-child(4),
#dataTableProduccionCalidad td:nth-child(4) {
    width: 200px;
}

#resumenSemanal h5 {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
    margin-bottom: 8px;
}
#resumenSemanal p {
    margin: 4px 0;
    font-size: 0.9rem;
}
.summary-bars-wrapper {
    display: flex;
    justify-content: space-around;
    gap: 20px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}
.summary-bar-container {
    width: 60px;
    height: 120px;
    background-color: var(--surface-hover-color);
    border-radius: 6px;
    display: flex;
    flex-direction: column-reverse;
    position: relative;
}
.summary-bar {
    width: 100%;
    border-radius: 6px;
    position: relative;
    transition: height 0.5s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
}
.summary-bar span {
    color: var(--text-primary);
    font-weight: bold;
    font-size: 18px;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
    text-align: center;
    width: 100%;
}
.summary-bar-label {
    position: absolute;
    bottom: -20px;
    width: 100%;
    text-align: center;
    font-size: 0.8rem;
    color: var(--text-secondary);
}
.tarima-details {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--surface-hover-color);
    margin: 5px 0;
    overflow: hidden;
}

.details-summary {
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-secondary);
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s ease;
}
.details-summary:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
.details-summary::-webkit-details-marker {
    display: none;
}
.details-summary .arrow {
    font-size: 0.8em;
    transition: transform 0.2s ease;
}
.tarima-details[open] > .details-summary .arrow {
    transform: rotate(180deg);
}
.details-content {
    padding: 10px 15px;
    border-top: 1px solid var(--border-color);
    background-color: var(--surface-color);
}
.details-content ul {
    margin: 0;
    padding-left: 5px;
    list-style-type: none;
}
.details-content li:last-child {
    border-bottom: none;
}
#dataTableTarimas {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
}
#dataTableTarimas th, #dataTableTarimas td {
    vertical-align: middle;
}
#dataTableTarimas tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.03);
}
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
.modal-overlay.visible { opacity: 1; visibility: visible; }
.modal-content { transform: scale(0.95); transition: transform 0.3s; width: 90%; max-width: 800px; }
.modal-overlay.visible .modal-content { transform: scale(1); }
.modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; text-align: center; width: 100%; color: var(--text-primary); }
.modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
#modalBody input, #modalBody select, #modalBody textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary); box-sizing: border-box; }
#modalBody textarea { min-height: 80px; resize: vertical; }
#modalBody p { font-size: 0.9em; color: var(--text-dark); margin-top:4px; }
.param-list, .area-list { list-style: none; padding: 0; margin: 16px 0; max-height: 45vh; overflow-y: auto; }
.param-item { display: grid; grid-template-columns: auto 1fr 1.2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
.param-item input, .param-item select { margin: 0; }
.param-value-container { grid-column: 4; }
.hidden { display: none; }
.area-item { display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
.area-source-container, .user-filter-container { display: flex; flex-direction: column; gap: 4px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
.area-source-container label, .user-filter-container label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
.btn-danger { background-color: var(--danger-color); color: white; width: auto; padding: 8px 12px; transition: background-color 0.2s; }
.btn-danger:hover { background-color: var(--danger-hover-color); }
.drag-handle { cursor: grab; color: var(--text-dark); padding: 4px; display: flex; align-items: center; justify-content: center; }
.drag-handle:active { cursor: grabbing; }
.param-item.dragging { opacity: 0.5; background-color: var(--primary-color); }
.modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; }
.tab-btn { background: none; border: none; padding: 10px 16px; cursor: pointer; color: var(--text-dark); font-weight: 600; border-bottom: 3px solid transparent; }
.tab-btn.active { color: var(--text-primary); border-bottom-color: var(--primary-color); }
.tab-content { display: none; }
.tab-content.active { display: block; }
.formula-helpers { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
.helper-pill { background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
.helper-pill:hover { background-color: var(--primary-color); color: var(--primary-text-color); border-color: var(--primary-color); }
#login-error-msg { color: var(--danger-color); text-align: center; margin-top: 10px; font-weight: 500; height: 1em; }
.collapsible-section { border: 1px solid var(--border-color); border-radius: 12px; margin-top: 16px; overflow: hidden; background-color: var(--surface-color); }
.collapsible-header { background-color: transparent; padding: 12px 16px; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid transparent; transition: all 0.2s; }
.collapsible-section.open .collapsible-header { border-bottom-color: var(--border-color); }
.collapsible-header:hover { background-color: var(--surface-hover-color); }
.collapsible-header::after { content: 'â–¼'; transition: transform 0.2s; }
.collapsible-section.open .collapsible-header::after { transform: rotate(180deg); }
.collapsible-content { padding: 16px; max-height: 0; overflow-y: auto; transition: max-height 0.4s ease-out, padding 0.4s ease-out; }
.collapsible-section.open .collapsible-content { max-height: 60vh; }
#addPackerForm { display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 12px; align-items: end; }
#packerList { list-style: none; padding: 0; margin-top: 16px; max-height: 250px; overflow-y: auto; }
#packerList li { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; padding: 8px; border-radius: 6px; }
#packerList li:nth-child(odd) { background-color: var(--surface-hover-color); }

/* --- Estilos para Reporte Tarimas --- */
#dataTableTarimas {
    table-layout: auto;
}
#dataTableTarimas th,
#dataTableTarimas td {
    white-space: normal;
    word-wrap: break-word;
    vertical-align: top;
    text-align: left;
}
#dataTableTarimas .detalle-cell {
    padding: 5px;
    background-color: var(--surface-hover-color);
}
#dataTableTarimas .detalle-cell ul {
    margin: 0;
    padding-left: 20px;
    list-style-type: square;
}
#dataTableTarimas .detalle-cell li {
    margin-bottom: 4px;
    font-size: 0.85rem;
}
.status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
}
.status-verde { background-color: var(--success-color); }
.status-naranja { background-color: #f59e0b; }
.status-rojo { background-color: var(--danger-color); }
/* --- Fin Estilos Reporte Tarimas --- */

/* --- Estilos Adicionales --- */
.btn-small {
    padding: 5px 10px;
    font-size: 0.85rem;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.missing-bxid {
    border-left: 4px solid var(--danger-color) !important;
    background-color: rgba(239, 68, 68, 0.05) !important;
}
.missing-bxid strong {
    color: var(--danger-color) !important;
}
#modalBody ul {
    padding-right: 10px;
}

/* --- INICIO: Estilos del Nuevo Dashboard (Limpios y Corregidos) --- */

#viewLiveDashboard {
    width: 100%;
    box-sizing: border-box;
}

#viewLiveDashboard .main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas:
        "sidebar"
        "main";
    height: calc(100vh - 32px);
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding: 0;
    box-sizing: border-box;
}

#viewLiveDashboard .sidebar {
    position: static;
    max-height: none;
    top: 0;
    gap: 0;
    width: 100%;
    box-sizing: border-box;
}

#viewLiveDashboard .sidebar .card {
    height: auto;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    width: 100%;
    box-sizing: border-box;
}

#viewLiveDashboard .sidebar .card > div:not(.sidebar-header) {
    display: none;
}
#viewLiveDashboard .sidebar .card .sidebar-header {
    width: 100%;
}

#viewLiveDashboard .main-content {
    grid-area: main;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-width: 0;
    padding: 0 16px;
    box-sizing: border-box;
}

.dashboard-kpi-container {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
    width: 100%;
}

.kpi-card {
    background-color: var(--surface-hover-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    flex: 1 1 calc(50% - 8px);
    min-width: 160px;
    max-width: calc(50% - 8px);
}

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.kpi-header h4 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--text-primary);
}

.kpi-meta {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-dark);
}

.kpi-card h1 {
    font-size: 3.5rem;
    color: var(--text-primary);
    margin: 10px 0;
    text-align: center;
    font-weight: 700;
}

.kpi-progress-bar-container {
    width: 100%;
    height: 12px;
    background-color: var(--border-color);
    border-radius: 6px;
    overflow: hidden;
    margin-top: 5px;
}

.kpi-progress-bar {
    height: 100%;
    width: 0%;
    border-radius: 6px;
    background-color: var(--success-color);
    transition: width 0.5s ease-in-out;
    box-shadow: 0 0 10px var(--success-color);
}

.progress-bar-green { background-color: var(--success-color); box-shadow: 0 0 10px var(--success-color); }
.progress-bar-yellow { background-color: #f59e0b; box-shadow: 0 0 10px #f59e0b; }
.progress-bar-red { background-color: var(--danger-color); box-shadow: 0 0 10px var(--danger-color); }

.kpi-percent {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-align: right;
    margin-top: 4px;
}

#liveFeedContainer p {
    font-size: 0.9rem;
    margin: 8px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
#liveFeedContainer p:last-child {
    border-bottom: none;
}

.kpi-piezas {
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin: -10px 0 10px 0; /* Ajusta el espacio entre la terminación y las piezas */
    text-align: center;
}

.last-scan-label {
    display: block;
    text-align: right;
    font-size: 0.8rem;
    color: var(--text-dark);
    font-style: italic;
    margin-top: 8px; /* Espacio para separarlo de la gráfica */
}

/* --- Ajustes de centrado para el Dashboard --- */
#liveTurnoTitle {
	flex-grow: 1; /* Esto hace que el título ocupe el espacio disponible */
	text-align: center; /* Centra el texto */
	margin: 0 16px; /* Le da aire para que no se pegue a los botones */
}

.live-dashboard-wrapper .card h5 {
	text-align: center; /* Centra el título "Producción por Hora (En Vivo)" */
	margin-top: 0;
	margin-bottom: 16px;
}

/* --- Media Queries para pantallas mÃ¡s grandes --- */
@media (min-width: 768px) {
    #viewLiveDashboard .main-content {
        padding: 0;
    }
    .kpi-card {
        flex: 1 1 calc(33.333% - 11px);
        max-width: calc(33.333% - 11px);
    }
}
@media (min-width: 1024px) {
    .kpi-card {
        flex: 1 1 calc(25% - 12px);
        max-width: calc(25% - 12px);
    }
}

/* --- FIN: Estilos del Nuevo Dashboard --- */

/* Estilos @media (max-width: 900px) que ya tenÃ­as */
@media (max-width: 900px), (max-height: 450px) {
    body { overflow-y: auto; padding: 8px; }
    .app-header { margin-bottom: 16px; }
    .app-branding { font-size: 2rem; }
    .app-title { font-size: 1rem; }

    .main-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: auto;
        gap: 12px;
        padding-top: 0;
        width: 100%;
        padding-left: 0;
        padding-right: 0;
    }

    #viewLiveDashboard .main-container {
        padding: 0;
    }

    #viewLiveDashboard .main-content {
        padding: 0 8px;
    }

    .sidebar { height: auto; }
    .main-content { min-height: 50vh; gap: 12px; min-width: 0; }
    .card { padding: 16px; }
    .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table th, table td { padding: 8px 10px; font-size: 0.8rem; text-align: center; }
    #summaryContainer table th:first-child, #summaryContainer table td:first-child { text-align: left; }
    .modal-content { width: 95%; max-height: 85vh; display: flex; flex-direction: column; }
    #modalBody { overflow-y: auto; }
    .param-item, .area-item { grid-template-columns: 1fr; gap: 8px; text-align: left; }
    .param-item .btn-danger, .area-item .btn-danger { justify-self: end; }
    .param-value-container { grid-column: 1; }
    #fibraReportContainer .fibra-grid { grid-template-columns: 1fr; }
    .table-grid-container { grid-template-columns: 1fr; }
    #addPackerForm { grid-template-columns: 1fr; }
    #packerList li { grid-template-columns: 1fr; text-align: center; gap: 4px; }
}

/* =============================================
   FIX FINAL: DESACTIVAR GRID EN EL DASHBOARD LIVE
   ============================================= */

/* Sidebar ahora es un header, no un panel lateral */
#viewLiveDashboard .sidebar {
    width: 100% !important;
    max-width: 1100px;
    display: block !important;
    margin: 0 auto;
}

/* Header centrado y limpio */
#viewLiveDashboard .sidebar-header {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/* Contenido principal CENTRADO */
#viewLiveDashboard .main-content {
    width: 100%;
    max-width: 1100px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 0 auto !important;
}

/* KPIs perfectamente centrados */
#viewLiveDashboard .dashboard-kpi-container {
    justify-content: center !important;
}

/* Layout centrado del nuevo dashboard */


/* Header */
.live-dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.header-buttons {
    display: flex;
    gap: 12px;
}

/* KPIs centradas */
#kpiCardContainer {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 16px;
}

/* --- Estilos para el Modal Semanal 20% --- */
/* --- Estilos para el Modal Semanal 20% (Con Vistas) --- */
.modal-view-tabs {
	display: flex;
	gap: 10px;
	margin-top: 20px;
	border-bottom: 2px solid var(--border-color);
}
.modal-tab-btn {
	padding: 10px 16px;
	border-radius: 8px 8px 0 0;
	cursor: pointer;
	background-color: transparent;
	border: none;
	border-bottom: 3px solid transparent;
	color: var(--text-secondary);
	font-weight: 600;
	font-size: 0.9rem;
	transition: all 0.2s;
}
.modal-tab-btn:hover {
	color: var(--text-primary);
}
.modal-tab-btn.active {
	color: var(--text-primary);
	border-bottom: 3px solid var(--primary-color);
}
.modal-view-content {
	display: none;
	padding-top: 20px;
	animation: fadeInUp 0.3s ease-out;
	min-height: 45vh;
}
.modal-view-content.active {
	display: block;
}

/* Contenedores internos de las vistas */
#viewComparativa .modal-chart-wrapper {
	height: 45vh; /* Altura fija para la gráfica */
	position: relative;
}
#viewRanking .modal-ranking-wrapper {
	overflow-y: auto;
	max-height: 45vh;
}
#viewRanking .modal-ranking-wrapper h5 {
	margin-top: 0;
	text-align: center;
	color: var(--text-primary);
}

/* Estilos de la tabla de ranking (sin cambios, solo movidos aquí) */
#rankingTable20 {
	width: 100%;
	table-layout: auto;
	font-size: 0.85rem;
}
#rankingTable20 th {
	text-align: left;
	padding: 6px 8px;
}
#rankingTable20 td {
	padding: 6px 8px;
	white-space: nowrap;
}
#rankingTable20 th:nth-child(2), #rankingTable20 td:nth-child(2),
#rankingTable20 th:nth-child(3), #rankingTable20 td:nth-child(3) {
	text-align: right;
	font-weight: bold;
}

/* Ocultar layout viejo (por si acaso) */
.modal-semanal-layout {
	display: none !important;
}

/* Responsive (se aplica al wrapper) */
@media (max-width: 768px) {
	.modal-view-content {
		min-height: 50vh;
	}
	#viewComparativa .modal-chart-wrapper {
		height: 50vh;
	}
	#viewRanking .modal-ranking-wrapper {
		max-height: 50vh;
	}
}



/* FIX DEFINITIVO: centrado real del Dashboard */
#viewLiveDashboard .live-dashboard-wrapper {
    width: 100%;
    max-width: 1100px;      /* el tamaño ideal de tu dashboard */
    margin: 0 auto;         /* <-- ESTO ES LO QUE LO CENTRA */
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
}

/* FIX REAL: Cancelar por completo el GRID heredado */
#viewLiveDashboard .main-container { /* <--- ¡YA NO TIENE LA COMA! */
    display: block !important;
    margin: 0 auto !important;
    padding: 0 !important;
    grid-template-columns: none !important;
}
    /* Estilos para el Podio del Ranking (Corregido) */
#rankingTable20 tbody tr.gold td {
		background-color: rgba(255, 215, 0, 0.4) !important; /* Oro (un poco más fuerte) */
		color: #111827 !important; /* FORZAR TEXTO OSCURO para contraste */
		font-weight: 600;
	}
#rankingTable20 tbody tr.silver td {
		background-color: rgba(192, 192, 192, 0.3) !important; /* Plata */
		color: var(--text-primary);
	}
#rankingTable20 tbody tr.bronze td {
		background-color: rgba(205, 127, 50, 0.3) !important; /* Bronce */
		color: var(--text-primary);
	}
	
	/* Hover para el podio */
	#rankingTable20 tbody tr.gold:hover td {
		background-color: rgba(255, 215, 0, 0.2) !important; /* Hover de oro */
	}
	#rankingTable20 tbody tr.silver:hover td {
		background-color: rgba(192, 192, 192, 0.15) !important;
	}
	#rankingTable20 tbody tr.bronze:hover td {
		background-color: rgba(205, 127, 50, 0.15) !important;
	}
	
	/* En light-theme, el hover de plata y bronce debe ser más oscuro */
	body.light-theme #rankingTable20 tbody tr.silver:hover td,
	body.light-theme #rankingTable20 tbody tr.bronze:hover td {
		background-color: rgba(0, 0, 0, 0.1) !important;
	}
   
  /* =================================================
   ESTILOS MODERNOS: RANKING CARDS & PODIO
   ================================================= */

.ranking-card-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 4px;
}

.ranking-card {
    display: grid;
    grid-template-columns: 40px 1fr 1.5fr; /* Posición | Datos | Stats */
    align-items: center;
    background-color: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 12px 16px;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
    overflow: hidden;
}

.ranking-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Posición (Círculo) */
.rank-badge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--surface-hover-color);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 0.9rem;
}

/* Info Empleado */
.emp-info {
    display: flex;
    flex-direction: column;
    padding-left: 12px;
}
.emp-name {
    font-weight: 700;
    color: var(--text-primary);
    font-size: 1rem;
}
.emp-turno {
    font-size: 0.75rem;
    color: var(--text-secondary);
    background: var(--surface-hover-color);
    padding: 2px 6px;
    border-radius: 4px;
    width: fit-content;
    margin-top: 4px;
}

/* Stats y Barra */
.emp-stats-wrapper {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.emp-metrics {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: var(--text-primary);
}
.metric-val { font-weight: 700; }

/* PODIO - COLORES Y EFECTOS */
.ranking-card.gold {
    background: linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
    border: 1px solid #FFD700;
}
.ranking-card.gold .rank-badge {
    background-color: #FFD700;
    color: #000;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
}

.ranking-card.silver {
    background: linear-gradient(145deg, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05));
    border: 1px solid #C0C0C0;
}
.ranking-card.silver .rank-badge {
    background-color: #C0C0C0;
    color: #000;
}

.ranking-card.bronze {
    background: linear-gradient(145deg, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05));
    border: 1px solid #CD7F32;
}
.ranking-card.bronze .rank-badge {
    background-color: #CD7F32;
    color: #fff;
}

/* Barra de Progreso en Tarjeta */
.card-progress-bg {
    width: 100%;
    height: 8px;
    background-color: rgba(0,0,0,0.2);
    border-radius: 4px;
    overflow: hidden;
}
.card-progress-fill {
    height: 100%;
    background-color: var(--success-color);
    border-radius: 4px;
    width: 0;
    transition: width 1s ease-out;
}
/* Colores de barra para el podio */
.ranking-card.gold .card-progress-fill { background-color: #FFD700; }
.ranking-card.silver .card-progress-fill { background-color: #C0C0C0; }
.ranking-card.bronze .card-progress-fill { background-color: #CD7F32; }

/* =========================================
   ESTILOS MODO EXPORTACIÓN (FIX DEFINITIVO)
   ========================================= */

/* Cuando se activa el modo exportación, forzamos un ancho fijo grande 
   para que la imagen salga de alta calidad y todo quepa */
.export-mode #exportWrapper {
    display: grid !important;
    grid-template-columns: 1.2fr 0.8fr !important; /* Gráfica 60% - Ranking 40% */
    gap: 30px !important;
    background-color: var(--bg-gradient) !important; /* Fondo del tema actual */
    padding: 30px !important;
    border-radius: 12px;
    width: 1200px !important; /* FORZAR ANCHO FIJO para que no dependa de tu pantalla */
    margin: 0 auto !important;
    position: fixed !important; /* Sacarlo del flujo normal momentáneamente */
    top: 0;
    left: 0;
    z-index: -100; /* Esconderlo detrás mientras se toma la foto */
}

/* Forzar que ambas pestañas se vean a la vez */
.export-mode .modal-view-content {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    width: 100% !important;
}

/* Ocultar los botones de las pestañas en la foto */
.export-mode-parent .modal-view-tabs {
    display: none !important;
}

/* QUITAR EL SCROLL DEL RANKING para que salgan todos los empleados */
.export-mode .modal-ranking-wrapper,
.export-mode #rankingList {
    max-height: none !important;
    overflow: visible !important;
    height: auto !important;
}

/* Ajustar la gráfica para que se vea bien en la foto */
.export-mode .modal-chart-wrapper {
    height: 500px !important; /* Altura fija para la imagen */
    border: none !important;
    box-shadow: none !important;
}

/* Ajuste para texto en imagen oscura */
body.dark-theme .export-mode h5, 
body.dark-theme .export-mode span,
body.dark-theme .export-mode p {
    color: #ffffff !important;
}


/* --- ESTILOS MODERNOS PARA SELECTOR DE TURNOS (TOGGLE CHIPS) --- */
.turno-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Dos columnas */
    gap: 8px;
    margin-top: 4px;
}

.btn-turno-toggle {
    background-color: var(--surface-color);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 6px 10px; /* Menos relleno para que sean más pequeños */
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.8rem; /* Letra un poco más chica */
    font-weight: 600;  /* Texto un poco más gordito para que resalte */
    text-align: center;
    transition: all 0.2s ease;
    user-select: none;
}

/* El hover y active se quedan igual, o puedes ajustarlos si quieres */
.btn-turno-toggle:hover {
    background-color: var(--surface-hover-color);
}

.btn-turno-toggle.active {
    background-color: var(--primary-color);
    color: var(--primary-text-color);
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Sombra más sutil */
    transform: translateY(-1px); /* Pequeño efecto de "levantado" */
}

</style>
</head>
<body class="dark-theme">

    <div class="app-container">
        <div id="menuView">
    <div class="menu-wrapper">
        <header class="app-header animated-startup">
            <h1 class="app-branding">CORNING</h1>
            <h2 class="app-title">Centro de Reportes</h2>
        </header>
        <main class="card animated-startup" style="animation-delay: 0.1s;">
            <div class="menu-container">
                <button id="reporteProduccionBtn" class="btn">Reporte de Producción</button>
                <button id="reporteProduccion20Btn" class="btn">Reporte de Producción 20%</button>
                <button id="reporteProduccionDailyBtn" class="btn">Reporte de Producción Daily</button>
                <button id="reporteProduccionCalidadBtn" class="btn">Reporte de Producción Calidad</button>
				
                <button id="reporteTarimasBtn" class="btn">Reporte de Tarimas Confirmadas</button>
                <button id="reporteTerminacionesBtn" class="btn">Reporte de Terminaciones</button>
                <button id="view901Btn" class="btn">Reporte 901</button>
                <button id="reporteBoxIDBtn" class="btn">Reporte BoxID</button>
                <button id="liveDashboardBtn" class="btn" style="grid-column: 1 / -1; background-color: var(--success-color); color: var(--primary-text-color);">Vista Producción</button>
            </div>
        </main>
    </div>
</div>

        <div id="viewProduccionHora">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="flex-grow: 1; overflow-y: auto; padding-right: 8px;">
                        <div id="fechaUnicaContainer" class="control-group">
                                <label for="prod_fecha_unica">Fecha</label>
                                <input type="date" id="prod_fecha_unica">
                            </div>

                            <div id="fechaRangoContainer" style="display: none;">
                                <div class="control-group">
                                    <label for="prod_fecha_inicio">Fecha Inicio</label>
                                    <input type="date" id="prod_fecha_inicio">
                                </div>
                                <div class="control-group">
                                    <label for="prod_fecha_fin">Fecha Fin</label>
                                    <input type="date" id="prod_fecha_fin">
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="prod_turno">Turno</label>
                                <select id="prod_turno">
                                    <option value="T45">T45 (L-M, Día)</option>
                                    <option value="T46">T46 (L-M, Noche)</option>
                                    <option value="T47">T47 (J-D, Día)</option>
                                    <option value="T48">T48 (J-D, Noche)</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="prod_area">Área</label>
                                <select id="prod_area">
                                    <option value="ALL">Todas las Áreas</option>
                                </select>
                            </div>
                            <div id="packerSelectsContainer" style="display: none;"></div>
                            <hr style="border-color: var(--border-color); margin: 24px 0;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button id="showProduccionHoraBtn" class="btn btn-glass">Producción por Hora</button>
                                <button id="showProduccionFibraBtn" class="btn btn-glass">Producción por Fibra</button>
                                <button id="showProduccionSemanaBtn" class="btn btn-glass">Producción por Semana</button>
                            </div>
                        </div>
                       <button id="generarReporteProduccionBtn" class="btn" style="margin-top: 16px; width: 100%;">Generar Reporte</button>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción</h2></header>

                    <div id="chartContainer" class="card">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción por Hora</h3></div>
                            <button id="exportChartBtn" class="icon-btn" title="Exportar Gráfica como JPG" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        </div>
                        <canvas id="produccionChart"></canvas>
                        <div id="chartSummary"></div>
                    </div>

                    <div id="fibraReportContainer" class="card" style="display: none;">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción por Fibra</h3></div>
                        </div>
                        <div id="fibraReportContent"></div>
                    </div>

                    <div id="semanalContainer" class="card" style="display: none; flex-direction: column;">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción Semanal Comparativa</h3></div>
                            <button id="exportarSemanalBtn" class="icon-btn" title="Exportar como JPG"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        </div>
                        <div style="display: flex; flex-direction: row; gap: 20px; flex-grow: 1;">
                             <div style="flex-grow: 1; position: relative; min-height: 60vh;">
                                <canvas id="produccionSemanalChart"></canvas>
                            </div>
                            <div id="resumenSemanal" style="flex-basis: 220px; flex-shrink: 0;">
                                </div>
                        </div>
                    </div>

                    <div class="table-grid-container" id="produccionTablesGrid" style="grid-template-columns: 1fr 1fr;">
                                            </div>
                </main>
            </div>
        </div>
        <div id="viewProduccion20">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display:flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="padding: 0 10px; flex-grow: 1; display: flex; flex-direction: column;">
                           <div class="control-group">
                                <label for="prod20_fecha">Fecha del Reporte</label>
                                <input type="date" id="prod20_fecha">
                            </div>
                            <div class="control-group">
                                <label for="prod20_turno">Turno</label>
                                <select id="prod20_turno">
                                    <option value="T45">T45 (L-M, Día)</option>
                                    <option value="T46">T46 (L-M, Noche)</option>
                                    <option value="T47">T47 (J-D, Día)</option>
                                    <option value="T48">T48 (J-D, Noche)</option>
                                </select>
                            </div>
                            <button id="consultarProduccion20Btn" class="btn" style="width: 100%;">Consultar Reporte</button>
                               <button id="abrirModalSemanalBtn" class="btn btn-glass" style="width: 100%; margin-top: 12px;">Reporte Semanal</button>
                            <hr style="border-color: var(--border-color); margin: 24px 0;">
                            <div id="fileDropAreaProd20" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center; margin-top: 0;">
                                <h4>Actualizar Datos</h4>
                                <p>Arrastra un archivo para añadir o actualizar registros</p>
                            </div>
                            <input type="file" id="fileInputProd20" accept=".xlsx, .xls" style="display: none;">
                        </div>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción 20%</h2></header>

                    <div id="chartContainer20" class="card">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción de Terminaciones por Hora</h3></div>
                        </div>
                        <canvas id="produccion20Chart"></canvas>
                        <div id="chartSummary20"></div>
                    </div>

                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableProduccion20">
                                <thead><tr><th>Carga o consulta un reporte para ver los datos...</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <div id="viewProduccionDaily" style="display: none;">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display:flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="padding: 0 10px; flex-grow: 1; display: flex; flex-direction: column;">
                           <div class="control-group">
                                <label for="prodDaily_fecha">Fecha del Reporte</label>
                                <input type="date" id="prodDaily_fecha">
                            </div>
                            <div class="control-group">
                                <label for="prodDaily_turno">Turno</label>
                                <select id="prodDaily_turno">
                                    <option value="T45">T45 (L-M, Día)</option>
                                    <option value="T46">T46 (L-M, Noche)</option>
                                    <option value="T47">T47 (J-D, Día)</option>
                                    <option value="T48">T48 (J-D, Noche)</option>
                                </select>
                            </div>
                            <button id="consultarProduccionDailyBtn" class="btn" style="width: 100%;">Consultar Reporte</button>
                            <button id="abrirModalSemanalDailyBtn" class="btn btn-glass" style="width: 100%; margin-top: 12px;">Reporte Semanal</button>
                            <hr style="border-color: var(--border-color); margin: 24px 0;">
                            <div id="fileDropAreaProdDaily" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center; margin-top: 0;">
                                <h4>Actualizar Datos</h4>
                                <p>Arrastra un archivo para añadir o actualizar registros</p>
                            </div>
                            <input type="file" id="fileInputProdDaily" accept=".xlsx, .xls" style="display: none;">
                        </div>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción Daily</h2></header>

                    <div id="chartContainerDaily" class="card">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción de Terminaciones por Hora</h3></div>
                        </div>
                        <canvas id="produccionDailyChart"></canvas>
                        <div id="chartSummaryDaily"></div>
                    </div>

                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableProduccionDaily">
                                <thead><tr><th>Carga o consulta un reporte para ver los datos...</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
		
      <div id="viewLiveDashboard" style="display: none; opacity: 0;">
    <div class="live-dashboard-wrapper">

        <header class="live-dashboard-header animated-startup" style="animation-delay: 0.1s;">
            <h3 id="liveTurnoTitle">Turno: Cargando...</h3>

            <div class="header-buttons">
                <button class="backToMenuBtn icon-btn" title="Regresar al Menú">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M19 12H5" />
                        <path d="m12 19-7-7 7-7" />
                    </svg>
                </button>

                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y2="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>

                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg"
                        width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <section id="kpiCardContainer" class="dashboard-kpi-container animated-startup"
            style="animation-delay: 0.15s;">
            </section>

        <div class="card animated-startup" style="animation-delay: 0.2s;">
            <h5>Producción por Hora (En Vivo)</h5>
            <div id="liveChartContainer" style="flex-grow: 1; position: relative; min-height: 35vh;">
                <canvas id="liveProduccionChart"></canvas>
            </div>
            <span id="liveChartLastScan" class="last-scan-label"></span>
        </div>

        </div>
</div>
		
<div id="viewProduccionCalidad" style="display: none;">
    <div class="main-container">
        <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
            <div class="card" style="height: 100%; display:flex; flex-direction: column;">
                <div class="sidebar-header">
                    <h3>Panel de Control</h3>
                    <div>
                        <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                            <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        </button>
                        <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                    </div>
                </div>
                <div style="padding: 0 10px; flex-grow: 1; display: flex; flex-direction: column;">
                   <div class="control-group">
                        <label for="prodCalidad_fecha">Fecha del Reporte</label>
                        <input type="date" id="prodCalidad_fecha">
                    </div>
                    <div class="control-group">
                        <label for="prodCalidad_turno">Turno</label>
                        <select id="prodCalidad_turno">
                            <option value="T45">T45 (L-M, Día)</option>
                            <option value="T46">T46 (L-M, Noche)</option>
                            <option value="T47">T47 (J-D, Día)</option>
                            <option value="T48">T48 (J-D, Noche)</option>
                        </select>
                    </div>
                    <button id="consultarProduccionCalidadBtn" class="btn" style="width: 100%;">Consultar Reporte</button>
                    <button id="abrirModalSemanalCalidadBtn" class="btn btn-glass" style="width: 100%; margin-top: 12px;">Reporte Semanal</button>
                    <hr style="border-color: var(--border-color); margin: 24px 0;">
                    <div id="fileDropAreaProdCalidad" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center; margin-top: 0;">
                        <h4>Actualizar Datos</h4>
                        <p>Arrastra un archivo para añadir o actualizar registros</p>
                    </div>
                    <input type="file" id="fileInputProdCalidad" accept=".xlsx, .xls" style="display: none;">
                </div>
            </div>
        </aside>
        <main class="main-content animated-startup" style="animation-delay: 0.2s;">
            <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción Calidad</h2></header>

            <div id="chartContainerCalidad" class="card">
                <div class="summary-header">
                    <div class="title-wrapper"><h3>Producción de Terminaciones por Hora</h3></div>
                </div>
                <canvas id="produccionCalidadChart"></canvas>
                <div id="chartSummaryCalidad"></div>
            </div>

            <div class="card table-container">
                <div class="table-wrapper">
                    <table id="dataTableProduccionCalidad">
                        <thead><tr><th>Carga o consulta un reporte para ver los datos...</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>
        <div id="view901">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div id="fileDropArea901" class="file-drop-area"><p>Arrastra un archivo para añadir registros</p></div>
                        <input type="file" id="fileInput901" accept=".xlsx, .xls" style="display: none;">
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte 901</h2></header>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTable901"><thead><tr><th>Carga un archivo para ver los datos...</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
		
<div id="viewBoxID" style="display: none; justify-content: center; align-items: center; height: 100vh;">
    <div class="main-container" style="grid-template-columns: 1fr; max-width: 800px; height: auto; gap: 24px;">
        <main class="main-content animated-startup" style="display: contents;">
            <header class="app-header">
                <h1 class="app-branding">CORNING</h1>
                <h2 class="app-title">Módulo de Trazabilidad Logística</h2>
            </header>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
                <div class="card">
                     <div class="sidebar-header">
                        <h3>Paso 1: Cargar Reporte de Embarques</h3>
                        <div>
                           <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                           <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                               <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                               <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                           </button>
                        </div>
                    </div>
                    <div id="fileDropAreaBoxID" class="file-drop-area" style="margin-top: 16px;">
                        <h4>Archivo de BoxID</h4>
                        <p>Arrastra el archivo que contiene BoxID (J), GR (A) y Fecha (G).</p>
                    </div>
                    <input type="file" id="fileInputBoxID" accept=".xlsx, .xls" multiple style="display: none;">
                </div>

                <div class="card">
                     <h3>Paso 2: Cargar Reporte de Usuarios</h3>
                    <div id="fileDropAreaGrUsuarios" class="file-drop-area" style="margin-top: 16px;">
                        <h4>Archivo "GR USUARIOS"</h4>
                        <p>Arrastra el archivo con Usuario (I), Orden (F) y GR (B).</p>
                    </div>
                    <input type="file" id="fileInputGrUsuarios" accept=".xlsx, .xls" multiple style="display: none;">
                </div>
            </div>
        </main>
    </div>
</div>
	
<div id="viewTarimasConfirmadas" style="display: none;">
    <div class="main-container">
        <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
    <div class="card" style="height: 100%; display:flex; flex-direction: column;">
        <div class="sidebar-header">
            <h3>Panel de Control</h3>
            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
        <div style="padding: 0 10px; flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto;">
            <div class="control-group">
                <label for="prodTarimas_fecha">Fecha de Creación</label>
                <input type="date" id="prodTarimas_fecha">
            </div>
            <div class="control-group">
                <label for="prodTarimas_turno">Turno</label>
                <select id="prodTarimas_turno">
                    <option value="T45">T45 (L-M, Día)</option>
                    <option value="T46">T46 (L-M, Noche)</option>
                    <option value="T47">T47 (J-D, Día)</option>
                    <option value="T48">T48 (J-D, Noche)</option>
                    {/* <option value="TODOS">Todos los Turnos</option> */}
                </select>
            </div>
            <div class="control-group">
                <label for="prodTarimas_area">Área</label>
                <select id="prodTarimas_area">
                    <option value="" disabled selected>Cargando áreas...</option>
                    <option value="ALL">Todas las Áreas</option>
                </select>
            </div>
            <button id="consultarTarimasBtn" class="btn" style="width: 100%; margin-top: 5px;">Consultar Tarimas</button>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <button id="calcularTerminacionesDiaBtn" class="btn btn-glass" style="width: 100%;">Calcular Terminaciones del Turno</button>
            <div style="min-height: 20px;"></div>
        </div>
    </div>
</aside>
		<main class="main-content animated-startup" style="animation-delay: 0.2s;">
            <header class="app-header">
                <h1 class="app-branding">CORNING</h1>
                <h2 class="app-title">Reporte de Tarimas Confirmadas</h2>
            </header>
            <div id="terminacionesDashboardContainer" class="card animated-startup" style="display: none; margin-bottom: 16px; animation-delay: 0.3s;">
            </div>
            <div id="tarimasTableContainer" class="card table-container">
                <div class="table-wrapper">
                    <table id="dataTableTarimas">
                        <thead><tr><th>Seleccione fecha y turno, luego consulte.</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>		
		<div id="viewTerminaciones">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;"><div class="card" style="height: 100%; display: flex; flex-direction: column;"><div class="sidebar-header"><h3>Panel de Control</h3><div>
                    <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                    <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                </div></div>
                    <div id="fileDropAreaZpptwc" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Zpptwc)</h4><p>Arrastra el primer archivo aquí</p></div><input type="file" id="fileInputZpptwc" accept=".xlsx, .xls" style="display: none;">
                    <div id="fileDropAreaCoois" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Coois)</h4><p>Arrastra el segundo archivo aquí</p></div><input type="file" id="fileInputCoois" accept=".xlsx, .xls" style="display: none;">
                </div></aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Terminaciones</h2></header>
                    <div class="card" id="summaryContainer">
                        <div class="summary-header">
                            <h3>Resumen de Terminaciones</h3>
                        </div>
                        <p>Cargue los archivos para ver el resumen.</p>
                    </div>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableTerminaciones"><thead><tr><th>Carga los dos reportes de SAP para generar el informe</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay"><div id="modalContent" class="modal-content"><span id="modalClose" class="modal-close">&times;</span><h2 id="modalTitle" class="modal-title"></h2><div id="modalBody" style="margin-top:16px; color: var(--text-secondary);"></div></div></div>
</body>
   <script>
    // --- INICIO: CONFIGURACIÓN Y VARIABLES GLOBALES ---
    const firebaseConfig = { apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDXO", authDomain: "rastreador-de-ordenes.firebaseapp.com", projectId: "rastreador-de-ordenes", storageBucket: "rastreador-de-ordenes.appspot.com", messagingSenderId: "956052823395", appId: "1:956052823395:web:2ba74d9591d2b24c3cc756" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', () => {
        const doc = (id) => document.getElementById(id);
        const views = {
            menu: doc('menuView'),
            '901': doc('view901'),
            terminaciones: doc('viewTerminaciones'),
            produccionHora: doc('viewProduccionHora'),
            produccion20: doc('viewProduccion20'),
            produccionDaily: doc('viewProduccionDaily'),
            produccionCalidad: doc('viewProduccionCalidad'),
            tarimasConfirmadas: doc('viewTarimasConfirmadas'), // <-- AÑADE ESTA
            boxID: doc('viewBoxID'),
            liveDashboard: doc('viewLiveDashboard')
        };
        let session = { isMaster: false };
        let activeView = 'menu';
        let params = {
            '901_config': { columns: [], userFilter: [] },
            terminaciones_config: {
                zpptwc_cols: [],
                coois_cols: [],
                final_cols: [],
                area_config: { source_col: '', mappings: [] }
            },
            produccion_hora_config: {
                packers: []
            },
            produccion_20_config: {
                startRow: 15,
                columns: [
                    { key: 'Estación', excel_col: 'F' },
                    { key: 'Serial Number', excel_col: 'I' },
                    { key: 'Cantidad', excel_col: 'L' },
                    { key: 'Catalogo', excel_col: 'Q' },
                    { key: 'Orden', excel_col: 'R' },
                    { key: 'Empleado', excel_col: 'S' },
                    { key: 'Fecha y hora', excel_col: 'W' }
                ]
            },
			// --- NUEVA LÍNEA ---
			produccion_20_empleados_config: { empleados: [] }, 
			// --- FIN NUEVA LÍNEA ---
            produccion_daily_config: {
                startRow: 15,
                columns: [
                    { key: 'Estación', excel_col: 'F' },
                    { key: 'Serial Number', excel_col: 'I' },
                    { key: 'Cantidad', excel_col: 'L' },
                    { key: 'Catalogo', excel_col: 'Q' },
                    { key: 'Orden', excel_col: 'R' },
                    { key: 'Empleado', excel_col: 'S' },
                    { key: 'Fecha y hora', excel_col: 'W' }
                ]
            },
produccion_calidad_config: { // <-- AÑADE ESTE OBJETO COMPLETO
    startRow: 15,
    columns: [
        { key: 'Line', excel_col: 'C' },
        { key: 'Serial Number', excel_col: 'I' },
        { key: 'Cantidad', excel_col: 'L' },
        { key: 'Catalogo', excel_col: 'Q' },
        { key: 'Orden', excel_col: 'R' },
        { key: 'Fecha y hora', excel_col: 'W' }
    ]
}
       };
        let reportData = { zpptwc: null, coois: null };
        let productionChart = null;
        let production20Chart = null;
        let productionDailyChart = null;
        let productionCalidadChart = null;
        let fiberPieCharts = [];
        let productionReportData = null;
        let graficaSemanalInstance = null;
        let graficaSemanalDailyInstance = null;
        let graficaSemanalCalidadInstance = null;
        let weeklyProductionChart = null;
        let liveListener = null; // El "listener" que escucha en vivo
        let liveProductionChart = null; // La gráfica de barras en vivo


        // --- INICIO: LÓGICA DE NAVEGACIÓN Y UI GENERAL ---
        function switchView(viewKey) {
    const currentViewEl = views[activeView];
    const nextViewEl = views[viewKey];
    if (!nextViewEl) return;
    activeView = viewKey;
    currentViewEl.style.opacity = '0';
    setTimeout(() => {
        currentViewEl.style.display = 'none';
        nextViewEl.style.display = 'block';
        if (viewKey === 'menu') {
            nextViewEl.style.display = 'flex';
        }
        requestAnimationFrame(() => { nextViewEl.style.opacity = '1'; });
        if (viewKey === 'produccionHora') {
            loadAreasForProductionReport();
        } else if (viewKey === 'produccion20') {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            doc('prod20_fecha').value = `${year}-${month}-${day}`;
            doc('prod20_turno').value = getAutoCurrentShift();
            renderProduccion20Table([]);
            renderProduccion20Chart([], new Date());
        } else if (viewKey === 'produccionDaily') {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            doc('prodDaily_fecha').value = `${year}-${month}-${day}`;
            doc('prodDaily_turno').value = getAutoCurrentShift();
            renderProduccionDailyTable([]);
            renderProduccionDailyChart([], new Date());
        } else if (viewKey === 'produccionCalidad') {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            doc('prodCalidad_fecha').value = `${year}-${month}-${day}`;
            doc('prodCalidad_turno').value = getAutoCurrentShift();
            renderProduccionCalidadTable([]);
            renderProduccionCalidadChart([], new Date());
	} else if (viewKey === 'tarimasConfirmadas') {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                doc('prodTarimas_fecha').value = `${year}-${month}-${day}`;
                doc('prodTarimas_turno').value = getAutoCurrentShift(); 
                loadAreasForTarimasReport();
                renderTarimasTable([]); // Limpia tabla
              // --- LÍNEAS DE ERROR ELIMINADAS ---
            } else if (viewKey === 'boxID') {
            	doc('fileDropAreaBoxID').style.borderColor = 'var(--border-color)';
        }
    }, 300);
}

        doc('reporteProduccionBtn').addEventListener('click', () => switchView('produccionHora'));
doc('reporteProduccion20Btn').addEventListener('click', () => switchView('produccion20'));
doc('reporteProduccionDailyBtn').addEventListener('click', () => switchView('produccionDaily'));
doc('reporteProduccionCalidadBtn').addEventListener('click', () => switchView('produccionCalidad'));
doc('view901Btn').addEventListener('click', () => switchView('901'));
doc('reporteTerminacionesBtn').addEventListener('click', () => switchView('terminaciones'));
doc('abrirModalSemanalBtn').addEventListener('click', abrirModalReporteSemanal);
		doc('reporteTarimasBtn').addEventListener('click', () => switchView('tarimasConfirmadas'));
        doc('consultarTarimasBtn').addEventListener('click', consultarTarimas);
		doc('calcularTerminacionesDiaBtn').addEventListener('click', consultarTerminacionesConfirmadas);
		doc('reporteBoxIDBtn').addEventListener('click', () => switchView('boxID')); // <-- LÍNEA NUEVA
doc('liveDashboardBtn').addEventListener('click', () => showLiveDashboard());
document.querySelectorAll('.backToMenuBtn').forEach(btn => btn.addEventListener('click', () => {
        if (activeView === 'liveDashboard') {
            stopLiveDashboard(); // Apagamos el listener si estábamos en el dashboard
        }
        switchView('menu');
    }));

        let currentTheme = localStorage.getItem('theme') || 'dark';
        function applyTheme(theme) {
            document.body.className = `${theme}-theme`;
            document.querySelectorAll('.themeToggleBtn').forEach(btn => {
                const sunIcon = btn.querySelector('.sun-icon');
                const moonIcon = btn.querySelector('.moon-icon');
                if (sunIcon && moonIcon) {
                    sunIcon.style.display = theme === 'light' ? 'none' : 'block';
                    moonIcon.style.display = theme === 'light' ? 'block' : 'none';
                }
            });
            if (productionChart || fiberPieChart1 || fiberPieChart2 || production20Chart || weeklyProductionChart || productionDailyChart) {
                updateChartTheme();
            }
        }
        document.querySelectorAll('.themeToggleBtn').forEach(btn => btn.addEventListener('click', () => { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); }));

        const modalOverlay = doc('modalOverlay');
        function showModal(title, content) { doc('modalTitle').textContent = title; doc('modalBody').innerHTML = content; modalOverlay.classList.add('visible'); }
        function hideModal() { modalOverlay.classList.remove('visible'); }
        doc('modalClose').addEventListener('click', hideModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideModal(); });

        document.querySelectorAll('.settingsBtn').forEach(btn => btn.addEventListener('click', () => { session.isMaster ? showParamsModal() : showLoginModal(); }));
        function showLoginModal() { const content = `<p style="text-align: center;">Introduce las credenciales de maestro.</p><input type="text" id="userInput" placeholder="Usuario"><input type="password" id="passInput" placeholder="Contraseña"><button id="loginBtn" class="btn" style="margin-top: 16px; width: 100%;">Autenticar</button><div id="login-error-msg"></div>`; showModal('Autenticación Maestra', content); doc('loginBtn').addEventListener('click', checkMasterCredentials); }
        function checkMasterCredentials() { const errorMsgEl = doc('login-error-msg'); if (doc('userInput').value === 'LUNAU' && doc('passInput').value === 'Resoner96') { session.isMaster = true; sessionStorage.setItem('reportesMasterSession', 'true'); hideModal(); showParamsModal(); } else { errorMsgEl.textContent = 'Credenciales incorrectas.'; } }

        // --- INICIO: LÓGICA DE MODALES DE CONFIGURACIÓN ---
        function showParamsModal() {
    if (activeView === '901') {
        const config = params['901_config'];
        const filterText = (config.userFilter || []).join(', ');
        const paramsHTML = `<ul class="param-list param-list-901">${(config.columns || []).map(p => createParamItem901(p.key, p.startCell)).join('')}</ul>`;
        const content = `<div class="user-filter-container"><label for="userFilterInput">Filtrar por Usuarios (separados por coma)</label><textarea id="userFilterInput" placeholder="PINTORA2, LUNAU2... (dejar vacío para incluir a todos)">${filterText}</textarea></div><hr style="border-color: var(--border-color); margin: 16px 0;"><p style="text-align:center;">Define los nombres de columna y la celda de inicio de cada una (ej. A2).</p>${paramsHTML}<button id="addParam901Btn" class="btn" style="width: auto; padding: 8px 16px;">Añadir Columna</button><button id="saveParams901Btn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Mapeo y Filtros</button>`;
        showModal('Configurar Mapeo y Filtros de 901', content);
        doc('addParam901Btn').addEventListener('click', () => doc('modalBody').querySelector('.param-list-901').insertAdjacentHTML('beforeend', createParamItem901('', '')));
        doc('saveParams901Btn').addEventListener('click', saveParams901);
    } else if (activeView === 'terminaciones') {
        showTerminacionesConfigModal();
    } else if (activeView === 'produccionHora') {
        showProduccionHoraConfigModal();
    } else if (activeView === 'produccion20') {
        showProduccion20ConfigModal();
    } else if (activeView === 'produccionDaily') {
        showProduccionDailyConfigModal();
    } else if (activeView === 'produccionCalidad') { 
        showProduccionCalidadConfigModal();
    } else if (activeView === 'tarimasConfirmadas') { // <-- ¡AQUÍ ESTÁ EL AJUSTE!
        showAreaConfigModal();
    }
}

        function showProduccionHoraConfigModal() {
            const config = params.produccion_hora_config;
            const content = `
                <div class="collapsible-section open" id="packerRegistrySection">
                    <div class="collapsible-header">Base de Datos de Empacadores</div>
                    <div class="collapsible-content">
                        <p>Añada, edite o elimine empacadores para autocompletar en el panel de control. Los cambios se guardan al presionar el botón de abajo.</p>
                        <form id="addPackerForm">
                            <input type="text" id="newPackerId" placeholder="ID Empacador" required>
                            <select id="newPackerArea">${doc('prod_area').innerHTML}</select>
                            <input type="number" id="newPackerLinea" placeholder="Línea #" required min="1" style="width: 100%; padding: 8px; box-sizing: border-box; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary);">
                            <select id="newPackerTurno" required>${doc('prod_turno').innerHTML}</select>
                            <button type="submit" class="btn" style="padding: 8px 12px; font-size: 1rem;">+</button>
                        </form>
                        <ul id="packerList"></ul>
                    </div>
                </div>
                <button id="saveProduccionHoraConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Base de Datos</button>
            `;
            showModal('Configurar Empacadores', content);
            doc('saveProduccionHoraConfigBtn').addEventListener('click', saveProduccionHoraConfig);

            const section = doc('packerRegistrySection');
            section.querySelector('.collapsible-header').addEventListener('click', () => {
                section.classList.toggle('open');
            });

            doc('addPackerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPacker = {
                    id: doc('newPackerId').value.trim().toUpperCase(),
                    area: doc('newPackerArea').value,
                    linea: doc('newPackerLinea').value, // Asegúrate que este sea .value (del input numérico)
                    turno: doc('newPackerTurno').value
                };

                // --- ¡LÓGICA MEJORADA! ---
                // Buscamos si ya existe una entrada idéntica (mismo ID, misma Línea, mismo Turno)
                const yaExiste = params.produccion_hora_config.packers.some(
                    p => p.id === newPacker.id && p.linea === newPacker.linea && p.turno === newPacker.turno
                );

                if (newPacker.id && !yaExiste) {
                    params.produccion_hora_config.packers.push(newPacker);
                    renderPackerListInModal();
                    doc('newPackerId').value = '';
                } else if (newPacker.id && yaExiste) {
                    alert("Error: Ese empacador ya está registrado en esa misma línea y turno.");
                }
            });

            renderPackerListInModal();
        }

        function renderPackerListInModal() {
            const listEl = doc('packerList');
            if (!listEl) return;
            const packers = params.produccion_hora_config.packers || [];
            packers.sort((a, b) => a.id.localeCompare(b.id));

            listEl.innerHTML = packers.map((p, index) => `
                <li>
                    <span><strong>${p.id}</strong></span>
                    <span>${p.area}</span>
                    <span>Línea ${p.linea}</span>
                    <span>${p.turno}</span>
                    <button class="btn-danger" data-index="${index}" style="font-size: 0.8rem; padding: 4px 8px;">X</button>
                </li>
            `).join('');

            listEl.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    params.produccion_hora_config.packers.splice(index, 1);
                    renderPackerListInModal();
                });
            });
        }

        async function saveProduccionHoraConfig() {
            const newConfig = {
                packers: params.produccion_hora_config.packers || []
            };
            try {
                await db.collection('report_configs').doc('produccion_hora_params').set(newConfig);
                params.produccion_hora_config = newConfig;
                applyProduccionHoraConfig();
                showModal('Éxito', '<p>Base de datos de empacadores guardada.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        function createParamItem901(key, startCell) { return `<li class="param-item" style="grid-template-columns: 1fr 1fr auto;"><input type="text" class="param-key" placeholder="Nombre de Columna" value="${key || ''}"><input type="text" class="param-cell" placeholder="Celda de Inicio (ej. A2)" value="${startCell || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }

        async function saveParams901() {
            const newColumns = Array.from(doc('modalBody').querySelectorAll('.param-item')).map(item => ({ key: item.querySelector('.param-key').value.trim(), startCell: item.querySelector('.param-cell').value.trim().toUpperCase() })).filter(p => p.key && p.startCell);
            const userFilter = doc('userFilterInput').value.split(',').map(u => u.trim()).filter(Boolean);
            const newConfig = { columns: newColumns, userFilter: userFilter };
            try {
                await db.collection('report_configs').doc('901_params').set(newConfig);
                params['901_config'] = newConfig;
                showModal('Éxito', '<p>Mapeo y filtros de 901 guardados.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        function showTerminacionesConfigModal() {
            const config = params.terminaciones_config;
            const content = `
                <div class="modal-tabs">
                    <button class="tab-btn active" data-tab="zpptwc">1. Mapeo Zpptwc</button>
                    <button class="tab-btn" data-tab="coois">2. Mapeo Coois</button>
                    <button class="tab-btn" data-tab="areas">3. Mapeo de Áreas</button>
                    <button class="tab-btn" data-tab="final">4. Columnas Finales</button>
                </div>
                <div id="tab-zpptwc" class="tab-content active"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Zpptwc.</p><ul class="param-list">${(config.zpptwc_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                <div id="tab-coois" class="tab-content"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Coois.</p><ul class="param-list">${(config.coois_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                <div id="tab-areas" class="tab-content">
                    <div class="area-source-container">
                        <label for="area-source-col">Columna Clave de Coois con Código de Área</label>
                        <input type="text" id="area-source-col" placeholder="Ej. MRP" value="${(config.area_config || {}).source_col || ''}">
                        <p>Usa el "Nombre Clave" (definido en la pestaña 2) de la columna del reporte Coois que contiene el código de área (ej. MRP).</p>
                    </div>
                    <ul class="area-list">${((config.area_config || {}).mappings || []).map(a => createAreaItemHTML(a.code, a.name)).join('')}</ul>
                </div>
                <div id="tab-final" class="tab-content"><p>Define las columnas que aparecerán en el reporte final. Para cálculos complejos, usa los tipos automáticos.</p><ul class="param-list">${(config.final_cols || []).map(p => createFinalColHTML(p.key, p.type, p.value)).join('')}</ul></div>
                <button class="addBtn btn" style="width: auto; padding: 8px 16px;">Añadir Fila</button>
                <button id="saveTerminacionesSettingsBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>`;
            showModal('Configurar Automatización de Terminaciones', content);
            const modalBody = doc('modalBody');
            modalBody.querySelectorAll('.tab-btn').forEach(button => button.addEventListener('click', () => { modalBody.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); doc(`tab-${button.dataset.tab}`).classList.add('active'); }));
            modalBody.querySelector('.addBtn').addEventListener('click', () => { const activeTab = modalBody.querySelector('.tab-content.active'); if(activeTab.id === 'tab-areas') { activeTab.querySelector('.area-list').insertAdjacentHTML('beforeend', createAreaItemHTML('', '')); } else if(activeTab.id === 'tab-final') { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createFinalColHTML('', 'source', '')); } else { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createSourceColHTML('', '')); } });

            const lists = modalBody.querySelectorAll('.param-list');
            lists.forEach(list => {
                list.addEventListener('dragstart', e => { if (e.target.classList.contains('param-item')) e.target.classList.add('dragging'); });
                list.addEventListener('dragend', e => { if (e.target.classList.contains('param-item')) e.target.classList.remove('dragging'); });
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const draggingItem = list.querySelector('.dragging');
                    if (!draggingItem) return;
                    const afterElement = getDragAfterElement(list, e.clientY);
                    if (afterElement == null) { list.appendChild(draggingItem); }
                    else { list.insertBefore(draggingItem, afterElement); }
                });
            });
            doc('saveTerminacionesSettingsBtn').addEventListener('click', saveTerminacionesSettings);
        }

        // --- REEMPLAZO 1: La UI del Modal ---
function showProduccion20ConfigModal() {
	// Obtenemos ambas configs
	const configCols = params.produccion_20_config;
	const configEmps = params.produccion_20_empleados_config; // Config de empleados
	
	const columnsHTML = configCols.columns.map(p => createSourceColHTML(p.key, p.excel_col)).join('');
	
	const content = `
		<div class="collapsible-section open" id="employeeRegistrySection">
			<div class="collapsible-header">Registro de Empleados (Ranking)</div>
			<div class="collapsible-content">
				<p>Añada empleados para que su nombre aparezca en el Ranking Semanal. Los cambios se guardan con el botón principal de abajo.</p>
				<form id="addEmployeeForm" style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 12px; align-items: end; margin-bottom: 16px;">
					<input type="text" id="newEmpId" placeholder="No. Empleado" required>
					<input type="text" id="newEmpNombre" placeholder="Nombre Completo" required>
					<button type="submit" class="btn" style="padding: 8px 12px; font-size: 1rem;">+</button>
				</form>
				<ul id="employeeList" style="list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;"></ul>
			</div>
		</div>
		<div class="collapsible-section" id="columnMappingSection" style="margin-top: 16px;">
			<div class="collapsible-header">Mapeo de Columnas (Excel)</div>
			<div class="collapsible-content">
				<div class="control-group">
					<label for="prod20StartRow">Fila de inicio de datos</label>
					<input type="number" id="prod20StartRow" value="${configCols.startRow || 15}">
				</div>
				<hr style="border-color: var(--border-color); margin: 16px 0;">
				<p style="text-align:center;">Define el nombre y la letra de la columna en Excel.</p>
				<ul class="param-list" id="prod20ParamList">${columnsHTML}</ul>
				<button id="addProd20ColBtn" class="btn btn-glass" style="width: auto; padding: 8px 16px;">Añadir Columna</button>
			</div>
		</div>
		<button id="saveProd20ConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>
	`;
	showModal('Configurar Reporte Producción 20%', content);

	// --- Listeners para Colapsables ---
	doc('employeeRegistrySection').querySelector('.collapsible-header').addEventListener('click', (e) => e.currentTarget.parentElement.classList.toggle('open'));
	doc('columnMappingSection').querySelector('.collapsible-header').addEventListener('click', (e) => e.currentTarget.parentElement.classList.toggle('open'));

	// --- Listeners para Mapeo de Columnas (sin cambios) ---
	const paramList = doc('prod20ParamList');
	paramList.addEventListener('dragstart', e => { if (e.target.classList.contains('param-item')) e.target.classList.add('dragging'); });
	paramList.addEventListener('dragend', e => { if (e.target.classList.contains('param-item')) e.target.classList.remove('dragging'); });
	paramList.addEventListener('dragover', e => {
		e.preventDefault();
		const draggingItem = paramList.querySelector('.dragging');
		if (!draggingItem) return;
		const afterElement = getDragAfterElement(paramList, e.clientY);
		if (afterElement == null) { paramList.appendChild(draggingItem); }
		else { paramList.insertBefore(draggingItem, afterElement); }
	});
	doc('addProd20ColBtn').addEventListener('click', () => {
		paramList.insertAdjacentHTML('beforeend', createSourceColHTML('', ''));
	});

	// --- Listeners para Registro de Empleados (NUEVO) ---
	doc('addEmployeeForm').addEventListener('submit', (e) => {
		e.preventDefault();
		const idInput = doc('newEmpId');
		const nombreInput = doc('newEmpNombre');
		const newEmp = {
			id: idInput.value.trim().toUpperCase(),
			nombre: nombreInput.value.trim()
		};
		
		if (newEmp.id && newEmp.nombre) {
			const empleados = params.produccion_20_empleados_config.empleados || [];
			// Evitar duplicados por ID
			if (!empleados.some(emp => emp.id === newEmp.id)) {
				empleados.push(newEmp);
				renderEmployeeListInModal(); // Re-render
				idInput.value = '';
				nombreInput.value = '';
				idInput.focus();
			} else {
				alert('Ese número de empleado ya está registrado.');
			}
		}
	});
	
	renderEmployeeListInModal(); // Render inicial de la lista de empleados
	
	// Listener del botón de Guardar (ahora llama a la nueva función unificada)
	doc('saveProd20ConfigBtn').addEventListener('click', saveProd20ConfigAndEmpleados);
}

// --- FUNCIÓN NUEVA: Para renderizar la lista de empleados en el modal ---
function renderEmployeeListInModal() {
	const listEl = doc('employeeList');
	if (!listEl) return;
	
	const empleados = params.produccion_20_empleados_config.empleados || [];
	empleados.sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordenar por nombre

	listEl.innerHTML = empleados.map((p, index) => `
		<li style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 12px; align-items: center; padding: 8px; border-radius: 6px;">
			<span style="font-weight: bold; color: var(--text-primary);">${p.id}</span>
			<span style="color: var(--text-secondary);">${p.nombre}</span>
			<button class="btn-danger" data-index="${index}" style="font-size: 0.8rem; padding: 4px 8px;">X</button>
		</li>
	`).join('');

	// Asignar listeners a los botones de borrar
	listEl.querySelectorAll('.btn-danger').forEach(btn => {
		btn.addEventListener('click', (e) => {
			const index = parseInt(e.target.dataset.index, 10);
			params.produccion_20_empleados_config.empleados.splice(index, 1);
			renderEmployeeListInModal(); // Re-render la lista
		});
	});
}

// --- REEMPLAZO 2: La función de Guardado (ahora unificada) ---
async function saveProd20ConfigAndEmpleados() {
	// 1. Guardar Configuración de Columnas
	const newColumns = Array.from(doc('prod20ParamList').querySelectorAll('.param-item')).map(item => ({
		key: item.querySelector('.param-key').value.trim(),
		excel_col: item.querySelector('.param-excel-col').value.trim().toUpperCase()
	})).filter(p => p.key && p.excel_col);

	const newConfigCols = {
		startRow: parseInt(doc('prod20StartRow').value, 10) || 15,
		columns: newColumns
	};
	
	// 2. Guardar Configuración de Empleados
	// (ya está actualizada en params.produccion_20_empleados_config.empleados por los botones)
	const newConfigEmps = {
		empleados: params.produccion_20_empleados_config.empleados || []
	};

	try {
		// Iniciar ambos guardados en paralelo
		const saveColsPromise = db.collection('report_configs').doc('produccion_20_params').set(newConfigCols);
		const saveEmpsPromise = db.collection('report_configs').doc('produccion_20_empleados_params').set(newConfigEmps);
		
		// Esperar a que ambos terminen
		await Promise.all([saveColsPromise, saveEmpsPromise]);

		// Actualizar params locales
		params.produccion_20_config = newConfigCols;
		params.produccion_20_empleados_config = newConfigEmps;
		
		showModal('Éxito', '<p>Configuración de Columnas y Empleados guardada.</p>');
	} catch (e) {
		console.error("Error al guardar configuración 20%:", e);
		showModal('Error', '<p>No se pudo guardar la configuración.</p>');
	}
}
        
        function showProduccionDailyConfigModal() {
            const config = params.produccion_daily_config;
            const columnsHTML = config.columns.map(p => createSourceColHTML(p.key, p.excel_col)).join('');
            const content = `
                <div class="control-group">
                     <label for="prodDailyStartRow">Fila de inicio de datos</label>
                     <input type="number" id="prodDailyStartRow" value="${config.startRow || 15}">
                </div>
                <hr style="border-color: var(--border-color); margin: 16px 0;">
                <p style="text-align:center;">Arrastra para reordenar. Define el nombre de cada columna y la letra de la columna en Excel.</p>
                <ul class="param-list" id="prodDailyParamList">${columnsHTML}</ul>
                <button id="addProdDailyColBtn" class="btn" style="width: auto; padding: 8px 16px;">Añadir Columna</button>
                <button id="saveProdDailyConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>
            `;
            showModal('Configurar Reporte Producción Daily', content);
            
			// --- AJUSTE CLAVE 3: HABILITAR DRAG & DROP ---
			const paramList = doc('prodDailyParamList');
			paramList.addEventListener('dragstart', e => { if (e.target.classList.contains('param-item')) e.target.classList.add('dragging'); });
			paramList.addEventListener('dragend', e => { if (e.target.classList.contains('param-item')) e.target.classList.remove('dragging'); });
			paramList.addEventListener('dragover', e => {
				e.preventDefault();
				const draggingItem = paramList.querySelector('.dragging');
				if (!draggingItem) return;
				const afterElement = getDragAfterElement(paramList, e.clientY);
				if (afterElement == null) { paramList.appendChild(draggingItem); }
				else { paramList.insertBefore(draggingItem, afterElement); }
			});

            doc('addProdDailyColBtn').addEventListener('click', () => {
                doc('prodDailyParamList').insertAdjacentHTML('beforeend', createSourceColHTML('', ''));
            });
            doc('saveProdDailyConfigBtn').addEventListener('click', saveProduccionDailyConfig);
        }

        async function saveProduccionDailyConfig() {
            const newColumns = Array.from(doc('prodDailyParamList').querySelectorAll('.param-item')).map(item => ({
                key: item.querySelector('.param-key').value.trim(),
                excel_col: item.querySelector('.param-excel-col').value.trim().toUpperCase()
            })).filter(p => p.key && p.excel_col);

            const newConfig = {
                startRow: parseInt(doc('prodDailyStartRow').value, 10) || 15,
                columns: newColumns
            };

            try {
                await db.collection('report_configs').doc('produccion_daily_params').set(newConfig);
                params.produccion_daily_config = newConfig;
                showModal('Éxito', '<p>Configuración del Reporte Producción Daily guardada.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        function createSourceColHTML(key, excel_col) { return `<li class="param-item" draggable="true" style="grid-template-columns: auto 1fr 1fr auto;"><span class="drag-handle" title="Arrastrar para reordenar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle><circle cx="19" cy="5" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="19" cy="19" r="1"></circle></svg></span><input type="text" class="param-key" placeholder="Nombre de Columna" value="${key||''}"><input type="text" class="param-excel-col" placeholder="Letra de Columna (ej. A)" value="${excel_col||''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
        function createAreaItemHTML(code, name) { return `<li class="area-item" style="grid-template-columns: 1fr 2fr auto;"><input type="text" class="area-code" placeholder="Código MRP" value="${code || ''}"><input type="text" class="area-name" placeholder="Nombre de Área" value="${name || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
        function createFinalColHTML(key, type, value) { const options = `<option value="source">Dato Directo</option><option value="formula">Fórmula (Avanzado)</option><option value="fibras_auto">Fibras (Automático)</option><option value="terminaciones_auto">Terminaciones (Automático)</option><option value="familia_auto">Familia (Automático)</option>`; let selectedOptions = options.replace(`value="${type}"`,`value="${type}" selected`); const isFormula = type === 'formula'; const isSource = type === 'source'; const isAuto = !isFormula && !isSource; return `<li class="param-item" draggable="true" style="grid-template-columns:auto 1fr 1.2fr 2fr auto"><span class="drag-handle" title="Arrastrar para reordenar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle><circle cx="19" cy="5" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="19" cy="19" r="1"></circle></svg></span><input type="text" class="param-key" placeholder="Nombre Columna Final" value="${key||''}"><select class="param-type">${selectedOptions}</select><div class="${isAuto ? 'hidden' : ''}"><input type="text" class="param-value-input" placeholder="${isFormula ? 'Escribe fórmula...' : 'Nombre Clave de la fuente'}" value="${value||''}" onfocus="populateFormulaHelpers(this, ${isFormula})"><div class="formula-helpers"></div></div><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.param-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; }
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        window.populateFormulaHelpers = (inputElement, isFormula) => { const container = inputElement.nextElementSibling; container.innerHTML = ''; if (!isFormula) return; const modalBody = inputElement.closest('#modalBody'); if (!modalBody) return; const currentKey = inputElement.closest('.param-item').querySelector('.param-key').value; const zpptwc_cols = Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => el.querySelector('.param-key').value); const coois_cols = Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => el.querySelector('.param-key').value); const final_cols = Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => el.querySelector('.param-key').value); const availableCols = [...zpptwc_cols, ...coois_cols, ...final_cols.filter(k => k !== currentKey), 'Area'].filter(Boolean); const uniqueCols = [...new Set(availableCols)]; uniqueCols.forEach(colName => { const pill = document.createElement('button'); pill.className = 'helper-pill'; pill.textContent = colName; pill.onclick = (e) => { e.preventDefault(); insertAtCursor(inputElement, `{${colName}}`); }; container.appendChild(pill); }); };
        function insertAtCursor(input, text) { const start = input.selectionStart; input.value = input.value.substring(0, start) + text + input.value.substring(input.selectionEnd); input.focus(); input.selectionEnd = start + text.length; }
        doc('modalOverlay').addEventListener('change', (e) => { if (e.target.classList.contains('param-type')) { const item = e.target.closest('.param-item'); const inputDiv = item.querySelector('div:not(.formula-helpers)'); const isAuto = ['fibras_auto', 'terminaciones_auto', 'familia_auto'].includes(e.target.value); if(inputDiv) inputDiv.classList.toggle('hidden', isAuto); } });

        async function saveTerminacionesSettings() {
            try {
                const modalBody = document.getElementById('modalBody');
                if (!modalBody) throw new Error("El cuerpo del modal no fue encontrado.");
                const newConfig = {
                    zpptwc_cols: Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                    coois_cols: Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                    area_config: {
                        source_col: modalBody.querySelector('#area-source-col').value.trim(),
                        mappings: Array.from(modalBody.querySelectorAll('#tab-areas .area-item')).map(el => ({ code: el.querySelector('.area-code').value, name: el.querySelector('.area-name').value }))
                    },
                    final_cols: Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), type: el.querySelector('.param-type').value, value: el.querySelector('.param-value-input').value.trim() })),
                };
                await db.collection('report_configs').doc('terminaciones_params_v2').set(newConfig);
                params.terminaciones_config = newConfig;
                showModal('Éxito', '<p>Configuración de Terminaciones guardada.</p>');
            } catch(e) {
                console.error("Error saving terminaciones settings:", e);
                showModal('Error', '<p>No se pudo guardar la configuración. Detalles: ' + e.message + '</p>');
            }
        }

        // --- INICIO: CARGA DE DATOS (PARAMS Y ARCHIVOS) ---
        async function loadParams(configKey) {
    const docIdMap = {
        '901_config': '901_params',
        'terminaciones_config': 'terminaciones_params_v2',
        'produccion_hora_config': 'produccion_hora_params',
        'produccion_20_config': 'produccion_20_params',
		// --- NUEVA LÍNEA ---
		'produccion_20_empleados_config': 'produccion_20_empleados_params', 
		// --- FIN NUEVA LÍNEA ---
        'produccion_daily_config': 'produccion_daily_params',
        'produccion_calidad_config': 'produccion_calidad_params',
        'terminaciones_areas_config': 'terminaciones_areas_params'
    };
    const docId = docIdMap[configKey];
    if (!docId) return;

    try {
        const docRef = await db.collection('report_configs').doc(docId).get();
        if (docRef.exists) {
            const data = docRef.data();
            // ¡AQUÍ ESTÁ EL AJUSTE!
            if (configKey === 'produccion_20_config' || configKey === 'produccion_daily_config' || configKey === 'produccion_calidad_config' || configKey === 'terminaciones_areas_config') {
                params[configKey] = { ...params[configKey], ...data };
			// --- NUEVO ELSE IF ---
			} else if (configKey === 'produccion_20_empleados_config') {
				params.produccion_20_empleados_config = { empleados: [], ...data };
			// --- FIN NUEVO ELSE IF ---
            } else if (configKey === '901_config') {
                params[configKey] = { columns: data.columns || [], userFilter: data.userFilter || [] };
            } else if (configKey === 'terminaciones_config') {
                params.terminaciones_config = { zpptwc_cols: [], coois_cols: [], final_cols: [], area_config: { source_col: '', mappings: [] }, ...data };
            } else if (configKey === 'produccion_hora_config') {
                params.produccion_hora_config = { packers: [], ...data };
                applyProduccionHoraConfig();
            }
        }
    } catch(e) { console.error(`Error al cargar ${configKey}:`, e); }
}
        function applyProduccionHoraConfig() {
        }

        // --- FUNCIÓN DE REEMPLAZO (JS) ---
        function populatePackerSelects() {
            const turno = doc('prod_turno').value;
            const area = doc('prod_area').value;
            const packers = params.produccion_hora_config.packers || [];
            const container = doc('packerSelectsContainer');
            
            // 1. Encontrar todas las líneas únicas para este turno/área
            const filteredPackers = packers.filter(p => p.turno === turno && (p.area === area || area === 'ALL' || p.area === 'ALL'));
            const lineasUnicas = [...new Set(filteredPackers.map(p => p.linea))].sort((a, b) => a - b);

            // 2. Guardar selecciones actuales antes de limpiar
            const currentSelections = {};
            container.querySelectorAll('select').forEach(select => {
                currentSelections[select.id] = select.value;
            });
            
            // 3. Limpiar y regenerar
            container.innerHTML = '';
            
            lineasUnicas.forEach(linea => {
                const selectId = `prod_linea${linea}_packer`;
                const packersDeLinea = filteredPackers.filter(p => p.linea === linea);
                
                let optionsHtml = '<option value="" disabled selected>Seleccionar...</option>';
                packersDeLinea.sort((a,b) => a.id.localeCompare(b.id)).forEach(p => {
                    optionsHtml += `<option value="${p.id}">${p.id}</option>`;
                });

                const controlGroup = `
                    <div class="control-group" style="display: block;">
                        <label for="${selectId}">Empacador Línea ${linea}</label>
                        <select id="${selectId}">${optionsHtml}</select>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', controlGroup);

                // 4. Restaurar selección si existía
                if (currentSelections[selectId] && packersDeLinea.some(p => p.id === currentSelections[selectId])) {
                    doc(selectId).value = currentSelections[selectId];
                }
            });
        }
        doc('prod_turno').addEventListener('change', populatePackerSelects);
        doc('prod_area').addEventListener('change', populatePackerSelects);


        function setupFileHandler(dropAreaId, inputId, configKey) {
    const dropArea = doc(dropAreaId); 
    const input = doc(inputId);
    if (!dropArea || !input) return;

    const handle = (files) => {
        if (files && files.length) {
            handleFile(files, configKey);
        }
    };

    dropArea.addEventListener('click', () => input.click());
    input.addEventListener('change', (e) => { 
        handle(e.target.files);
        e.target.value = ''; // Limpiamos el input para poder cargar el mismo archivo de nuevo
    });
    dropArea.addEventListener('dragover', (e) => e.preventDefault());
    dropArea.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        handle(e.dataTransfer.files);
    });
}

        setupFileHandler('fileDropArea901', 'fileInput901', '901');
setupFileHandler('fileDropAreaZpptwc', 'fileInputZpptwc', 'zpptwc');
setupFileHandler('fileDropAreaCoois', 'fileInputCoois', 'coois');
setupFileHandler('fileDropAreaProd20', 'fileInputProd20', 'produccion20');
setupFileHandler('fileDropAreaProdDaily', 'fileInputProdDaily', 'produccionDaily');
setupFileHandler('fileDropAreaProdCalidad', 'fileInputProdCalidad', 'produccionCalidad');
setupFileHandler('fileDropAreaBoxID', 'fileInputBoxID', 'boxID'); // <-- ESTA ES LA LÍNEA CRÍTICA
setupFileHandler('fileDropAreaGrUsuarios', 'fileInputGrUsuarios', 'grUsuarios');

        function handleFile(files, configKey) {
    // Lista de funciones que solo pueden procesar un archivo a la vez
    const singleFileFunctions = [
        '901', 
        'produccion20', 
        'produccionDaily', 
        'produccionCalidad', 
        'zpptwc', 
        'coois'
    ];

    if (configKey === 'boxID') {
        // Esta función sí maneja múltiples archivos
        handleBoxIDFile(files);
    } else if (configKey === 'grUsuarios') {
        // Esta nueva función también manejará múltiples archivos
        handleGrUsuariosFile(files);
    } else if (singleFileFunctions.includes(configKey)) {
        // Para todas las demás, solo procesamos el PRIMER archivo de la lista
        const file = files[0];
        if (!file) return; // Si no hay archivo, no hacemos nada

        // Llamamos a la función correcta con UN SOLO archivo
        if (configKey === '901') handle901File(file);
        if (configKey === 'produccion20') handleProduccion20File(file);
        if (configKey === 'produccionDaily') handleProduccionDailyFile(file);
        if (configKey === 'produccionCalidad') handleProduccionCalidadFile(file);
        
        // Esta es la lógica original para los archivos de Terminaciones
        if (configKey === 'zpptwc' || configKey === 'coois') {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const mapping = (configKey === 'zpptwc') ? params.terminaciones_config.zpptwc_cols : params.terminaciones_config.coois_cols;
                    const sheetData = XLSX.utils.sheet_to_json(ws, { header: 'A', defval: null, range: 1 });
                    const data = sheetData.map(row => {
                        let rowData = {};
                        for (const map of mapping) {
                            if(map.excel_col) rowData[map.key] = row[map.excel_col];
                        }
                        return rowData;
                    }).filter(row => row.Orden);
                    reportData[configKey] = data;
                    doc(`fileDropArea${configKey.charAt(0).toUpperCase() + configKey.slice(1)}`).style.borderColor = '#4ade80';

                    if (configKey === 'coois') {
                        const batch = db.batch();
                        data.forEach(row => {
                            const orderId = String(row.Orden || '').replace(/^0+/, '');
                            if(orderId) {
                                const docRef = db.collection('coois_historico').doc(orderId);
                                batch.set(docRef, row, { merge: true });
                            }
                        });
                        await batch.commit();
                    }
                    processTerminacionesReport();
                } catch (err) {
                    console.error("Error al procesar archivo:", err);
                    showModal('Error de Archivo', '<p>No se pudo procesar el archivo Excel. Verifique el mapeo de letras de columna y la conexión a la base de datos.</p>');
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }
}


        const formulaHelpers = {
            EXTRAER: (text, start, length) => (typeof text !== 'string' || text === null) ? '' : String(text).substring(start - 1, start - 1 + length),
            EXTRAER_FIBRAS: (text, start, length) => {
                if (typeof text !== 'string' || text === null) return 0;
                const code = String(text).substring(start - 1, start - 1 + length).toUpperCase();
                if (!code) return 0;
                switch (code) {
                    case '1': return 1; case '2': return 2; case '3': return 3; case '4': return 4;
                    case '5': return 5; case '6': return 6; case '7': return 7; case '8': return 8;
                    case '9': return 9; case 'A': return 1; case 'B': return 2; case 'C': return 4;
                    case 'D': return 6; case 'E': return 8; case 'F': return 12; case 'G': return 24;
                    case 'T': return 12; default: const num = parseFloat(code); return isNaN(num) ? 0 : num;
                }
            },
            IF: (condition, valueIfTrue, valueIfFalse) => condition ? valueIfTrue : valueIfFalse,
        };

        function excelSerialToDateObject(serial) {
            if (serial instanceof Date) return serial;
            if (typeof serial !== 'number' || isNaN(serial)) return null;
            const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
            return new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
        }

        function formatShortDateTime(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const year = date.getFullYear().toString().slice(-2); // Saca los últimos 2 dígitos del año
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hour}:${minute}`; // Formato: 14/10/25 08:00
        }

async function loadAreasForTarimasReport() {
    try {
        const areasSnapshot = await db.collection('areas').get();
        const areaSelect = doc('prodTarimas_area');
        // Guardar selección actual si existe, si no, seleccionar vacío
        const currentVal = areaSelect.value || "";
        // Limpiar opciones excepto la de "Cargando..." y "Todas"
        areaSelect.innerHTML = '<option value="" disabled>Seleccione área...</option><option value="ALL">Todas las Áreas</option>';

        let areas = [];
        areasSnapshot.forEach(doc => {
            if (doc.id !== 'CONFIG') { // Excluir documentos de configuración si los tienes
                areas.push(doc.id);
            }
        });
        areas.sort(); // Ordenar alfabéticamente

        areas.forEach(areaId => {
            const option = document.createElement('option');
            option.value = areaId;
            option.textContent = areaId;
            areaSelect.appendChild(option);
        });

        // Restaurar selección anterior o dejar "Seleccione área..."
        if (areaSelect.querySelector(`option[value="${currentVal}"]`)) {
             areaSelect.value = currentVal;
        } else {
             areaSelect.value = ""; // Forzar el placeholder si la opción ya no existe o era inválida
        }

    } catch (e) {
        console.error("[Áreas Tarimas] Error cargando áreas:", e);
        // Poner mensaje de error en el select
        const areaSelect = doc('prodTarimas_area');
        areaSelect.innerHTML = '<option value="" disabled selected>Error al cargar</option>';
    }
}       

// =======================================================================================
// --- INICIO: LÓGICA DEL DASHBOARD EN VIVO ---
// =======================================================================================

// --- FUNCIÓN DE REEMPLAZO (showLiveDashboard) ---
function showLiveDashboard() {
    // --- INICIO DE LA CORRECCIÓN DE TURNO ---
    // 1. Obtener la fecha y turno de TRABAJO actual, no de calendario.
    const now = new Date();
    const { shift: turnoActual, dateKey: fechaDeTrabajoActual } = getWorkShiftAndDate(now);
    
    // 2. Calcular el rango de horas para ESE turno de trabajo.
    const { startTime } = getShiftDateRange(fechaDeTrabajoActual, turnoActual); 
    // --- FIN DE LA CORRECCIÓN DE TURNO ---
    
    const areaALeer = "MULTIPORT"; // Asumimos esta área
    doc('liveTurnoTitle').textContent = `Turno: ${turnoActual} (${areaALeer})`;

    renderLiveChart({}, [], startTime); // Llama a la gráfica vacía con el startTime correcto
    switchView('liveDashboard'); 

    if (liveListener) {
        console.log("Deteniendo listener anterior...");
        liveListener();
        liveListener = null;
    }

    // Pre-calcular los empacadores para este turno
    const allPackers = params.produccion_hora_config.packers || [];
    const empacadoresFiltrados = allPackers.filter(p => p.turno === turnoActual && (p.area === areaALeer || p.area === 'ALL'));
    const empacadoresPorLinea = new Map(); 
    empacadoresFiltrados.forEach(p => {
        const lineaNum = String(p.linea);
        if (!empacadoresPorLinea.has(lineaNum)) {
            empacadoresPorLinea.set(lineaNum, new Set());
        }
        empacadoresPorLinea.get(lineaNum).add(p.id);
    });
    
    console.log(`Iniciando listener en vivo para: areas/${areaALeer}/orders`);
    
    liveListener = db.collection("areas").doc(areaALeer).collection("orders")
        .onSnapshot(querySnapshot => {
            
            console.log("¡Datos en vivo recibidos!", querySnapshot.size, "órdenes analizadas.");
            let allOrders = [];
            querySnapshot.forEach(doc => {
                allOrders.push(doc.data());
            });
            
            // --- INICIO DE LA CORRECCIÓN DE TURNO (PASO 3) ---
            // Pasamos la fechaDeTrabajoActual (ej: '2025-11-13') en lugar de la fecha de calendario ('hoyStr')
            updateLiveDashboard(allOrders, turnoActual, fechaDeTrabajoActual, startTime, empacadoresPorLinea);
            // --- FIN DE LA CORRECCIÓN DE TURNO ---

        }, error => {
            console.error("¡Error en el listener en vivo!:", error);
            doc('liveFeedContent').innerHTML = `<p style="color:var(--danger-color);">Error de conexión con Firebase. Revise permisos.</p>`;
        });
}

function stopLiveDashboard() {
    if (liveListener) {
        console.log("Deteniendo listener en vivo...");
        liveListener(); // Esta función "apaga" el onSnapshot
        liveListener = null;
    }
    if (liveProductionChart) {
        liveProductionChart.destroy();
        liveProductionChart = null;
    }
}

// --- FUNCIÓN DE REEMPLAZO (updateLiveDashboard) ---
// --- FUNCIÓN DE REEMPLAZO (updateLiveDashboard) ---
function updateLiveDashboard(allOrders, turnoActual, fechaDeTrabajoActual, shiftStartTime, empacadoresPorLinea) {
    let allPackedItems = [];
    let lastScan = { timestamp: new Date(0), empacador: 'N/A', linea: 'N/A' };
    const totalsByLine = {};
    const hourlyBins = Array(12).fill(0).map(() => ({}));
    const lineasEncontradas = new Set();

    // 1. PROCESAR TODOS LOS DATOS (Sin cambios)
    allOrders.forEach(order => {
        const empaqueArray = order.empaqueData || []; 
        if (!Array.isArray(empaqueArray)) {
            if (typeof order.empaqueData.forEach === 'function') {
                order.empaqueData.forEach(serialsInBox => empaqueArray.push({ serials: serialsInBox }));
            } else {
                console.warn(`empaqueData de orden ${order.orderNumber} no es un array, saltando.`);
                return;
            }
        }
        
        empaqueArray.forEach(box => {
            const serialsInBox = box.serials;
            if (Array.isArray(serialsInBox)) {
                serialsInBox.forEach(item => {
                    const packedDate = excelSerialToDateObject(item['Finish Packed Date']);
                    if (!packedDate) return;

                    const { shift, dateKey } = getWorkShiftAndDate(packedDate);

                    if (shift === turnoActual && dateKey === fechaDeTrabajoActual) {
                        const empacador = (item['Employee ID'] || '').toString().toUpperCase();
                        let lineaAsignada = null;

                        for (const [lineaNum, setDeEmpacadores] of empacadoresPorLinea.entries()) {
                            if (setDeEmpacadores.has(empacador)) {
                                lineaAsignada = `Línea ${lineaNum}`;
                                break;
                            }
                        }

                        if (lineaAsignada) {
                            lineasEncontradas.add(lineaAsignada);
                            const char = (order.catalogNumber || '').substring(3, 4).toUpperCase();
                            const terminaciones = (char === 'T') ? 12 : (parseInt(char, 10) || 0);

                            if (!totalsByLine[lineaAsignada]) totalsByLine[lineaAsignada] = { term: 0, pzas: 0 };
                            totalsByLine[lineaAsignada].term += terminaciones;
                            totalsByLine[lineaAsignada].pzas++; // <-- ¡Aquí se cuentan las piezas!

                            const diffMillis = packedDate - shiftStartTime;
                            const hourIndex = Math.floor(diffMillis / (1000 * 60 * 60));
                            if (hourIndex >= 0 && hourIndex < 12) {
                                if (!hourlyBins[hourIndex][lineaAsignada]) hourlyBins[hourIndex][lineaAsignada] = 0;
                                hourlyBins[hourIndex][lineaAsignada] += terminaciones;
                            }

                            if (packedDate > lastScan.timestamp) {
                                lastScan = { timestamp: packedDate, empacador, linea: lineaAsignada };
                            }
                        }
                    }
                });
            }
        });
    });

    const lineasOrdenadas = [...lineasEncontradas].sort();

    // --- 2. ACTUALIZAR FEED DE ACTIVIDAD (AHORA DISCRETO) ---
    const lastScanEl = doc('liveChartLastScan'); // <-- ¡NUEVO! Apunta al span en la gráfica
    if (lastScan.timestamp > 0) {
        lastScanEl.innerHTML = `Último escaneo: ${lastScan.timestamp.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })} (${lastScan.linea})`;
    } else {
        lastScanEl.innerHTML = `Esperando escaneo...`;
    }

    // --- 3. ACTUALIZAR TARJETAS (KPIs) ---
    const metaTurno = 5280; 
    const kpiContainer = doc('kpiCardContainer');
    let kpiHtml = ''; 

    lineasOrdenadas.forEach(lineaNombre => {
        const lineaNumero = lineaNombre.split(' ')[1];
        
        // --- ¡NUEVO! Obtenemos el total de piezas y terminaciones ---
        const totalTerm = (totalsByLine[lineaNombre] && totalsByLine[lineaNombre].term) ? totalsByLine[lineaNombre].term : 0;
        const totalPzas = (totalsByLine[lineaNombre] && totalsByLine[lineaNombre].pzas) ? totalsByLine[lineaNombre].pzas : 0;
        
        const percent = (totalTerm / metaTurno) * 100;
        let progressClass = 'progress-bar-red';
        if (percent >= 80) progressClass = 'progress-bar-green';
        else if (percent >= 40) progressClass = 'progress-bar-yellow';

        kpiHtml += `
            <div class="kpi-card" id="kpi-linea-${lineaNumero}">
                <div class="kpi-header">
                    <h4>${lineaNombre}</h4>
                    <span id="kpi-linea-${lineaNumero}-meta" class="kpi-meta">Meta: ${metaTurno.toLocaleString()}</span>
                </div>
                <h1 id="kpi-linea-${lineaNumero}-total">${totalTerm.toLocaleString()}</h1>
                <h4 id="kpi-linea-${lineaNumero}-piezas" class="kpi-piezas">${totalPzas.toLocaleString()} Piezas</h4>
                
                <div class="kpi-progress-bar-container">
                    <div id="kpi-linea-${lineaNumero}-progress" class="kpi-progress-bar ${progressClass}" style="width: ${Math.min(percent, 100)}%;"></div>
                </div>
                <span id="kpi-linea-${lineaNumero}-percent" class="kpi-percent">${percent.toFixed(1)}%</span>
            </div>
        `;
    });

    if (lineasOrdenadas.length === 0) {
        kpiContainer.innerHTML = `<p style="color: var(--text-secondary); text-align: center; width: 100%; grid-column: 1 / -1;">Esperando datos de producción para las líneas...</p>`;
    } else {
        kpiContainer.innerHTML = kpiHtml;
    }

    // --- 4. ACTUALIZAR GRÁFICA DE BARRAS (Sin cambios) ---
    renderLiveChart(hourlyBins, lineasOrdenadas, shiftStartTime);
}

// --- FUNCIÓN DE REEMPLAZO (renderLiveChart) ---
function renderLiveChart(hourlyData, lineasOrdenadas, shiftStartTime) {
    const canvas = doc('liveProduccionChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Lógica de Metas (Sin cambios)
    const goals = Array(12).fill(480);
    goals[1] = 360; goals[5] = 280; goals[8] = 360; 
    const visualGoalLine = Array(12).fill(480);

    // Destruir chart viejo (Sin cambios)
    if (liveProductionChart) {
        liveProductionChart.destroy();
        liveProductionChart = null;
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height); 

    // 1. Crear Etiquetas (Sin cambios)
    const labels = [];
    const startTime = (shiftStartTime instanceof Date) ? shiftStartTime : new Date(shiftStartTime);
    
    if (isNaN(startTime.getTime())) {
        console.error("Error Crítico: La fecha de inicio (startTime) es inválida.", shiftStartTime);
        for (let i = 0; i < 12; i++) labels.push('Error Fecha');
    } else {
        for (let i = 0; i < 12; i++) {
            const start = new Date(startTime.getTime());
            start.setHours(start.getHours() + i);
            const end = new Date(start.getTime());
            end.setHours(end.getHours() + 1);
            const format = { hour: '2-digit', minute: '2-digit', hour12: false };
            labels.push(`${start.toLocaleTimeString([], format)} - ${end.toLocaleTimeString([], format)}`);
        }
    }

    // 2. Crear Datasets (Sin cambios)
    const colors = ['rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)'];
    const borderColors = ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)'];
    
    const dynamicDatasets = lineasOrdenadas.map((linea, index) => {
        return {
            label: linea,
            data: labels.map((_, i) => (hourlyData[i] && hourlyData[i][linea]) ? hourlyData[i][linea] : 0),
            backgroundColor: colors[index % colors.length],
            borderColor: borderColors[index % borderColors.length],
            borderWidth: 1,
            order: 1
        };
    });
    
    dynamicDatasets.unshift({ 
        type: 'line', 
        label: 'Meta', 
        data: visualGoalLine,
        borderColor: getComputedStyle(document.body).getPropertyValue('--success-color'), 
        borderWidth: 2, 
        borderDash: [5, 5], 
        pointRadius: 0, 
        fill: false, 
        order: 0
    });
    
    // 3. Crear Gráfica
    liveProductionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: dynamicDatasets
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { color: 'var(--text-primary)', filter: item => item.datasetIndex > 0 } }, 
                title: { 
                    display: true, 
                    text: 'Producción por Hora (En Vivo)',
                    color: 'var(--text-primary)', 
                    font: { size: 16 } 
                },
                datalabels: {
                    display: context => context.dataset.type !== 'line',
                    labels: {
                        value: {
                            anchor: 'end', 
                            align: 'top',
                            offset: 5,
                            backgroundColor: (ctx) => {
                                const isSuccess = ctx.dataset.data[ctx.dataIndex] >= goals[ctx.dataIndex]; 
                                const colorVar = isSuccess ? '--glow-green' : '--glow-red';
                                const rawColor = getComputedStyle(document.body).getPropertyValue(colorVar).trim();
                                return rawColor.replace(/0.9\)$/, '0.4)');
                            },
                            borderColor: (ctx) => {
                                return ctx.dataset.data[ctx.dataIndex] >= goals[ctx.dataIndex] ? getComputedStyle(document.body).getPropertyValue('--success-color') : getComputedStyle(document.body).getPropertyValue('--danger-color');
                            },
                            borderWidth: 1,
                            borderRadius: 4,
                            color: 'white',
                            font: { weight: 'bold' },
                            padding: { top: 2, bottom: 2, left: 5, right: 5 },
                            formatter: (value) => value > 0 ? value.toLocaleString() : '',
                        },
                        percentage: { 
                            align: 'center', anchor: 'center',
                            color: (ctx) => {
                                const barHeight = ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.dataIndex].height;
                                return barHeight > 18 ? 'rgba(255, 255, 255, 0.9)' : 'transparent';
                            },
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, ctx) => {
                                const goalForHour = goals[ctx.dataIndex];
                                if (value <= 0 || goalForHour === 0) return '';
                                const percentage = (value / goalForHour) * 100;
                                return percentage.toFixed(0) + '%';
                            },
                            textStrokeColor: 'rgba(0,0,0,0.6)',
                            textStrokeWidth: 2
                        }
                    }
                }
            },
            scales: {
                x: { 
                    grid: { color: 'var(--chart-grid-color)' }, 
                    ticks: { color: 'var(--chart-tick-color)', maxRotation: 0, minRotation: 0, autoSkip: true, font: { size: 10 } },
                    categoryPercentage: 0.7,
                    barPercentage: 0.9
                },
                y: { 
                    beginAtZero: true, 
                    grid: { 
                        color: 'var(--chart-grid-color)',
                        // --- ¡AQUÍ ESTÁ EL ARREGLO DE LA CUADRÍCULA! ---
                        drawOnChartArea: false 
                    }, 
                    ticks: { color: 'var(--chart-tick-color)' }, 
                    title: { display: true, text: 'Total de Terminaciones', color: 'var(--chart-tick-color)' },
                    afterDataLimits: (scale) => {
                        scale.max = scale.max * 1.2;
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    updateChartTheme();
}

// =======================================================================================
// --- FIN: LÓGICA DEL DASHBOARD EN VIVO ---
// =======================================================================================



        // =======================================================================================
        // --- INICIO: LÓGICA REPORTE PRODUCCIÓN POR SEMANA DAILY ---
        // =======================================================================================

        doc('consultarProduccionDailyBtn').addEventListener('click', consultarReporteProduccionDaily);
        doc('abrirModalSemanalDailyBtn').addEventListener('click', abrirModalReporteSemanalDaily);

        async function handleProduccionDailyFile(file) {
    const config = params.produccion_daily_config;
    console.log('CONFIGURACIÓN USADA PARA DAILY:', JSON.stringify(config, null, 2));

    if (!config || !config.columns || !config.columns.length === 0) {
        showModal('Configuración Requerida', '<p>Por favor, configure el mapeo de columnas...</p>');
        return;
    }
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: config.startRow - 1, blankrows: false });

            const colMap = {};
            config.columns.forEach(col => {
               colMap[col.key] = XLSX.utils.decode_col(col.excel_col);
            });

            const data = jsonData.map(row => {
                const rowData = {};
                
                // --- INICIO DE LA NUEVA DEPURACIÓN DETALLADA ---
                console.log('--- Procesando nueva fila del Excel ---');
                config.columns.forEach(col => {
                    // Imprimimos la clave con delimitadores para ver espacios
                    console.log(`Mapeando clave: '[${col.key}]' con valor de la celda:`, row[colMap[col.key]]);
                    rowData[col.key] = row[colMap[col.key]];
                });
                console.log('Objeto final creado:', rowData);
                // --- FIN DE LA NUEVA DEPURACIÓN ---

                return rowData;
            }).filter(row => row['Serial Number'] !== undefined && String(row['Serial Number']).trim() !== '');

            if (data.length === 0) { /* ...código sin cambios... */ return; }

            const batch = db.batch();
            let processedCount = 0;
            data.forEach(row => {
                const serial = String(row['Serial Number']).trim();
                let fechaHora = null;
                if(serial){
                    const docRef = db.collection('produccion_daily_historico').doc(serial);
                    // Aquí es donde falla, al intentar leer la propiedad con la clave incorrecta
                    if (row['Fecha y hora'] instanceof Date) {
                        fechaHora = row['Fecha y hora'];
                    } else if (typeof row['Fecha y hora'] === 'number') {
                        fechaHora = excelSerialToDateObject(row['Fecha y hora']);
                    }

                    if (fechaHora) {
                        batch.set(docRef, { ...row, 'Fecha y hora': firebase.firestore.Timestamp.fromDate(fechaHora) });
                        processedCount++;
                    }
                }
            });
            
            await batch.commit();

            doc('fileDropAreaProdDaily').style.borderColor = 'var(--success-color)';
            showModal('Éxito', `<p>${processedCount} registros han sido guardados...</p>`);
            consultarReporteProduccionDaily();

        } catch (err) { /* ...código de error sin cambios... */ }
    };
    reader.readAsArrayBuffer(file);
}

        async function consultarReporteProduccionDaily() {
            const fechaInput = doc('prodDaily_fecha').value;
            const turnoInput = doc('prodDaily_turno').value;

            if (!fechaInput) {
                showModal('Fecha Requerida', '<p>Por favor, seleccione una fecha.</p>');
                return;
            }
            const btn = doc('consultarProduccionDailyBtn');
            btn.disabled = true;
            btn.textContent = 'Consultando...';

            const { startTime, endTime } = getShiftDateRange(fechaInput, turnoInput);

            try {
                const snapshot = await db.collection('produccion_daily_historico')
                    .where('Fecha y hora', '>=', startTime)
                    .where('Fecha y hora', '<=', endTime)
                    .get();

                const data = [];
                // --- INICIO DEL CAMBIO ---
                // Eliminamos la lógica compleja de getWorkShiftAndDate y el doble filtro.
                // Ahora, simplemente tomamos TODOS los resultados que nos da la base de datos,
                // que ya vienen filtrados por el rango de horas correcto.
                snapshot.forEach(docSnap => {
                    const docData = docSnap.data();
                    const fechaHora = docData['Fecha y hora'] ? docData['Fecha y hora'].toDate() : null;
                    if (fechaHora) {
                        // Ya no hay un "if (shift === turnoInput)" aquí.
                        data.push({ ...docData, 'Fecha y hora': fechaHora });
                    }
                });
                // --- FIN DEL CAMBIO ---

                if (data.length === 0) {
                    showModal('Sin Datos', `<p>No se encontraron registros para la fecha y turno seleccionados.</p>`);
                    renderProduccionDailyTable([]);
                    renderProduccionDailyChart([], startTime);
                    return;
                }

                const processedData = data.map(row => {
                    const catalogo = row['Catalogo'] || '';
                    const cuartoDigito = catalogo.substring(3, 4).toUpperCase();
                    const fibras = cuartoDigito === 'T' ? 12 : parseInt(cuartoDigito, 10) || 0;
                    const terminaciones = fibras * (Number(row['Cantidad']) || 0);
                    
                    return { 
                        ...row, 
                        'Finish date': row['Fecha y hora'], 
                        Linea: row['Estación'], 
                        'Catálogo': row['Catalogo'],
                        Fibras: fibras, 
                        Terminaciones: terminaciones 
                    };
                });
				
                renderProduccionDailyTable(processedData);
                renderProduccionDailyChart(processedData, startTime);

            } catch (e) {
                console.error("Error consultando reporte Daily:", e);
                showModal('Error de Consulta', `<p>No se pudo obtener el reporte de la base de datos.</p>`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Consultar Reporte';
            }
        }

        function renderProduccionDailyTable(data) {
            const table = doc('dataTableProduccionDaily');
            if (!data || data.length === 0) {
                table.innerHTML = `<thead><tr><th>Sin datos para mostrar.</th></tr></thead><tbody></tbody>`;
                return;
            }

            const headers = [...params.produccion_daily_config.columns.map(c => c.key), 'Fibras', 'Terminaciones'];
            
            let headerHtml = '<thead><tr>';
            headers.forEach(h => headerHtml += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
            headerHtml += '</tr></thead>';

            let bodyHtml = '<tbody>';
            data.sort((a, b) => (b['Fecha y hora'] || 0) - (a['Fecha y hora'] || 0));

            data.forEach(row => {
                bodyHtml += `<tr>`;
                headers.forEach(header => {
                    let value = row[header];
                    // --- CORRECCIÓN DE FORMATO DE FECHA ---
                    if (header === 'Fecha y hora' && value instanceof Date) {
                        value = formatShortDateTime(value);
                    }
                    bodyHtml += `<td>${value ?? ''}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            bodyHtml += '</tbody>';
            table.innerHTML = headerHtml + bodyHtml;
            
            table.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keyup', () => {
                    const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({
                        columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')),
                        value: i.value.toLowerCase()
                    }));
                    table.querySelectorAll('tbody tr').forEach(row => {
                        let shouldShow = true;
                        filters.forEach(filter => {
                            if (filter.value) {
                                const cell = row.children[filter.columnIndex];
                                if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) {
                                    shouldShow = false;
                                }
                            }
                        });
                        row.style.display = shouldShow ? '' : 'none';
                    });
                });
            });
        }

        function renderProduccionDailyChart(data, shiftStartTime) {
            const ctx = doc('produccionDailyChart').getContext('2d');
            if (productionDailyChart) {
                productionDailyChart.destroy();
            }
            if (!data || data.length === 0 || !shiftStartTime) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                doc('chartSummaryDaily').innerHTML = '';
                return;
            }

            const hourlyBins = Array.from({ length: 12 }, () => ({}));
            // --- INICIO DEL CAMBIO ---
            const totalesPorLinea = {}; // Este objeto ahora guardará piezas Y terminaciones
            
            data.forEach(item => {
                let linea = 'N/A';
                const lineValue = String(item['Line'] || '').toUpperCase();
                if (lineValue.includes('LINEA 1')) {
                    linea = 'Linea 1';
                } else if (lineValue.includes('LINEA 2')) {
                    linea = 'Linea 2';
                }

                const terminaciones = Number(item['Terminaciones']) || 0;
                const piezas = Number(item['Cantidad']) || 0;

                // Si es la primera vez que vemos esta línea, la inicializamos como un objeto
                if (!totalesPorLinea[linea]) {
                    totalesPorLinea[linea] = { pzas: 0, term: 0 };
                }
                // Sumamos tanto piezas como terminaciones a su línea correspondiente
                totalesPorLinea[linea].pzas += piezas;
                totalesPorLinea[linea].term += terminaciones;
                
                if (item['Fecha y hora'] instanceof Date) {
                    const diffMillis = item['Fecha y hora'] - shiftStartTime;
                    if (diffMillis >= 0) {
                        const hourIndex = Math.floor(diffMillis / (1000 * 60 * 60));
                        if (hourIndex >= 0 && hourIndex < 12) {
                            hourlyBins[hourIndex][linea] = (hourlyBins[hourIndex][linea] || 0) + terminaciones;
                        }
                    }
                }
            });

            // Generamos el nuevo HTML para el resumen, desglosado por línea
            const lineasOrdenadas = Object.keys(totalesPorLinea).sort();
            const summaryHtml = lineasOrdenadas.map(linea =>
                `${linea}: <strong>${totalesPorLinea[linea].pzas.toLocaleString()} pzas</strong> / <strong>${totalesPorLinea[linea].term.toLocaleString()} term.</strong>`
            ).join(' | ');

            doc('chartSummaryDaily').innerHTML = summaryHtml;
            // --- FIN DEL CAMBIO ---

            const allLineas = Object.keys(totalesPorLinea).sort();
            const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)'];
            const datasets = allLineas.map((linea, index) => ({
                label: `Terminaciones ${linea}`,
                data: hourlyBins.map(hourData => hourData[linea] || 0),
                backgroundColor: colors[index % colors.length],
            }));

            const labels = [];
            for (let i = 0; i < 12; i++) {
                const start = new Date(shiftStartTime);
                start.setHours(start.getHours() + i);
                const end = new Date(start);
                end.setHours(end.getHours() + 1);
                const format = { hour: '2-digit', minute: '2-digit', hour12: false };
                labels.push(`${start.toLocaleTimeString([], format)} - ${end.toLocaleTimeString([], format)}`);
            }

            productionDailyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)'}},
                        title: { display: true, text: 'Producción de Terminaciones por Hora', color: 'var(--text-primary)', font: { size: 14 }},
                        datalabels: {
                            display: true, anchor: 'end', align: 'top',
                            color: 'var(--text-primary)',
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => value > 0 ? value.toLocaleString() : ''
                        }
                    },
                    scales: {
                        x: { grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' } },
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'var(--chart-grid-color)' }, 
                            ticks: { color: 'var(--chart-tick-color)' },
                            title: { display: true, text: 'Total de Terminaciones', color: 'var(--chart-tick-color)' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            updateChartTheme();
        }

        // --- Lógica para el Reporte Semanal del Reporte Daily ---
        // --- Lógica para el Reporte Semanal del Reporte Daily ---
        function abrirModalReporteSemanalDaily() {
            const modalHTML = `
            	<div class="controles-semanales" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px; align-items: end;">
            		<div>
            			<label for="semanalDaily_fecha_inicio">Fecha de Inicio</label>
            			<input type="date" id="semanalDaily_fecha_inicio">
            		</div>
            		<div>
            			<label for="semanalDaily_fecha_fin">Fecha de Fin</label>
            			<input type="date" id="semanalDaily_fecha_fin">
            		</div>
            		<div>
            			<label for="semanalDaily_turno">Turno</label>
            			<select id="semanalDaily_turno">
            				<option value="T45">T45 (L-M, Día)</option>
            				<option value="T46">T46 (L-M, Noche)</option>
            				<option value="T47">T47 (J-D, Día)</option>
            				<option value="T48">T48 (J-D, Noche)</option>
            			</select>
            		</div>
            	</div>
            	<button id="generarReporteSemanalDailyBtn" class="btn" style="width: 100%;">Generar Gráfica Comparativa</button>
            	<div id="chartContainerSemanalDaily" style="margin-top: 20px; height: 45vh; position: relative;">
            		<canvas id="graficaSemanalDaily"></canvas>
            	</div>
            `;
            showModal('Reporte Semanal de Terminaciones (Daily)', modalHTML);

            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 6);
            doc('semanalDaily_fecha_fin').value = hoy.toISOString().split('T')[0];
            doc('semanalDaily_fecha_inicio').value = haceUnaSemana.toISOString().split('T')[0];
            doc('semanalDaily_turno').value = getAutoCurrentShift();

            doc('generarReporteSemanalDailyBtn').addEventListener('click', consultarReporteSemanalDaily);
        }

        async function consultarReporteSemanalDaily() {
            const btn = doc('generarReporteSemanalDailyBtn');
            btn.disabled = true;
            btn.textContent = 'Generando...';

            const fechaInicio = doc('semanalDaily_fecha_inicio').value;
            const fechaFin = doc('semanalDaily_fecha_fin').value;
            const turnoSeleccionado = doc('semanalDaily_turno').value;

            if (!fechaInicio || !fechaFin || !turnoSeleccionado) {
                alert('Por favor, selecciona un rango de fechas y un turno.');
                btn.disabled = false;
                btn.textContent = 'Generar Gráfica Comparativa';
                return;
            }

            const fechaInicioDate = new Date(`${fechaInicio}T00:00:00`);
			const fechaFinDate = new Date(`${fechaFin}T00:00:00`);
			fechaFinDate.setDate(fechaFinDate.getDate() + 1);
			fechaFinDate.setHours(6, 29, 59, 999);


            try {
                // --- INICIO DE LA CORRECCIÓN ---
                const snapshot = await db.collection('produccion_daily_historico')
                    // CAMBIO 1: Se busca por el campo de fecha correcto 'Fecha y hora'
                    .where('Fecha y hora', '>=', fechaInicioDate)
                    .where('Fecha y hora', '<=', fechaFinDate)
                    .get();

                const datosAgrupados = {};
                const labelsFechas = new Set();
                const allLineas = new Set();

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    // CAMBIO 2: Se lee la fecha del campo correcto
                    const fechaHora = data['Fecha y hora'].toDate();
					
                    const { shift, dateKey } = getWorkShiftAndDate(fechaHora);

					if (shift === turnoSeleccionado && dateKey >= fechaInicio && dateKey <= fechaFin) {
                    	labelsFechas.add(dateKey);
                    	
                        // CAMBIO 3: Se lee y procesa la línea desde el campo 'Line'
                        let linea = 'N/A';
                        const lineValue = String(data['Line'] || '').toUpperCase();
                        if (lineValue.includes('LINEA 1')) {
                            linea = 'Linea 1';
                        } else if (lineValue.includes('LINEA 2')) {
                            linea = 'Linea 2';
                        }
                    	allLineas.add(linea);

                    	if (!datosAgrupados[dateKey]) datosAgrupados[dateKey] = {};
                    	if (!datosAgrupados[dateKey][linea]) datosAgrupados[dateKey][linea] = 0;
                    	
                        // CAMBIO 4: Se lee el catálogo desde el campo correcto 'Catalogo' (sin tilde)
                    	const catalogo = data['Catalogo'] || '';
                    	const cuartoDigito = catalogo.substring(3, 4).toUpperCase();
                    	const fibras = cuartoDigito === 'T' ? 12 : parseInt(cuartoDigito, 10) || 0;
                    	const terminaciones = fibras * (Number(data['Cantidad']) || 0);

                    	datosAgrupados[dateKey][linea] += terminaciones;
					}
                });
                // --- FIN DE LA CORRECCIÓN ---

                const fechasOrdenadas = Array.from(labelsFechas).sort();
                renderGraficaSemanalDaily(datosAgrupados, fechasOrdenadas, Array.from(allLineas).sort());

            } catch (e) {
                console.error("Error consultando reporte semanal daily:", e);
                alert("No se pudo generar el reporte semanal. Revisa la consola.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generar Gráfica Comparativa';
            }
        }

        function renderGraficaSemanalDaily(datos, labels, lineas) {
            const ctx = doc('graficaSemanalDaily').getContext('2d');
            if (graficaSemanalDailyInstance) {
                graficaSemanalDailyInstance.destroy();
            }

            const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)'];
            const datasets = lineas.map((linea, index) => ({
                label: `Terminaciones Línea ${linea}`,
                data: labels.map(fecha => (datos[fecha] && datos[fecha][linea]) ? datos[fecha][linea] : 0),
                backgroundColor: colors[index % colors.length]
            }));

            graficaSemanalDailyInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(f => new Date(f + 'T12:00:00').toLocaleDateString('es-MX', { weekday: 'short', month: 'short', day: 'numeric' })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: 'var(--chart-tick-color)' }, 
                            grid: { color: 'var(--chart-grid-color)' }, 
                            title: { display: true, text: 'Total Terminaciones', color: 'var(--chart-tick-color)' } 
                        },
                        x: { 
                            ticks: { color: 'var(--chart-tick-color)' }, 
                            grid: { color: 'var(--chart-grid-color)' } 
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)' } },
                        datalabels: {
                            color: 'white',
                            font: { weight: 'bold' },
                            formatter: (value) => value > 0 ? value.toLocaleString() : ''
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            updateChartTheme();
        }

        // =======================================================================================
        // --- FIN: LÓGICA REPORTE PRODUCCIÓN POR SEMANA DAILY ---
        // =======================================================================================
        
        async function handleBoxIDFile(files) {
    if (!files || files.length === 0) return;
    
    showModal('Procesando...', `<p>Cargando ${files.length} archivo(s). Por favor, espere...</p>`);

    const processSingleFile = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    
                    // --- ¡AQUÍ ESTÁ EL AJUSTE CLAVE! ---
                    // Cambia este número. Si tus datos (no el encabezado) empiezan en la fila 2 de Excel, pones 1.
                    // Si empiezan en la fila 3, pones 2, y así.
                    const filaDeInicio = 1; // <--- ¡¡¡CAMBIA ESTE NÚMERO!!!

                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: filaDeInicio });
                    
                    const dataInFile = jsonData
                        .map(row => ({
                            boxId: row[9],  // Columna J
                            gr: row[0],       // Columna A
                            receivedDate: row[6] // Columna G
                        }))
                        .filter(item => item.boxId !== undefined && item.boxId !== null && String(item.boxId).trim() !== '');
                    
                    resolve(dataInFile);
                } catch (err) {
                    console.error(`Error procesando el archivo ${file.name}:`, err);
                    reject(`No se pudo leer el archivo ${file.name}.`);
                }
            };
            reader.onerror = () => reject(`Error al leer el archivo ${file.name}.`);
            reader.readAsArrayBuffer(file);
        });
    };

    try {
        const results = await Promise.all(Array.from(files).map(processSingleFile));
        const allData = results.flat();

        if (allData.length === 0) {
            showModal('Sin Datos', '<p>No se encontraron BoxIDs válidos en la columna J de los archivos seleccionados.</p>');
            return;
        }

        const batch = db.batch();
        const uniqueData = new Map();
        allData.forEach(item => {
            uniqueData.set(String(item.boxId).trim(), item);
        });

        uniqueData.forEach((data, boxId) => {
            const docRef = db.collection('boxID_historico').doc(boxId);
            
            const receivedAtDate = data.receivedDate ? excelSerialToDateObject(data.receivedDate) : new Date();

            const dataToSave = {
                gr: data.gr || 'N/A',
                receivedAt: receivedAtDate 
            };
            batch.set(docRef, dataToSave, { merge: true });
        });

        await batch.commit();

        doc('fileDropAreaBoxID').style.borderColor = 'var(--success-color)';
        showModal('Éxito', `<p>Proceso completado. Se han guardado/actualizado <strong>${uniqueData.size}</strong> registros únicos de <strong>${files.length}</strong> archivo(s).</p>`);

    } catch (err) {
        console.error("Error en el procesamiento de múltiples archivos:", err);
        doc('fileDropAreaBoxID').style.borderColor = 'var(--danger-color)';
        showModal('Error de Archivo', `<p>${err}</p>`);
    }
}
        
        async function handleGrUsuariosFile(files) {
    if (!files || files.length === 0) return;
    showModal('Procesando...', `<p>Cargando ${files.length} archivo(s) de usuarios...</p>`);

    const processSingleFile = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: 1 });
                    
                    const dataInFile = jsonData
                        .map(row => ({
                            gr: row[1],       // Columna B (índice 1)
                            orden: row[5],    // Columna F (índice 5)
                            usuario: row[8]   // Columna I (índice 8)
                        }))
                        .filter(item => item.gr && String(item.gr).trim() !== '');
                    resolve(dataInFile);
                } catch (err) { reject(`Error al leer ${file.name}.`); }
            };
            reader.readAsArrayBuffer(file);
        });
    };

    try {
        const results = await Promise.all(Array.from(files).map(processSingleFile));
        const allData = results.flat();

        if (allData.length === 0) {
            showModal('Sin Datos', '<p>No se encontró información de GR válida en los archivos seleccionados.</p>');
            return;
        }

        const batch = db.batch();
        // Usamos un Map para quedarnos con el último registro de un GR si viniera repetido
        const grDataMap = new Map();
        allData.forEach(item => {
            grDataMap.set(String(item.gr).trim(), {
                usuario: item.usuario || 'N/A',
                orden: item.orden || 'N/A'
            });
        });

        // AHORA SÍ: Simplemente guardamos cada GR en la nueva colección 'gr_historico'
        grDataMap.forEach((data, gr) => {
            const docRef = db.collection('gr_historico').doc(gr);
            batch.set(docRef, data, { merge: true });
        });

        await batch.commit();

        doc('fileDropAreaGrUsuarios').style.borderColor = 'var(--success-color)';
        showModal('Éxito', `<p>Proceso completado. Se han guardado <strong>${grDataMap.size}</strong> registros de GR únicos.</p>`);

    } catch (err) {
        console.error("Error en el procesamiento de archivos GR Usuarios:", err);
        doc('fileDropAreaGrUsuarios').style.borderColor = 'var(--danger-color)';
        showModal('Error', `<p>${err.message || err}</p>`);
    }
}
        
        // --- INICIO: LÓGICA DEL REPORTE SEMANAL 20% ---
        // --- Lógica para el Reporte Semanal 20% ---
function abrirModalReporteSemanal() {
    const modalHTML = `
        <div class="controles-semanales" style="display: grid; grid-template-columns: 1fr 1fr 1.5fr auto; gap: 12px; margin-bottom: 20px; align-items: start;">
            <div>
                <label style="font-size: 0.8rem; color: var(--text-secondary); display:block; margin-bottom:4px;">Inicio</label>
                <input type="date" id="semanal_fecha_inicio" style="width:100%;">
            </div>
            <div>
                <label style="font-size: 0.8rem; color: var(--text-secondary); display:block; margin-bottom:4px;">Fin</label>
                <input type="date" id="semanal_fecha_fin" style="width:100%;">
            </div>
            
            <div>
                <label style="font-size: 0.8rem; color: var(--text-secondary); display:block; margin-bottom:4px;">Turnos</label>
                <div class="turno-grid" id="contenedorTurnos" style="grid-template-columns: repeat(4, 1fr); gap: 6px;"> 
                    <div class="btn-turno-toggle" data-value="T45">T45</div>
                    <div class="btn-turno-toggle" data-value="T46">T46</div>
                    <div class="btn-turno-toggle" data-value="T47">T47</div>
                    <div class="btn-turno-toggle" data-value="T48">T48</div>
                </div>
            </div>

            <div style="display: flex; gap: 8px; align-self: end;">
                <button id="generarReporteSemanalBtn" class="btn" style="padding: 0 20px; height: 38px;">Generar</button>
                <button id="exportarReporteCompletoBtn" class="btn btn-glass" style="height: 38px; width: 38px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Exportar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                </button>
            </div>
        </div>

        <div class="modal-view-tabs" id="modalTabsContainer">
            <button id="btnComparativaTurnos" class="modal-tab-btn active">Comparativa</button>
            <button id="btnRankingSemanal" class="modal-tab-btn">Ranking</button>
        </div>

        <div id="exportWrapper" style="position: relative;">
            <div id="viewComparativa" class="modal-view-content active">
                <div class="modal-chart-wrapper" style="background: var(--surface-color); border-radius: 12px; padding: 10px; border: 1px solid var(--border-color);">
                    <canvas id="graficaSemanal20"></canvas>
                </div>
            </div>
            <div id="viewRanking" class="modal-view-content">
                <div class="modal-ranking-wrapper">
                    <div id="rankingList" class="ranking-card-container">
                        <p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Genera el reporte para ver el ranking.</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    showModal('Reporte Semanal 20%', modalHTML);

    // ... (El resto de la lógica de botones y listeners sigue idéntico) ...
    const botonesTurno = document.querySelectorAll('.btn-turno-toggle');
    const currentShift = getAutoCurrentShift();

    botonesTurno.forEach(btn => {
        if (btn.dataset.value === currentShift) {
            btn.classList.add('active');
        }
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
        });
    });

    const hoy = new Date();
    const haceUnaSemana = new Date();
    haceUnaSemana.setDate(hoy.getDate() - 6);
    doc('semanal_fecha_fin').value = hoy.toISOString().split('T')[0];
    doc('semanal_fecha_inicio').value = haceUnaSemana.toISOString().split('T')[0];

    doc('generarReporteSemanalBtn').addEventListener('click', consultarReporteSemanal);
    doc('exportarReporteCompletoBtn').addEventListener('click', exportarReporteCompleto);

    const btnComparativa = doc('btnComparativaTurnos');
    const btnRanking = doc('btnRankingSemanal');
    const viewComparativa = doc('viewComparativa');
    const viewRanking = doc('viewRanking');

    btnComparativa.addEventListener('click', () => {
        btnComparativa.classList.add('active'); btnRanking.classList.remove('active');
        viewComparativa.classList.add('active'); viewRanking.classList.remove('active');
    });
    btnRanking.addEventListener('click', () => {
        btnComparativa.classList.remove('active'); btnRanking.classList.add('active');
        viewComparativa.classList.remove('active'); viewRanking.classList.add('active');
    });
}

async function consultarReporteSemanal() {
    const btn = doc('generarReporteSemanalBtn');
    btn.disabled = true;
    btn.textContent = 'Generando...';

    const fechaInicio = doc('semanal_fecha_inicio').value;
    const fechaFin = doc('semanal_fecha_fin').value;
    
    // --- CAMBIO AQUÍ: Leer los botones activos en lugar del select ---
    const selectedShifts = Array.from(document.querySelectorAll('.btn-turno-toggle.active'))
                                .map(btn => btn.dataset.value);
    // --------------------------------------------------------------

    if (!fechaInicio || !fechaFin) {
        alert('Por favor, selecciona un rango de fechas.');
        btn.disabled = false;
        btn.textContent = 'Generar Reporte Semanal';
        return;
    }
    
    if (selectedShifts.length === 0) {
        alert('Por favor, selecciona al menos un turno.');
        btn.disabled = false;
        btn.textContent = 'Generar Reporte Semanal';
        return;
    }

    const fechaInicioDate = new Date(`${fechaInicio}T00:00:00`);
    const fechaFinDate = new Date(`${fechaFin}T00:00:00`);
    fechaFinDate.setDate(fechaFinDate.getDate() + 1);
    fechaFinDate.setHours(6, 29, 59, 999);

    try {
        const empleadosList = params.produccion_20_empleados_config.empleados || [];
        const empleadoMap = new Map(empleadosList.map(emp => [String(emp.id).toUpperCase(), emp.nombre]));

        const snapshot = await db.collection('produccion_20_historico')
            .where('Fecha y hora', '>=', fechaInicioDate)
            .where('Fecha y hora', '<=', fechaFinDate)
            .get();

        const datosAgrupadosPorDia = {};
        const datosRanking = {};
        const labelsFechas = new Set();
        const turnosEncontrados = new Set();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const fechaHora = data['Fecha y hora'].toDate();
            const { shift, dateKey } = getWorkShiftAndDate(fechaHora);

            if (selectedShifts.includes(shift) && dateKey >= fechaInicio && dateKey <= fechaFin) {
                labelsFechas.add(dateKey);
                turnosEncontrados.add(shift);

                const catalogo = data['Catalogo'] || '';
                const digit = catalogo.substring(3, 4).toUpperCase();
                const terminacionesPorPieza = digit === 'T' ? 12 : parseInt(digit, 10) || 0;
                const cantidad = Number(data['Cantidad']) || 1;
                const terminacionesTotales = terminacionesPorPieza * cantidad;
                
                const empleadoNum = String(data['Empleado'] || 'N/A').toUpperCase();
                const empleado = empleadoMap.get(empleadoNum) || empleadoNum; 

                if (!datosAgrupadosPorDia[dateKey]) datosAgrupadosPorDia[dateKey] = {};
                if (!datosAgrupadosPorDia[dateKey][shift]) datosAgrupadosPorDia[dateKey][shift] = 0;
                datosAgrupadosPorDia[dateKey][shift] += terminacionesTotales;

                if (!datosRanking[empleado]) {
                    datosRanking[empleado] = { piezas: 0, terminaciones: 0, turno: shift };
                }
                datosRanking[empleado].piezas += cantidad;
                datosRanking[empleado].terminaciones += terminacionesTotales;
            }
        });

        const fechasOrdenadas = Array.from(labelsFechas).sort();
        const turnosOrdenados = Array.from(turnosEncontrados).sort();

        renderGraficaSemanal20(datosAgrupadosPorDia, fechasOrdenadas, turnosOrdenados);
        renderRankingSemanal20(datosRanking);

    } catch (e) {
        console.error("Error consultando reporte semanal:", e);
        alert("No se pudo generar el reporte.");
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generar Reporte Semanal';
    }
}

// --- Función renderGraficaSemanal20 ---
function renderGraficaSemanal20(datos, labels, turnos) {
	const ctx = doc('graficaSemanal20').getContext('2d');
	if (graficaSemanalInstance) graficaSemanalInstance.destroy();

	// --- INICIO: Lógica para mapear colores a turnos ---
	const colors = [
		'rgba(54, 162, 235, 0.7)',  // Azul para T45
		'rgba(255, 99, 132, 0.7)',  // Rojo para T46
		'rgba(75, 192, 192, 0.7)',  // Verde/Aqua para T47
		'rgba(255, 206, 86, 0.7)'   // Amarillo para T48
	];
	const turnosMap = { 'T45': 0, 'T46': 1, 'T47': 2, 'T48': 3 };
	// --- FIN: Lógica de colores ---

	// --- INICIO: Creación de Datasets por Turno ---
	const datasets = turnos.map(turno => ({
		label: `Terminaciones ${turno}`,
		data: labels.map(fecha => (datos[fecha] && datos[fecha][turno]) ? datos[fecha][turno] : 0),
		backgroundColor: colors[turnosMap[turno] % colors.length]
	}));
	// --- FIN: Creación de Datasets ---

	graficaSemanalInstance = new Chart(ctx, {
		type: 'bar',
		data: {
			labels: labels.map(f =>
				new Date(f + 'T12:00:00').toLocaleDateString('es-MX', {
					weekday: 'short',
					month: 'short',
					day: 'numeric'
				})
			),
			datasets: datasets // Usamos los nuevos datasets
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			scales: {
				y: {
					beginAtZero: true,
					ticks: { color: 'var(--chart-tick-color)' },
					grid: { color: 'var(--chart-grid-color)', drawOnChartArea: false },
					title: { display: true, text: 'Total Terminaciones', color: 'var(--chart-tick-color)' }, // Título del eje Y
					afterDataLimits: scale => scale.max = scale.max * 1.15
				},
				x: {
					ticks: { color: 'var(--chart-tick-color)' },
					grid: { color: 'var(--chart-grid-color)' },
					categoryPercentage: 0.7,
					barPercentage: 0.9
				}
			},
			plugins: {
				legend: { position: 'top', labels: { color: 'var(--text-primary)' } },
				datalabels: {
					display: true,
					anchor: 'end',
					align: 'top',
					offset: 8,
					backgroundColor: ctx => document.body.classList.contains('dark-theme')
						? 'rgba(40, 43, 48, 0.75)'
						: 'rgba(255, 255, 255, 0.75)',
					borderColor: ctx => ctx.dataset.backgroundColor,
					borderWidth: 1,
					borderRadius: 4,
					color: ctx => document.body.classList.contains('dark-theme') ? '#F1F5F9' : '#111827',
					padding: { top: 2, bottom: 2, left: 5, right: 5 },
					font: { weight: 'bold', size: 10 },
					formatter: v => v > 0 ? v.toLocaleString() : ''
				}
			}
		},
		plugins: [ChartDataLabels]
	});

	updateChartTheme();
}

// --- Ranking Semanal ---
// --- Ranking Semanal ---
function renderRankingSemanal20(datosRanking) {
    const container = doc('rankingList');
    if (!container) return;

    // Convertir a array
    const rankingArray = Object.entries(datosRanking).map(([empleado, data]) => ({
        empleado,
        piezas: data.piezas,
        terminaciones: data.terminaciones,
        turno: data.turno
    }));

    // Ordenar
    rankingArray.sort((a, b) => b.terminaciones - a.terminaciones);

    if (rankingArray.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Sin datos para los filtros seleccionados.</p>';
        return;
    }

    const maxTerminaciones = rankingArray[0].terminaciones;
    let cardsHtml = '';

    rankingArray.forEach((item, index) => {
        let rankClass = '';
        let medal = index + 1;
        
        if (index === 0) { rankClass = 'gold'; medal = '🥇'; }
        else if (index === 1) { rankClass = 'silver'; medal = '🥈'; }
        else if (index === 2) { rankClass = 'bronze'; medal = '🥉'; }

        const porcentaje = maxTerminaciones > 0 ? (item.terminaciones / maxTerminaciones) * 100 : 0;

        cardsHtml += `
            <div class="ranking-card ${rankClass}">
                <div class="rank-badge">${medal}</div>
                
                <div class="emp-info">
                    <span class="emp-name">${item.empleado}</span>
                    <span class="emp-turno">${item.turno}</span>
                </div>

                <div class="emp-stats-wrapper">
                    <div class="emp-metrics">
                        <span>${item.terminaciones.toLocaleString()} <small>Term.</small></span>
                        <span style="opacity:0.7;">${item.piezas.toLocaleString()} <small>Pzas.</small></span>
                    </div>
                    <div class="card-progress-bg">
                        <div class="card-progress-fill" style="width: ${porcentaje}%;"></div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = cardsHtml;
}
// --- PEGA ESTA FUNCIÓN NUEVA Y COMPLETA (después de consultarReporteSemanal) ---

function renderGraficaSemanal(datos, labels, turnos) {
    const ctx = doc('graficaSemanal').getContext('2d');
    if (graficaSemanalInstance) {
        graficaSemanalInstance.destroy();
    }

    const colors = [
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 99, 132, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(255, 206, 86, 0.7)'
    ];

    // Mapa para que T45 siempre sea azul, T46 rojo, etc.
    const turnosMap = { 'T45': 0, 'T46': 1, 'T47': 2, 'T48': 3 };

    const datasets = turnos.map(turno => ({
        label: `Terminaciones ${turno}`,
        data: labels.map(fecha =>
            (datos[fecha] && datos[fecha][turno]) ? datos[fecha][turno] : 0
        ),
        backgroundColor: colors[turnosMap[turno] % colors.length]
    }));

    graficaSemanalInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(f =>
                new Date(f + 'T12:00:00').toLocaleDateString('es-MX', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                })
            ),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true, 
                    ticks: { color: 'var(--chart-tick-color)' }, 
                    grid: { 
                        color: 'var(--chart-grid-color)',
                        drawOnChartArea: false
                    }, 
                    title: { display: true, text: 'Total Terminaciones', color: 'var(--chart-tick-color)' },
                    afterDataLimits: (scale) => {
                        scale.max = scale.max * 1.15;
                    }
                },
                x: { 
                    ticks: { color: 'var(--chart-tick-color)' }, 
                    grid: { color: 'var(--chart-grid-color)' },
                    categoryPercentage: 0.7,
                    barPercentage: 0.9
                }
            },
            plugins: {
                legend: { position: 'top', labels: { color: 'var(--text-primary)' } },
                datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'top',
                    offset: 8,
                    backgroundColor: (context) => {
                        return document.body.classList.contains('dark-theme')
                            ? 'rgba(40, 43, 48, 0.75)'
                            : 'rgba(255, 255, 255, 0.75)';
                    },
                    borderColor: (context) => context.dataset.backgroundColor,
                    borderWidth: 1,
                    borderRadius: 4,
                    color: (context) => {
                        return document.body.classList.contains('dark-theme')
                            ? '#F1F5F9'
                            : '#111827';
                    },
                    padding: { top: 2, bottom: 2, left: 5, right: 5 },
                    font: { weight: 'bold', size: 10 },
                    formatter: (value) => value > 0 ? value.toLocaleString() : ''
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    updateChartTheme();
}

        function renderGraficaSemanalProduccion(datos, labels) {
    const ctx = doc('produccionSemanalChart').getContext('2d');
    if (weeklyProductionChart) {
        weeklyProductionChart.destroy();
    }

    const meta = 5280;

    weeklyProductionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(f =>
                new Date(f + 'T00:00:00').toLocaleDateString('es-MX', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                })
            ),
            datasets: [
                {
                    label: 'Línea 1',
                    data: labels.map(fecha => datos[fecha]['Línea 1'].term),
                    backgroundColor: 'rgba(245, 158, 11, 0.8)', // <-- ¡ÁMBAR / DORADO!
                },
                {
                    label: 'Línea 2',
                    data: labels.map(fecha => datos[fecha]['Línea 2'].term),
                    backgroundColor: 'rgba(16, 185, 129, 0.8)', // <-- ¡VERDE ESMERALDA!
                },
                {
                    type: 'line',
                    label: 'Meta',
                    data: Array(labels.length).fill(meta),
                    borderColor: 'var(--success-color)',
                    borderWidth: 2,
                    // borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    datalabels: { display: false } 
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'var(--chart-tick-color)' },
                    grid: { color: 'var(--chart-grid-color)' }
                },
                x: {
                    ticks: { color: 'var(--chart-tick-color)' },
                    grid: { color: 'var(--chart-grid-color)' }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: 'var(--text-primary)' }
                },
                datalabels: {
                    // --- Solo mostrar etiquetas en las barras, no en la línea ---
                    display: (context) => context.dataset.type !== 'line',
                    labels: {
                        terminaciones: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => value > 0 ? value.toLocaleString('es-MX') : '',
                            color: 'var(--text-primary)',
                            font: { weight: 'bold' }
                        },
                        eficiencia: {
                            anchor: 'center',
                            align: 'center',
                            formatter: (value, context) => {
                                if (context.dataset.type === 'line' || value === 0) return '';
                                const percentage = ((value / meta) * 100).toFixed(0) + '%';
                                return percentage;
                            },
                            // Colores y estilo adaptativos
                            color: (context) => {
                                const isLightTheme = document.body.classList.contains('light-theme');
                                const barHeight = context.chart
                                    .getDatasetMeta(context.datasetIndex)
                                    .data[context.dataIndex].height;
                                if (barHeight < 20) return 'transparent';
                                return isLightTheme
                                    ? '#111827'
                                    : 'rgba(255, 255, 255, 0.9)';
                            },
                            font: { weight: 'bold', size: 14 },
                            textStrokeColor: (context) => {
                                const isLightTheme = document.body.classList.contains('light-theme');
                                return isLightTheme
                                    ? 'rgba(255,255,255,0.6)'
                                    : 'rgba(0,0,0,0.6)';
                            },
                            textStrokeWidth: 2
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    updateChartTheme();
}
        
        function getWorkShiftAndDate(date) {
            const hour = date.getHours();
            const minute = date.getMinutes();

            let workDate = new Date(date.getTime());

            if (hour < 6 || (hour === 6 && minute < 30)) {
                workDate.setDate(workDate.getDate() - 1);
            }

            const year = workDate.getFullYear();
            const month = String(workDate.getMonth() + 1).padStart(2, '0');
            const dayOfMonth = String(workDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${dayOfMonth}`;
            
            const referenceDate = new Date('2025-10-06T00:00:00');
            const diffTime = workDate.getTime() - referenceDate.getTime();
            const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
            const isShortWeek = diffWeeks % 2 === 0;

            const workDay = workDate.getDay();

            const isDayTime = (hour > 6 || (hour === 6 && minute >= 30)) && (hour < 18 || (hour === 18 && minute < 30));

            let shift;

            if (isShortWeek) {
                if (workDay >= 1 && workDay <= 3) {
                    shift = isDayTime ? 'T45' : 'T46';
                } else {
                    shift = isDayTime ? 'T47' : 'T48';
                }
            } else {
                if (workDay >= 1 && workDay <= 4) {
                    shift = isDayTime ? 'T45' : 'T46';
                } else {
                    shift = isDayTime ? 'T47' : 'T48';
                }
            }

            return {
                shift: shift,
                dateKey: dateKey 
            };
        }
        
        // --- INICIO: LÓGICA REPORTE PRODUCCIÓN 20% ---
        doc('consultarProduccion20Btn').addEventListener('click', consultarReporteProduccion20);

        async function handleProduccion20File(file) {
            const config = params.produccion_20_config;
            if (!config || !config.columns || !config.columns.length === 0) {
                showModal('Configuración Requerida', '<p>Por favor, configure el mapeo de columnas para este reporte en el panel de configuración (icono de engrane).</p>');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: config.startRow - 1, blankrows: false });

                    const colMap = {};
                    config.columns.forEach(col => {
                       colMap[col.key] = XLSX.utils.decode_col(col.excel_col);
                    });

                    const data = jsonData.map(row => {
                        const rowData = {};
                        config.columns.forEach(col => {
                            rowData[col.key] = row[colMap[col.key]];
                        });
                        return rowData;
                    }).filter(row => row['Serial Number'] !== undefined && String(row['Serial Number']).trim() !== '');

                    if (data.length === 0) {
                      showModal('Sin Datos', `<p>No se encontraron datos válidos a partir de la fila ${config.startRow} en el archivo Excel.</p>`);
                      return;
                    }

                    const batch = db.batch();
                    let processedCount = 0;
                    data.forEach(row => {
                        const serial = String(row['Serial Number']).trim();
                        if(serial){
                            const docRef = db.collection('produccion_20_historico').doc(serial);
                            let fechaHora = null;
                            if (row['Fecha y hora'] instanceof Date) {
                                fechaHora = row['Fecha y hora'];
                            } else if (typeof row['Fecha y hora'] === 'number') {
                                fechaHora = excelSerialToDateObject(row['Fecha y hora']);
                            }

                            if (fechaHora) {
                                batch.set(docRef, { ...row, 'Fecha y hora': firebase.firestore.Timestamp.fromDate(fechaHora) });
                                processedCount++;
                            }
                        }
                    });
                    await batch.commit();

                    doc('fileDropAreaProd20').style.borderColor = 'var(--success-color)';
                    showModal('Éxito', `<p>${processedCount} registros han sido guardados en la base de datos. Vuelva a consultar la fecha para ver los datos actualizados.</p>`);
                    consultarReporteProduccion20();

                } catch (err) {
                    console.error("Error al procesar y guardar archivo de Producción 20%:", err);
                    doc('fileDropAreaProd20').style.borderColor = 'var(--danger-color)';
                    showModal('Error de Archivo', `<p>No se pudo procesar o guardar el archivo. Verifique el formato, la configuración y la conexión a la base de datos.</p>`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function consultarReporteProduccion20() {
            const fechaInput = doc('prod20_fecha').value;
            const turnoInput = doc('prod20_turno').value;

            if (!fechaInput) {
                showModal('Fecha Requerida', '<p>Por favor, seleccione una fecha para consultar el reporte.</p>');
                return;
            }
            const btn = doc('consultarProduccion20Btn');
            btn.disabled = true;
            btn.textContent = 'Consultando...';

            const { startTime, endTime } = getShiftDateRange(fechaInput, turnoInput);

            try {
                const snapshot = await db.collection('produccion_20_historico')
                    .where('Fecha y hora', '>=', startTime)
                    .where('Fecha y hora', '<=', endTime)
                    .get();

                const data = [];
                snapshot.forEach(doc => {
                    const docData = doc.data();
                    data.push({
                        ...docData,
                        'Fecha y hora': docData['Fecha y hora'] ? docData['Fecha y hora'].toDate() : null
                    });
                });

                if (data.length === 0) {
                    showModal('Sin Datos', `<p>No se encontraron registros para la fecha y turno seleccionados.</p>`);
                    renderProduccion20Table([]);
                    renderProduccion20Chart([], startTime);
                    return;
                }

                const processedData = data.map(row => {
                    const catalogo = row['Catalogo'];
                    const digit = (catalogo || '').substring(3, 4).toUpperCase();
                    const terminaciones = digit === 'T' ? 12 : parseInt(digit, 10) || 0;
                    return { ...row, fechaHora: row['Fecha y hora'], terminaciones };
                });

                renderProduccion20Table(processedData);
                renderProduccion20Chart(processedData, startTime);

            } catch (e) {
                console.error("Error al consultar datos de Firestore:", e);
                showModal('Error de Consulta', '<p>No se pudo obtener el reporte de la base de datos.</p>');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Consultar Reporte';
            }
        }


        function renderProduccion20Table(data) {
            const table = doc('dataTableProduccion20');
             if (!data || data.length === 0) {
                 table.innerHTML = `<thead><tr><th>Sin datos para mostrar. Consulte una fecha o cargue un archivo.</th></tr></thead><tbody></tbody>`;
                 return;
             }

            let headers = params.produccion_20_config.columns.map(c => c.key);

            if (!headers.map(h => h.toLowerCase()).includes('terminaciones')) {
                 headers.push('Terminaciones');
            }

            let headerHtml = '<thead><tr>';
            headers.forEach(h => headerHtml += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
            headerHtml += '</tr></thead>';

            let bodyHtml = '<tbody>';
            data.sort((a, b) => (b.fechaHora || 0) - (a.fechaHora || 0));

            data.forEach(row => {
                bodyHtml += `<tr>`;
                headers.forEach(header => {
                    let value;
                    const headerLower = header.toLowerCase();
                    if (headerLower === 'fecha y hora') {
                        value = row.fechaHora ? formatShortDateTime(row.fechaHora) : row[header];
                    } else if (headerLower === 'terminaciones') {
                        value = row.terminaciones * (Number(row['Cantidad']) || 1);
                    } else {
                        value = row[header];
                    }
                    bodyHtml += `<td>${value ?? ''}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            bodyHtml += '</tbody>';
            table.innerHTML = headerHtml + bodyHtml;
            addProduccion20FilterListeners();
        }

        function addProduccion20FilterListeners(){
            doc('dataTableProduccion20').querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keyup', filterProduccion20Table);
            });
        }

        function filterProduccion20Table() {
            const table = doc('dataTableProduccion20');
            const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => {
                const th = i.closest('th');
                return {
                    columnIndex: Array.from(th.parentNode.children).indexOf(th),
                    value: i.value.toLowerCase()
                };
            });
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                let shouldShow = true;
                filters.forEach(filter => {
                    if (filter.value) {
                        const cell = row.children[filter.columnIndex];
                        if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) {
                            shouldShow = false;
                        }
                    }
                });
                row.style.display = shouldShow ? '' : 'none';
            });
        }

        function renderProduccion20Chart(data, shiftStartTime) {
            const ctx = doc('produccion20Chart').getContext('2d');
            if (production20Chart) {
                production20Chart.destroy();
            }

            if (!data || data.length === 0 || !shiftStartTime) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                doc('chartSummary20').innerHTML = '';
                return;
            }

            const hourlyBins = Array.from({ length: 12 }, () => ({}));
            const allStations = new Set();
            const totalTerminacionesPorEstacion = {};

            data.forEach(item => {
                const estacion = item['Estación'] || 'N/A';
                allStations.add(estacion);
                const cantidad = Number(item['Cantidad']) || 1;
                const totalTerm = item.terminaciones * cantidad;
                totalTerminacionesPorEstacion[estacion] = (totalTerminacionesPorEstacion[estacion] || 0) + totalTerm;

                if (item.fechaHora instanceof Date) {
                    const diffMillis = item.fechaHora - shiftStartTime;
                    if (diffMillis >= 0) {
                        const hourIndex = Math.floor(diffMillis / (1000 * 60 * 60));
                        if (hourIndex >= 0 && hourIndex < 12) {
                            if (!hourlyBins[hourIndex][estacion]) {
                                hourlyBins[hourIndex][estacion] = { piezas: 0, terminaciones: 0 };
                            }
                            hourlyBins[hourIndex][estacion].piezas += cantidad;
                            hourlyBins[hourIndex][estacion].terminaciones += totalTerm;
                        }
                    }
                }
            });

            const totalPiezas = data.reduce((sum, item) => sum + (Number(item['Cantidad']) || 1), 0);
            const totalTerminaciones = Object.values(totalTerminacionesPorEstacion).reduce((sum, count) => sum + count, 0);

            let summaryHTML = `<div style="margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Total Piezas: <strong>${totalPiezas.toLocaleString()}</strong> / Total Terminaciones: <strong>${totalTerminaciones.toLocaleString()}</strong></div>`;

            let stationSummaryHtml = '<div style="font-size: 0.85rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px;">';
            for (const [station, count] of Object.entries(totalTerminacionesPorEstacion).sort()) {
                stationSummaryHtml += `<span><strong>${station}:</strong> ${count.toLocaleString()} term</span>`;
            }
            stationSummaryHtml += '</div>';
            doc('chartSummary20').innerHTML = summaryHTML + stationSummaryHtml;

            const sortedStations = [...allStations].sort();
            const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'];
            const datasets = sortedStations.map((station, index) => ({
                label: station,
                data: hourlyBins.map(hourData => hourData[station]?.terminaciones || 0),
                backgroundColor: colors[index % colors.length],
            }));

            const hourlyTotals = hourlyBins.map(hourData => {
                let totalPzs = 0;
                let totalTerm = 0;
                for (const station in hourData) {
                    totalPzs += hourData[station].piezas;
                    totalTerm += hourData[station].terminaciones;
                }
                return { piezas: totalPzs, terminaciones: totalTerm };
            });

            const labels = [];
            for (let i = 0; i < 12; i++) {
                const start = new Date(shiftStartTime);
                start.setHours(start.getHours() + i);
                const end = new Date(start);
                end.setHours(end.getHours() + 1);
                const format = { hour: '2-digit', minute: '2-digit', hour12: false };
                labels.push(`${start.toLocaleTimeString([], format)} - ${end.toLocaleTimeString([], format)}`);
            }

            production20Chart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)'}},
                        title: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const stationName = context.dataset.label;
                                    const hourData = hourlyBins[context.dataIndex];
                                    if (hourData && hourData[stationName]) {
                                        const { piezas, terminaciones } = hourData[stationName];
                                        return `${stationName}: ${terminaciones} term. (${piezas} pzs)`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)', font: { size: 10 }, maxRotation: 45, minRotation: 45 } },
                        y: { beginAtZero: true, grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' }, afterDataLimits: (scale) => { scale.max *= 1.25; } }
                    }
                },
                plugins: [
                    {
                        id: 'totalLabels',
                        afterDatasetsDraw: (chart) => {
                            const { ctx, data, scales: { x, y } } = chart;
                            ctx.save();
                            ctx.font = 'bold 10px Inter';
                            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                            ctx.textAlign = 'center';

                            hourlyTotals.forEach((total, index) => {
                                if (total.piezas > 0 || total.terminaciones > 0) {
                                    const text = `Pzs: ${total.piezas} / Term: ${total.terminaciones}`;

                                    let maxVal = 0;
                                    chart.data.datasets.forEach((dataset, i) => {
                                        if (chart.isDatasetVisible(i)) {
                                            const value = dataset.data[index] || 0;
                                            if (value > maxVal) {
                                                maxVal = value;
                                            }
                                        }
                                    });

                                    const yPos = y.getPixelForValue(maxVal);
                                    ctx.fillText(text, x.getPixelForTick(index), yPos - 8);
                                }
                            });
                            ctx.restore();
                        }
                    }
                ]
            });
            updateChartTheme();
        }


        // --- INICIO: LÓGICA REPORTE DE PRODUCCIÓN POR HORA ---
        function getAutoCurrentShift() {
            const now = new Date();

            const referenceDate = new Date('2025-10-06T00:00:00');
            const diffTime = now.getTime() - referenceDate.getTime();
            const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
            const isShortWeek = diffWeeks % 2 === 0;

            let day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();

            if (hour < 6 || (hour === 6 && minute < 30)) {
                day = (day === 0) ? 6 : day - 1;
            }

            const isDayTime = hour >= 6 && (hour < 18 || (hour === 18 && minute < 30));

            if (isShortWeek) {
                if (day >= 1 && day <= 3) {
                    return isDayTime ? 'T45' : 'T46';
                } else {
                    return isDayTime ? 'T47' : 'T48';
                }
            } else {
                if (day >= 1 && day <= 4) {
                    return isDayTime ? 'T45' : 'T46';
                } else {
                    return isDayTime ? 'T47' : 'T48';
                }
            }
        }

        function getShiftDateRange(selectedDateStr, selectedShift) {
            const date = new Date(`${selectedDateStr}T00:00:00`);
            let startTime, endTime;
            switch(selectedShift) {
                case 'T45': case 'T47':
                    startTime = new Date(date.getTime()); startTime.setHours(6, 30, 0, 0);
                    endTime = new Date(date.getTime()); endTime.setHours(18, 29, 59, 999);
                    break;
                case 'T46': case 'T48':
                    startTime = new Date(date.getTime()); startTime.setHours(18, 30, 0, 0);
                    endTime = new Date(date.getTime()); endTime.setDate(endTime.getDate() + 1);
                    endTime.setHours(6, 29, 59, 999);
                    break;
            }
            return { startTime, endTime };
        }

        doc('generarReporteProduccionBtn').addEventListener('click', generateProductionReport);
        doc('exportChartBtn').addEventListener('click', exportChartAsJPG);
        doc('exportarSemanalBtn').addEventListener('click', exportarSemanalComoJPG);

        function hideAllProductionViews() {
            doc('chartContainer').style.display = 'none';
            doc('fibraReportContainer').style.display = 'none';
            doc('semanalContainer').style.display = 'none';
            doc('produccionTablesGrid').style.display = 'none';
        }

        doc('showProduccionHoraBtn').addEventListener('click', () => {
            hideAllProductionViews();
            doc('fechaUnicaContainer').style.display = 'block';
            doc('fechaRangoContainer').style.display = 'none';
            doc('chartContainer').style.display = 'flex';
            doc('produccionTablesGrid').style.display = 'grid';
            doc('generarReporteProduccionBtn').textContent = 'Generar Reporte por Hora';
        });

        doc('showProduccionFibraBtn').addEventListener('click', () => {
            if (!productionReportData) {
                showModal('Datos no disponibles', '<p>Primero debe generar un reporte de producción por hora.</p>');
                return;
            }
            hideAllProductionViews();
            doc('fechaUnicaContainer').style.display = 'block';
            doc('fechaRangoContainer').style.display = 'none';
            renderFiberReport(productionReportData);
            doc('fibraReportContainer').style.display = 'flex';
            doc('generarReporteProduccionBtn').textContent = 'Generar Reporte por Hora';
        });
        
        doc('showProduccionSemanaBtn').addEventListener('click', () => {
            hideAllProductionViews();
            doc('fechaUnicaContainer').style.display = 'none';
            doc('fechaRangoContainer').style.display = 'block';
            doc('semanalContainer').style.display = 'flex';
            doc('generarReporteProduccionBtn').textContent = 'Generar Reporte Semanal';
            if (weeklyProductionChart) weeklyProductionChart.destroy();
            doc('resumenSemanal').innerHTML = '<h4 style="text-align:center;">Configure filtros y presione "Generar Reporte".</h4>';
        });

    async function loadAreasForProductionReport() {
            try {
                const areasSnapshot = await db.collection('areas').get();
                const areaSelect = doc('prod_area');
                const currentVal = areaSelect.value;
                const existingOptions = new Set(Array.from(areaSelect.options).map(o => o.value));
                let areas = [];
                areasSnapshot.forEach(doc => { if (doc.id !== 'CONFIG') areas.push(doc.id); });
                areas.sort();
                areas.forEach(areaId => {
                    if (!existingOptions.has(areaId)) {
                        const option = document.createElement('option');
                        option.value = areaId; option.textContent = areaId;
                        areaSelect.appendChild(option);
                    }
                });
                areaSelect.value = currentVal;
            } catch (e) { console.error("Error cargando áreas:", e); }
        }


        async function generateProductionReport() {
            if (doc('semanalContainer').style.display === 'flex') {
                await generarReporteSemanalProduccion();
            } else {
                await generarReportePorHora();
            }
        }

        // --- FUNCIÓN DE REEMPLAZO (generarReportePorHora) ---
async function generarReportePorHora() {
    const btn = doc('generarReporteProduccionBtn');
    btn.disabled = true; btn.textContent = 'Cargando datos...';
    doc('exportChartBtn').style.display = 'none';
    
    // Limpiar tablas anteriores
    const tablesGrid = doc('produccionTablesGrid');
    tablesGrid.innerHTML = ''; // Limpiamos el contenedor

    try {
        const selectedDateStr = doc('prod_fecha_unica').value;
        const selectedTurno = doc('prod_turno').value;
        const selectedArea = doc('prod_area').value;
        
        // 1. OBTENER CONFIGURACIÓN DE EMPACADORES (Sigue igual)
        const todosLosEmpacadores = params.produccion_hora_config.packers || [];
        const empacadoresFiltrados = todosLosEmpacadores.filter(p => 
            (p.area === selectedArea || selectedArea === 'ALL' || p.area === 'ALL') && p.turno === selectedTurno
        );

        const empacadoresPorLinea = new Map();
        empacadoresFiltrados.forEach(p => {
            const lineaNum = String(p.linea);
            if (!empacadoresPorLinea.has(lineaNum)) {
                empacadoresPorLinea.set(lineaNum, new Set());
            }
            empacadoresPorLinea.get(lineaNum).add(p.id);
        });
        
        if (empacadoresFiltrados.length === 0) {
            showModal('Sin Empacadores', '<p>No se encontraron empacadores configurados para esta Área y Turno en el panel de Configuración.</p>');
            renderProductionChart([], null, selectedTurno);
            productionReportData = [];
            return;
        }

        if (!selectedDateStr) { showModal('Error', '<p>Por favor, selecciona una fecha.</p>'); return; }
        
        // 2. OBTENER DATOS DE FIREBASE (Sigue igual)
        const { startTime, endTime } = getShiftDateRange(selectedDateStr, selectedTurno);
        const query = selectedArea === 'ALL' ? db.collectionGroup('orders') : db.collection('areas').doc(selectedArea).collection('orders');
        
        const snapshot = await query.get();
        
        // 3. PROCESAR DATOS (Sigue igual)
        let allPackedItems = [];
        if (!snapshot.empty) {
            snapshot.forEach(orderDoc => {
                const orderData = orderDoc.data();
                if (Array.isArray(orderData.empaqueData)) {
                    orderData.empaqueData.forEach(box => {
                        if (Array.isArray(box.serials)) {
                            box.serials.forEach(item => {
                                const packedDate = excelSerialToDateObject(item['Finish Packed Date']);
                                if (packedDate && packedDate >= startTime && packedDate <= endTime) {
                                    const empacador = (item['Employee ID'] || '').toString().toUpperCase();
                                    let lineaAsignada = null;
                                    for (const [linea, setDeEmpacadores] of empacadoresPorLinea.entries()) {
                                        if (setDeEmpacadores.has(empacador)) {
                                            lineaAsignada = linea;
                                            break;
                                        }
                                    }
                                    if (lineaAsignada) {
                                        allPackedItems.push({
                                            orden: orderDoc.id, catalogo: orderData.catalogNumber || 'N/A',
                                            empacador: empacador, timestamp: packedDate,
                                            linea: `Línea ${lineaAsignada}`,
                                            boxId: box.boxId || 'SIN_CAJA'
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }
        
        const detailedData = allPackedItems.map(item => {
            const char = (item.catalogo || '').substring(3, 4).toUpperCase();
            const fibras = (char === 'T') ? 12 : (parseInt(char, 10) || 0);
            return { ...item, fibras, terminaciones: fibras };
        });
        productionReportData = detailedData;
        
        const groupedByBox = new Map();
        detailedData.forEach(item => {
            const key = `${item.orden}-${item.boxId}`;
            if (!groupedByBox.has(key)) {
                groupedByBox.set(key, { ...item, piezas: 0, terminaciones: 0 });
            }
            const group = groupedByBox.get(key);
            group.piezas++;
            group.terminaciones += item.terminaciones;
            if (item.timestamp > group.timestamp) { group.timestamp = item.timestamp; }
        });
        
        const aggregatedData = Array.from(groupedByBox.values()).sort((a, b) => b.timestamp - a.timestamp);
        
        // --- ¡AQUÍ ESTÁ EL CAMBIO! ---
        // 4. AGRUPAR DATOS POR LÍNEA (ANTES DE CREAR HTML)
        const datosPorLinea = new Map();
        aggregatedData.forEach(row => {
            const lineaNombre = row.linea;
            if (!lineaNombre) return;
            
            if (!datosPorLinea.has(lineaNombre)) {
                datosPorLinea.set(lineaNombre, []);
            }
            datosPorLinea.get(lineaNombre).push(row);
        });

        // 5. OBTENER LISTA DE LÍNEAS QUE SÍ TIENEN DATOS
        const lineasConDatos = [...datosPorLinea.keys()].sort();

        // 6. VERIFICAR SI HAY ALGO QUE MOSTRAR
        if (lineasConDatos.length === 0) {
            // Esto pasa si hay empacadores configurados (paso 1), pero no empacaron nada (paso 3).
            showModal('Sin Producción', '<p>No se encontró producción registrada para los empacadores de este turno y área.</p>');
            tablesGrid.innerHTML = ''; // Contenedor vacío
            renderProductionChart([], startTime, selectedTurno); // Gráfica vacía
            productionReportData = [];
            return; // Salir
        }

        // 7. AJUSTAR GRID Y CREAR TABLAS (SOLO PARA LÍNEAS CON DATOS)
        tablesGrid.style.gridTemplateColumns = `repeat(${lineasConDatos.length}, 1fr)`;

        lineasConDatos.forEach(lineaNombre => {
            const lineaNumero = lineaNombre.split(' ')[1]; // Saca el '1' de 'Línea 1'
            const tableId = `dataTableProduccionL${lineaNumero}`;
            const tableHtml = `
                <div class="card table-container">
                    <h5>Producción ${lineaNombre}</h5>
                    <div class="table-wrapper">
                        <table id="${tableId}">
                            <thead><tr><th>Cargando...</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            `;
            tablesGrid.insertAdjacentHTML('beforeend', tableHtml);
        });

        // 8. RENDERIZAR DATOS EN LAS TABLAS CREADAS
        for (const [lineaNombre, data] of datosPorLinea.entries()) {
            const lineaNumero = lineaNombre.split(' ')[1];
            renderProductionTable(data, `dataTableProduccionL${lineaNumero}`, lineaNombre);
        }
        // --- FIN DEL CAMBIO ---
        
        // 9. RENDERIZAR GRÁFICA (esto no cambia)
        renderProductionChart(detailedData, startTime, selectedTurno);

    } catch (e) {
        console.error("Error generando reporte por hora:", e);
        showModal('Error', `<p>Ocurrió un error: ${e.message}</p>`);
        productionReportData = null;
    } finally {
        btn.disabled = false; btn.textContent = 'Generar Reporte';
    }
}
    async function generarReporteSemanalProduccion() {
            const btn = doc('generarReporteProduccionBtn');
            btn.disabled = true;
            btn.textContent = 'Cargando datos...';
            
            try {
                const fechaInicioStr = doc('prod_fecha_inicio').value;
                const fechaFinStr = doc('prod_fecha_fin').value;
                const selectedArea = doc('prod_area').value;
                const selectedTurno = doc('prod_turno').value;

                if (!fechaInicioStr || !fechaFinStr) {
                    showModal('Error', '<p>Por favor, selecciona un rango de fechas.</p>');
                    btn.disabled = false; btn.textContent = 'Generar Reporte';
                    return;
                }

                const empacadoresFiltrados = (params.produccion_hora_config.packers || []).filter(p => 
                    (p.area === selectedArea || selectedArea === 'ALL') && p.turno === selectedTurno
                );
                const empacadoresL1 = empacadoresFiltrados.filter(p => p.linea === '1').map(p => p.id);
                const empacadoresL2 = empacadoresFiltrados.filter(p => p.linea === '2').map(p => p.id);
                
                const queryStartTime = new Date(`${fechaInicioStr}T06:30:00`);
                queryStartTime.setDate(queryStartTime.getDate() - 1);
                
                const queryEndTime = new Date(`${fechaFinStr}T00:00:00`);
                queryEndTime.setDate(queryEndTime.getDate() + 1);
                queryEndTime.setHours(6, 29, 59, 999);

                const query = selectedArea === 'ALL' ? db.collectionGroup('orders') : db.collection('areas').doc(selectedArea).collection('orders');
                const snapshot = await query.get();

                if (snapshot.empty) {
                    showModal('Sin Datos', '<p>No se encontraron órdenes para el área seleccionada.</p>');
                    renderGraficaSemanalProduccion({}, []);
                    renderResumenSemanalProduccion({ 'Línea 1': { term: 0, pzas: 0 }, 'Línea 2': { term: 0, pzas: 0 } }, 0);
                    return;
                }

                let datosAgrupadosPorDia = {};
                let totales = { 'Línea 1': { term: 0, pzas: 0 }, 'Línea 2': { term: 0, pzas: 0 } };

                snapshot.forEach(orderDoc => {
                    const orderData = orderDoc.data();
                    if (Array.isArray(orderData.empaqueData)) {
                        orderData.empaqueData.forEach(box => {
                            if (Array.isArray(box.serials)) {
                                box.serials.forEach(item => {
                                    const packedDate = excelSerialToDateObject(item['Finish Packed Date']);
                                    
                                    if (packedDate) {
                                        const { shift, dateKey } = getWorkShiftAndDate(packedDate);
                                        const esTurnoValido = (selectedTurno === shift);
                                        const esFechaValida = dateKey >= fechaInicioStr && dateKey <= fechaFinStr;

                                        if (esTurnoValido && esFechaValida) {
                                            const empacador = (item['Employee ID'] || '').toString().toUpperCase();
                                            let linea = null;
                                            if (empacadoresL1.includes(empacador)) linea = 'Línea 1';
                                            else if (empacadoresL2.includes(empacador)) linea = 'Línea 2';

                                            if (linea) {
                                                const char = (orderData.catalogNumber || '').substring(3, 4).toUpperCase();
                                                const terminaciones = (char === 'T') ? 12 : (parseInt(char, 10) || 0);

                                                if (!datosAgrupadosPorDia[dateKey]) {
                                                    datosAgrupadosPorDia[dateKey] = { 'Línea 1': { term: 0, pzas: 0 }, 'Línea 2': { term: 0, pzas: 0 } };
                                                }
                                                datosAgrupadosPorDia[dateKey][linea].term += terminaciones;
                                                datosAgrupadosPorDia[dateKey][linea].pzas++;
                                                totales[linea].term += terminaciones;
                                                totales[linea].pzas++;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    }
                });
                
                const labelsFechas = Object.keys(datosAgrupadosPorDia).sort();
                renderGraficaSemanalProduccion(datosAgrupadosPorDia, labelsFechas);
                renderResumenSemanalProduccion(totales, labelsFechas.length);

            } catch (e) {
                console.error("Error generando reporte semanal:", e);
                showModal('Error', `<p>Ocurrió un error: ${e.message}</p>`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generar Reporte';
            }
        }

        function renderResumenSemanalProduccion(totales, diasTrabajados) {
    const container = doc('resumenSemanal');
    const metaDiaria = 5280;
    const metaTotal = metaDiaria * diasTrabajados;

    const eficienciaL1 = metaTotal > 0 ? ((totales['Línea 1'].term / metaTotal) * 100) : 0;
    const eficienciaL2 = metaTotal > 0 ? ((totales['Línea 2'].term / metaTotal) * 100) : 0;

    const alturaBarraL1 = Math.min(eficienciaL1, 100);
    const alturaBarraL2 = Math.min(eficienciaL2, 100);

    container.innerHTML = `
        <h4 style="text-align: center; margin-top: 0;">Resumen del Periodo</h4>

        <div style="background-color: var(--surface-hover-color); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <h5>Meta Total de la Semana</h5>
            <p><strong>Terminaciones:</strong> ${metaTotal.toLocaleString('es-MX')}</p>
        </div>

        <div style="background-color: var(--surface-hover-color); padding: 12px; border-radius: 8px;">
            <h5>Línea 1</h5>
            <p><strong>Terminaciones:</strong> ${totales['Línea 1'].term.toLocaleString('es-MX')}</p>
            <p><strong>Eficiencia:</strong> ${eficienciaL1.toFixed(1)}%</p>
        </div>

        <div style="background-color: var(--surface-hover-color); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <h5>Línea 2</h5>
            <p><strong>Terminaciones:</strong> ${totales['Línea 2'].term.toLocaleString('es-MX')}</p>
            <p><strong>Eficiencia:</strong> ${eficienciaL2.toFixed(1)}%</p>
        </div>

        <div class="summary-bars-wrapper">
            <div class="summary-bar-container">
                <div class="summary-bar" style="height: ${alturaBarraL1}%; background-color: rgba(245, 158, 11, 0.8);">
                    <span>${eficienciaL1.toFixed(0)}%</span>
                </div>
                <div class="summary-bar-label">Línea 1</div>
            </div>

            <div class="summary-bar-container">
                <div class="summary-bar" style="height: ${alturaBarraL2}%; background-color: rgba(16, 185, 129, 0.8);">
                    <span>${eficienciaL2.toFixed(0)}%</span>
                </div>
                <div class="summary-bar-label">Línea 2</div>
            </div>
        </div>
    `;
}

        function renderProductionTable(data, tableId, lineName) {
            const table = doc(tableId);
            if (!data || data.length === 0) {
                table.innerHTML = `<thead><tr><th>Sin registros para ${lineName}.</th></tr></thead><tbody></tbody>`;
                return;
            }
            const headers = ['Orden', 'Box ID', 'Catálogo', 'Piezas', 'Fecha/Hora', 'Term.'];
            let html = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            data.forEach(row => {
                html += `<tr><td>${row.orden}</td><td>${row.boxId}</td><td>${row.catalogo}</td><td>${row.piezas}</td><td>${formatShortDateTime(row.timestamp)}</td><td>${row.terminaciones}</td></tr>`;
            });
            table.innerHTML = html + `</tbody>`;
        }

        // --- FUNCIÓN DE REEMPLAZO (renderProductionChart) ---
function renderProductionChart(data, shiftStartTime, turno) {
    // --- INICIO DEL ARREGLO ---
    const canvas = doc('produccionChart'); // 1. Obtenemos el <canvas>
    if (!canvas) { // 2. Seguridad por si no lo encuentra
        console.error("renderProductionChart: No se encontró el canvas 'produccionChart'.");
        return; 
    }
    const ctx = canvas.getContext('2d'); // 3. Obtenemos el contexto

    // 4. ¡EL ARREGLO! Primero destruimos el chart viejo, si existe
    if (productionChart) {
        productionChart.destroy();
    }

    // 5. ¡EL ARREGLO! Limpiamos a la fuerza el canvas (crucial en móviles)
    // Esto ahora se hace SIEMPRE, para asegurar que la memoria se libere
    ctx.clearRect(0, 0, canvas.width, canvas.height); 
    // --- FIN DEL ARREGLO ---

    if(data.length === 0){
        // Ya no necesitamos el clearRect aquí, solo el resto
        doc('chartSummary').innerHTML = ''; doc('exportChartBtn').style.display = 'none'; return;
    }

    // --- INICIO DE LA MODIFICACIÓN DINÁMICA ---
    const goals = Array(12).fill(480); // Metas (esto sigue igual)
    goals[1] = 360; goals[5] = 280; goals[8] = 360; 
    const visualGoalLine = Array(12).fill(480);

    const hourlyData = {}; // { 0: {}, 1: {}, ... 11: {} }
    const labels = [];
    const totalSummary = {}; // Objeto vacío
    const lineasEncontradas = new Set(); // Set para líneas únicas

    // 1. Inicializar etiquetas y hourlyData
    for (let i = 0; i < 12; i++) {
        const startHour = new Date(shiftStartTime); startHour.setHours(startHour.getHours() + i);
        const endHour = new Date(startHour); endHour.setHours(endHour.getHours() + 1);
        const format = { hour: '2-digit', minute: '2-digit', hour12: false };
        labels.push(`${startHour.toLocaleTimeString('es-ES', format)} - ${endHour.toLocaleTimeString('es-ES', format)}`);
        hourlyData[i] = {}; // Objeto vacío para cada hora
    }

    // 2. Procesar datos y descubrir líneas
    data.forEach(item => {
        const lineaNombre = item.linea; // ej: "Línea 1", "Línea 3"
        if (!lineaNombre) return; // Ignorar si no tiene línea

        lineasEncontradas.add(lineaNombre); // Añadir al Set

        // Inicializar summary si es la primera vez que vemos esta línea
        if (!totalSummary[lineaNombre]) {
            totalSummary[lineaNombre] = { piezas: 0, terminaciones: 0 };
        }

        const diffHours = Math.floor((item.timestamp - shiftStartTime) / (1000 * 60 * 60));
        if(diffHours >= 0 && diffHours < 12){
            // Inicializar la línea en el bin de esa hora si no existe
            if (!hourlyData[diffHours][lineaNombre]) {
                hourlyData[diffHours][lineaNombre] = 0;
            }
            hourlyData[diffHours][lineaNombre] += item.terminaciones;
        }

        // Acumular totales
        totalSummary[lineaNombre].piezas++;
        totalSummary[lineaNombre].terminaciones += item.terminaciones;
    });

    // 3. Crear el HTML del resumen dinámicamente
    const lineasOrdenadas = [...lineasEncontradas].sort(); // ["Línea 1", "Línea 2", "Línea 3"]
    const summaryHtml = lineasOrdenadas.map(linea => {
        const summary = totalSummary[linea];
        return `${linea}: <strong>${summary.piezas} pzas / ${summary.terminaciones} term.</strong>`;
    }).join(' | ');
    doc('chartSummary').innerHTML = summaryHtml;

    // 4. Crear los datasets dinámicamente
    const colors = ['rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)'];
    const borderColors = ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)'];

    const dynamicDatasets = lineasOrdenadas.map((linea, index) => {
        return {
            label: linea,
            data: Object.values(hourlyData).map(d => d[linea] || 0), // Obtener el dato de esa línea, o 0
            backgroundColor: colors[index % colors.length],
            borderColor: borderColors[index % borderColors.length],
            borderWidth: 1,
            order: 1
        };
    });

    // 5. Añadir el dataset de la meta
    dynamicDatasets.unshift({ 
        type: 'line', 
        label: 'Meta', 
        data: visualGoalLine,// Usamos el array de metas que definimos arriba
        borderColor: getComputedStyle(document.body).getPropertyValue('--success-color'), 
        borderWidth: 2, 
        borderDash: [5, 5], 
        pointRadius: 0, 
        fill: false, 
        order: 0 
    });

    // --- FIN DE LA MODIFICACIÓN DINÁMICA ---

    productionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: dynamicDatasets // <-- USAR LOS DATASETS DINÁMICOS
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { color: 'var(--text-primary)', filter: item => item.datasetIndex > 0 } }, // Sigue ocultando la meta
                title: { display: true, text: `Producción de Terminaciones - ${turno}`, color: 'var(--text-primary)', font: { size: 16 } },
                datalabels: {
                    display: context => context.dataset.type !== 'line',
                    labels: {
                        value: {
                            anchor: 'end', 
                            align: 'top',
                            offset: 5,
                            backgroundColor: (ctx) => {
                                const isSuccess = ctx.dataset.data[ctx.dataIndex] >= goals[ctx.dataIndex]; // Revisa contra la meta correcta
                                const colorVar = isSuccess ? '--glow-green' : '--glow-red';
                                const rawColor = getComputedStyle(document.body).getPropertyValue(colorVar).trim();
                                return rawColor.replace(/0.9\)$/, '0.4)');
                            },
                            borderColor: (ctx) => {
                                return ctx.dataset.data[ctx.dataIndex] >= goals[ctx.dataIndex] ? getComputedStyle(document.body).getPropertyValue('--success-color') : getComputedStyle(document.body).getPropertyValue('--danger-color');
                            },
                            borderWidth: 1,
                            borderRadius: 4,
                            color: 'white',
                            font: { weight: 'bold' },
                            padding: { top: 2, bottom: 2, left: 5, right: 5 },
                            formatter: (value) => value > 0 ? value.toLocaleString() : '',
                        },
                        percentage: { 
                            align: 'center', anchor: 'center',
                            color: (ctx) => {
                                const barHeight = ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.dataIndex].height;
                                return barHeight > 18 ? 'rgba(255, 255, 255, 0.9)' : 'transparent';
                            },
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, ctx) => {
                                const goalForHour = goals[ctx.dataIndex];
                                if (value <= 0 || goalForHour === 0) return '';
                                const percentage = (value / goalForHour) * 100;
                                return percentage.toFixed(0) + '%';
                            },
                            textStrokeColor: 'rgba(0,0,0,0.6)',
                            textStrokeWidth: 2
                        }
                    }
                }
            },
            scales: {
                x: { 
                    grid: { color: 'var(--chart-grid-color)' }, 
                    ticks: { color: 'var(--chart-tick-color)', maxRotation: 0, minRotation: 0, autoSkip: true, font: { size: 10 } },
                    categoryPercentage: 0.7,
                    barPercentage: 0.9
                },
                y: { 
                    beginAtZero: true, 
                    grid: { color: 'var(--chart-grid-color)' }, 
                    ticks: { color: 'var(--chart-tick-color)' }, 
                    title: { display: true, text: 'Total de Terminaciones', color: 'var(--chart-tick-color)' },
                    afterDataLimits: (scale) => {
                        scale.max = scale.max * 1.2;
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    doc('exportChartBtn').style.display = 'block';
    updateChartTheme();
}

        // --- FUNCIÓN DE REEMPLAZO (renderFiberReport) ---
        function renderFiberReport(data) {
            const container = doc('fibraReportContent');
            
            // --- INICIO DE LA MODIFICACIÓN DINÁMICA ---
            
            // 1. Destruir todos los pie charts anteriores
            if (fiberPieCharts.length > 0) {
                fiberPieCharts.forEach(chart => chart.destroy());
                fiberPieCharts = []; // Limpiar el array
            }

            if (!data || data.length === 0) { 
                container.innerHTML = '<p>No hay datos de producción para analizar.</p>'; 
                return; 
            }

            // 2. Agrupar datos por línea
            const datosPorLinea = new Map();
            const lineasEncontradas = new Set();
            data.forEach(item => {
                const lineaNombre = item.linea;
                if (!lineaNombre) return;

                lineasEncontradas.add(lineaNombre);
                if (!datosPorLinea.has(lineaNombre)) {
                    datosPorLinea.set(lineaNombre, []);
                }
                datosPorLinea.get(lineaNombre).push(item);
            });

            // 3. Helper (generateHtmlForLine) - (La función interna ya era dinámica, no cambia)
            const generateHtmlForLine = (lineData, lineName, chartId) => {
                if (lineData.length === 0) return `<div><h5>${lineName}</h5><p>Sin producción registrada.</p></div>`;
                const fibraData = {};
                lineData.forEach(item => {
                    const fibraKey = `${item.fibras} Fibras`;
                    const catalogo = item.catalogo;
                    if (!fibraData[fibraKey]) fibraData[fibraKey] = {};
                    if (!fibraData[fibraKey][catalogo]) fibraData[fibraKey][catalogo] = 0;
                    fibraData[fibraKey][catalogo]++;
                });
                let tableHTML = `<div class="table-wrapper" style="max-height: 200px;"><table class="sub-table"><thead><tr><th>Fibra</th><th>Catálogo</th><th>Piezas</th></tr></thead><tbody>`;
                Object.entries(fibraData).forEach(([fibra, catalogos]) => {
                    Object.entries(catalogos).forEach(([catalogo, piezas]) => { tableHTML += `<tr><td>${fibra}</td><td>${catalogo}</td><td>${piezas}</td></tr>`; });
                });
                tableHTML += '</tbody></table></div>';
                return `<div><h5>${lineName}</h5><div class="pie-chart-container"><canvas id="${chartId}"></canvas></div>${tableHTML}</div>`;
            };

            // 4. Helper (createPieChart) - (La función interna ya era dinámica, no cambia)
            const createPieChart = (chartId, lineData) => {
                const ctx = doc(chartId)?.getContext('2d');
                if (!ctx || lineData.length === 0) return null;
                const pieData = {};
                lineData.forEach(item => {
                    const fibraKey = `${item.fibras} Fibras`;
                    if (!pieData[fibraKey]) pieData[fibraKey] = 0;
                    pieData[fibraKey]++;
                });
                const pieLabels = Object.keys(pieData);
                const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
                return new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: pieLabels,
                        datasets: [{ data: Object.values(pieData), backgroundColor: pieLabels.map((_, i) => colors[i % colors.length]) }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return (value * 100 / sum).toFixed(1) + '%';
                                },
                                color: '#fff',
                                textShadowColor: 'rgba(0,0,0,0.7)', textShadowBlur: 5,
                                font: { weight: 'bold' }
                            }
                        }
                    },
                     plugins: [ChartDataLabels]
                });
            };

            // 5. Generar HTML y crear gráficas dinámicamente
            const lineasOrdenadas = [...lineasEncontradas].sort();
            let gridHtml = '';
            lineasOrdenadas.forEach((lineaNombre, index) => {
                const chartId = `fibraPieChart${index}`;
                const dataDeLinea = datosPorLinea.get(lineaNombre) || [];
                gridHtml += generateHtmlForLine(dataDeLinea, lineaNombre, chartId);
            });

            // Ajustar el grid-template-columns basado en cuántas líneas hay
            container.innerHTML = `<div class="fibra-grid" style="grid-template-columns: repeat(${lineasOrdenadas.length}, 1fr);">${gridHtml}</div>`;

            // 6. Crear las gráficas y guardarlas en el array
            lineasOrdenadas.forEach((lineaNombre, index) => {
                const chartId = `fibraPieChart${index}`;
                const dataDeLinea = datosPorLinea.get(lineaNombre) || [];
                const newChart = createPieChart(chartId, dataDeLinea);
                if (newChart) {
                    fiberPieCharts.push(newChart); // Guardar la instancia
                }
            });
            
	        // --- FIN DE LA MODIFICACIÓN DINÁMICA ---
            
            updateChartTheme();
        }

        function updateChartTheme() {
    const charts = [productionChart, ...fiberPieCharts, production20Chart, productionDailyChart, weeklyProductionChart, graficaSemanalDailyInstance, productionCalidadChart, graficaSemanalCalidadInstance, liveProductionChart, graficaSemanalInstance].filter(Boolean);
    if (charts.length === 0) return;
    const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
    const tickColor = getComputedStyle(document.body).getPropertyValue('--chart-tick-color').trim();
    const gridColor = getComputedStyle(document.body).getPropertyValue('--chart-grid-color').trim();
    const successColor = getComputedStyle(document.body).getPropertyValue('--success-color').trim();
    
    charts.forEach(chart => {
        if (chart.options.plugins.legend) chart.options.plugins.legend.labels.color = textColor;
        if (chart.options.plugins.title) chart.options.plugins.title.color = textColor;
        if(chart.config.type.includes('bar') || chart.config.type.includes('line')) {
            if (chart.options.plugins.datalabels) {
                if(chart.options.plugins.datalabels.labels) {
                    if(chart.options.plugins.datalabels.labels.terminaciones) chart.options.plugins.datalabels.labels.terminaciones.color = textColor;
                } else if (chart.options.plugins.datalabels.color !== 'white') {
                    chart.options.plugins.datalabels.color = textColor;
                }
            }
            if (chart.data.datasets.some(ds => ds.type === 'line')) {
                let lineDataset = chart.data.datasets.find(ds => ds.type === 'line');
                if (lineDataset) lineDataset.borderColor = successColor;
            }
            // El bloque que causaba el problema ha sido eliminado de aquí.
            if (chart.options.scales.x) { chart.options.scales.x.ticks.color = tickColor; chart.options.scales.x.grid.color = gridColor; }
            if (chart.options.scales.y) { chart.options.scales.y.ticks.color = tickColor; chart.options.scales.y.grid.color = gridColor; }
            if (chart.options.scales.y.title) chart.options.scales.y.title.color = tickColor;
        }
        chart.update();
    });
}

async function exportarReporteCompleto() {
    const wrapper = document.getElementById('exportWrapper');
    const modalContent = document.getElementById('modalContent'); // Necesitamos el padre para ocultar los tabs
    const btn = document.getElementById('exportarReporteCompletoBtn');
    
    if (!wrapper) return;

    // 1. Preparar UI para la foto
    btn.disabled = true;
    const originalText = btn.innerHTML;
    btn.innerHTML = '📸'; // Indicador visual

    // Añadimos clases para cambiar el layout
    modalContent.classList.add('export-mode-parent'); // Para ocultar tabs
    wrapper.classList.add('export-mode'); // Para reacomodar gráfica y ranking
    
    // IMPORTANTE: Forzar redimensionamiento de la gráfica para que llene el nuevo espacio
    if (graficaSemanalInstance) {
        graficaSemanalInstance.resize();
    }

    // Esperamos un poco para que el navegador procese los cambios de estilo y la gráfica se redibuje
    await new Promise(r => setTimeout(r, 800));

    // Definir color de fondo (para evitar transparencias raras)
    const isDark = document.body.classList.contains('dark-theme');
    const bgColor = isDark ? '#1f2937' : '#ffffff';

    try {
        // 2. Capturar con html2canvas
        // Usamos window.scrollTo para evitar problemas si el usuario bajó en la página
        const scrollY = window.scrollY;
        
        const canvas = await html2canvas(wrapper, {
            backgroundColor: bgColor,
            scale: 2, // Doble resolución para que se vea nítido
            useCORS: true,
            logging: false,
            width: 1200, // Coincide con el CSS
            windowWidth: 1200,
            onclone: (clonedDoc) => {
                // Truco: Asegurar que en el clon todo sea visible
                const clonedWrapper = clonedDoc.getElementById('exportWrapper');
                clonedWrapper.style.display = 'grid';
            }
        });

        // 3. Descargar
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        
        const fInicio = document.getElementById('semanal_fecha_inicio').value;
        const fFin = document.getElementById('semanal_fecha_fin').value;
        link.download = `Reporte_Semanal_Completo_${fInicio}_al_${fFin}.jpg`;
        link.click();

    } catch (e) {
        console.error("Error al exportar reporte completo:", e);
        alert("Hubo un error al generar la imagen. Intenta de nuevo.");
    } finally {
        // 4. Restaurar UI (Super importante)
        wrapper.classList.remove('export-mode');
        modalContent.classList.remove('export-mode-parent');
        
        // Regresar la gráfica a su tamaño normal
        if (graficaSemanalInstance) {
            graficaSemanalInstance.resize();
        }
        
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}


        function exportChartAsJPG() {
            const chartContainer = doc('chartContainer');
            if (!productionChart || !chartContainer) { showModal('Error', '<p>No hay una gráfica para exportar.</p>'); return; }
            const exportBtn = doc('exportChartBtn');
            exportBtn.style.visibility = 'hidden';
            const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const bgColor = theme === 'dark' ? '#2a2d32' : '#f9fafb';
            html2canvas(chartContainer, { backgroundColor: bgColor, scale: 2.5, useCORS: true })
            .then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                const fecha = doc('prod_fecha_inicio').value || 'fecha';
                const turno = doc('prod_turno').value;
                link.download = `Reporte_Produccion_${turno}_${fecha}.jpg`;
                link.click();
            }).finally(() => { exportBtn.style.visibility = 'visible'; });
        }
        
        function exportarSemanalComoJPG() {
            const container = doc('semanalContainer');
            if (!weeklyProductionChart || !container) {
                showModal('Error', '<p>No hay una gráfica semanal para exportar. Genere el reporte primero.</p>');
                return;
            }
            
            const exportBtn = doc('exportarSemanalBtn');
            exportBtn.style.visibility = 'hidden';

            const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const bgColor = theme === 'dark' ? '#22252a' : '#f9fafb';

            html2canvas(container, { backgroundColor: bgColor, scale: 2, useCORS: true })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    
                    const fechaInicio = doc('prod_fecha_inicio').value;
                    const fechaFin = doc('prod_fecha_fin').value;
                    
                    link.download = `Reporte_Semanal_Produccion_${fechaInicio}_al_${fechaFin}.jpg`;
                    link.click();
                }).finally(() => {
                    exportBtn.style.visibility = 'visible';
                });
        }
        

        // --- INICIO: LÓGICA REPORTE TERMINACIONES ---
        async function processTerminacionesReport(){/*...tu código original...*/ }
        function evaluateFormula(formula, row){/*...tu código original...*/ }
        function evaluateAuto(type, row){/*...tu código original...*/ }
        function renderTerminacionesTable(data){/*...tu código original...*/ }
        function filterTerminacionesTable(){/*...tu código original...*/ }
        window.copyToClipboard = (text, element) => {/*...tu código original...*/};
        function renderTerminacionesSummary(data){/*...tu código original...*/ }
        function exportSummaryAsJPG(){/*...tu código original...*/ }
        // --- FIN: LÓGICA REPORTE TERMINACIONES ---


        // --- INICIO: LÓGICA REPORTE 901 ---
        async function handle901File(file) {
            const config = params['901_config'];
            if (!config.columns || config.columns.length === 0) { showModal('Error de Configuración', `<p>Por favor, configure el mapeo de columnas para el reporte 901.</p>`); return; }
            const dateColumnMap = config.columns.find(p => p.key.toLowerCase() === 'fecha');
            const userColumnMap = config.columns.find(p => p.key.toLowerCase() === 'usuario');
            if (!dateColumnMap) { showModal('Error de Configuración', `<p>Debe existir una columna llamada "Fecha" en el mapeo.</p>`); return; }
            if (config.userFilter && config.userFilter.length > 0 && !userColumnMap) { showModal('Error de Configuración', `<p>Se especificaron filtros de usuario, pero no hay una columna mapeada como "Usuario".</p>`); return; }
            const allowedUsers = (config.userFilter || []).map(u => u.toUpperCase());
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]]; const range = XLSX.utils.decode_range(ws['!ref']);
                    const extractedData = []; const today = new Date(); today.setHours(0, 0, 0, 0);
                    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                        const dateCol = dateColumnMap.startCell.match(/[A-Z]+/)[0];
                        const dateCell = ws[dateCol + (R + 1)];
                        if (!dateCell || !dateCell.v) continue;
                        let rowDate = dateCell.t === 'n' ? excelSerialToDateObject(dateCell.v) : dateCell.v instanceof Date ? dateCell.v : null;
                        if (!rowDate) continue; rowDate.setHours(0,0,0,0);
                        const isToday = rowDate.getTime() === today.getTime(); const isPast = rowDate.getTime() < today.getTime();
                        let userValue = '';
                        if (userColumnMap) {
                            const userCol = userColumnMap.startCell.match(/[A-Z]+/)[0]; const userCell = ws[userCol + (R + 1)];
                            userValue = (userCell ? String(userCell.v) : '').toUpperCase();
                        }
                        const userIsOnFilterList = allowedUsers.length === 0 || allowedUsers.includes(userValue);
                        if (isPast || (isToday && userIsOnFilterList)) {
                            let rowData = {};
                            config.columns.forEach(p => {
                                const cellConfig = p.startCell.trim().toUpperCase(); let value;
                                if (cellConfig.includes(',')) {
                                    const cols = cellConfig.split(',').map(c => c.trim().match(/[A-Z]+/)[0]); const values = [];
                                    cols.forEach(col => {
                                        const cell = ws[col + (R + 1)]; const cellValue = cell ? (cell.w || cell.v) : undefined;
                                        if (cellValue !== undefined && cellValue !== null && cellValue !== 0 && String(cellValue).trim() !== '') values.push(cellValue);
                                    }); value = values.join(' / ');
                                } else {
                                    const col = cellConfig.match(/[A-Z]+/)[0]; const cell = ws[col + (R + 1)];
                                    value = cell ? (cell.w || cell.v) : undefined;
                                }

                                if (p.key.toLowerCase() === 'qty' && value !== undefined && value !== null) {
                                    const num = parseInt(value, 10);
                                    if (!isNaN(num)) {
                                        value = num;
                                    }
                                }

                                if (p.key.toLowerCase().includes('special stock')) {
                                    if (value === 0 || value === '0') {
                                        value = '';
                                    }
                                }
                                rowData[p.key] = value;
                            });
                            if (userIsOnFilterList) {
                                if (isToday) rowData.colorClass = 'row-today';
                                else if (rowDate.getTime() === yesterday.getTime()) rowData.colorClass = 'row-yesterday';
                                else rowData.colorClass = 'row-past';
                            }
                            extractedData.push(rowData);
                        }
                    }
                    if(extractedData.length === 0){ showModal('Sin Coincidencias', '<p>No se encontraron registros que cumplan con los filtros.</p>'); renderTable901([]); return; }
                    renderTable901(extractedData);
                    showModal('Éxito', `<p>${extractedData.length} registros han sido cargados.</p>`);
                } catch (err) { console.error("Error al procesar archivo 901:", err); showModal('Error de Archivo', `<p>No se pudo procesar el archivo. Verifique el formato y la configuración.</p>`) }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTable901(data) {
            const tableElement = doc('dataTable901'); const paramConfig = params['901_config'].columns;
            if (!paramConfig || !paramConfig.length) { tableElement.innerHTML = `<thead><tr><th>Por favor, configure el mapeo de columnas.</th></tr></thead><tbody></tbody>`; return; }
            const headers = paramConfig.map(p => p.key); let html = '<thead><tr>';
            headers.forEach(h => html += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
            html += '</tr></thead><tbody>';
            data.forEach(row => {
                html += `<tr class="${row.colorClass || ''}">`;
                headers.forEach(header => {
                    const value = row[header] ?? '';
                    if (header.toUpperCase() === 'GR') html += `<td class="copyable" onclick="copyToClipboard('${String(value).replace(/'/g, "\\'")}', this)" title="Haz clic para copiar">${value}</td>`;
                    else html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            tableElement.innerHTML = html + '</tbody>';
            tableElement.querySelectorAll('.filter-input').forEach(input => { input.addEventListener('keyup', () => filterTable901()); });
        }

        function filterTable901() {
            const table = doc('dataTable901');
            const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({ columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')), value: i.value.toLowerCase() }));
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                let shouldShow = true;
                filters.forEach(filter => { if (filter.value) { const cell = row.children[filter.columnIndex]; if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) shouldShow = false; } });
                row.style.display = shouldShow ? '' : 'none';
            });
        }



 // --- INICIO: LÓGICA REPORTE TARIMAS CONFIRMADAS ---
        
// --- FUERA DEL DOMContentLoaded ---

// --- AJUSTE: Función consultarTarimas con FILTRO DE ÁREA ---
async function consultarTarimas() {
    const fechaInput = doc('prodTarimas_fecha').value;
    const turnoSeleccionado = doc('prodTarimas_turno').value;
    const areaSeleccionada = doc('prodTarimas_area').value; // <-- OBTENEMOS EL ÁREA SELECCIONADA

    // Validamos que todos los campos necesarios tengan valor
    if (!fechaInput || !turnoSeleccionado || !areaSeleccionada) {
        showModal('Datos Requeridos', '<p>Por favor, seleccione fecha, turno y área.</p>');
        return;
    }

    const btn = doc('consultarTarimasBtn');
    if (!btn) {
        console.error("[Consultar Tarimas] Botón #consultarTarimasBtn no encontrado.");
        return;
    }
    btn.disabled = true;
    btn.textContent = `Consultando ${turnoSeleccionado} (${areaSeleccionada === 'ALL' ? 'Todas' : areaSeleccionada})...`;

    const parts = fechaInput.split('-');
    const fechaSeleccionadaStr_render = `${parts[2]}/${parts[1]}/${parts[0]}`;
    const fechaSeleccionadaStr_compare = `${parts[0]}-${parts[1]}-${parts[2]}`;
    console.log(`[Tarimas] Buscando fecha: ${fechaSeleccionadaStr_compare}, Turno: ${turnoSeleccionado}, Área: ${areaSeleccionada}`);

    const dashboardContainer = doc('terminacionesDashboardContainer');
    const tableContainer = doc('tarimasTableContainer');
    const tableElement = doc('dataTableTarimas');

    if (dashboardContainer) dashboardContainer.style.display = 'none';
    if (!tableContainer || !tableElement) {
        console.error("[Consultar Tarimas] Contenedor #tarimasTableContainer o tabla #dataTableTarimas no encontrado.");
        showModal('Error Interno', '<p>No se pudo encontrar la tabla de resultados.</p>');
        btn.disabled = false; btn.textContent = 'Consultar Tarimas';
        return;
    }
    tableContainer.style.display = 'flex';
    tableElement.innerHTML = '<thead><tr><th>Consultando tarimas...</th></tr></thead><tbody></tbody>';

    try {
        // --- CONSTRUCCIÓN DE LA CONSULTA CON FILTRO DE ÁREA ---
        let query = db.collection('tarimas_confirmadas');

        // Aplicar filtro de área SI NO es "Todas"
        if (areaSeleccionada !== 'ALL') {
            query = query.where('area', '==', areaSeleccionada);
            console.log(`[Tarimas] Aplicando filtro de área: ${areaSeleccionada}`);
        } else {
            console.log(`[Tarimas] Consultando todas las áreas.`);
        }
        
        // Obtenemos los límites de fecha/hora para el turno
        const { startTime, endTime } = getShiftDateRange(fechaInput, turnoSeleccionado);
        
        // Aplicamos los filtros de fecha (ESTOS SON NECESARIOS para optimizar)
        query = query.where('fecha', '>=', startTime).where('fecha', '<=', endTime);

        // --- FIN CONSTRUCCIÓN DE CONSULTA ---

        const palletsSnapshot = await query.get(); // Ejecutamos la consulta construida

        // El resto de la lógica para procesar el snapshot y filtrar por turno permanece igual
        if (palletsSnapshot.empty) {
             // Si el área específica no tuvo tarimas en ese rango de fecha, puede ser normal
            throw new Error(`No se encontraron tarimas confirmadas para el turno ${turnoSeleccionado} en la fecha ${fechaSeleccionadaStr_render} ${areaSeleccionada !== 'ALL' ? ' en el área ' + areaSeleccionada : ''}.`);
        }

        let tarimasDelTurno = [];
        palletsSnapshot.docs.forEach(docSnap => {
            const palletData = docSnap.data();
             // Doble verificación por si el filtro de fecha/hora no fue exacto (raro, pero seguro)
            if (!palletData || typeof palletData !== 'object' || !palletData.fecha || typeof palletData.fecha.toDate !== 'function' || !palletData.folio || !palletData.gafete || !Array.isArray(palletData.cajas) || palletData.cajas.length === 0) return;
            try {
                const palletConfirmationDate = palletData.fecha.toDate();
                const { shift, dateKey } = getWorkShiftAndDate(palletConfirmationDate);
                 // Verificamos que coincida EXACTAMENTE con el turno y la fecha clave
                if (dateKey === fechaSeleccionadaStr_compare && shift === turnoSeleccionado) {
                    tarimasDelTurno.push({
                        id: docSnap.id, cajas: palletData.cajas, folio: palletData.folio,
                        gafete: palletData.gafete, confirmationDate: palletConfirmationDate,
                        // Añadimos el área guardada en la tarima para usarla después si es necesario
                        area: palletData.area || 'Indefinida' 
                    });
                }
            } catch (e) { console.error(`[Tarimas] Error procesando fecha/turno Tarima ID ${docSnap.id}:`, e); }
        });

        if (tarimasDelTurno.length === 0) {
            // Esto puede pasar si las tarimas encontradas por fecha/hora no eran del turno exacto
             throw new Error(`No se encontraron tarimas confirmadas para el turno ${turnoSeleccionado} en la fecha ${fechaSeleccionadaStr_render} ${areaSeleccionada !== 'ALL' ? ' en el área ' + areaSeleccionada : ''} (verificación post-consulta).`);
        }
        console.log(`[Tarimas] ${tarimasDelTurno.length} tarimas encontradas para procesar.`);

        // --- Procesamiento de BXID (SIN CAMBIOS) ---
        const palletPromises = tarimasDelTurno.map(async (tarima) => {
            const totalCajas = tarima.cajas.length;
            const bxidList = tarima.cajas
                .map(box => box?.codigoCaja ? String(box.codigoCaja).trim() : null)
                .filter(bxid => bxid);

            let receivedCount = 0;
            let bxidDetailsMap = new Map();
            let latestReceivedAt = null;

            if (bxidList.length > 0) {
                try {
                    const readPromises = bxidList.map(bxid => db.collection('boxID_historico').doc(bxid).get());
                    const bxidSnapshots = await Promise.all(readPromises);

                    bxidSnapshots.forEach((snap, index) => {
                        const searchedBxid = bxidList[index];
                        if (snap.exists) {
                            receivedCount++;
                            const bxData = snap.data();
                            const receivedDate = bxData.receivedAt && typeof bxData.receivedAt.toDate === 'function'
                                ? bxData.receivedAt.toDate() : null;
                            bxidDetailsMap.set(searchedBxid, { found: true, gr: bxData.gr || 'N/A', receivedAt: receivedDate });
                            if (receivedDate && (!latestReceivedAt || receivedDate > latestReceivedAt)) { latestReceivedAt = receivedDate; }
                        } else {
                            bxidDetailsMap.set(searchedBxid, { found: false, gr: 'N/A', receivedAt: null });
                        }
                    });
                } catch (bxidError) { /* ... manejo de error sin cambios ... */ }
            } else { /* ... manejo de tarima sin BXIDs válidos ... */ }

            const finalBxidDetails = tarima.cajas.map(boxInfo => { /* ... mapeo sin cambios ... */
                 if (!boxInfo || typeof boxInfo !== 'object') {
                     return { bxid: 'Inválido', orden: 'N/A', gr: 'N/A', receivedAt: null };
                 }
                 const bxid = boxInfo.codigoCaja ? String(boxInfo.codigoCaja).trim() : null;
                 const lookupResult = bxid ? (bxidDetailsMap.get(bxid) || { found: false, gr: 'N/A', receivedAt: null }) : { found: false, gr: 'N/A', receivedAt: null };
                 return { bxid: boxInfo.codigoCaja || 'N/A', orden: boxInfo.numeroOrden || 'N/A', gr: lookupResult.gr, receivedAt: lookupResult.receivedAt };
            });

            let status = 'status-rojo';
            let statusText = 'No Recibida';
            const validBxidCount = bxidList.length;

            if (validBxidCount === 0 && totalCajas > 0) { statusText = 'Sin BXIDs Válidos'; }
            else if (receivedCount > 0 && receivedCount < validBxidCount) { status = 'status-naranja'; statusText = 'Recibida Parcial'; }
            else if (receivedCount === validBxidCount && validBxidCount > 0) { status = 'status-verde'; statusText = 'Recibida Completa'; }

            return {
                folio: tarima.folio, user: tarima.gafete, totalCajas: totalCajas,
                statusClass: status, statusText: statusText,
                confirmationDate: tarima.confirmationDate, latestReceivedAt: latestReceivedAt,
                bxidDetails: finalBxidDetails,
                // Incluimos el área de la tarima por si la necesitas mostrar en la tabla
                area: tarima.area 
            };
        });

        const processedPallets = await Promise.all(palletPromises);
        console.log("[Tarimas] Datos finales procesados:", processedPallets);
        renderTarimasTable(processedPallets);

    } catch (e) {
        console.error("[Tarimas] Error GENERAL:", e);
        const currentTable = doc('dataTableTarimas');
        if (currentTable) {
             currentTable.innerHTML = `<thead><tr><th style='color: var(--danger-color);'>Error al consultar</th></tr></thead><tbody><tr><td>${e.message}</td></tr></tbody>`;
        }
    } finally {
        const currentBtn = doc('consultarTarimasBtn');
        if(currentBtn) {
            currentBtn.disabled = false;
            currentBtn.textContent = 'Consultar Tarimas';
            console.log("[Tarimas] Botón restaurado.");
        } else {
            console.error("[Tarimas] No se pudo encontrar #consultarTarimasBtn para restaurarlo.");
        }
    }
}
// --- FIN DE LA FUNCIÓN ---
		
// --- Asegúrate que esta función esté FUERA del DOMContentLoaded ---
function renderTarimasTable(pallets) {
    const table = doc('dataTableTarimas');
    if (!table) {
        console.error("[Render Tarimas] Error: Elemento #dataTableTarimas no encontrado.");
        return;
    }

    if (!pallets || pallets.length === 0) {
        table.innerHTML = `<thead><tr><th>No se encontraron tarimas para esta fecha y turno.</th></tr></thead><tbody></tbody>`;
        return;
    }

    // --- AJUSTE: AÑADIMOS 'ÁREA' AL HEADER ---
    const headers = ['Folio', 'Usuario', 'Área', 'Hora Confirmación', 'Recibido Logística (Último)', 'Estatus', 'Cajas', 'Detalles'];
    let headerHtml = '<thead><tr>';
    headers.forEach((h, index) => {
        let styles = 'padding: 12px 10px; text-align: left; white-space: nowrap;';
        // --- AJUSTE: Añadimos 'Área' al centrado ---
        if (['Área', 'Hora Confirmación', 'Recibido Logística (Último)', 'Estatus', 'Cajas', 'Detalles'].includes(h)) {
            styles += ' text-align: center;';
        }
        headerHtml += `<th style="${styles}"><span>${h}</span></th>`;
    });
    headerHtml += '</tr></thead>';

    let bodyHtml = '<tbody>';
    pallets.sort((a, b) => (a.folio || '').localeCompare(b.folio || ''));

    pallets.forEach((pallet, index) => {
        const confirmationTime = pallet.confirmationDate
            ? pallet.confirmationDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false })
            : 'N/A';
        const latestReceivedFormatted = pallet.latestReceivedAt
            ? formatShortDateTime(pallet.latestReceivedAt)
            : 'Pendiente';

        const detailsButtonHtml = `<button class="btn btn-glass btn-small view-details-btn"
                                           data-index="${index}"
                                           aria-label="Ver detalles de tarima ${pallet.folio}">
                                       Ver <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                   </button>`;

        bodyHtml += `<tr style="border-bottom: 1px solid var(--border-color);">`;
        bodyHtml += `<td style="padding: 10px 10px; font-weight: bold;">${pallet.folio}</td>`;
        bodyHtml += `<td style="padding: 10px 10px;">${pallet.user}</td>`;
        bodyHtml += `<td style="padding: 10px 10px; text-align: center;">${pallet.area}</td>`; // <-- ¡NUEVA CELDA!
        bodyHtml += `<td style="padding: 10px 10px; text-align: center;">${confirmationTime}</td>`;
        bodyHtml += `<td style="padding: 10px 10px; text-align: center;">${latestReceivedFormatted}</td>`;
        bodyHtml += `<td style="padding: 10px 10px; text-align: center;"><span class="status-dot ${pallet.statusClass}"></span> ${pallet.statusText}</td>`;
        bodyHtml += `<td style="padding: 10px 10px; text-align: center; font-weight: bold;">${pallet.totalCajas}</td>`;
        bodyHtml += `<td style="padding: 10px 10px; text-align: center;">${detailsButtonHtml}</td>`;
        bodyHtml += `</tr>`;
    });

    bodyHtml += '</tbody>';
    table.innerHTML = headerHtml + bodyHtml;

    table.querySelectorAll('.view-details-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const index = parseInt(event.currentTarget.dataset.index, 10);
            if (pallets && pallets[index]) {
                const palletData = pallets[index];
                try {
                    const detailsCopy = JSON.parse(JSON.stringify(palletData.bxidDetails));
                    showBoxDetailsModal(detailsCopy, palletData.statusText, palletData.folio);
                } catch (e) {
                     console.error("Error al preparar datos para el modal:", e);
                     showModal('Error', '<p>No se pudieron cargar los detalles (error de datos).</p>');
                }
            } else {
                console.error("[Render Tarimas] Datos de 'pallets' no disponibles para el índice:", index);
                showModal('Error', '<p>No se pudieron cargar los detalles (datos no encontrados).</p>');
            }
        });
    });
}
// --- NUEVA FUNCIÓN PARA MOSTRAR EL MODAL ---
function showBoxDetailsModal(bxidDetails, statusText, folio) {
    console.log("[Modal Detalle] Abriendo para Folio:", folio, " Estado:", statusText, " Datos:", bxidDetails);

    // --- VERIFICACIÓN INICIAL ---
    if (!Array.isArray(bxidDetails)) {
        console.error("[Modal Detalle] Error: bxidDetails no es un array.");
        showModal('Error Interno', '<p>Los datos de las cajas son inválidos.</p>');
        return;
    }
    // --- FIN VERIFICACIÓN ---

    try {
        const detailsWithDates = bxidDetails.map(bx => {
            // --- VERIFICACIÓN EXTRA POR CADA CAJA ---
            if (!bx) {
                console.warn("[Modal Detalle] Se encontró un elemento 'undefined' en bxidDetails.");
                return { // Devolver un objeto por defecto para evitar errores posteriores
                    bxid: 'Inválido',
                    orden: 'N/A',
                    gr: 'N/A',
                    receivedAt: null
                };
            }
            // --- FIN VERIFICACIÓN EXTRA ---

            let receivedDate = null;
            if (bx.receivedAt) { // Solo procesar si receivedAt existe en el objeto bx
                if (typeof bx.receivedAt.toDate === 'function') {
                    receivedDate = bx.receivedAt.toDate();
                } else if (typeof bx.receivedAt === 'string') {
                    const parsedDate = new Date(bx.receivedAt);
                    if (!isNaN(parsedDate)) {
                        receivedDate = parsedDate;
                    } else {
                        console.warn(`[Modal Detalle] No se pudo convertir string a fecha: ${bx.receivedAt}`);
                    }
                } else if (Object.prototype.toString.call(bx.receivedAt) === '[object Date]' && !isNaN(bx.receivedAt)) {
                    receivedDate = bx.receivedAt;
                } else {
                     console.warn(`[Modal Detalle] Formato de fecha no reconocido para BXID ${bx.bxid}:`, bx.receivedAt);
                }
            }
            // Asegurarse de devolver todas las propiedades esperadas, incluso si faltaban en el original
            return {
                bxid: bx.bxid || 'N/A',
                orden: bx.orden || 'N/A',
                gr: bx.gr || 'N/A',
                receivedAt: receivedDate // Será Date o null
            };
        });

        // ... (resto del código para generar modalContentHtml y llamar a showModal - SIN CAMBIOS) ...
        let modalContentHtml = `<p style="text-align:center; font-size:0.9em; color: var(--text-secondary);">Mostrando ${detailsWithDates.length} cajas para Tarima: <strong>${folio}</strong></p>`;
        modalContentHtml += `<ul style="list-style-type: none; padding: 0; max-height: 60vh; overflow-y: auto;">`;

        detailsWithDates.forEach(bx => {
            const isValidDate = bx.receivedAt instanceof Date && !isNaN(bx.receivedAt);
            const isMissing = statusText === 'Recibida Parcial' && !isValidDate;
            const itemClass = isMissing ? 'missing-bxid' : '';
            const receivedFormatted = isValidDate ? formatShortDateTime(bx.receivedAt) : 'Pendiente';
            const statusClassDot = isValidDate ? 'status-verde' : 'status-rojo';

            modalContentHtml += `<li class="${itemClass}" style="margin-bottom: 8px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--surface-color); display: flex; align-items: center; gap: 8px;">
                                  <span class="status-dot ${statusClassDot}" style="flex-shrink: 0;"></span>
                                  <div style="flex-grow: 1; font-size: 0.9em;">
                                    <strong style="color: var(--text-primary);">BXID:</strong> ${bx.bxid}<br>
                                    <strong>Orden:</strong> ${bx.orden} |
                                    <strong>GR:</strong> ${bx.gr} |
                                    <strong>Recibido:</strong> ${receivedFormatted}
                                  </div>
                               </li>`;
        });

        modalContentHtml += `</ul>`;
        showModal(`Detalle de Cajas - Tarima ${folio}`, modalContentHtml);

     } catch (error) {
         console.error("[Modal Detalle] Error construyendo modal:", error);
         showModal('Error', '<p>No se pudieron mostrar los detalles de las cajas. Revisa la consola.</p>');
     }
}
	   
// --- PONER ESTA FUNCIÓN FUERA DEL DOMContentLoaded ---
// --- FUERA DEL DOMContentLoaded ---

// --- FUERA DEL DOMContentLoaded ---

// --- AJUSTE: Función consultarTerminacionesConfirmadas con FILTRO DE ÁREA en la consulta ---
async function consultarTerminacionesConfirmadas() {
    const fechaInput = doc('prodTarimas_fecha').value;
    const turnoSeleccionado = doc('prodTarimas_turno').value;
    const areaSeleccionada = doc('prodTarimas_area').value;

    if (!fechaInput || !turnoSeleccionado || !areaSeleccionada) {
        showModal('Datos Requeridos', '<p>Por favor, seleccione fecha, turno y área.</p>');
        return;
    }

    const btn = doc('calcularTerminacionesDiaBtn');
    if (!btn) return;
    btn.disabled = true;
    btn.textContent = `Calculando ${turnoSeleccionado} (${areaSeleccionada === 'ALL' ? 'Todas' : areaSeleccionada})...`;
    orderDataCache.clear(); 

    const parts = fechaInput.split('-');
    const fechaSeleccionadaStr_render = `${parts[2]}/${parts[1]}/${parts[0]}`;
    const fechaSeleccionadaStr_compare = `${parts[0]}-${parts[1]}-${parts[2]}`;
    console.log(`[TermConf] Calculando para Fecha: ${fechaSeleccionadaStr_compare}, Turno: ${turnoSeleccionado}, Área: ${areaSeleccionada}`);

    const dashboardContainer = doc('terminacionesDashboardContainer');
    const tableContainer = doc('tarimasTableContainer'); 

    if (tableContainer) tableContainer.style.display = 'none'; 
    if (!dashboardContainer) {
        console.error("[TermConf] Elemento #terminacionesDashboardContainer no encontrado.");
        showModal('Error Interno', '<p>No se pudo encontrar el contenedor del dashboard.</p>');
        btn.disabled = false; btn.textContent = 'Calcular Terminaciones del Turno';
        return;
    }
    dashboardContainer.innerHTML = '<p style="text-align:center;">Consultando tarimas...</p>'; 
    dashboardContainer.style.display = 'block';

    let granTotalTerminaciones = 0; 
    let totalTarimasProcesadas = 0;
    let totalCajasConsultadas = 0;
    let ordenesConsultadas = new Set();
    let ordenesConDatos = new Set();
    let cajasProcesadasConTerminaciones = 0;
    const summaryByOrderCatalog = {};

    try {
        // --- ¡AQUÍ ESTÁ EL AJUSTE! ---
        // 1. Construir la consulta base
        let query = db.collection('tarimas_confirmadas');

        // 2. Aplicar filtro de área SI NO es "Todas"
        if (areaSeleccionada !== 'ALL') {
            query = query.where('area', '==', areaSeleccionada);
            console.log(`[TermConf] Aplicando filtro de área en consulta: ${areaSeleccionada}`);
        } else {
            console.log(`[TermConf] Consultando tarimas de todas las áreas.`);
        }
        
        // 3. Aplicar filtros de fecha/hora para optimizar
        const { startTime, endTime } = getShiftDateRange(fechaInput, turnoSeleccionado);
        query = query.where('fecha', '>=', startTime).where('fecha', '<=', endTime);
        // --- FIN DEL AJUSTE ---

        // 4. Ejecutar la consulta (ahora potencialmente filtrada por área)
        const palletsSnapshot = await query.get();

        if (palletsSnapshot.empty) {
            throw new Error(`No se encontraron tarimas confirmadas para el turno ${turnoSeleccionado} en la fecha ${fechaSeleccionadaStr_render}${areaSeleccionada !== 'ALL' ? ' en el área ' + areaSeleccionada : ''}.`);
        }

        let tarimasDelTurno = [];
        palletsSnapshot.docs.forEach(docSnap => {
            const palletData = docSnap.data();
            if (!palletData || typeof palletData !== 'object' || !palletData.fecha || typeof palletData.fecha.toDate !== 'function' || !palletData.folio || !palletData.gafete || !Array.isArray(palletData.cajas) || palletData.cajas.length === 0) return;
            try {
                const palletConfirmationDate = palletData.fecha.toDate();
                const { shift, dateKey } = getWorkShiftAndDate(palletConfirmationDate);
                
                // 5. Doble verificación de turno/fecha
                if (dateKey === fechaSeleccionadaStr_compare && shift === turnoSeleccionado) {
                    tarimasDelTurno.push({
                        folio: palletData.folio,
                        cajas: palletData.cajas,
                        // ¡Importante! Guardamos el área de la tarima para la lógica de cálculo
                        area: palletData.area || (areaSeleccionada !== 'ALL' ? areaSeleccionada : 'Indefinida') 
                    });
                }
            } catch { /* Ignorar */ }
        });

        if (tarimasDelTurno.length === 0) {
             throw new Error(`No se encontraron tarimas confirmadas para el turno ${turnoSeleccionado} en la fecha ${fechaSeleccionadaStr_render}${areaSeleccionada !== 'ALL' ? ' en el área ' + areaSeleccionada : ''} (verificación post-consulta).`);
        }
        totalTarimasProcesadas = tarimasDelTurno.length;
        console.log(`[TermConf] ${totalTarimasProcesadas} tarimas encontradas (después de filtrar por área en consulta).`);
        dashboardContainer.innerHTML = `<p style="text-align:center;">Consultando datos de órdenes para ${totalTarimasProcesadas} tarimas...</p>`;

        // 6. Procesar Cajas y Órdenes
        for (const tarima of tarimasDelTurno) {
            // ¡Importante! Usamos el área de la tarima actual.
            const areaDeLaTarima = tarima.area; 

            for (const caja of tarima.cajas) {
                totalCajasConsultadas++;
                const numeroOrdenLimpio = caja.numeroOrden ? String(caja.numeroOrden).replace(/^0+/, '') : null;
                const codigoCajaActual = caja.codigoCaja ? String(caja.codigoCaja).trim() : null;

                if (numeroOrdenLimpio && codigoCajaActual) {
                    let orderData = null;
                    if (orderDataCache.has(numeroOrdenLimpio)) { 
                        orderData = orderDataCache.get(numeroOrdenLimpio); 
                    } else {
                        ordenesConsultadas.add(numeroOrdenLimpio);
                         try {
                             let orderDocRef;
                             // ¡IMPORTANTE! La búsqueda de órdenes AHORA USA el 'areaDeLaTarima'
                             if (areaDeLaTarima === 'ALL' || areaDeLaTarima === 'Indefinida' || areaDeLaTarima === 'Desconocida') {
                                 const orderQuery = await db.collectionGroup('orders').where(firebase.firestore.FieldPath.documentId(), '==', numeroOrdenLimpio).limit(1).get();
                                 if (!orderQuery.empty) orderDocRef = orderQuery.docs[0];
                             } else {
                                 const docSnapshot = await db.collection('areas').doc(areaDeLaTarima).collection('orders').doc(numeroOrdenLimpio).get();
                                 if (docSnapshot.exists) orderDocRef = docSnapshot;
                             }
                             
                             if (orderDocRef) {
                                 orderData = orderDocRef.data();
                                 if (orderData) { orderDataCache.set(numeroOrdenLimpio, orderData); ordenesConDatos.add(numeroOrdenLimpio); }
                                 else { orderDataCache.set(numeroOrdenLimpio, null); }
                             } else { orderDataCache.set(numeroOrdenLimpio, null); }
                         } catch (error) { orderDataCache.set(numeroOrdenLimpio, null); console.error(`[TermConf] Error buscando orden ${numeroOrdenLimpio}:`, error);}
                    } 

                    if (orderData && orderData.catalogNumber && Array.isArray(orderData.empaqueData)) {
                        const catalogNumber = orderData.catalogNumber;
                        
                        // 7. ¡AQUÍ USAMOS EL ÁREA DE LA TARIMA PARA EL CÁLCULO!
                        const fibras = calculateTerminaciones(catalogNumber, areaDeLaTarima); 

                        if (fibras > 0) {
                            const empaqueCaja = orderData.empaqueData.find(e => e.boxId === codigoCajaActual);
                            if (empaqueCaja && Array.isArray(empaqueCaja.serials)) {
                                const piezas = empaqueCaja.serials.length;
                                if (piezas > 0) {
                                    const terminacionesCaja = piezas * fibras;
                                    granTotalTerminaciones += terminacionesCaja;
                                    cajasProcesadasConTerminaciones++;
                                    
                                    if (!summaryByOrderCatalog[numeroOrdenLimpio]) { summaryByOrderCatalog[numeroOrdenLimpio] = {}; }
                                    if (!summaryByOrderCatalog[numeroOrdenLimpio][catalogNumber]) { summaryByOrderCatalog[numeroOrdenLimpio][catalogNumber] = { piezas: 0, terminaciones: 0 }; }
                                    summaryByOrderCatalog[numeroOrdenLimpio][catalogNumber].piezas += piezas;
                                    summaryByOrderCatalog[numeroOrdenLimpio][catalogNumber].terminaciones += terminacionesCaja;
                                }
                            }
                        }
                    }
                }
            }
        }

        console.log(`[TermConf] Cálculo finalizado. Total Terminaciones: ${granTotalTerminaciones}. Órdenes buscadas: ${ordenesConsultadas.size}. Órdenes con datos: ${ordenesConDatos.size}. Cajas sumadas: ${cajasProcesadasConTerminaciones}/${totalCajasConsultadas}.`);
        renderTerminacionesDashboard(granTotalTerminaciones, totalTarimasProcesadas, totalCajasConsultadas, fechaSeleccionadaStr_render, turnoSeleccionado, areaSeleccionada, summaryByOrderCatalog);

    } catch (e) {
        console.error("[TermConf] Error:", e);
        const currentDashboard = doc('terminacionesDashboardContainer');
        if (currentDashboard) {
            currentDashboard.innerHTML = `<h4 style='color: var(--danger-color); text-align: center;'>Error</h4><p style='text-align: center;'>${e.message}</p>`;
            currentDashboard.style.display = 'block';
        }
    } finally {
         const currentBtn = doc('calcularTerminacionesDiaBtn');
         if (currentBtn) { currentBtn.disabled = false; currentBtn.textContent = 'Calcular Terminaciones del Turno'; }
    }
}

// --- NUEVA FUNCIÓN PARA RENDERIZAR EL DASHBOARD ---
function renderTerminacionesDashboard(totalTerminaciones, numTarimas, numCajas, fecha, turno, area, summaryData) { // <-- Añadido summaryData
    const container = doc('terminacionesDashboardContainer');
    if (!container) return; // Salir si el contenedor no existe

    const areaTexto = area === 'ALL' ? 'Todas las Áreas' : `Área ${area}`;

    // --- HTML para las tarjetas superiores (sin cambios) ---
    let dashboardHtml = `
        <h4 style="margin-top: 0; margin-bottom: 20px; text-align: center; color: var(--text-primary);">
            Resumen Terminaciones (${fecha} - Turno ${turno} - ${areaTexto})
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 25px;">
            <div style="background-color: var(--surface-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                <span style="font-size: 1.8em; font-weight: bold; color: var(--primary-color); display: block;">
                    ${totalTerminaciones.toLocaleString()}
                </span>
                <span style="font-size: 0.9em; color: var(--text-secondary); display: block;">
                    Terminaciones Totales
                </span>
            </div>
            <div style="background-color: var(--surface-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                <span style="font-size: 1.8em; font-weight: bold; color: var(--text-primary); display: block;">
                    ${numTarimas.toLocaleString()}
                </span>
                <span style="font-size: 0.9em; color: var(--text-secondary); display: block;">
                    Tarimas Confirmadas
                </span>
            </div>
             <div style="background-color: var(--surface-color); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                <span style="font-size: 1.8em; font-weight: bold; color: var(--text-primary); display: block;">
                    ${numCajas.toLocaleString()}
                </span>
                <span style="font-size: 0.9em; color: var(--text-secondary); display: block;">
                    Cajas Registradas
                </span>
            </div>
        </div>
    `;

    // --- NUEVO: Generar HTML para el resumen por Orden/Catálogo ---
    dashboardHtml += `<h5 style="margin-top: 0; margin-bottom: 15px; text-align: center; color: var(--text-secondary);">Desglose por Orden y Catálogo</h5>`;

    const ordenes = Object.keys(summaryData).sort(); // Ordenar por número de orden

    if (ordenes.length > 0) {
        // Usaremos una tabla para mejor alineación
        dashboardHtml += `<div class="table-wrapper" style="max-height: 40vh; overflow-y: auto;">`; // Con scroll si es largo
        dashboardHtml += `<table style="width: 100%; table-layout: auto;">`; // table-layout: auto para ajustar columnas
        dashboardHtml += `<thead>
                            <tr>
                                <th style="text-align: left; padding: 8px 10px;">Orden</th>
                                <th style="text-align: left; padding: 8px 10px;">Catálogo</th>
                                <th style="text-align: right; padding: 8px 10px;">Piezas</th>
                                <th style="text-align: right; padding: 8px 10px;">Terminaciones</th>
                            </tr>
                         </thead><tbody>`;

        for (const orden of ordenes) {
            const catalogos = Object.keys(summaryData[orden]).sort(); // Ordenar catálogos dentro de la orden
            for (const catalogo of catalogos) {
                const data = summaryData[orden][catalogo];
                dashboardHtml += `<tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 6px 10px;">${orden}</td>
                                    <td style="padding: 6px 10px;">${catalogo}</td>
                                    <td style="text-align: right; padding: 6px 10px;">${data.piezas.toLocaleString()}</td>
                                    <td style="text-align: right; padding: 6px 10px; font-weight: bold;">${data.terminaciones.toLocaleString()}</td>
                                  </tr>`;
            }
        }

        dashboardHtml += `</tbody></table></div>`;
    } else {
        dashboardHtml += `<p style="text-align: center; color: var(--text-dark);">No se encontraron datos detallados para el resumen.</p>`;
    }
    // --- FIN NUEVO ---

    container.innerHTML = dashboardHtml; // Poner todo el HTML en el contenedor
    container.style.display = 'block'; // Mostrar el contenedor
}
		
// Mapa para cachear catálogos por número de orden
const orderCatalogCache = new Map();
const orderDataCache = new Map();

// Función para obtener catálogo (requiere acceso global a db y orderCatalogCache)
// --- FUERA DEL DOMContentLoaded ---

async function getCatalogNumberForOrder(orderNumber) {
    const cleanOrderNumber = String(orderNumber).replace(/^0+/, '');

    // Simplemente busca en la caché global
    if (orderCatalogCache.has(cleanOrderNumber)) {
        const cachedCatalog = orderCatalogCache.get(cleanOrderNumber);
        // console.log(`[TermConf Cache] Catálogo para ${cleanOrderNumber}: ${cachedCatalog || 'No encontrado (cached)'}`);
        return cachedCatalog; // Devuelve el catálogo o null si no se encontró previamente
    } else {
        // Si no está en caché, significa que no se encontró en la consulta inicial
        console.warn(`[TermConf Cache] Orden ${cleanOrderNumber} no encontrada en la caché inicial.`);
        return null;
    }
}

// Función para calcular terminaciones (requiere acceso global)
// --- AJUSTE: calculateTerminaciones AHORA ACEPTA UN ÁREA Y USA LONGITUD ---
function calculateTerminaciones(catalogNumber, area = 'Default') {
    if (!catalogNumber || typeof catalogNumber !== 'string' || catalogNumber.length < 4) return 0;

    const config = params.terminaciones_areas_config || {};
    const rules = config[area] || config['Default'] || []; 
    const catalogUpper = catalogNumber.toUpperCase();

    const sortedRules = rules.sort((a, b) => b.prefijo.length - a.prefijo.length);
    
    for (const rule of sortedRules) {
        if (rule.prefijo && catalogUpper.startsWith(rule.prefijo)) {
            // --- ¡AQUÍ ESTÁ EL AJUSTE! ---
            const longitud = rule.longitud || 1; // Default a 1 si no está definido
            const start = rule.posicion - 1;   // Posición 5 en UI es índice 4 en JS
            const end = start + longitud;      // Índice 4 + longitud 2 = extrae 4 y 5
            const digit = (catalogNumber.substring(start, end) || '').toUpperCase();
            // --- FIN DEL AJUSTE ---
            
            if (rule.t_es_12 && digit === 'T') {
                return 12;
            }
            
            const num = parseInt(digit, 10);
            const result = isNaN(num) ? 0 : num;
            return result;
        }
    }

    const wildcardRule = rules.find(r => r.prefijo === '');
    if (wildcardRule) {
        // --- ¡AQUÍ ESTÁ EL AJUSTE! ---
        const longitud = wildcardRule.longitud || 1;
        const start = wildcardRule.posicion - 1;
        const end = start + longitud;
        const digit = (catalogNumber.substring(start, end) || '').toUpperCase();
        // --- FIN DEL AJUSTE ---

        if (wildcardRule.t_es_12 && digit === 'T') return 12;
        const num = parseInt(digit, 10);
        return isNaN(num) ? 0 : num;
    }

    // 3. Fallback (lógica original si no hay reglas)
    const digit = catalogNumber.substring(3, 4).toUpperCase();
    if (digit === 'T') return 12;
    const num = parseInt(digit, 10);
    return isNaN(num) ? 0 : num;
}


		
// =======================================================================================
// --- INICIO: LÓGICA REPORTE PRODUCCIÓN CALIDAD ---
// =======================================================================================

doc('consultarProduccionCalidadBtn').addEventListener('click', consultarProduccionCalidad);
doc('abrirModalSemanalCalidadBtn').addEventListener('click', abrirModalReporteSemanalCalidad);

async function handleProduccionCalidadFile(file) {
    const config = params.produccion_calidad_config;
    if (!config || !config.columns || !config.columns.length === 0) {
        showModal('Configuración Requerida', '<p>Por favor, configure el mapeo de columnas para este reporte en el panel de configuración (icono de engrane).</p>');
        return;
    }
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: config.startRow - 1, blankrows: false });

            const colMap = {};
            config.columns.forEach(col => {
               colMap[col.key] = XLSX.utils.decode_col(col.excel_col);
            });

            const data = jsonData.map(row => {
                const rowData = {};
                config.columns.forEach(col => {
                    rowData[col.key] = row[colMap[col.key]];
                });
                return rowData;
            }).filter(row => row['Serial Number'] !== undefined && String(row['Serial Number']).trim() !== '');

            if (data.length === 0) {
                showModal('Sin Datos', `<p>No se encontraron datos válidos a partir de la fila ${config.startRow} en el archivo Excel.</p>`);
                return;
            }

            const batch = db.batch();
            let processedCount = 0;
            data.forEach(row => {
                const serial = String(row['Serial Number']).trim();
                if(serial){
                    const docRef = db.collection('produccion_calidad_historico').doc(serial);
                    let fechaHora = null;
                    if (row['Fecha y hora'] instanceof Date) {
                        fechaHora = row['Fecha y hora'];
                    } else if (typeof row['Fecha y hora'] === 'number') {
                        fechaHora = excelSerialToDateObject(row['Fecha y hora']);
                    }

                    if (fechaHora) {
                        batch.set(docRef, { ...row, 'Fecha y hora': firebase.firestore.Timestamp.fromDate(fechaHora) });
                        processedCount++;
                    }
                }
            });

            await batch.commit();

            doc('fileDropAreaProdCalidad').style.borderColor = 'var(--success-color)';
            showModal('Éxito', `<p>${processedCount} registros han sido guardados en la base de datos. Vuelva a consultar la fecha para ver los datos actualizados.</p>`);
            consultarProduccionCalidad();

        } catch (err) {
            console.error("Error al procesar y guardar archivo de Producción Calidad:", err);
            doc('fileDropAreaProdCalidad').style.borderColor = 'var(--danger-color)';
            showModal('Error de Archivo', `<p>No se pudo procesar o guardar el archivo. Verifique el formato, la configuración y la conexión a la base de datos.</p>`);
        }
    };
    reader.readAsArrayBuffer(file);
}

async function consultarProduccionCalidad() {
    const fechaInput = doc('prodCalidad_fecha').value;
    const turnoInput = doc('prodCalidad_turno').value;

    if (!fechaInput) {
        showModal('Fecha Requerida', '<p>Por favor, seleccione una fecha.</p>');
        return;
    }
    const btn = doc('consultarProduccionCalidadBtn');
    btn.disabled = true;
    btn.textContent = 'Consultando...';

    const { startTime, endTime } = getShiftDateRange(fechaInput, turnoInput);

    try {
        const snapshot = await db.collection('produccion_calidad_historico')
            .where('Fecha y hora', '>=', startTime)
            .where('Fecha y hora', '<=', endTime)
            .get();

        const data = [];
        snapshot.forEach(docSnap => {
            const docData = docSnap.data();
            const fechaHora = docData['Fecha y hora'] ? docData['Fecha y hora'].toDate() : null;
            if (fechaHora) {
                data.push({ ...docData, 'Fecha y hora': fechaHora });
            }
        });

        if (data.length === 0) {
            showModal('Sin Datos', `<p>No se encontraron registros para la fecha y turno seleccionados.</p>`);
            renderProduccionCalidadTable([]);
            renderProduccionCalidadChart([], startTime);
            return;
        }

        const processedData = data.map(row => {
            const catalogo = row['Catalogo'] || '';
            const cuartoDigito = catalogo.substring(3, 4).toUpperCase();
            const fibras = cuartoDigito === 'T' ? 12 : parseInt(cuartoDigito, 10) || 0;
            const terminaciones = fibras * (Number(row['Cantidad']) || 0);

            return { 
                ...row,
                Fibras: fibras, 
                Terminaciones: terminaciones 
            };
        });

        renderProduccionCalidadTable(processedData);
        renderProduccionCalidadChart(processedData, startTime);

    } catch (e) {
        console.error("Error consultando reporte Calidad:", e);
        showModal('Error de Consulta', `<p>No se pudo obtener el reporte de la base de datos.</p>`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Consultar Reporte';
    }
}

function renderProduccionCalidadTable(data) {
    const table = doc('dataTableProduccionCalidad');
    if (!data || data.length === 0) {
        table.innerHTML = `<thead><tr><th>Sin datos para mostrar.</th></tr></thead><tbody></tbody>`;
        return;
    }

    const headers = [...params.produccion_calidad_config.columns.map(c => c.key), 'Fibras', 'Terminaciones'];

    let headerHtml = '<thead><tr>';
    headers.forEach(h => headerHtml += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
    headerHtml += '</tr></thead>';

    let bodyHtml = '<tbody>';
    data.sort((a, b) => (b['Fecha y hora'] || 0) - (a['Fecha y hora'] || 0));

    data.forEach(row => {
        bodyHtml += `<tr>`;
        headers.forEach(header => {
            let value = row[header];
            if (header === 'Fecha y hora' && value instanceof Date) {
                value = formatShortDateTime(value);
            }
            bodyHtml += `<td>${value ?? ''}</td>`;
        });
        bodyHtml += `</tr>`;
    });
    bodyHtml += '</tbody>';
    table.innerHTML = headerHtml + bodyHtml;

    table.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('keyup', () => {
            const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({
                columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')),
                value: i.value.toLowerCase()
            }));
            table.querySelectorAll('tbody tr').forEach(row => {
                let shouldShow = true;
                filters.forEach(filter => {
                    if (filter.value) {
                        const cell = row.children[filter.columnIndex];
                        if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) {
                            shouldShow = false;
                        }
                    }
                });
                row.style.display = shouldShow ? '' : 'none';
            });
        });
    });
}

function renderProduccionCalidadChart(data, shiftStartTime) {
    const ctx = doc('produccionCalidadChart').getContext('2d');
    if (productionCalidadChart) {
        productionCalidadChart.destroy();
    }
    if (!data || data.length === 0 || !shiftStartTime) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        doc('chartSummaryCalidad').innerHTML = '';
        return;
    }

    const hourlyBins = Array.from({ length: 12 }, () => ({}));
    const totalesPorGrupo = {};
    let totalPiezas = 0;
    let granTotalTerminaciones = 0;
    
    data.forEach(item => {
        const grupo = item['Line'] || 'N/A';
        const terminaciones = Number(item['Terminaciones']) || 0;
        const piezas = Number(item['Cantidad']) || 0;
        granTotalTerminaciones += terminaciones;
        totalPiezas += piezas;

        if (!totalesPorGrupo[grupo]) {
            totalesPorGrupo[grupo] = { pzas: 0, term: 0 };
        }
        totalesPorGrupo[grupo].pzas += piezas;
        totalesPorGrupo[grupo].term += terminaciones;
        
        if (item['Fecha y hora'] instanceof Date) {
            const diffMillis = item['Fecha y hora'] - shiftStartTime;
            if (diffMillis >= 0) {
                const hourIndex = Math.floor(diffMillis / (1000 * 60 * 60));
                if (hourIndex >= 0 && hourIndex < 12) {
                    hourlyBins[hourIndex][grupo] = (hourlyBins[hourIndex][grupo] || 0) + terminaciones;
                }
            }
        }
    });

    const gruposOrdenados = Object.keys(totalesPorGrupo).sort();
    const summaryHtml = gruposOrdenados.map(grupo =>
        `${grupo}: <strong>${totalesPorGrupo[grupo].pzas.toLocaleString()} pzas</strong> / <strong>${totalesPorGrupo[grupo].term.toLocaleString()} term.</strong>`
    ).join(' | ');
    doc('chartSummaryCalidad').innerHTML = summaryHtml;

    const todosLosGrupos = Object.keys(totalesPorGrupo).sort();
    const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)'];
    const datasets = todosLosGrupos.map((grupo, index) => ({
        label: `Terminaciones ${grupo}`,
        data: hourlyBins.map(hourData => hourData[grupo] || 0),
        backgroundColor: colors[index % colors.length],
    }));

    const labels = [];
    for (let i = 0; i < 12; i++) {
        const start = new Date(shiftStartTime);
        start.setHours(start.getHours() + i);
        const end = new Date(start);
        end.setHours(end.getHours() + 1);
        const format = { hour: '2-digit', minute: '2-digit', hour12: false };
        labels.push(`${start.toLocaleTimeString([], format)} - ${end.toLocaleTimeString([], format)}`);
    }

    productionCalidadChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { color: 'var(--text-primary)'}},
                title: { display: true, text: 'Producción de Terminaciones por Hora', color: 'var(--text-primary)', font: { size: 14 }},
                // --- INICIO DEL AJUSTE ESTÉTICO PARA LAS ETIQUETAS ---
                datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'top',
                    offset: 8, // Separa la etiqueta de la barra para que no se superponga
                    backgroundColor: (context) => {
                        // Cambia el color del fondo de la etiqueta dependiendo del tema
                        return document.body.classList.contains('dark-theme') ? 'rgba(40, 43, 48, 0.75)' : 'rgba(255, 255, 255, 0.75)';
                    },
                    borderColor: (context) => context.dataset.backgroundColor, // Borde del color de la barra
                    borderWidth: 1,
                    borderRadius: 4, // Bordes redondeados
                    color: (context) => {
                        // Cambia el color del texto dependiendo del tema para mejor contraste
                        return document.body.classList.contains('dark-theme') ? '#F1F5F9' : '#111827';
                    },
                    padding: { top: 2, bottom: 2, left: 5, right: 5 },
                    font: { weight: 'bold', size: 10 },
                    formatter: (value) => value > 0 ? value.toLocaleString() : ''
                }
                // --- FIN DEL AJUSTE ESTÉTICO ---
            },
            scales: {
                // Aseguramos que las barras no estén apiladas
                x: { 
                    stacked: false, 
                    grid: { color: 'var(--chart-grid-color)' }, 
                    ticks: { color: 'var(--chart-tick-color)' } 
                },
                y: { 
                    stacked: false, 
                    beginAtZero: true, 
                    grid: { 
                        drawOnChartArea: true, // La cuadrícula se dibuja detrás de las barras
                        color: 'var(--chart-grid-color)' 
                    }, 
                    ticks: { color: 'var(--chart-tick-color)' }, 
                    title: { display: true, text: 'Total de Terminaciones', color: 'var(--chart-tick-color)' },
                    // Agregamos un poco de espacio extra arriba para que quepan las etiquetas
                    afterDataLimits: (scale) => {
                        scale.max = scale.max * 1.15;
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    updateChartTheme();
}

// --- Lógica para el Reporte Semanal de Calidad ---
function abrirModalReporteSemanalCalidad() {
    const modalHTML = `
        <div class="controles-semanales" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px; align-items: end;">
            <div><label for="semanalCalidad_fecha_inicio">Fecha de Inicio</label><input type="date" id="semanalCalidad_fecha_inicio"></div>
            <div><label for="semanalCalidad_fecha_fin">Fecha de Fin</label><input type="date" id="semanalCalidad_fecha_fin"></div>
            <div><label for="semanalCalidad_turno">Turno</label><select id="semanalCalidad_turno">${doc('prodCalidad_turno').innerHTML}</select></div>
        </div>
        <button id="generarReporteSemanalCalidadBtn" class="btn" style="width: 100%;">Generar Gráfica Comparativa</button>
        <div id="chartContainerSemanalCalidad" style="margin-top: 20px; height: 45vh; position: relative;"><canvas id="graficaSemanalCalidad"></canvas></div>`;
    showModal('Reporte Semanal de Terminaciones (Calidad)', modalHTML);

    const hoy = new Date();
    const haceUnaSemana = new Date();
    haceUnaSemana.setDate(hoy.getDate() - 6);
    doc('semanalCalidad_fecha_fin').value = hoy.toISOString().split('T')[0];
    doc('semanalCalidad_fecha_inicio').value = haceUnaSemana.toISOString().split('T')[0];
    doc('semanalCalidad_turno').value = getAutoCurrentShift();

    doc('generarReporteSemanalCalidadBtn').addEventListener('click', consultarReporteSemanalCalidad);
}

async function consultarReporteSemanalCalidad() {
    const btn = doc('generarReporteSemanalCalidadBtn');
    btn.disabled = true;
    btn.textContent = 'Generando...';

    const fechaInicio = doc('semanalCalidad_fecha_inicio').value;
    const fechaFin = doc('semanalCalidad_fecha_fin').value;
    const turnoSeleccionado = doc('semanalCalidad_turno').value;

    if (!fechaInicio || !fechaFin || !turnoSeleccionado) {
        alert('Por favor, selecciona un rango de fechas y un turno.');
        btn.disabled = false;
        btn.textContent = 'Generar Gráfica Comparativa';
        return;
    }

    const fechaInicioDate = new Date(`${fechaInicio}T00:00:00`);
    const fechaFinDate = new Date(`${fechaFin}T00:00:00`);
    fechaFinDate.setDate(fechaFinDate.getDate() + 1);
    fechaFinDate.setHours(6, 29, 59, 999);

    try {
        const snapshot = await db.collection('produccion_calidad_historico')
            .where('Fecha y hora', '>=', fechaInicioDate)
            .where('Fecha y hora', '<=', fechaFinDate)
            .get();

        const datosAgrupados = {};
        const labelsFechas = new Set();
        const allLineas = new Set();

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const fechaHora = data['Fecha y hora'].toDate();
            const { shift, dateKey } = getWorkShiftAndDate(fechaHora);

            if (shift === turnoSeleccionado && dateKey >= fechaInicio && dateKey <= fechaFin) {
                labelsFechas.add(dateKey);

                let linea = 'N/A';
                const lineValue = String(data['Line'] || '').toUpperCase();
                if (lineValue.includes('LINEA 1')) linea = 'Linea 1';
                else if (lineValue.includes('LINEA 2')) linea = 'Linea 2';
                allLineas.add(linea);

                if (!datosAgrupados[dateKey]) datosAgrupados[dateKey] = {};
                if (!datosAgrupados[dateKey][linea]) datosAgrupados[dateKey][linea] = 0;

                const catalogo = data['Catalogo'] || '';
                const cuartoDigito = catalogo.substring(3, 4).toUpperCase();
                const fibras = cuartoDigito === 'T' ? 12 : parseInt(cuartoDigito, 10) || 0;
                const terminaciones = fibras * (Number(data['Cantidad']) || 0);

                datosAgrupados[dateKey][linea] += terminaciones;
            }
        });

        const fechasOrdenadas = Array.from(labelsFechas).sort();
        renderGraficaSemanalCalidad(datosAgrupados, fechasOrdenadas, Array.from(allLineas).sort());

    } catch (e) {
        console.error("Error consultando reporte semanal calidad:", e);
        alert("No se pudo generar el reporte semanal. Revisa la consola.");
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generar Gráfica Comparativa';
    }
}

function renderGraficaSemanalCalidad(datos, labels, lineas) {
    const ctx = doc('graficaSemanalCalidad').getContext('2d');
    if (graficaSemanalCalidadInstance) {
        graficaSemanalCalidadInstance.destroy();
    }

    const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)'];
    const datasets = lineas.map((linea, index) => ({
        label: `Terminaciones ${linea}`,
        data: labels.map(fecha => (datos[fecha] && datos[fecha][linea]) ? datos[fecha][linea] : 0),
        backgroundColor: colors[index % colors.length]
    }));

    graficaSemanalCalidadInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(f => new Date(f + 'T12:00:00').toLocaleDateString('es-MX', { weekday: 'short', month: 'short', day: 'numeric' })),
            datasets: datasets
        },
        options: { /* Opciones idénticas... */ },
        plugins: [ChartDataLabels]
    });
    updateChartTheme();
}

function showProduccionCalidadConfigModal() {
            const config = params.produccion_calidad_config;
            const columnsHTML = config.columns.map(p => createSourceColHTML(p.key, p.excel_col)).join('');
            const content = `
                <div class="control-group">
                     <label for="prodCalidadStartRow">Fila de inicio de datos</label>
                     <input type="number" id="prodCalidadStartRow" value="${config.startRow || 15}">
                </div>
                <hr style="border-color: var(--border-color); margin: 16px 0;">
                <p style="text-align:center;">Arrastra para reordenar. Define el nombre de cada columna y la letra de la columna en Excel.</p>
                <ul class="param-list" id="prodCalidadParamList">${columnsHTML}</ul>
                <button id="addProdCalidadColBtn" class="btn" style="width: auto; padding: 8px 16px;">Añadir Columna</button>
                <button id="saveProdCalidadConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>
            `;
            showModal('Configurar Reporte Producción Calidad', content);
            
			const paramList = doc('prodCalidadParamList');
			paramList.addEventListener('dragstart', e => { if (e.target.classList.contains('param-item')) e.target.classList.add('dragging'); });
			paramList.addEventListener('dragend', e => { if (e.target.classList.contains('param-item')) e.target.classList.remove('dragging'); });
			paramList.addEventListener('dragover', e => {
				e.preventDefault();
				const draggingItem = paramList.querySelector('.dragging');
				if (!draggingItem) return;
				const afterElement = getDragAfterElement(paramList, e.clientY);
				if (afterElement == null) { paramList.appendChild(draggingItem); }
				else { paramList.insertBefore(draggingItem, afterElement); }
			});

            doc('addProdCalidadColBtn').addEventListener('click', () => {
                doc('prodCalidadParamList').insertAdjacentHTML('beforeend', createSourceColHTML('', ''));
            });
            doc('saveProdCalidadConfigBtn').addEventListener('click', saveProduccionCalidadConfig);
        }

        async function saveProduccionCalidadConfig() {
            const newColumns = Array.from(doc('prodCalidadParamList').querySelectorAll('.param-item')).map(item => ({
                key: item.querySelector('.param-key').value.trim(),
                excel_col: item.querySelector('.param-excel-col').value.trim().toUpperCase()
            })).filter(p => p.key && p.excel_col);

            const newConfig = {
                startRow: parseInt(doc('prodCalidadStartRow').value, 10) || 15,
                columns: newColumns
            };

            try {
                await db.collection('report_configs').doc('produccion_calidad_params').set(newConfig);
                params.produccion_calidad_config = newConfig;
                showModal('Éxito', '<p>Configuración del Reporte de Calidad guardada.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

// --- ¡NUEVA FUNCIÓN! Modal de Configuración de Áreas ---
function showAreaConfigModal() {
    const config = params.terminaciones_areas_config || {};
    // Clonamos las opciones del dropdown de áreas que ya existe en la vista
    const areaOptions = doc('prodTarimas_area').innerHTML; 

    const content = `
        <div class="control-group">
            <label for="configAreaSelect">Seleccionar Área para Configurar</label>
            <select id="configAreaSelect" class="control-group select">
                ${areaOptions
                    .replace('<option value="ALL">Todas las Áreas</option>', '')
                    .replace('value="" disabled', 'value="Default"')
                    .replace('Cargando áreas...', 'Default (Reglas Globales)')
                }
            </select>
        </div>
        <hr style="border-color: var(--border-color); margin: 16px 0;">
        <p style="text-align:center; color: var(--text-dark); font-size: 0.9em;">Define reglas de prefijo para los catálogos de esta área. La app usará la primera regla que coincida (la más específica). Si ninguna coincide, usará la lógica por defecto.</p>
        <ul class="param-list" id="areaRulesList" style="max-height: 40vh; overflow-y: auto;">
            </ul>
        <button id="addAreaRuleBtn" class="btn btn-glass" style="width: auto; padding: 8px 16px;">Añadir Regla</button>
        <button id="saveAreaConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración de Áreas</button>
    `;
    showModal('Configurar Cálculo de Fibras por Área', content);

    const areaSelect = doc('configAreaSelect');
    areaSelect.addEventListener('change', () => {
        renderAreaRules(areaSelect.value);
    });
    
    doc('addAreaRuleBtn').addEventListener('click', () => {
        const list = doc('areaRulesList');
        // Por defecto, la regla comodín (sin prefijo)
        list.insertAdjacentHTML('beforeend', createAreaRuleHTML({ prefijo: "", posicion: 4, t_es_12: true }));
    });
    
    doc('saveAreaConfigBtn').addEventListener('click', saveAreaConfig);
    
    renderAreaRules(areaSelect.value);
}

// --- ¡NUEVA FUNCIÓN! Helper para el modal de áreas ---
function renderAreaRules(areaKey) {
    const list = doc('areaRulesList');
    if (!list) return;
    
    const config = params.terminaciones_areas_config || {};
    const rules = config[areaKey] || [];
    
    list.innerHTML = rules.map(rule => createAreaRuleHTML(rule)).join('');
    if (rules.length === 0) {
        list.innerHTML = `<p style="text-align:center; color: var(--text-dark);">No hay reglas para esta área. Se usará la lógica por defecto (4to dígito).</p>`;
    }
}

// --- ¡NUEVA FUNCIÓN! Helper para el modal de áreas ---
function createAreaRuleHTML(rule) {
    return `
    <li class="param-item" style="grid-template-columns: 2fr 1fr 1fr auto auto; gap: 12px;">
        <input type="text" class="rule-prefix" placeholder="Prefijo (ej: 123-)" value="${rule.prefijo || ''}">
        <input type="number" class="rule-pos" placeholder="Pos. Inicio" value="${rule.posicion || 4}" min="1" style="text-align: center;">
        <input type="number" class="rule-length" placeholder="Cant. Dígitos" value="${rule.longitud || 1}" min="1" style="text-align: center;">
        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; justify-content: center; color: var(--text-secondary); cursor: pointer;">
            <input type="checkbox" class="rule-t" ${rule.t_es_12 ? 'checked' : ''}> 'T' es 12
        </label>
        <button class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 6px 10px; font-size: 0.9rem;">X</button>
    </li>
    `;
}
// --- ¡NUEVA FUNCIÓN! Guardar la configuración de áreas ---
async function saveAreaConfig() {
    const modalBody = doc('modalBody');
    const selectedArea = doc('configAreaSelect').value;
    if (!selectedArea) {
        showModal('Error', '<p>No se seleccionó ningún área.</p>');
        return;
    }

    const rules = Array.from(modalBody.querySelectorAll('#areaRulesList .param-item')).map(item => ({
        prefijo: item.querySelector('.rule-prefix').value.trim().toUpperCase(),
        posicion: parseInt(item.querySelector('.rule-pos').value, 10) || 4,
        longitud: parseInt(item.querySelector('.rule-length').value, 10) || 1, // <-- ¡AQUÍ ESTÁ EL CAMBIO!
        t_es_12: item.querySelector('.rule-t').checked
    }));

    if (!params.terminaciones_areas_config) {
        params.terminaciones_areas_config = {};
    }
    params.terminaciones_areas_config[selectedArea] = rules;

    try {
        await db.collection('report_configs').doc('terminaciones_areas_params').set(params.terminaciones_areas_config);
        showModal('Éxito', `<p>Configuración para el área <strong>${selectedArea}</strong> guardada.</p>`);
    } catch (e) {
        console.error("Error guardando config de áreas:", e);
        showModal('Error', '<p>No se pudo guardar la configuración en la base de datos.</p>');
    }
}

// =======================================================================================
// --- FIN: LÓGICA REPORTE PRODUCCIÓN CALIDAD ---
// =======================================================================================


        // --- INICIO: INICIALIZACIÓN DE LA APP ---
        function initializeApp() {
    if (sessionStorage.getItem('reportesMasterSession') === 'true') session.isMaster = true;
    Promise.all([
        loadParams('901_config'),
        loadParams('terminaciones_config'),
        loadParams('produccion_hora_config'),
        loadParams('produccion_20_config'),
		// --- NUEVA LÍNEA ---
		loadParams('produccion_20_empleados_config'),
		// --- FIN NUEVA LÍNEA ---
        loadParams('produccion_daily_config'),
        loadParams('produccion_calidad_config'),
        loadParams('terminaciones_areas_config')
    ]).then(() => {
        const today = new Date();
        const pastDate = new Date();
        pastDate.setDate(today.getDate() - 6);

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        doc('prod_fecha_unica').value = formatDate(today);
        doc('prod_fecha_inicio').value = formatDate(pastDate);
        doc('prod_fecha_fin').value = formatDate(today);
        doc('prod20_fecha').value = formatDate(today);
        doc('prodDaily_fecha').value = formatDate(today);
        doc('prodCalidad_fecha').value = formatDate(today);
        
        const currentShift = getAutoCurrentShift();
        doc('prod_turno').value = currentShift;
        doc('prod20_turno').value = currentShift;
        doc('prodDaily_turno').value = currentShift;
        doc('prodCalidad_turno').value = currentShift;

        applyTheme(currentTheme);
        Object.values(views).forEach(v => { v.style.display = 'none'; v.style.opacity = '0'; });
        views.menu.style.display = 'flex'; views.menu.style.opacity = '1';
    });
}
        initializeApp();
    });
</script>
</body>
</html>
