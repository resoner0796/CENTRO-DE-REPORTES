<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Reportes</title>

    <meta name="theme-color" content="#22252a">
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    
    <!-- Estilos CSS -->
    <style>
        :root {}

        body.dark-theme {
            --bg-gradient: radial-gradient(ellipse at center top, #22252a 0%, #0a0a0a 70%);
            --surface-color: rgba(35, 38, 43, 0.6);
            --surface-hover-color: rgba(55, 58, 63, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #E5E7EB;
            --primary-text-color: #0A0A0A;
            --danger-color: #FB7185;
            --danger-hover-color: #f43f5e;
            --text-primary: #F1F5F9; 
            --text-secondary: #94A3B8;
            --text-dark: #64748B;
            --thead-bg: rgba(55, 65, 81, 0.8);
            --sticky-col-bg: #2a2d32;
            --success-color: #4ade80;
            --row-today-bg: rgba(74, 222, 128, 0.1);
            --row-yesterday-bg: rgba(251, 191, 36, 0.1);
            --row-past-bg: rgba(244, 63, 94, 0.1);
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-tick-color: #94A3B8;
        }

        body.light-theme {
            --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
            --surface-color: rgba(255, 255, 255, 0.5);
            --surface-hover-color: rgba(243, 244, 246, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #1F2937;
            --primary-text-color: #FFFFFF;
            --danger-color: #EF4444;
            --danger-hover-color: #dc2626;
            --text-primary: #111827; 
            --text-secondary: #4B5563;
            --text-dark: #9CA3AF;
            --branding-color: #0055A5;
            --thead-bg: rgba(229, 231, 235, 0.8);
            --sticky-col-bg: #f1f5f9;
            --success-color: #22c55e;
            --row-today-bg: rgba(34, 197, 94, 0.1);
            --row-yesterday-bg: rgba(245, 158, 11, 0.1);
            --row-past-bg: rgba(239, 68, 68, 0.1);
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-tick-color: #4B5563;
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        html { min-height: 100%; background-color: #0a0a0a; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--text-primary); margin: 0; min-height: 100vh;
            display: flex; justify-content: center; transition: background 0.3s ease-in-out;
            background-attachment: fixed; padding: 16px; box-sizing: border-box; overflow-x: hidden;
        }
        .app-container { width: 100%; max-width: 1600px; }
        #menuView, #view901, #viewTerminaciones, #viewProduccionHora { transition: opacity 0.3s ease-in-out, display 0.3s; }
        #menuView { display: flex; align-items: center; justify-content: center; height: 100%; }
        .menu-wrapper { width: 100%; max-width: 600px; text-align: center; }
        .animated-startup { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .app-header { text-align: center; margin-bottom: 24px; }
        .app-branding { font-family: 'Tinos', 'Times New Roman', serif; font-weight: 400; font-size: 2.5rem; color: var(--text-primary); letter-spacing: 2px; margin: 0; transition: color 0.3s ease-in-out; }
        body.light-theme .app-branding { color: var(--branding-color); }
        .app-title { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin: 4px 0 0; }

        .card, .modal-content {
            background-color: var(--surface-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 24px; border-top: 1px solid rgba(255, 255, 255, 0.15); border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3); border-right: 2px solid rgba(0, 0, 0, 0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        body.light-theme .card, body.light-theme .modal-content {
            border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1); border-right: 2px solid rgba(0, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .menu-container { display: flex; flex-direction: column; gap: 16px; }
        .btn { padding: 16px 24px; border-radius: 12px; cursor: pointer; background-color: var(--primary-color); border: none; color: var(--primary-text-color); font-weight: 700; font-size: 1.1rem; text-align: center; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .theme-switcher-container { position: absolute; top: 16px; right: 16px; }
        #themeToggleBtn { padding: 8px 12px; font-size: 1.5rem; line-height: 1; background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); }
        #themeToggleBtn:hover { background-color: var(--surface-hover-color); color: var(--text-primary); }
        #view901, #viewTerminaciones, #viewProduccionHora { display: none; width: 100%; }
        .main-container { display: grid; grid-template-columns: 320px 1fr; gap: 16px; width: 100%; height: calc(100vh - 120px); }
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: var(--text-primary); background-color: var(--surface-hover-color); }
        .main-content { display: flex; flex-direction: column; gap: 16px; min-height: 0; }
        #summaryContainer { flex-shrink: 0; padding: 16px; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .summary-header h3 { margin: 0; }
        .table-container { flex-grow: 1; min-height: 0; }
        .table-wrapper { overflow: auto; height: 100%; border-radius: 12px; border: 1px solid var(--border-color); }
        #summaryContainer .table-wrapper { border: none; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; vertical-align: top; }
        .copyable { cursor: pointer; transition: color 0.2s; }
        .copyable:hover { color: var(--success-color); }
        .filter-input, .control-group input, .control-group select { 
            display: block; width: 100%; box-sizing: border-box; background-color: var(--surface-color); 
            border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; 
            padding: 8px 12px; font-size: 0.9rem; 
        }
        .filter-input { border-radius: 4px; padding: 4px 6px; margin-top: 4px; font-size: 0.8rem; }

        .control-group { margin-bottom: 16px; }
        .control-group label { display: block; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; font-size: 0.9rem; }

        .file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-top: 16px; }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area h4 { margin: 0 0 8px 0; color: var(--text-secondary); }
        #summaryContainer table th, #summaryContainer table td { text-align: right; }
        #summaryContainer table th:first-child, #summaryContainer table td:first-child { 
            text-align: left; font-weight: bold; position: sticky; left: 0; z-index: 1;
            background-color: var(--sticky-col-bg);
        }
        #summaryContainer table .grand-total { font-weight: bold; border-top: 2px solid var(--border-color); }

        .row-today { background-color: var(--row-today-bg) !important; }
        .row-yesterday { background-color: var(--row-yesterday-bg) !important; }
        .row-past { background-color: var(--row-past-bg) !important; }
        
        #chartContainer { position: relative; padding: 16px; display: flex; flex-direction: column; flex-shrink: 0; }
        #produccionChart { max-height: 250px; }
        #chartSummary { text-align: center; padding-top: 10px; font-weight: 600; color: var(--text-secondary); border-top: 1px solid var(--border-color); margin-top: 10px; }
        #chartSummary strong { color: var(--text-primary); }


        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s; width: 90%; max-width: 800px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; text-align: center; width: 100%; color: var(--text-primary);}
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody input, #modalBody select, #modalBody textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary); box-sizing: border-box;}
        #modalBody textarea { min-height: 80px; resize: vertical; }
        #modalBody p { font-size: 0.9em; color: var(--text-dark); margin-top:4px; }
        .param-list, .area-list { list-style: none; padding: 0; margin: 16px 0; max-height: 45vh; overflow-y: auto;}
        .param-item { display: grid; grid-template-columns: auto 1fr 1.2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .param-item input, .param-item select { margin: 0; }
        .param-value-container { grid-column: 4; }
        .hidden { display: none; }
        .area-item { display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .area-source-container, .user-filter-container { display: flex; flex-direction: column; gap: 4px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
        .area-source-container label, .user-filter-container label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;}
        .btn-danger { background-color: var(--danger-color); color: white; width: auto; padding: 8px 12px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .drag-handle { cursor: grab; color: var(--text-dark); padding: 4px; display: flex; align-items: center; }
        .drag-handle:active { cursor: grabbing; }
        .param-item.dragging { opacity: 0.5; background-color: var(--primary-color); }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px;}
        .tab-btn { background: none; border: none; padding: 10px 16px; cursor: pointer; color: var(--text-dark); font-weight: 600; border-bottom: 3px solid transparent;}
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--primary-color);}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .formula-helpers { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .helper-pill { background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .helper-pill:hover { background-color: var(--primary-color); color: var(--primary-text-color); border-color: var(--primary-color); }
        #login-error-msg { color: var(--danger-color); text-align: center; margin-top: 10px; font-weight: 500; height: 1em; }

        @media (max-width: 900px), (max-height: 450px) {
            body { overflow-y: auto; padding: 8px; }
            .app-header { margin-bottom: 16px; }
            .app-branding { font-size: 2rem; }
            .app-title { font-size: 1rem; }
            .main-container { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; gap: 12px; }
            .sidebar { height: auto; }
            .main-content { min-height: 50vh; gap: 12px; min-width: 0; }
            .card { padding: 16px; }
            .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table th, table td { padding: 8px 10px; font-size: 0.8rem; text-align: center; }
            #summaryContainer table th:first-child, #summaryContainer table td:first-child { text-align: left; }
            .modal-content { width: 95%; max-height: 85vh; display: flex; flex-direction: column; }
            #modalBody { overflow-y: auto; }
            .param-item, .area-item { grid-template-columns: 1fr; gap: 8px; text-align: left; }
            .param-item .btn-danger, .area-item .btn-danger { justify-self: end; }
            .param-value-container { grid-column: 1; }
        }
    </style>
</head>
<body class="dark-theme">

    <div class="theme-switcher-container">
        <button id="themeToggleBtn" class="btn">‚òÄÔ∏è</button>
    </div>

    <div class="app-container">
        <div id="menuView">
            <div class="menu-wrapper">
                <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Centro de Reportes</h2></header>
                <main class="card animated-startup" style="animation-delay: 0.1s;">
                    <div class="menu-container">
                        <button id="reporteProduccionBtn" class="btn">Reporte de Producci√≥n por Hora</button>
                        <button id="reporteTerminacionesBtn" class="btn">Reporte de Terminaciones</button>
                        <button id="view901Btn" class="btn">901</button>
                    </div>
                </main>
            </div>
        </div>
        
        <div id="viewProduccionHora">
            <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producci√≥n por Hora</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="flex-grow: 1; overflow-y: auto; padding-right: 8px;">
                            <div class="control-group">
                                <label for="prod_fecha">Fecha</label>
                                <input type="date" id="prod_fecha">
                            </div>
                            <div class="control-group">
                                <label for="prod_turno">Turno</label>
                                <select id="prod_turno">
                                    <option value="1">Turno 1 (6:30 AM - 6:30 PM)</option>
                                    <option value="2">Turno 2 (6:30 PM - 6:30 AM)</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="prod_area">√Årea</label>
                                <select id="prod_area">
                                    <option value="ALL">Todas las √Åreas</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="prod_linea1_packer">Empacador L√≠nea 1</label>
                                <input type="text" id="prod_linea1_packer" placeholder="ID de empacador...">
                            </div>
                            <div class="control-group">
                                <label for="prod_linea2_packer">Empacador L√≠nea 2</label>
                                <input type="text" id="prod_linea2_packer" placeholder="ID de empacador...">
                            </div>
                        </div>
                         <button id="generarReporteProduccionBtn" class="btn" style="margin-top: 16px; width: 100%;">Generar Reporte</button>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <div id="chartContainer" class="card">
                        <div class="summary-header">
                            <h3>Producci√≥n por Hora</h3>
                            <button id="exportChartBtn" class="icon-btn" title="Exportar Gr√°fica como JPG" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        </div>
                        <canvas id="produccionChart"></canvas>
                        <div id="chartSummary"></div>
                    </div>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableProduccion">
                                <thead><tr><th>Configure los par√°metros y genere el reporte.</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="view901">
            <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte 901</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div id="fileDropArea901" class="file-drop-area"><p>Arrastra un archivo para a√±adir registros</p></div>
                        <input type="file" id="fileInput901" accept=".xlsx, .xls" style="display: none;">
                    </div>
                </aside>
                <main class="main-content card table-container animated-startup" style="animation-delay: 0.2s;">
                    <div class="table-wrapper">
                        <table id="dataTable901"><thead><tr><th>Carga un archivo para ver los datos...</th></tr></thead><tbody></tbody></table>
                    </div>
                </main>
            </div>
        </div>

        <div id="viewTerminaciones">
             <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Terminaciones</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;"><div class="card" style="height: 100%; display: flex; flex-direction: column;"><div class="sidebar-header"><h3>Panel de Control</h3><div><button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button><button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button></div></div>
                    <div id="fileDropAreaZpptwc" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Zpptwc)</h4><p>Arrastra el primer archivo aqu√≠</p></div><input type="file" id="fileInputZpptwc" accept=".xlsx, .xls" style="display: none;">
                    <div id="fileDropAreaCoois" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Coois)</h4><p>Arrastra el segundo archivo aqu√≠</p></div><input type="file" id="fileInputCoois" accept=".xlsx, .xls" style="display: none;">
                </div></aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <div class="card" id="summaryContainer">
                        <div class="summary-header">
                            <h3>Resumen de Terminaciones</h3>
                        </div>
                        <p>Cargue los archivos para ver el resumen.</p>
                    </div>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableTerminaciones"><thead><tr><th>Carga los dos reportes de SAP para generar el informe</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay"><div id="modalContent" class="modal-content"><span id="modalClose" class="modal-close">&times;</span><h2 id="modalTitle" class="modal-title"></h2><div id="modalBody" style="margin-top:16px; color: var(--text-secondary);"></div></div></div>

    <script>
        // --- INICIO: CONFIGURACI√ìN Y VARIABLES GLOBALES ---
        const firebaseConfig = { apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0", authDomain: "rastreador-de-ordenes.firebaseapp.com", projectId: "rastreador-de-ordenes", storageBucket: "rastreador-de-ordenes.appspot.com", messagingSenderId: "956052823395", appId: "1:956052823395:web:2ba74d9591d2b24c3cc756" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const doc = (id) => document.getElementById(id);
            const views = { 
                menu: doc('menuView'), 
                '901': doc('view901'), 
                terminaciones: doc('viewTerminaciones'),
                produccionHora: doc('viewProduccionHora')
            };
            let session = { isMaster: false }; 
            let activeView = 'menu';
            let params = { 
                '901_config': { columns: [], userFilter: [] },
                terminaciones_config: {
                    zpptwc_cols: [],
                    coois_cols: [],
                    final_cols: [],
                    area_config: { source_col: '', mappings: [] }
                },
                produccion_hora_config: {
                    linea1_packer: '',
                    linea2_packer: '',
                    area: 'ALL'
                }
            };
            let reportData = { zpptwc: null, coois: null };
            let productionChart = null;

            // --- INICIO: L√ìGICA DE NAVEGACI√ìN Y UI GENERAL ---
            function switchView(viewKey) {
                const currentViewEl = views[activeView]; const nextViewEl = views[viewKey]; if (!nextViewEl) return;
                activeView = viewKey; currentViewEl.style.opacity = '0';
                setTimeout(() => {
                    currentViewEl.style.display = 'none'; nextViewEl.style.display = viewKey === 'menu' ? 'flex' : 'block';
                    requestAnimationFrame(() => { nextViewEl.style.opacity = '1'; });
                    if(viewKey === 'produccionHora') {
                        loadAreasForProductionReport();
                    }
                }, 300);
            }
            
            doc('reporteProduccionBtn').addEventListener('click', () => switchView('produccionHora'));
            doc('view901Btn').addEventListener('click', () => switchView('901'));
            doc('reporteTerminacionesBtn').addEventListener('click', () => switchView('terminaciones'));
            document.querySelectorAll('.backToMenuBtn').forEach(btn => btn.addEventListener('click', () => switchView('menu')));
            
            let currentTheme = localStorage.getItem('theme') || 'dark';
            function applyTheme(theme) { 
                document.body.className = `${theme}-theme`; 
                doc('themeToggleBtn').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                if(productionChart) {
                    updateChartTheme();
                }
            }
            doc('themeToggleBtn').addEventListener('click', () => { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); });

            const modalOverlay = doc('modalOverlay');
            function showModal(title, content) { doc('modalTitle').textContent = title; doc('modalBody').innerHTML = content; modalOverlay.classList.add('visible'); }
            function hideModal() { modalOverlay.classList.remove('visible'); }
            doc('modalClose').addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

            document.querySelectorAll('.settingsBtn').forEach(btn => btn.addEventListener('click', () => { session.isMaster ? showParamsModal() : showLoginModal(); }));
            function showLoginModal() { const content = `<p style="text-align: center;">Introduce las credenciales de maestro.</p><input type="text" id="userInput" placeholder="Usuario"><input type="password" id="passInput" placeholder="Contrase√±a"><button id="loginBtn" class="btn" style="margin-top: 16px; width: 100%;">Autenticar</button><div id="login-error-msg"></div>`; showModal('Autenticaci√≥n Maestra', content); doc('loginBtn').addEventListener('click', checkMasterCredentials); }
            function checkMasterCredentials() { const errorMsgEl = doc('login-error-msg'); if (doc('userInput').value === 'LUNAU' && doc('passInput').value === 'Resoner96') { session.isMaster = true; sessionStorage.setItem('reportesMasterSession', 'true'); hideModal(); showParamsModal(); } else { errorMsgEl.textContent = 'Credenciales incorrectas.'; } }

            // --- INICIO: L√ìGICA DE MODALES DE CONFIGURACI√ìN ---
            function showParamsModal() {
                if (activeView === '901') {
                    const config = params['901_config'];
                    const filterText = (config.userFilter || []).join(', ');
                    const paramsHTML = `<ul class="param-list param-list-901">${(config.columns || []).map(p => createParamItem901(p.key, p.startCell)).join('')}</ul>`;
                    const content = `<div class="user-filter-container"><label for="userFilterInput">Filtrar por Usuarios (separados por coma)</label><textarea id="userFilterInput" placeholder="PINTORA2, LUNAU2... (dejar vac√≠o para incluir a todos)">${filterText}</textarea></div><hr style="border-color: var(--border-color); margin: 16px 0;"><p style="text-align:center;">Define los nombres de columna y la celda de inicio de cada una (ej. A2).</p>${paramsHTML}<button id="addParam901Btn" class="btn" style="width: auto; padding: 8px 16px;">A√±adir Columna</button><button id="saveParams901Btn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Mapeo y Filtros</button>`;
                    showModal('Configurar Mapeo y Filtros de 901', content);
                    doc('addParam901Btn').addEventListener('click', () => doc('modalBody').querySelector('.param-list-901').insertAdjacentHTML('beforeend', createParamItem901('', '')));
                    doc('saveParams901Btn').addEventListener('click', saveParams901);
                } else if (activeView === 'terminaciones') {
                    showTerminacionesConfigModal();
                } else if (activeView === 'produccionHora') {
                    showProduccionHoraConfigModal();
                }
            }

            function showProduccionHoraConfigModal() {
                const config = params.produccion_hora_config;
                const content = `
                    <p>Guarda los IDs de empacador que usas con m√°s frecuencia.</p>
                    <div class="control-group">
                        <label for="modal_linea1_packer">Empacador L√≠nea 1 (por defecto)</label>
                        <input type="text" id="modal_linea1_packer" value="${config.linea1_packer || ''}">
                    </div>
                    <div class="control-group">
                        <label for="modal_linea2_packer">Empacador L√≠nea 2 (por defecto)</label>
                        <input type="text" id="modal_linea2_packer" value="${config.linea2_packer || ''}">
                    </div>
                     <div class="control-group">
                        <label for="modal_prod_area">√Årea por defecto</label>
                        <select id="modal_prod_area">${doc('prod_area').innerHTML}</select>
                    </div>
                    <button id="saveProduccionHoraConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuraci√≥n</button>
                `;
                showModal('Configurar Reporte de Producci√≥n', content);
                doc('modal_prod_area').value = config.area || 'ALL';
                doc('saveProduccionHoraConfigBtn').addEventListener('click', saveProduccionHoraConfig);
            }

            async function saveProduccionHoraConfig() {
                const newConfig = {
                    linea1_packer: doc('modal_linea1_packer').value.trim(),
                    linea2_packer: doc('modal_linea2_packer').value.trim(),
                    area: doc('modal_prod_area').value
                };
                try {
                    await db.collection('report_configs').doc('produccion_hora_params').set(newConfig);
                    params.produccion_hora_config = newConfig;
                    applyProduccionHoraConfig();
                    showModal('√âxito', '<p>Configuraci√≥n de producci√≥n guardada.</p>');
                } catch (e) {
                    showModal('Error', '<p>No se pudo guardar la configuraci√≥n.</p>');
                }
            }
            
            function createParamItem901(key, startCell) { return `<li class="param-item" style="grid-template-columns: 1fr 1fr auto;"><input type="text" class="param-key" placeholder="Nombre de Columna" value="${key || ''}"><input type="text" class="param-cell" placeholder="Celda de Inicio (ej. A2)" value="${startCell || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            
            async function saveParams901() { 
                const newColumns = Array.from(doc('modalBody').querySelectorAll('.param-item')).map(item => ({ key: item.querySelector('.param-key').value.trim(), startCell: item.querySelector('.param-cell').value.trim().toUpperCase() })).filter(p => p.key && p.startCell); 
                const userFilter = doc('userFilterInput').value.split(',').map(u => u.trim()).filter(Boolean);
                const newConfig = { columns: newColumns, userFilter: userFilter }; 
                try { 
                    await db.collection('report_configs').doc('901_params').set(newConfig); 
                    params['901_config'] = newConfig; 
                    showModal('√âxito', '<p>Mapeo y filtros de 901 guardados.</p>'); 
                } catch (e) { 
                    showModal('Error', '<p>No se pudo guardar la configuraci√≥n.</p>'); 
                } 
            }
            
            function showTerminacionesConfigModal() {
                const config = params.terminaciones_config;
                const content = `
                    <div class="modal-tabs">
                        <button class="tab-btn active" data-tab="zpptwc">1. Mapeo Zpptwc</button>
                        <button class="tab-btn" data-tab="coois">2. Mapeo Coois</button>
                        <button class="tab-btn" data-tab="areas">3. Mapeo de √Åreas</button>
                        <button class="tab-btn" data-tab="final">4. Columnas Finales</button>
                    </div>
                    <div id="tab-zpptwc" class="tab-content active"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Zpptwc.</p><ul class="param-list">${(config.zpptwc_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                    <div id="tab-coois" class="tab-content"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Coois.</p><ul class="param-list">${(config.coois_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                    <div id="tab-areas" class="tab-content">
                        <div class="area-source-container">
                            <label for="area-source-col">Columna Clave de Coois con C√≥digo de √Årea</label>
                            <input type="text" id="area-source-col" placeholder="Ej. MRP" value="${(config.area_config || {}).source_col || ''}">
                            <p>Usa el "Nombre Clave" (definido en la pesta√±a 2) de la columna del reporte Coois que contiene el c√≥digo de √°rea (ej. MRP).</p>
                        </div>
                        <ul class="area-list">${((config.area_config || {}).mappings || []).map(a => createAreaItemHTML(a.code, a.name)).join('')}</ul>
                    </div>
                    <div id="tab-final" class="tab-content"><p>Define las columnas que aparecer√°n en el reporte final. Para c√°lculos complejos, usa los tipos autom√°ticos.</p><ul class="param-list">${(config.final_cols || []).map(p => createFinalColHTML(p.key, p.type, p.value)).join('')}</ul></div>
                    <button class="addBtn btn" style="width: auto; padding: 8px 16px;">A√±adir Fila</button>
                    <button id="saveTerminacionesSettingsBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuraci√≥n</button>`;
                showModal('Configurar Automatizaci√≥n de Terminaciones', content);
                const modalBody = doc('modalBody');
                modalBody.querySelectorAll('.tab-btn').forEach(button => button.addEventListener('click', () => { modalBody.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); doc(`tab-${button.dataset.tab}`).classList.add('active'); }));
                modalBody.querySelector('.addBtn').addEventListener('click', () => { const activeTab = modalBody.querySelector('.tab-content.active'); if(activeTab.id === 'tab-areas') { activeTab.querySelector('.area-list').insertAdjacentHTML('beforeend', createAreaItemHTML('', '')); } else if(activeTab.id === 'tab-final') { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createFinalColHTML('', 'source', '')); } else { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createSourceColHTML('', '')); } });
                doc('saveTerminacionesSettingsBtn').addEventListener('click', saveTerminacionesSettings);
            }
            function createSourceColHTML(key, excel_col) { return `<li class="param-item" style="grid-template-columns: 1fr 1fr auto;"><input type="text" class="param-key" placeholder="Nombre Clave (sin espacios)" value="${key||''}"><input type="text" class="param-excel-col" placeholder="Letra de Columna (ej. A, B)" value="${excel_col||''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            function createAreaItemHTML(code, name) { return `<li class="area-item" style="grid-template-columns: 1fr 2fr auto;"><input type="text" class="area-code" placeholder="C√≥digo MRP" value="${code || ''}"><input type="text" class="area-name" placeholder="Nombre de √Årea" value="${name || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            function createFinalColHTML(key, type, value) { const options = `<option value="source">Dato Directo</option><option value="formula">F√≥rmula (Avanzado)</option><option value="fibras_auto">Fibras (Autom√°tico)</option><option value="terminaciones_auto">Terminaciones (Autom√°tico)</option><option value="familia_auto">Familia (Autom√°tico)</option>`; let selectedOptions = options.replace(`value="${type}"`,`value="${type}" selected`); const isFormula = type === 'formula'; const isSource = type === 'source'; const isAuto = !isFormula && !isSource; return `<li class="param-item" style="grid-template-columns:1fr 1fr 2fr auto"><input type="text" class="param-key" placeholder="Nombre Columna Final" value="${key||''}"><select class="param-type">${selectedOptions}</select><div class="${isAuto ? 'hidden' : ''}"><input type="text" class="param-value-input" placeholder="${isFormula ? 'Escribe f√≥rmula...' : 'Nombre Clave de la fuente'}" value="${value||''}" onfocus="populateFormulaHelpers(this, ${isFormula})"><div class="formula-helpers"></div></div><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            window.populateFormulaHelpers = (inputElement, isFormula) => { const container = inputElement.nextElementSibling; container.innerHTML = ''; if (!isFormula) return; const modalBody = inputElement.closest('#modalBody'); if (!modalBody) return; const currentKey = inputElement.closest('.param-item').querySelector('.param-key').value; const zpptwc_cols = Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => el.querySelector('.param-key').value); const coois_cols = Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => el.querySelector('.param-key').value); const final_cols = Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => el.querySelector('.param-key').value); const availableCols = [...zpptwc_cols, ...coois_cols, ...final_cols.filter(k => k !== currentKey), 'Area'].filter(Boolean); const uniqueCols = [...new Set(availableCols)]; uniqueCols.forEach(colName => { const pill = document.createElement('button'); pill.className = 'helper-pill'; pill.textContent = colName; pill.onclick = (e) => { e.preventDefault(); insertAtCursor(inputElement, `{${colName}}`); }; container.appendChild(pill); }); };
            function insertAtCursor(input, text) { const start = input.selectionStart; input.value = input.value.substring(0, start) + text + input.value.substring(input.selectionEnd); input.focus(); input.selectionEnd = start + text.length; }
            doc('modalOverlay').addEventListener('change', (e) => { if (e.target.classList.contains('param-type')) { const item = e.target.closest('.param-item'); const inputDiv = item.querySelector('div:not(.formula-helpers)'); const isAuto = ['fibras_auto', 'terminaciones_auto', 'familia_auto'].includes(e.target.value); if(inputDiv) inputDiv.classList.toggle('hidden', isAuto); } });
            
            async function saveTerminacionesSettings() {
                try {
                    const modalBody = document.getElementById('modalBody');
                    if (!modalBody) throw new Error("El cuerpo del modal no fue encontrado.");
                    const newConfig = {
                        zpptwc_cols: Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                        coois_cols: Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                        area_config: { 
                            source_col: modalBody.querySelector('#area-source-col').value.trim(), 
                            mappings: Array.from(modalBody.querySelectorAll('#tab-areas .area-item')).map(el => ({ code: el.querySelector('.area-code').value, name: el.querySelector('.area-name').value })) 
                        },
                        final_cols: Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), type: el.querySelector('.param-type').value, value: el.querySelector('.param-value-input').value.trim() })),
                    };
                    await db.collection('report_configs').doc('terminaciones_params_v2').set(newConfig); 
                    params.terminaciones_config = newConfig; 
                    showModal('√âxito', '<p>Configuraci√≥n de Terminaciones guardada.</p>'); 
                } catch(e) { 
                    console.error("Error saving terminaciones settings:", e);
                    showModal('Error', '<p>No se pudo guardar la configuraci√≥n. Detalles: ' + e.message + '</p>'); 
                }
            }
            
            // --- INICIO: CARGA DE DATOS (PARAMS Y ARCHIVOS) ---
            async function loadParams(configKey) {
                const docIdMap = {
                    '901_config': '901_params',
                    'terminaciones_config': 'terminaciones_params_v2',
                    'produccion_hora_config': 'produccion_hora_params'
                };
                const docId = docIdMap[configKey];
                if (!docId) return;

                try {
                    const docRef = await db.collection('report_configs').doc(docId).get();
                    if (docRef.exists) {
                        const data = docRef.data();
                        if (configKey === '901_config') {
                            params[configKey] = { columns: data.columns || [], userFilter: data.userFilter || [] };
                        } else if (configKey === 'terminaciones_config') {
                            params.terminaciones_config = { zpptwc_cols: [], coois_cols: [], final_cols: [], area_config: { source_col: '', mappings: [] }, ...data };
                        } else if (configKey === 'produccion_hora_config') {
                            params.produccion_hora_config = { linea1_packer: '', linea2_packer: '', area: 'ALL', ...data };
                            applyProduccionHoraConfig();
                        }
                    }
                } catch(e) { console.error(`Error al cargar ${configKey}:`, e); }
            }
            
            function applyProduccionHoraConfig() {
                const config = params.produccion_hora_config;
                doc('prod_linea1_packer').value = config.linea1_packer || '';
                doc('prod_linea2_packer').value = config.linea2_packer || '';
                doc('prod_area').value = config.area || 'ALL';
            }

            function setupFileHandler(dropAreaId, inputId, configKey) {
                const dropArea = doc(dropAreaId); const input = doc(inputId);
                dropArea.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0], configKey); e.target.value = ''; });
                dropArea.addEventListener('dragover', (e) => e.preventDefault());
                dropArea.addEventListener('drop', (e) => { e.preventDefault(); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], configKey); });
            }

            setupFileHandler('fileDropArea901', 'fileInput901', '901');
            setupFileHandler('fileDropAreaZpptwc', 'fileInputZpptwc', 'zpptwc');
            setupFileHandler('fileDropAreaCoois', 'fileInputCoois', 'coois');
            
            function handleFile(file, configKey) {
                if(configKey === '901') { 
                    handle901File(file); 
                } else {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const mapping = (configKey === 'zpptwc') ? params.terminaciones_config.zpptwc_cols : params.terminaciones_config.coois_cols;
                            const sheetData = XLSX.utils.sheet_to_json(ws, { header: 'A', defval: null, range: 1 });
                            const data = sheetData.map(row => {
                                let rowData = {};
                                for (const map of mapping) {
                                    if(map.excel_col) {
                                        rowData[map.key] = row[map.excel_col];
                                    }
                                }
                                return rowData;
                            }).filter(row => row.Orden);
                            reportData[configKey] = data;
                            doc(`fileDropArea${configKey.charAt(0).toUpperCase() + configKey.slice(1)}`).style.borderColor = '#4ade80';

                            if (configKey === 'coois') {
                                const batch = db.batch();
                                data.forEach(row => {
                                    const orderId = String(row.Orden || '').replace(/^0+/, '');
                                    if(orderId) {
                                        const docRef = db.collection('coois_historico').doc(orderId);
                                        batch.set(docRef, row, { merge: true });
                                    }
                                });
                                await batch.commit();
                            }

                            processTerminacionesReport();
                        } catch (err) { 
                            console.error("Error al procesar archivo:", err);
                            showModal('Error de Archivo', '<p>No se pudo procesar el archivo Excel. Verifique el mapeo de letras de columna y la conexi√≥n a la base de datos.</p>'); 
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            }
            
            const formulaHelpers = {
                EXTRAER: (text, start, length) => (typeof text !== 'string' || text === null) ? '' : String(text).substring(start - 1, start - 1 + length),
                EXTRAER_FIBRAS: (text, start, length) => {
                    if (typeof text !== 'string' || text === null) return 0;
                    const code = String(text).substring(start - 1, start - 1 + length).toUpperCase();
                    if (!code) return 0;
                    switch (code) {
                        case '1': return 1; case '2': return 2; case '3': return 3; case '4': return 4;
                        case '5': return 5; case '6': return 6; case '7': return 7; case '8': return 8;
                        case '9': return 9; case 'A': return 1; case 'B': return 2; case 'C': return 4;
                        case 'D': return 6; case 'E': return 8; case 'F': return 12; case 'G': return 24;
                        case 'T': return 12; default: const num = parseFloat(code); return isNaN(num) ? 0 : num;
                    }
                },
                IF: (condition, valueIfTrue, valueIfFalse) => condition ? valueIfTrue : valueIfFalse,
            };

            function excelSerialToDateObject(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                try {
                    const decoded = XLSX.SSF.parse_date_code(serial);
                    if (decoded) {
                        return new Date(decoded.y, decoded.m - 1, decoded.d, decoded.H, decoded.M, decoded.S);
                    }
                } catch (e) {
                    console.error("Error al analizar el serial de fecha de Excel con XLSX:", e, "Serial:", serial);
                }
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + serial * 86400000);
                return new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
            }
            
            function formatFullDateTime(date) {
                if (!(date instanceof Date) || isNaN(date)) return '';
                return date.toLocaleString('es-ES', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                }).replace(',', '');
            }

            // --- INICIO: L√ìGICA REPORTE DE PRODUCCI√ìN POR HORA ---

            doc('generarReporteProduccionBtn').addEventListener('click', generateProductionReport);
            doc('exportChartBtn').addEventListener('click', exportChartAsJPG);
            
            async function loadAreasForProductionReport() {
                try {
                    const areasSnapshot = await db.collection('areas').get();
                    const areaSelect = doc('prod_area');
                    const modalAreaSelect = doc('modal_prod_area');

                    const currentVal = areaSelect.value;
                    
                    Array.from(areaSelect.options).forEach(option => {
                        if (option.value !== 'ALL') option.remove();
                    });

                    let areas = [];
                    areasSnapshot.forEach(doc => {
                       if (doc.id !== 'CONFIG') areas.push(doc.id);
                    });
                    areas.sort();
                    
                    areas.forEach(areaId => {
                        const option = document.createElement('option');
                        option.value = areaId;
                        option.textContent = areaId;
                        areaSelect.appendChild(option);
                    });
                    
                    if(modalAreaSelect) modalAreaSelect.innerHTML = areaSelect.innerHTML;
                    areaSelect.value = currentVal;

                } catch (e) { console.error("Error cargando √°reas:", e); }
            }
            
            async function generateProductionReport() {
                const btn = doc('generarReporteProduccionBtn');
                btn.disabled = true;
                btn.textContent = 'Cargando datos...';
                doc('exportChartBtn').style.display = 'none';

                try {
                    const selectedDateStr = doc('prod_fecha').value;
                    const selectedTurno = doc('prod_turno').value;
                    const packerL1 = doc('prod_linea1_packer').value.trim().toUpperCase();
                    const packerL2 = doc('prod_linea2_packer').value.trim().toUpperCase();
                    const selectedArea = doc('prod_area').value;

                    if (!selectedDateStr) {
                        showModal('Error', '<p>Por favor, selecciona una fecha.</p>');
                        return;
                    }
                    if (!packerL1 && !packerL2) {
                        showModal('Error', '<p>Por favor, ingrese al menos un ID de empacador.</p>');
                        return;
                    }

                    const selectedDate = new Date(`${selectedDateStr}T00:00:00`);
                    let startTime, endTime;

                    if (selectedTurno === '1') {
                        startTime = new Date(selectedDate.getTime());
                        startTime.setHours(6, 30, 0, 0);
                        endTime = new Date(selectedDate.getTime());
                        endTime.setHours(18, 29, 59, 999);
                    } else {
                        startTime = new Date(selectedDate.getTime());
                        startTime.setHours(18, 30, 0, 0);
                        endTime = new Date(selectedDate.getTime());
                        endTime.setDate(endTime.getDate() + 1);
                        endTime.setHours(6, 29, 59, 999);
                    }

                    const query = selectedArea === 'ALL'
                        ? db.collectionGroup('orders')
                        : db.collection('areas').doc(selectedArea).collection('orders');

                    const snapshot = await query.get();
                    if (snapshot.empty) {
                        showModal('Sin Datos', '<p>No se encontraron √≥rdenes para el √°rea seleccionada.</p>');
                        renderProductionTable([]);
                        renderProductionChart([], startTime, selectedTurno);
                        return;
                    }

                    let allPackedItems = [];
                    snapshot.forEach(orderDoc => {
                        const orderData = orderDoc.data();
                        const orderId = orderDoc.id;
                        const catalogNumber = orderData.catalogNumber || 'N/A';
                        const empaqueData = orderData.empaqueData || [];

                        if (Array.isArray(empaqueData)) {
                            empaqueData.forEach(box => {
                                if (Array.isArray(box.serials)) {
                                    box.serials.forEach(item => {
                                        const packedDateSerial = item['Finish Packed Date'];
                                        if (packedDateSerial) {
                                            const packedDate = excelSerialToDateObject(packedDateSerial);
                                            if (packedDate && packedDate >= startTime && packedDate <= endTime) {
                                                const empacador = (item['Employee ID'] || '').toString().toUpperCase();
                                                if(empacador === packerL1 || empacador === packerL2){
                                                    allPackedItems.push({
                                                        orden: orderId,
                                                        catalogo: catalogNumber,
                                                        empacador: empacador,
                                                        timestamp: packedDate,
                                                        linea: empacador === packerL1 ? 'L√≠nea 1' : 'L√≠nea 2',
                                                        boxId: box.boxId || 'SIN_CAJA'
                                                    });
                                                }
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });

                    const detailedData = allPackedItems.map(item => {
                        const char = item.catalogo.substring(3, 4).toUpperCase();
                        const fibras = (char === 'T') ? 12 : (parseInt(char, 10) || 0);
                        return {
                            ...item,
                            fibras: fibras,
                            terminaciones: fibras
                        };
                    });

                    const groupedByBox = new Map();
                    detailedData.forEach(item => {
                        const key = `${item.orden}-${item.boxId}`;
                        if (!groupedByBox.has(key)) {
                            groupedByBox.set(key, {
                                orden: item.orden,
                                catalogo: item.catalogo,
                                boxId: item.boxId,
                                piezas: 0,
                                terminaciones: 0,
                                linea: item.linea,
                                timestamp: item.timestamp
                            });
                        }
                        const group = groupedByBox.get(key);
                        group.piezas += 1;
                        group.terminaciones += item.terminaciones;
                        if (item.timestamp > group.timestamp) {
                            group.timestamp = item.timestamp;
                        }
                    });

                    const aggregatedData = Array.from(groupedByBox.values());
                    aggregatedData.sort((a, b) => b.timestamp - a.timestamp);

                    renderProductionTable(aggregatedData);
                    renderProductionChart(detailedData, startTime, selectedTurno);

                } catch (e) {
                    console.error("Error generando reporte:", e);
                    showModal('Error', `<p>Ocurri√≥ un error al generar el reporte: ${e.message}</p>`);
                    doc('exportChartBtn').style.display = 'none';
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Generar Reporte';
                }
            }

            function renderProductionTable(data) {
                const table = doc('dataTableProduccion');
                if (!data || data.length === 0) {
                    table.innerHTML = '<thead><tr><th>No se encontraron registros para los filtros seleccionados.</th></tr></thead><tbody></tbody>';
                    return;
                }

                const headers = ['Orden', 'Box ID', 'Cat√°logo', 'Piezas Empacadas', 'Fecha y Hora', 'Terminaciones', 'L√≠nea'];
                let html = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;

                data.forEach(row => {
                    html += `<tr>
                        <td>${row.orden}</td>
                        <td>${row.boxId}</td>
                        <td>${row.catalogo}</td>
                        <td>${row.piezas}</td>
                        <td>${formatFullDateTime(row.timestamp)}</td>
                        <td>${row.terminaciones}</td>
                        <td>${row.linea}</td>
                    </tr>`;
                });
                table.innerHTML = html + `</tbody>`;
            }

            function renderProductionChart(data, shiftStartTime, turno) {
                const ctx = doc('produccionChart').getContext('2d');
                if (productionChart) {
                    productionChart.destroy();
                }

                if(data.length === 0){
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    doc('chartSummary').innerHTML = '';
                    doc('exportChartBtn').style.display = 'none';
                    return;
                }

                const hourlyData = {};
                const labels = [];
                const totalSummary = {
                    linea1: { piezas: 0, terminaciones: 0 },
                    linea2: { piezas: 0, terminaciones: 0 }
                };

                for (let i = 0; i < 12; i++) {
                    const startHour = new Date(shiftStartTime);
                    startHour.setHours(startHour.getHours() + i);
                    const endHour = new Date(startHour);
                    endHour.setHours(endHour.getHours() + 1);
                    const format = { hour: 'numeric', minute: 'numeric', hour12: false };
                    const label = `${startHour.toLocaleTimeString('es-ES', format)} - ${endHour.toLocaleTimeString('es-ES', format)}`;
                    labels.push(label);
                    hourlyData[i] = { 'L√≠nea 1': 0, 'L√≠nea 2': 0 };
                }

                data.forEach(item => {
                    const diffHours = Math.floor((item.timestamp - shiftStartTime) / (1000 * 60 * 60));
                    if(diffHours >= 0 && diffHours < 12){
                         if(item.linea === 'L√≠nea 1'){
                            hourlyData[diffHours]['L√≠nea 1'] += item.terminaciones;
                         } else {
                            hourlyData[diffHours]['L√≠nea 2'] += item.terminaciones;
                         }
                    }
                    if (item.linea === 'L√≠nea 1') {
                        totalSummary.linea1.piezas += 1;
                        totalSummary.linea1.terminaciones += item.terminaciones;
                    } else {
                        totalSummary.linea2.piezas += 1;
                        totalSummary.linea2.terminaciones += item.terminaciones;
                    }
                });
                
                const summaryEl = doc('chartSummary');
                summaryEl.innerHTML = `
                    L√≠nea 1: <strong>${totalSummary.linea1.piezas} pzas / ${totalSummary.linea1.terminaciones} term.</strong>
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    L√≠nea 2: <strong>${totalSummary.linea2.piezas} pzas / ${totalSummary.linea2.terminaciones} term.</strong>
                `;


                const line1Data = Object.values(hourlyData).map(d => d['L√≠nea 1']);
                const line2Data = Object.values(hourlyData).map(d => d['L√≠nea 2']);

                productionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'L√≠nea 1',
                                data: line1Data,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'L√≠nea 2',
                                data: line2Data,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { color: 'var(--text-primary)' } },
                            title: {
                                display: true,
                                text: `Producci√≥n de Terminaciones - Turno ${turno}`,
                                color: 'var(--text-primary)',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' } },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'var(--chart-grid-color)' },
                                ticks: { color: 'var(--chart-tick-color)' },
                                title: { display: true, text: 'Total de Terminaciones', color: 'var(--chart-tick-color)' }
                            }
                        }
                    }
                });
                doc('exportChartBtn').style.display = 'block';
                updateChartTheme();
            }
            
            function updateChartTheme() {
                if (!productionChart) return;
                productionChart.options.plugins.legend.labels.color = document.body.classList.contains('dark-theme') ? '#F1F5F9' : '#111827';
                productionChart.options.plugins.title.color = document.body.classList.contains('dark-theme') ? '#F1F5F9' : '#111827';
                productionChart.options.scales.x.ticks.color = 'var(--chart-tick-color)';
                productionChart.options.scales.y.ticks.color = 'var(--chart-tick-color)';
                productionChart.options.scales.y.title.color = 'var(--chart-tick-color)';
                productionChart.options.scales.x.grid.color = 'var(--chart-grid-color)';
                productionChart.options.scales.y.grid.color = 'var(--chart-grid-color)';
                productionChart.update();
            }

            function exportChartAsJPG() {
                const canvas = doc('produccionChart');
                if (!productionChart || !canvas || canvas.height < 100) {
                    showModal('Error', '<p>No hay una gr√°fica para exportar. Por favor, genere un reporte primero.</p>');
                    return;
                }

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                const bgColor = theme === 'dark' ? '#2a2d32' : '#f9fafb';

                tempCtx.fillStyle = bgColor;
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(canvas, 0, 0);

                const link = document.createElement('a');
                link.href = tempCanvas.toDataURL('image/jpeg', 0.95);
                
                const fecha = doc('prod_fecha').value || 'fecha';
                const turno = doc('prod_turno').value;
                link.download = `Grafica_Produccion_Turno${turno}_${fecha}.jpg`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- INICIO: L√ìGICA REPORTE TERMINACIONES ---
            async function processTerminacionesReport() {
                if (!reportData.zpptwc) return;

                const config = params.terminaciones_config;
                const joinKey = 'Orden';
                if (!config.zpptwc_cols.some(c => c.key === joinKey) || !config.coois_cols.some(c => c.key === joinKey)) {
                    showModal('Error de Configuraci√≥n', '<p>Aseg√∫rese de mapear una columna con el nombre clave "Orden" en ambos reportes.</p>');
                    return;
                }

                const cooisMap = new Map();
                // 1. Cargar el hist√≥rico de Firebase
                try {
                    const snapshot = await db.collection('coois_historico').get();
                    snapshot.forEach(doc => {
                        cooisMap.set(doc.id, doc.data());
                    });
                } catch (e) {
                    console.error("Error al cargar hist√≥rico de COOIS:", e);
                    showModal('Advertencia', '<p>No se pudo cargar el hist√≥rico de datos COOIS. El reporte podr√≠a estar incompleto.</p>');
                }

                // 2. Sobrescribir con el archivo reci√©n cargado si existe
                if (reportData.coois) {
                    reportData.coois.forEach(row => {
                        const cleanOrder = String(row[joinKey] || '').replace(/^0+/, '');
                        if (cleanOrder) {
                            cooisMap.set(cleanOrder, row);
                        }
                    });
                }
                
                if (cooisMap.size === 0) {
                    showModal('Datos Insuficientes', '<p>Por favor, cargue un reporte SAP (Coois) para poder generar el informe.</p>');
                    return;
                }


                let finalData = reportData.zpptwc.map(zpptwcRow => {
                    const cleanOrder = String(zpptwcRow[joinKey] || '').replace(/^0+/, '');
                    const cooisRow = cooisMap.get(cleanOrder) || {};
                    let merged = {...zpptwcRow, ...cooisRow};
                    let finalRow = {};

                    // Mapeo inicial
                    for (const key in merged) {
                        let value = merged[key];
                        if (typeof value === 'string') value = value.trim();
                        if (key === 'Orden' || key === 'Material' || key === 'Operacion') {
                            finalRow[key] = String(value || '').replace(/^0+/, '');
                        } else if (key === 'Fecha' && value instanceof Date) {
                            finalRow.FechaDate = value;
                            finalRow[key] = `${String(value.getDate()).padStart(2, '0')}/${String(value.getMonth() + 1).padStart(2, '0')}/${value.getFullYear()}`;
                        } else {
                            finalRow[key] = value;
                        }
                    }

                    // Mapeo de √Årea
                    const areaCode = finalRow[config.area_config.source_col];
                    const areaMapping = config.area_config.mappings.find(m => String(m.code).trim() === String(areaCode).trim());
                    finalRow['Area'] = areaMapping ? areaMapping.name : 'Desconocida';

                    // Procesamiento de columnas finales
                    for (const col of config.final_cols) {
                        let result;
                        switch (col.type) {
                            case 'source':
                                result = finalRow[col.value];
                                break;
                            case 'formula':
                                result = evaluateFormula(col.value, finalRow);
                                break;
                            case 'fibras_auto':
                            case 'terminaciones_auto':
                            case 'familia_auto':
                                result = evaluateAuto(col.type, finalRow);
                                break;
                        }
                        finalRow[col.key] = result;
                    }
                     if (finalRow['Terminaciones'] !== undefined) {
                        let value = parseFloat(finalRow['Terminaciones']);
                        finalRow['Terminaciones'] = (isNaN(value) || value < 0) ? 0 : value;
                    }
                    return finalRow;
                });
                
                finalData.sort((a,b) => (b.FechaDate || 0) - (a.FechaDate || 0));

                renderTerminacionesTable(finalData);
                renderTerminacionesSummary(finalData);
            }

            function evaluateFormula(formula, row) {
                try {
                    let finalFormula = formula;
                    const matches = formula.match(/{[^{}]+}/g) || [];
                    matches.forEach(match => {
                        const key = match.substring(1, match.length - 1);
                        const value = typeof row[key] === 'number' ? row[key] : `"${String(row[key] || '').replace(/"/g, '\\"')}"`;
                        finalFormula = finalFormula.replace(new RegExp(match, 'g'), value);
                    });
                    
                    const functionMatches = finalFormula.match(/([A-Z_]+)\(([^)]+)\)/g) || [];
                    functionMatches.forEach(match => {
                       const [_, funcName, argsStr] = match.match(/([A-Z_]+)\((.*)\)/);
                       if(formulaHelpers[funcName]) {
                           const args = argsStr.split(',').map(arg => {
                               arg = arg.trim();
                               if (arg.startsWith('"') && arg.endsWith('"')) return arg.slice(1, -1);
                               if (!isNaN(arg)) return parseFloat(arg);
                               return arg;
                           });
                           const result = formulaHelpers[funcName](...args);
                           finalFormula = finalFormula.replace(match, JSON.stringify(result));
                       }
                    });
                    
                    return new Function(`return ${finalFormula}`)();
                } catch (e) {
                    console.warn(`Error al evaluar f√≥rmula "${formula}":`, e);
                    return "Error";
                }
            }
            
            function evaluateAuto(type, row) {
                 switch(type) {
                     case 'familia_auto':
                         return formulaHelpers.EXTRAER(row['Catalogo'], 1, 3);
                     case 'terminaciones_auto':
                         const fibras = parseFloat(row['Fibras']) || 0;
                         const cantidad = parseFloat(row['Cantidad']) || 0;
                         return fibras * cantidad;
                     case 'fibras_auto': {
                         const area = (row['Area'] || '').trim();
                         const catalogo = row['Catalogo'] || '';
                         let fibrasCalc = 0;
                         if (area === 'UNAP LEGACY') {
                            if (catalogo.startsWith('DSH') || catalogo.startsWith('DSF')) {
                                fibrasCalc = formulaHelpers.EXTRAER_FIBRAS(catalogo, 4, 1);
                            } else {
                                fibrasCalc = catalogo.startsWith('B100') ? formulaHelpers.EXTRAER_FIBRAS(catalogo, 7, 1) : formulaHelpers.EXTRAER_FIBRAS(catalogo, 6, 1);
                            }
                         } else if (area === 'MPORT FLEX') { 
                            fibrasCalc = (catalogo.startsWith('MSA') || catalogo.startsWith('MSF')) ? formulaHelpers.EXTRAER_FIBRAS(catalogo, 6, 1) : parseFloat(formulaHelpers.EXTRAER(catalogo, 5, 2)) || 0;
                         } else if (area === 'EVOLV MTB RPX' || area === 'MTB RPX') {
                            fibrasCalc = formulaHelpers.EXTRAER_FIBRAS(catalogo, 6, 1);
                         } else if (area === 'NON STD') {
                            fibrasCalc = 2; 
                         } else if (area === 'SPECIALTY') {
                            fibrasCalc = 12;
                         } else if (area === 'MULTIPORT') {
                             const extractedFibers = formulaHelpers.EXTRAER_FIBRAS(catalogo, 4, 1);
                             fibrasCalc = catalogo.startsWith('DFB') ? extractedFibers * 2 : extractedFibers;
                         }
                         else if (area === 'EVOLV MTB DEMARC') {
                            fibrasCalc = formulaHelpers.EXTRAER_FIBRAS(catalogo, 4, 1);
                         } else if (area === 'MOB LEGACY' || area === 'MTB DEMARC') {
                            fibrasCalc = formulaHelpers.EXTRAER_FIBRAS(catalogo, 5, 2);
                         }
                         return fibrasCalc;
                     }
                 }
                return 'N/A';
            }
            
            function renderTerminacionesTable(data) {
                const config = params.terminaciones_config.final_cols;
                if (!config || config.length === 0) return;
                const allHeaders = config.map(c => c.key);
                const tableElement = doc('dataTableTerminaciones');
                let html = '<thead><tr>';
                allHeaders.forEach(header => { html += `<th><span>${header}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${header}"></th>`; });
                html += '</tr></thead><tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    allHeaders.forEach(header => { html += `<td>${row[header] ?? ''}</td>`; });
                    html += '</tr>';
                });
                tableElement.innerHTML = html + '</tbody>';

                tableElement.querySelectorAll('.filter-input').forEach(input => {
                    input.addEventListener('keyup', () => filterTerminacionesTable());
                });
            }

            function filterTerminacionesTable() {
                const table = doc('dataTableTerminaciones');
                const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({
                    columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')),
                    value: i.value.toLowerCase()
                }));
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    let shouldShow = true;
                    filters.forEach(filter => {
                        if (filter.value) {
                            const cell = row.children[filter.columnIndex];
                            if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) {
                                shouldShow = false;
                            }
                        }
                    });
                    row.style.display = shouldShow ? '' : 'none';
                });
            }


window.copyToClipboard = (text, element) => {
                if (!text) return;
                const originalText = element.textContent;
                const originalColor = element.style.color;
                navigator.clipboard.writeText(text).then(() => {
                    element.textContent = '¬°Copiado!';
                    element.style.color = 'var(--success-color)';
                    setTimeout(() => {
                        element.textContent = originalText;
                        element.style.color = originalColor;
                    }, 1500);
                }).catch(err => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    element.textContent = '¬°Copiado!';
                    element.style.color = 'var(--success-color)';
                    setTimeout(() => {
                        element.textContent = originalText;
                        element.style.color = originalColor;
                    }, 1500);
                });
            };


            

            function renderTerminacionesSummary(data) {
                const container = doc('summaryContainer');
                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="summary-header"><h3>Resumen de Terminaciones</h3></div><p>No hay datos para mostrar.</p>`;
                    return;
                }
                const pivot = {};
                const dates = new Set();
                data.forEach(row => {
                    const area = row['Area'] || 'Sin √Årea';
                    const fecha = row['Fecha'] || 'Sin Fecha';
                    const terminaciones = parseFloat(row['Terminaciones']) || 0;
                    if (typeof terminaciones === 'number' && terminaciones > 0) {
                        dates.add(fecha);
                        if (!pivot[area]) pivot[area] = {};
                        if (!pivot[area][fecha]) pivot[area][fecha] = 0;
                        pivot[area][fecha] += terminaciones;
                    }
                });
                const sortedDates = [...dates].sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
                let summaryHTML = `<div class="summary-header"><h3>Resumen de Terminaciones</h3><button id="exportSummaryBtn" class="icon-btn" title="Exportar como JPG"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button></div><div id="summaryTableWrapper" class="table-wrapper"><table><thead><tr><th>√Årea</th>`;
                sortedDates.forEach(date => { summaryHTML += `<th>${date}</th>`; });
                summaryHTML += `<th>Total General</th></tr></thead><tbody>`;
                let colTotals = {};
                sortedDates.forEach(date => colTotals[date] = 0);
                let grandTotal = 0;
                const sortedAreas = Object.keys(pivot).sort();
                for(const area of sortedAreas) {
                    let rowTotal = 0;
                    summaryHTML += `<tr><td>${area}</td>`;
                    sortedDates.forEach(date => {
                        const value = pivot[area][date] || 0;
                        summaryHTML += `<td>${value.toLocaleString()}</td>`;
                        rowTotal += value;
                        colTotals[date] += value;
                    });
                    summaryHTML += `<td class="grand-total">${rowTotal.toLocaleString()}</td></tr>`;
                    grandTotal += rowTotal;
                }
                summaryHTML += `<tr class="grand-total"><td >Total General</td>`;
                sortedDates.forEach(date => { summaryHTML += `<td>${colTotals[date].toLocaleString()}</td>`; });
                summaryHTML += `<td>${grandTotal.toLocaleString()}</td></tr></tbody></table></div>`;
                container.innerHTML = summaryHTML;
                doc('exportSummaryBtn').addEventListener('click', exportSummaryAsJPG);
            }
            
            function exportSummaryAsJPG() {
                const summaryCard = doc('summaryContainer');
                const exportBtn = doc('exportSummaryBtn');
                if (!summaryCard || typeof html2canvas === 'undefined') { return; }
                exportBtn.disabled = true;
                exportBtn.innerHTML = '...';
                const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                const bgColor = theme === 'dark' ? '#22252a' : '#f9fafb';
                exportBtn.style.visibility = 'hidden';
                html2canvas(summaryCard, { 
                    backgroundColor: bgColor, scale: 2.5, useCORS: true,
                    onclone: (clonedDoc) => {
                        const clonedCard = clonedDoc.getElementById('summaryContainer');
                        const clonedWrapper = clonedCard.querySelector('.table-wrapper');
                        clonedCard.style.padding = '16px'; 
                        if (clonedWrapper) {
                            clonedWrapper.style.overflow = 'visible';
                            clonedWrapper.style.width = `${clonedWrapper.scrollWidth}px`;
                        }
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Resumen_Terminaciones.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                }).finally(() => {
                    exportBtn.style.visibility = 'visible';
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
                });
            }

            // --- INICIO: L√ìGICA REPORTE 901 ---
            
            async function handle901File(file) { 
                const config = params['901_config'];
                if (!config.columns || config.columns.length === 0) {
                    showModal('Error de Configuraci√≥n', `<p>Por favor, configure el mapeo de columnas para el reporte 901.</p>`);
                    return;
                }
                const dateColumnMap = config.columns.find(p => p.key.toLowerCase() === 'fecha');
                const userColumnMap = config.columns.find(p => p.key.toLowerCase() === 'usuario');

                if (!dateColumnMap) {
                    showModal('Error de Configuraci√≥n', `<p>Debe existir una columna llamada "Fecha" en el mapeo.</p>`);
                    return;
                }
                if (config.userFilter && config.userFilter.length > 0 && !userColumnMap) {
                    showModal('Error de Configuraci√≥n', `<p>Se especificaron filtros de usuario, pero no hay una columna mapeada como "Usuario".</p>`);
                    return;
                }

                const allowedUsers = (config.userFilter || []).map(u => u.toUpperCase());
                const reader = new FileReader(); 
                reader.onload = async (e) => { 
                    try { 
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        
                        const extractedData = [];
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);

                        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                            const dateCol = dateColumnMap.startCell.match(/[A-Z]+/)[0];
                            const dateCellAddress = dateCol + (R + 1);
                            const dateCell = ws[dateCellAddress];
                            
                            if (!dateCell || !dateCell.v) continue;

                            let rowDate;
                            if (dateCell.t === 'n') {
                                rowDate = excelSerialToDateObject(dateCell.v);
                            } else if (dateCell.v instanceof Date) {
                                rowDate = dateCell.v;
                            } else {
                                continue; 
                            }
                            rowDate.setHours(0,0,0,0);
                            
                            const isToday = rowDate.getTime() === today.getTime();
                            const isPast = rowDate.getTime() < today.getTime();
                            
                            let userValue = '';
                            if (userColumnMap) {
                                const userCol = userColumnMap.startCell.match(/[A-Z]+/)[0];
                                const userCellAddress = userCol + (R + 1);
                                const userCell = ws[userCellAddress];
                                userValue = (userCell ? String(userCell.v) : '').toUpperCase();
                            }
                            const userIsOnFilterList = allowedUsers.includes(userValue);

                            if (isPast || (isToday && userIsOnFilterList)) {
                                let rowData = {};
                                config.columns.forEach(p => {
                                    const cellConfig = p.startCell.trim().toUpperCase();
                                    let value;

                                    if (cellConfig.includes(',')) {
                                        const cols = cellConfig.split(',').map(c => c.trim().match(/[A-Z]+/)[0]);
                                        const values = [];
                                        cols.forEach(col => {
                                            const cellAddress = col + (R + 1);
                                            const cell = ws[cellAddress];
                                            const cellValue = cell ? (cell.w || cell.v) : undefined;
                                            if (cellValue !== undefined && cellValue !== null && cellValue !== 0 && String(cellValue).trim() !== '') {
                                                values.push(cellValue);
                                            }
                                        });
                                        value = values.join(' / ');
                                    } else {
                                        const col = cellConfig.match(/[A-Z]+/)[0];
                                        const cellAddress = col + (R + 1);
                                        const cell = ws[cellAddress];
                                        value = cell ? (cell.w || cell.v) : undefined;
                                    }
                                    
                                    if (p.key.toLowerCase() === 'qty' && typeof value === 'number') {
                                        if (value === parseInt(value, 10)) {
                                            value = parseInt(value, 10);
                                        }
                                    }
                                    rowData[p.key] = value;
                                });

                                if (userIsOnFilterList) {
                                    if (isToday) {
                                        rowData.colorClass = 'row-today';
                                    } else if (rowDate.getTime() === yesterday.getTime()) {
                                        rowData.colorClass = 'row-yesterday';
                                    } else {
                                        rowData.colorClass = 'row-past';
                                    }
                                }
                                extractedData.push(rowData);
                            }
                        }
                        
                        if(extractedData.length === 0){ 
                            showModal('Sin Coincidencias', '<p>No se encontraron registros que cumplan con los filtros.</p>'); 
                            renderTable901([]);
                            return; 
                        } 
                        
                        renderTable901(extractedData);
                        showModal('√âxito', `<p>${extractedData.length} registros han sido cargados.</p>`); 
                    } catch (err) { 
                        console.error("Error al procesar archivo 901:", err); 
                        showModal('Error de Archivo', `<p>No se pudo procesar el archivo. Verifique el formato y la configuraci√≥n.</p>`) 
                    } 
                }; 
                reader.readAsArrayBuffer(file); 
            }

            function renderTable901(data) { 
                const tableElement = doc('dataTable901'); 
                const paramConfig = params['901_config'].columns; 
                if (!paramConfig || !paramConfig.length) { 
                    tableElement.innerHTML = `<thead><tr><th>Por favor, configure el mapeo de columnas.</th></tr></thead><tbody></tbody>`; 
                    return; 
                } 
                const headers = paramConfig.map(p => p.key); 
                let html = '<thead><tr>'; 
                headers.forEach(h => html += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`); 
                html += '</tr></thead><tbody>'; 
                data.forEach(row => { 
                    html += `<tr class="${row.colorClass || ''}">`; 
                    headers.forEach(header => { 
                        const value = row[header] ?? '';
                        if (header.toUpperCase() === 'GR') {
                            html += `<td class="copyable" onclick="copyToClipboard('${String(value).replace(/'/g, "\\'")}', this)" title="Haz clic para copiar">${value}</td>`;
                        } else {
                            html += `<td>${value}</td>`; 
                        }
                    }); 
                    html += '</tr>'; 
                }); 
                tableElement.innerHTML = html + '</tbody>'; 
                tableElement.querySelectorAll('.filter-input').forEach(input => { 
                    input.addEventListener('keyup', () => filterTable901()); 
                }); 
            }
            
            function filterTable901() { 
                const table = doc('dataTable901'); 
                const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({ columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')), value: i.value.toLowerCase() })); 
                const rows = table.querySelectorAll('tbody tr'); 
                rows.forEach(row => { 
                    let shouldShow = true; 
                    filters.forEach(filter => { 
                        if (filter.value) { 
                            const cell = row.children[filter.columnIndex]; 
                            if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) { 
                                shouldShow = false; 
                            } 
                        } 
                    }); 
                    row.style.display = shouldShow ? '' : 'none'; 
                }); 
            }
            
            // --- INICIO: INICIALIZACI√ìN DE LA APP ---
            async function initializeApp() {
                if (sessionStorage.getItem('reportesMasterSession') === 'true') session.isMaster = true;
                await Promise.all([ 
                    loadParams('901_config'), 
                    loadParams('terminaciones_config'),
                    loadParams('produccion_hora_config')
                ]);
                
                const today = new Date();
                const timezoneOffset = today.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(today - timezoneOffset)).toISOString().split('T')[0];
                doc('prod_fecha').value = localISOTime;

                applyTheme(currentTheme);
                Object.values(views).forEach(v => { v.style.display = 'none'; v.style.opacity = '0'; });
                views.menu.style.display = 'flex'; views.menu.style.opacity = '1';
            }
            initializeApp();
        });
    </script>
</body>
</html>
