<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Reportes</title>

    <meta name="theme-color" content="#22252a">
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <!-- Fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    
    <!-- Estilos CSS -->
    <style>
        :root {}

        body.dark-theme {
            --bg-gradient: radial-gradient(ellipse at center top, #22252a 0%, #0a0a0a 70%);
            --surface-color: rgba(35, 38, 43, 0.6);
            --surface-hover-color: rgba(55, 58, 63, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #E5E7EB;
            --primary-text-color: #0A0A0A;
            --danger-color: #FB7185;
            --danger-hover-color: #f43f5e;
            --text-primary: #F1F5F9; 
            --text-secondary: #94A3B8;
            --text-dark: #64748B;
            --thead-bg: rgba(55, 65, 81, 0.8);
        }

        body.light-theme {
            --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
            --surface-color: rgba(255, 255, 255, 0.5);
            --surface-hover-color: rgba(243, 244, 246, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #1F2937;
            --primary-text-color: #FFFFFF;
            --danger-color: #EF4444;
            --danger-hover-color: #dc2626;
            --text-primary: #111827; 
            --text-secondary: #4B5563;
            --text-dark: #9CA3AF;
            --branding-color: #0055A5;
            --thead-bg: rgba(229, 231, 235, 0.8);
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        html { min-height: 100%; background-color: #0a0a0a; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--text-primary); margin: 0; min-height: 100vh;
            display: flex; justify-content: center; transition: background 0.3s ease-in-out;
            background-attachment: fixed; padding: 16px; box-sizing: border-box; overflow: hidden;
        }
        .app-container { width: 100%; max-width: 1600px; }
        #menuView, #view901, #viewTerminaciones { transition: opacity 0.3s ease-in-out, display 0.3s; }
        #menuView { display: flex; align-items: center; justify-content: center; height: 100%; }
        .menu-wrapper { width: 100%; max-width: 600px; text-align: center; }
        .animated-startup { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .app-header { text-align: center; margin-bottom: 24px; }
        .app-branding { font-family: 'Tinos', 'Times New Roman', serif; font-weight: 400; font-size: 2.5rem; color: var(--text-primary); letter-spacing: 2px; margin: 0; transition: color 0.3s ease-in-out; }
        body.light-theme .app-branding { color: var(--branding-color); }
        .app-title { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin: 4px 0 0 0; }

        .card, .modal-content {
            background-color: var(--surface-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 24px; border-top: 1px solid rgba(255, 255, 255, 0.15); border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3); border-right: 2px solid rgba(0, 0, 0, 0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        body.light-theme .card, body.light-theme .modal-content {
            border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1); border-right: 2px solid rgba(0, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .menu-container { display: flex; flex-direction: column; gap: 16px; }
        .btn { padding: 16px 24px; border-radius: 12px; cursor: pointer; background-color: var(--primary-color); border: none; color: var(--primary-text-color); font-weight: 700; font-size: 1.1rem; text-align: center; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .theme-switcher-container { position: absolute; top: 16px; right: 16px; }
        #themeToggleBtn { padding: 8px 12px; font-size: 1.5rem; line-height: 1; background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); }
        #themeToggleBtn:hover { background-color: var(--surface-hover-color); color: var(--text-primary); }
        #view901, #viewTerminaciones { display: none; width: 100%; }
        .main-container { display: grid; grid-template-columns: 320px 1fr; gap: 16px; width: 100%; height: calc(100vh - 120px); }
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: var(--text-primary); background-color: var(--surface-hover-color); }
        .main-content { display: flex; flex-direction: column; gap: 16px; }
        .chart-and-summary-container { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; height: 300px; }
        #chartContainer, #chartSummary { padding: 16px; }
        .table-container { flex-grow: 1; }
        .table-wrapper { overflow: auto; height: 100%; border-radius: 12px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; }
        .file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-top: 16px; }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area h4 { margin: 0 0 8px 0; color: var(--text-secondary); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s; width: 90%; max-width: 700px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; text-align: center; width: 100%; color: var(--text-primary);}
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody input, #modalBody select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary); box-sizing: border-box;}
        .param-list, .area-list { list-style: none; padding: 0; margin: 16px 0; max-height: 45vh; overflow-y: auto;}
        .param-item { display: grid; grid-template-columns: auto 1fr 1.2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .param-item input, .param-item select { margin: 0; }
        .param-value-container { grid-column: 4; }
        .hidden { display: none; }
        .area-item { display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .area-source-container { display: flex; flex-direction: column; gap: 4px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
        .area-source-container label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .btn-danger { background-color: var(--danger-color); color: white; width: auto; padding: 8px 12px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .drag-handle { cursor: grab; color: var(--text-dark); padding: 4px; display: flex; align-items: center; }
        .drag-handle:active { cursor: grabbing; }
        .param-item.dragging { opacity: 0.5; background-color: var(--primary-color); }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px;}
        .tab-btn { background: none; border: none; padding: 10px 16px; cursor: pointer; color: var(--text-dark); font-weight: 600; border-bottom: 3px solid transparent;}
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--primary-color);}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .formula-helpers { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .helper-pill { background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .helper-pill:hover { background-color: var(--primary-color); color: var(--primary-text-color); border-color: var(--primary-color); }
        #login-error-msg { color: var(--danger-color); text-align: center; margin-top: 10px; font-weight: 500; height: 1em; }
        
        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .sidebar { position: static; height: auto; }
            .chart-and-summary-container { grid-template-columns: 1fr; height: auto; }
        }
    </style>
</head>
<body class="dark-theme">

    <div class="theme-switcher-container">
        <button id="themeToggleBtn" class="btn">‚òÄÔ∏è</button>
    </div>

    <div class="app-container">
        <!-- VISTA DEL MEN√ö PRINCIPAL -->
        <div id="menuView">
            <div class="menu-wrapper">
                <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Centro de Reportes</h2></header>
                <main class="card animated-startup" style="animation-delay: 0.1s;">
                    <div class="menu-container">
                        <button id="reporteTerminacionesBtn" class="btn">Reporte de Terminaciones</button>
                        <button id="view901Btn" class="btn">901</button>
                    </div>
                </main>
            </div>
        </div>

        <!-- VISTA 901 (Restaurada) -->
        <div id="view901">
            <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte 901</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div id="fileDropArea901" class="file-drop-area"><p>Arrastra un archivo aqu√≠</p></div>
                        <input type="file" id="fileInput901" accept=".xlsx, .xls" style="display: none;">
                    </div>
                </aside>
                <main class="main-content card table-container animated-startup" style="animation-delay: 0.2s;">
                    <div class="table-wrapper">
                        <table id="dataTable901"><thead><tr><th>Carga un archivo para ver los datos</th></tr></thead><tbody></tbody></table>
                    </div>
                </main>
            </div>
        </div>

        <!-- VISTA REPORTE TERMINACIONES -->
        <div id="viewTerminaciones">
             <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Terminaciones</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;"><div class="card" style="height: 100%; display: flex; flex-direction: column;"><div class="sidebar-header"><h3>Panel de Control</h3><div><button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button><button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button></div></div><div id="fileDropAreaK1" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Archivo K1</h4><p>Arrastra un archivo aqu√≠</p></div><input type="file" id="fileInputK1" accept=".xlsx, .xls" style="display: none;"><div id="fileDropAreaK2" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Archivo K2</h4><p>Arrastra un archivo aqu√≠</p></div><input type="file" id="fileInputK2" accept=".xlsx, .xls" style="display: none;"></div></aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;"><div class="card chart-and-summary-container"><div id="chartSummary"><h3 style="margin-top: 0;">Resumen</h3><p><strong>√Årea:</strong> <span id="summaryArea">N/A</span></p><p><strong>Terminaciones:</strong> <span id="summaryTerminaciones">N/A</span></p><p><strong>Fecha:</strong> <span id="summaryFecha">N/A</span></p></div><div id="chartContainer" style="position: relative; height: 100%; width: 100%;"><canvas id="terminacionesChart"></canvas></div></div><div class="card table-container"><div class="table-wrapper"><table id="dataTableTerminaciones"><thead><tr><th>Carga los archivos K1 y K2 para ver los datos</th></tr></thead><tbody></tbody></table></div></div></main>
            </div>
        </div>
    </div>

    <!-- MODAL GENERAL -->
    <div id="modalOverlay" class="modal-overlay"><div id="modalContent" class="modal-content"><span id="modalClose" class="modal-close">&times;</span><h2 id="modalTitle" class="modal-title"></h2><div id="modalBody" style="margin-top:16px; color: var(--text-secondary);"></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0", authDomain: "rastreador-de-ordenes.firebaseapp.com", projectId: "rastreador-de-ordenes", storageBucket: "rastreador-de-ordenes.appspot.com", messagingSenderId: "956052823395", appId: "1:956052823395:web:2ba74d9591d2b24c3cc756" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const doc = (id) => document.getElementById(id);
            const views = { menu: doc('menuView'), '901': doc('view901'), terminaciones: doc('viewTerminaciones') };
            let session = { isMaster: false }; let activeView = 'menu';
            let params = { '901': [], terminaciones_k1: [], terminaciones_k2: [], terminaciones_areas: { sourceCell: '', mappings: [] } };
            let reportData = { k1: null, k2: null }; let terminacionesChartInstance = null;
            
            function switchView(viewKey) {
                const currentViewEl = views[activeView]; const nextViewEl = views[viewKey]; if (!nextViewEl) return;
                activeView = viewKey; currentViewEl.style.opacity = '0';
                setTimeout(() => {
                    currentViewEl.style.display = 'none'; nextViewEl.style.display = viewKey === 'menu' ? 'flex' : 'block';
                    requestAnimationFrame(() => { nextViewEl.style.opacity = '1'; });
                }, 300);
            }
            doc('view901Btn').addEventListener('click', () => switchView('901'));
            doc('reporteTerminacionesBtn').addEventListener('click', () => switchView('terminaciones'));
            document.querySelectorAll('.backToMenuBtn').forEach(btn => btn.addEventListener('click', () => switchView('menu')));
            let currentTheme = localStorage.getItem('theme') || 'dark';
            function applyTheme(theme) { document.body.className = `${theme}-theme`; doc('themeToggleBtn').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è'; }
            doc('themeToggleBtn').addEventListener('click', () => { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); });

            const modalOverlay = doc('modalOverlay');
            function showModal(title, content) { doc('modalTitle').textContent = title; doc('modalBody').innerHTML = content; modalOverlay.classList.add('visible'); }
            function hideModal() { modalOverlay.classList.remove('visible'); }
            doc('modalClose').addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

            document.querySelectorAll('.settingsBtn').forEach(btn => btn.addEventListener('click', () => { session.isMaster ? showParamsModal() : showLoginModal(); }));
            function showLoginModal() {
                const content = `<p style="text-align: center;">Introduce las credenciales de maestro.</p><input type="text" id="userInput" placeholder="Usuario"><input type="password" id="passInput" placeholder="Contrase√±a"><button id="loginBtn" class="btn" style="margin-top: 16px; width: 100%;">Autenticar</button><div id="login-error-msg"></div>`;
                showModal('Autenticaci√≥n Maestra', content);
                doc('loginBtn').addEventListener('click', checkMasterCredentials);
            }
            function checkMasterCredentials() {
                const errorMsgEl = doc('login-error-msg');
                if (doc('userInput').value === 'LUNAU' && doc('passInput').value === 'Resoner96') {
                    session.isMaster = true; sessionStorage.setItem('reportesMasterSession', 'true'); hideModal(); showParamsModal();
                } else {
                    errorMsgEl.textContent = 'Credenciales incorrectas.';
                }
            }

            function showParamsModal() {
                if (activeView === '901') {
                     const paramsHTML = `<ul class="param-list param-list-901">${params['901'].map(p => createParamItem901(p.key, p.cell)).join('')}</ul>`;
                    const content = `
                        <p style="text-align:center;">Define los nombres de columna y las celdas de Excel.</p>
                        ${paramsHTML}
                        <button id="addParam901Btn" class="btn" style="width: auto; padding: 8px 16px;">A√±adir Par√°metro</button>
                        <button id="saveParams901Btn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Cambios</button>`;
                    showModal('Configurar Par√°metros 901', content);
                    doc('addParam901Btn').addEventListener('click', () => {
                        doc('modalBody').querySelector('.param-list-901').insertAdjacentHTML('beforeend', createParamItem901('', ''));
                    });
                    doc('saveParams901Btn').addEventListener('click', saveParams901);

                } else if (activeView === 'terminaciones') {
                    showTabbedParamConfig();
                }
            }
            
            function createParamItem901(key, cell) {
                 return `
                    <li class="param-item" style="grid-template-columns: 1fr 1fr auto;">
                        <input type="text" class="param-key" placeholder="Nombre de Columna" value="${key || ''}">
                        <input type="text" class="param-cell" placeholder="Celda (ej. A1)" value="${cell || ''}">
                        <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>
                    </li>`;
            }

            async function saveParams901() {
                const newParams = Array.from(doc('modalBody').querySelectorAll('.param-item')).map(item => ({
                    key: item.querySelector('.param-key').value.trim(),
                    cell: item.querySelector('.param-cell').value.trim().toUpperCase()
                })).filter(p => p.key && p.cell);

                try {
                    await db.collection('report_configs').doc('901_params').set({ params: newParams });
                    params['901'] = newParams;
                    showModal('√âxito', '<p>Par√°metros de 901 guardados.</p>');
                } catch (e) {
                    console.error("Error al guardar par√°metros 901:", e);
                    showModal('Error', '<p>No se pudieron guardar los par√°metros.</p>');
                }
            }
            
            function showTabbedParamConfig() {
                const areaConfig = params.terminaciones_areas;
                const content = `
                    <div class="modal-tabs">
                        <button class="tab-btn active" data-tab="k1">Mapeo K1</button>
                        <button class="tab-btn" data-tab="k2">Mapeo K2</button>
                        <button class="tab-btn" data-tab="areas">Mapeo de √Åreas</button>
                    </div>
                    <div id="tab-k1" class="tab-content active"><ul class="param-list">${params.terminaciones_k1.map(p => createParamItemHTML(p.key, p.type, p.value)).join('')}</ul></div>
                    <div id="tab-k2" class="tab-content"><ul class="param-list">${params.terminaciones_k2.map(p => createParamItemHTML(p.key, p.type, p.value)).join('')}</ul></div>
                    <div id="tab-areas" class="tab-content">
                        <div class="area-source-container">
                            <label for="area-source-cell">Celda que contiene el C√≥digo de √Årea</label>
                            <input type="text" id="area-source-cell" placeholder="Ej. N1" value="${areaConfig.sourceCell || ''}">
                        </div>
                        <p style="text-align:center;">Define la correspondencia entre el c√≥digo y el nombre del √°rea.</p>
                        <ul class="area-list">${areaConfig.mappings.map(a => createAreaItemHTML(a.code, a.name)).join('')}</ul>
                    </div>
                    <button class="addBtn btn" style="width: auto; padding: 8px 16px;">A√±adir Fila</button>
                    <button id="saveTerminacionesSettingsBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Toda la Configuraci√≥n</button>`;
                showModal('Configurar Reporte de Terminaciones', content);
                
                const modalBody = doc('modalBody');
                modalBody.querySelectorAll('.tab-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        modalBody.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                        button.classList.add('active'); doc(`tab-${button.dataset.tab}`).classList.add('active');
                    });
                });
                
                modalBody.querySelector('.addBtn').addEventListener('click', () => {
                    const activeTab = modalBody.querySelector('.tab-content.active');
                    if(activeTab.id === 'tab-areas') {
                        activeTab.querySelector('.area-list').insertAdjacentHTML('beforeend', createAreaItemHTML('', ''));
                    } else {
                        activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createParamItemHTML('', 'cell', ''));
                    }
                });

                doc('saveTerminacionesSettingsBtn').addEventListener('click', saveTerminacionesSettings);
            }
            
            function createParamItemHTML(key, type, value) {
                const options = `
                    <option value="cell" ${type === 'cell' ? 'selected' : ''}>Celda Directa</option>
                    <option value="formula" ${type === 'formula' ? 'selected' : ''}>F√≥rmula</option>
                    <option value="area_identifier" ${type === 'area_identifier' ? 'selected' : ''}>Identificador de √Årea</option>
                `;
                const valueContainerVisible = type !== 'area_identifier';

                return `
                    <li class="param-item" draggable="true" ondragover="event.preventDefault()">
                        <span class="drag-handle" title="Arrastrar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg></span>
                        <input type="text" class="param-key" placeholder="Nombre Columna" value="${key || ''}">
                        <select class="param-type">${options}</select>
                        <div class="param-value-container ${!valueContainerVisible ? 'hidden' : ''}">
                            <input type="text" class="param-cell-input ${type !== 'cell' ? 'hidden' : ''}" placeholder="Celda (ej. A1)" value="${type === 'cell' ? value : ''}">
                            <input type="text" class="param-formula-input ${type !== 'formula' ? 'hidden' : ''}" placeholder="Escribe o usa las p√≠ldoras" value="${type === 'formula' ? value : ''}" onfocus="populateFormulaHelpers(this)">
                            <div class="formula-helpers"></div>
                        </div>
                        <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>
                    </li>`;
            }

            function createAreaItemHTML(code, name) {
                return `<li class="area-item"><input type="text" class="area-code" placeholder="C√≥digo (ej. K46)" value="${code || ''}"><input type="text" class="area-name" placeholder="Nombre de √Årea (ej. Multiport)" value="${name || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`;
            }

            window.populateFormulaHelpers = (inputElement) => {
                const container = inputElement.nextElementSibling; container.innerHTML = '';
                const availableCols = [...getParamsFromContainer(doc('tab-k1')), ...getParamsFromContainer(doc('tab-k2'))].map(p => p.key).filter(Boolean);
                const uniqueCols = [...new Set(availableCols)];
                uniqueCols.forEach(colName => {
                    const pill = document.createElement('button');
                    pill.className = 'helper-pill'; pill.textContent = colName;
                    pill.onclick = (e) => { e.preventDefault(); insertAtCursor(inputElement, `{${colName}}`); };
                    container.appendChild(pill);
                });
            };

            function insertAtCursor(input, text) {
                const start = input.selectionStart; input.value = input.value.substring(0, start) + text + input.value.substring(input.selectionEnd);
                input.focus(); input.selectionEnd = start + text.length;
            }

            doc('modalOverlay').addEventListener('change', (e) => {
                if (e.target.classList.contains('param-type')) {
                    const item = e.target.closest('.param-item');
                    const valueContainer = item.querySelector('.param-value-container');
                    const cellInput = valueContainer.querySelector('.param-cell-input');
                    const formulaInput = valueContainer.querySelector('.param-formula-input');
                    valueContainer.classList.toggle('hidden', e.target.value === 'area_identifier');
                    cellInput.classList.toggle('hidden', e.target.value !== 'cell');
                    formulaInput.classList.toggle('hidden', e.target.value !== 'formula');
                }
            });
            
            async function saveTerminacionesSettings() {
                const newParamsK1 = getParamsFromContainer(doc('tab-k1'));
                const newParamsK2 = getParamsFromContainer(doc('tab-k2'));
                const newAreaConfig = {
                    sourceCell: doc('area-source-cell').value.trim().toUpperCase(),
                    mappings: getAreasFromContainer(doc('tab-areas'))
                };
                try {
                    await db.collection('report_configs').doc('terminaciones_k1_params').set({ params: newParamsK1 });
                    await db.collection('report_configs').doc('terminaciones_k2_params').set({ params: newParamsK2 });
                    await db.collection('report_configs').doc('terminaciones_areas_params').set(newAreaConfig);
                    params.terminaciones_k1 = newParamsK1; params.terminaciones_k2 = newParamsK2; params.terminaciones_areas = newAreaConfig;
                    showModal('√âxito', '<p>Toda la configuraci√≥n se guard√≥ correctamente.</p>');
                } catch(e) { console.error("Error al guardar:", e); showModal('Error', '<p>No se pudo guardar la configuraci√≥n.</p>'); }
            }

            function getParamsFromContainer(container) {
                return Array.from(container.querySelectorAll('.param-item')).map(item => {
                    const key = item.querySelector('.param-key').value.trim();
                    const type = item.querySelector('.param-type').value;
                    let value = '';
                    if (type === 'cell') value = item.querySelector('.param-cell-input').value.trim().toUpperCase();
                    else if (type === 'formula') value = item.querySelector('.param-formula-input').value.trim();
                    return { key, type, value };
                }).filter(p => p.key);
            }

            function getAreasFromContainer(container) {
                 return Array.from(container.querySelectorAll('.area-item')).map(item => ({
                    code: item.querySelector('.area-code').value.trim(),
                    name: item.querySelector('.area-name').value.trim(),
                })).filter(a => a.code && a.name);
            }

            async function loadParams(configKey) {
                try {
                    const docRef = await db.collection('report_configs').doc(`${configKey}_params`).get();
                    if (docRef.exists) {
                         if (configKey === 'terminaciones_areas') {
                             params[configKey] = { sourceCell: '', mappings: [], ...docRef.data() };
                         } else {
                             params[configKey] = docRef.data().params || [];
                         }
                    }
                } catch(e) { console.error(`Error al cargar ${configKey}:`, e); }
            }

            function setupFileHandler(dropAreaId, inputId, configKey) {
                const dropArea = doc(dropAreaId); const input = doc(inputId);
                dropArea.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0], configKey); });
                dropArea.addEventListener('dragover', (e) => e.preventDefault());
                dropArea.addEventListener('drop', (e) => { e.preventDefault(); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], configKey); });
            }
            setupFileHandler('fileDropArea901', 'fileInput901', '901');
            setupFileHandler('fileDropAreaK1', 'fileInputK1', 'terminaciones_k1');
            setupFileHandler('fileDropAreaK2', 'fileInputK2', 'terminaciones_k2');

            function handleFile(file, configKey) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        
                        if (configKey === '901') {
                            const data901 = {};
                            params['901'].forEach(p => {
                                data901[p.key] = ws[p.cell] ? ws[p.cell].v : undefined;
                            });
                            renderTable([data901], params['901'], doc('dataTable901'));
                        } else {
                            const data = {};
                             params[configKey].filter(p => p.type === 'cell').forEach(p => {
                                data[p.key] = ws[p.value] ? ws[p.value].v : undefined;
                            });
                            if (configKey === 'terminaciones_k1') {
                                reportData.k1 = data; doc('fileDropAreaK1').style.borderColor = '#4ade80';
                            } else if (configKey === 'terminaciones_k2') {
                                reportData.k2 = data; doc('fileDropAreaK2').style.borderColor = '#4ade80';
                            }
                            updateTerminacionesView();
                        }
                    } catch (err) { 
                        console.error("Error al procesar archivo:", err);
                        showModal('Error de Archivo', '<p>No se pudo procesar el archivo Excel. Verifique que el formato y los datos sean correctos.</p>')
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            const formulaHelpers = {
                EXTRAER: (text, start, length) => (typeof text !== 'string' || text === null) ? '' : String(text).substring(start - 1, start - 1 + length),
                EXTRAER_FIBRAS: (text, start, length) => {
                    if(typeof text !== 'string' || text === null) return '';
                    const sub = String(text).substring(start - 1, start - 1 + length);
                    return sub.toUpperCase() === 'T' ? 12 : sub;
                },
                IF: (condition, valueIfTrue, valueIfFalse) => condition ? valueIfTrue : valueIfFalse,
            };

            function processCalculatedFields(data, allParams) {
                const processedData = { ...data };
                
                // Process area identifier first as it's a dependency for others
                const areaParam = allParams.find(p => p.type === 'area_identifier');
                if (areaParam) {
                    const areaConfig = params.terminaciones_areas;
                    const sourceCell = areaConfig.sourceCell;
                    const sourceParam = allParams.find(p => p.type === 'cell' && p.value === sourceCell);
                    if(sourceParam && processedData[sourceParam.key] !== undefined) {
                        const code = processedData[sourceParam.key];
                        const mapping = areaConfig.mappings.find(a => String(a.code).trim() === String(code).trim());
                        processedData[areaParam.key] = mapping ? mapping.name : '√Årea Desconocida';
                    } else {
                        processedData[areaParam.key] = 'Celda de C√≥digo no definida';
                    }
                }

                // Iteratively process formulas to handle dependencies
                const formulaParams = allParams.filter(p => p.type === 'formula');
                let processedCount = 0;
                let iterations = 0;
                while(processedCount < formulaParams.length && iterations < 10) {
                     formulaParams.forEach(p => {
                        if (processedData[p.key] !== undefined) return; // Already processed
                        try {
                            const dependencies = (p.value.match(/\{([^}]+)\}/g) || []).map(d => d.slice(1, -1));
                            const allDependenciesMet = dependencies.every(dep => processedData[dep] !== undefined);
                            
                            if(allDependenciesMet) {
                                let formula = p.value.replace(/\{([^}]+)\}/g, (match, key) => `data['${key.trim()}']`);
                                const func = new Function('data', 'helpers', `const {${Object.keys(helpers).join(',')}} = helpers; return ${formula}`);
                                processedData[p.key] = func(processedData, formulaHelpers);
                                processedCount++;
                            }
                        } catch (e) { processedData[p.key] = '¬°ERROR!'; processedCount++;}
                    });
                    iterations++;
                }

                return processedData;
            }

            function cleanFinalData(data) {
                const cleanedData = {...data};
                // Clean terminaciones
                if (cleanedData['Terminaciones'] !== undefined) {
                    let value = parseFloat(cleanedData['Terminaciones']);
                    if (isNaN(value) || value < 0) {
                        value = 0;
                    }
                    cleanedData['Terminaciones'] = value;
                }
                 return cleanedData;
            }

            function updateTerminacionesView() {
                if(reportData.k1 && reportData.k2) {
                    const combinedData = {...reportData.k1, ...reportData.k2};
                    const allParams = [...params.terminaciones_k1, ...params.terminaciones_k2];
                    
                    let finalData = processCalculatedFields(combinedData, allParams);
                    finalData = cleanFinalData(finalData);

                    renderTable([finalData], allParams, doc('dataTableTerminaciones'));
                    
                    const areaCol = allParams.find(p => p.type === 'area_identifier');
                    doc('summaryArea').textContent = areaCol && finalData[areaCol.key] ? finalData[areaCol.key] : 'N/A';
                    doc('summaryTerminaciones').textContent = finalData['Terminaciones'] ?? 'N/A'; // Use nullish coalescing
                    doc('summaryFecha').textContent = finalData['Fecha'] || 'N/A';
                    
                    const terminacionesValue = finalData['Terminaciones'];
                    if (typeof terminacionesValue === 'number') {
                         renderTerminacionesChart(terminacionesValue);
                    }
                }
            }
            
            function renderTable(data, paramConfig, tableElement) {
                if (!data || !data.length || !paramConfig || !paramConfig.length) {
                    tableElement.innerHTML = `<thead><tr><th>Sin datos para mostrar o sin configuraci√≥n.</th></tr></thead><tbody></tbody>`;
                    return;
                }
                const headers = paramConfig.map(p => p.key);
                let html = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                data.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => { html += `<td>${row[header] ?? ''}</td>`; });
                    html += '</tr>';
                });
                tableElement.innerHTML = html + '</tbody>';
            }
            
            function renderTerminacionesChart(terminaciones) {
                const ctx = doc('terminacionesChart').getContext('2d');
                if (terminacionesChartInstance) terminacionesChartInstance.destroy();
                terminacionesChartInstance = new Chart(ctx, { type: 'pie', data: { labels: ['Terminaciones', 'Restante'], datasets: [{ data: [terminaciones, 100 - terminaciones], backgroundColor: ['rgba(75, 192, 192, 0.7)','rgba(255, 99, 132, 0.7)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'var(--text-secondary)' } } } } });
            }

            async function initializeApp() {
                if (sessionStorage.getItem('reportesMasterSession') === 'true') session.isMaster = true;
                await Promise.all(Object.keys(params).map(key => loadParams(key)));
                applyTheme(currentTheme);
                Object.values(views).forEach(v => { v.style.display = 'none'; v.style.opacity = '0'; });
                views.menu.style.display = 'flex'; views.menu.style.opacity = '1';
            }
            
            initializeApp();
        });
    </script>
</body>
</html>