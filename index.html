<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Reportes</title>

    <meta name="theme-color" content="#22252a">
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    
    <!-- Estilos CSS -->
    <style>
        :root {}

        body.dark-theme {
            --bg-gradient: radial-gradient(ellipse at center top, #22252a 0%, #0a0a0a 70%);
            --surface-color: rgba(35, 38, 43, 0.6);
            --surface-hover-color: rgba(55, 58, 63, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #E5E7EB;
            --primary-text-color: #0A0A0A;
            --danger-color: #FB7185;
            --danger-hover-color: #f43f5e;
            --text-primary: #F1F5F9; 
            --text-secondary: #94A3B8;
            --text-dark: #64748B;
            --thead-bg: rgba(55, 65, 81, 0.8);
            --sticky-col-bg: #2a2d32;
            --success-color: #4ade80;
            --row-today-bg: rgba(74, 222, 128, 0.1);
            --row-yesterday-bg: rgba(251, 191, 36, 0.1);
            --row-past-bg: rgba(244, 63, 94, 0.1);
        }

        body.light-theme {
            --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
            --surface-color: rgba(255, 255, 255, 0.5);
            --surface-hover-color: rgba(243, 244, 246, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #1F2937;
            --primary-text-color: #FFFFFF;
            --danger-color: #EF4444;
            --danger-hover-color: #dc2626;
            --text-primary: #111827; 
            --text-secondary: #4B5563;
            --text-dark: #9CA3AF;
            --branding-color: #0055A5;
            --thead-bg: rgba(229, 231, 235, 0.8);
            --sticky-col-bg: #f1f5f9;
            --success-color: #22c55e;
            --row-today-bg: rgba(34, 197, 94, 0.1);
            --row-yesterday-bg: rgba(245, 158, 11, 0.1);
            --row-past-bg: rgba(239, 68, 68, 0.1);
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        html { min-height: 100%; background-color: #0a0a0a; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--text-primary); margin: 0; min-height: 100vh;
            display: flex; justify-content: center; transition: background 0.3s ease-in-out;
            background-attachment: fixed; padding: 16px; box-sizing: border-box; overflow-x: hidden;
        }
        .app-container { width: 100%; max-width: 1600px; }
        #menuView, #view901, #viewTerminaciones { transition: opacity 0.3s ease-in-out, display 0.3s; }
        #menuView { display: flex; align-items: center; justify-content: center; height: 100%; }
        .menu-wrapper { width: 100%; max-width: 600px; text-align: center; }
        .animated-startup { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .app-header { text-align: center; margin-bottom: 24px; }
        .app-branding { font-family: 'Tinos', 'Times New Roman', serif; font-weight: 400; font-size: 2.5rem; color: var(--text-primary); letter-spacing: 2px; margin: 0; transition: color 0.3s ease-in-out; }
        body.light-theme .app-branding { color: var(--branding-color); }
        .app-title { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin: 4px 0 0; }

        .card, .modal-content {
            background-color: var(--surface-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 24px; border-top: 1px solid rgba(255, 255, 255, 0.15); border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3); border-right: 2px solid rgba(0, 0, 0, 0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        body.light-theme .card, body.light-theme .modal-content {
            border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1); border-right: 2px solid rgba(0, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .menu-container { display: flex; flex-direction: column; gap: 16px; }
        .btn { padding: 16px 24px; border-radius: 12px; cursor: pointer; background-color: var(--primary-color); border: none; color: var(--primary-text-color); font-weight: 700; font-size: 1.1rem; text-align: center; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .theme-switcher-container { position: absolute; top: 16px; right: 16px; }
        #themeToggleBtn { padding: 8px 12px; font-size: 1.5rem; line-height: 1; background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); }
        #themeToggleBtn:hover { background-color: var(--surface-hover-color); color: var(--text-primary); }
        #view901, #viewTerminaciones { display: none; width: 100%; }
        .main-container { display: grid; grid-template-columns: 320px 1fr; gap: 16px; width: 100%; height: calc(100vh - 120px); }
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: var(--text-primary); background-color: var(--surface-hover-color); }
        .main-content { display: flex; flex-direction: column; gap: 16px; min-height: 0; }
        #summaryContainer { flex-shrink: 0; padding: 16px; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .summary-header h3 { margin: 0; }
        .table-container { flex-grow: 1; min-height: 0; }
        .table-wrapper { overflow: auto; height: 100%; border-radius: 12px; border: 1px solid var(--border-color); }
        #summaryContainer .table-wrapper { border: none; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; vertical-align: middle; }
        #dataTable901 th { display: flex; flex-direction: column; align-items: flex-start; }
        .copyable { cursor: pointer; transition: color 0.2s; }
        .copyable:hover { color: var(--success-color); }
        .filter-input { 
            width: 100%; 
            box-sizing: border-box;
            background-color: var(--surface-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 4px; 
            padding: 4px 6px; 
            margin-top: 4px; 
            font-size: 0.8rem; 
        }
        .file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-top: 16px; }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area h4 { margin: 0 0 8px 0; color: var(--text-secondary); }
        #summaryContainer table th, #summaryContainer table td { text-align: right; }
        #summaryContainer table th:first-child, #summaryContainer table td:first-child { 
            text-align: left; font-weight: bold; position: sticky; left: 0; z-index: 1;
            background-color: var(--sticky-col-bg);
        }
        #summaryContainer table .grand-total { font-weight: bold; border-top: 2px solid var(--border-color); }

        .row-today { background-color: var(--row-today-bg) !important; }
        .row-yesterday { background-color: var(--row-yesterday-bg) !important; }
        .row-past { background-color: var(--row-past-bg) !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s; width: 90%; max-width: 800px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; text-align: center; width: 100%; color: var(--text-primary);}
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody input, #modalBody select, #modalBody textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary); box-sizing: border-box;}
        #modalBody textarea { min-height: 80px; resize: vertical; }
        #modalBody p { font-size: 0.9em; color: var(--text-dark); margin-top:4px; }
        .param-list, .area-list { list-style: none; padding: 0; margin: 16px 0; max-height: 45vh; overflow-y: auto;}
        .param-item { display: grid; grid-template-columns: auto 1fr 1.2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .param-item input, .param-item select { margin: 0; }
        .param-value-container { grid-column: 4; }
        .hidden { display: none; }
        .area-item { display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .area-source-container, .user-filter-container { display: flex; flex-direction: column; gap: 4px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
        .area-source-container label, .user-filter-container label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;}
        .btn-danger { background-color: var(--danger-color); color: white; width: auto; padding: 8px 12px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .drag-handle { cursor: grab; color: var(--text-dark); padding: 4px; display: flex; align-items: center; }
        .drag-handle:active { cursor: grabbing; }
        .param-item.dragging { opacity: 0.5; background-color: var(--primary-color); }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px;}
        .tab-btn { background: none; border: none; padding: 10px 16px; cursor: pointer; color: var(--text-dark); font-weight: 600; border-bottom: 3px solid transparent;}
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--primary-color);}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .formula-helpers { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .helper-pill { background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .helper-pill:hover { background-color: var(--primary-color); color: var(--primary-text-color); border-color: var(--primary-color); }
        #login-error-msg { color: var(--danger-color); text-align: center; margin-top: 10px; font-weight: 500; height: 1em; }

        @media (max-width: 900px), (max-height: 450px) {
            body { overflow-y: auto; padding: 8px; }
            .app-header { margin-bottom: 16px; }
            .app-branding { font-size: 2rem; }
            .app-title { font-size: 1rem; }
            .main-container { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; gap: 12px; }
            .sidebar { height: auto; }
            .main-content { min-height: 50vh; gap: 12px; min-width: 0; }
            .card { padding: 16px; }
            .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table th, table td { padding: 8px 10px; font-size: 0.8rem; text-align: center; }
            #summaryContainer table th:first-child, #summaryContainer table td:first-child { text-align: left; }
            .modal-content { width: 95%; max-height: 85vh; display: flex; flex-direction: column; }
            #modalBody { overflow-y: auto; }
            .param-item, .area-item { grid-template-columns: 1fr; gap: 8px; text-align: left; }
            .param-item .btn-danger, .area-item .btn-danger { justify-self: end; }
            .param-value-container { grid-column: 1; }
        }
    </style>
</head>
<body class="dark-theme">

    <div class="theme-switcher-container">
        <button id="themeToggleBtn" class="btn">‚òÄÔ∏è</button>
    </div>

    <div class="app-container">
        <div id="menuView">
            <div class="menu-wrapper">
                <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Centro de Reportes</h2></header>
                <main class="card animated-startup" style="animation-delay: 0.1s;">
                    <div class="menu-container">
                        <button id="reporteTerminacionesBtn" class="btn">Reporte de Terminaciones</button>
                        <button id="view901Btn" class="btn">901</button>
                    </div>
                </main>
            </div>
        </div>

        <div id="view901">
            <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte 901</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div id="fileDropArea901" class="file-drop-area"><p>Arrastra un archivo para a√±adir registros</p></div>
                        <input type="file" id="fileInput901" accept=".xlsx, .xls" style="display: none;">
                    </div>
                </aside>
                <main class="main-content card table-container animated-startup" style="animation-delay: 0.2s;">
                    <div class="table-wrapper">
                        <table id="dataTable901"><thead><tr><th>Carga un archivo para ver los datos...</th></tr></thead><tbody></tbody></table>
                    </div>
                </main>
            </div>
        </div>

        <div id="viewTerminaciones">
             <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Terminaciones</h2></header>
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;"><div class="card" style="height: 100%; display: flex; flex-direction: column;"><div class="sidebar-header"><h3>Panel de Control</h3><div><button class="backToMenuBtn icon-btn" title="Regresar al Men√∫"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button><button class="settingsBtn icon-btn" title="Configuraci√≥n"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button></div></div>
                    <div id="fileDropAreaZpptwc" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Zpptwc)</h4><p>Arrastra el primer archivo aqu√≠</p></div><input type="file" id="fileInputZpptwc" accept=".xlsx, .xls" style="display: none;">
                    <div id="fileDropAreaCoois" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Coois)</h4><p>Arrastra el segundo archivo aqu√≠</p></div><input type="file" id="fileInputCoois" accept=".xlsx, .xls" style="display: none;">
                </div></aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <div class="card" id="summaryContainer">
                        <div class="summary-header">
                           <h3>Resumen de Terminaciones</h3>
                        </div>
                        <p>Cargue los archivos para ver el resumen.</p>
                    </div>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableTerminaciones"><thead><tr><th>Carga los dos reportes de SAP para generar el informe</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay"><div id="modalContent" class="modal-content"><span id="modalClose" class="modal-close">&times;</span><h2 id="modalTitle" class="modal-title"></h2><div id="modalBody" style="margin-top:16px; color: var(--text-secondary);"></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0", authDomain: "rastreador-de-ordenes.firebaseapp.com", projectId: "rastreador-de-ordenes", storageBucket: "rastreador-de-ordenes.appspot.com", messagingSenderId: "956052823395", appId: "1:956052823395:web:2ba74d9591d2b24c3cc756" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const doc = (id) => document.getElementById(id);
            const views = { menu: doc('menuView'), '901': doc('view901'), terminaciones: doc('viewTerminaciones') };
            let session = { isMaster: false }; let activeView = 'menu';
            let params = { 
                '901_config': { columns: [], userFilter: [] },
                terminaciones_config: {
                    zpptwc_cols: [],
                    coois_cols: [],
                    final_cols: [],
                    area_config: { source_col: '', mappings: [] }
                }
            };
            let reportData = { zpptwc: null, coois: null };
            
            function switchView(viewKey) {
                const currentViewEl = views[activeView]; const nextViewEl = views[viewKey]; if (!nextViewEl) return;
                activeView = viewKey; currentViewEl.style.opacity = '0';
                setTimeout(() => {
                    currentViewEl.style.display = 'none'; nextViewEl.style.display = viewKey === 'menu' ? 'flex' : 'block';
                    requestAnimationFrame(() => { nextViewEl.style.opacity = '1'; });
                }, 300);
            }
            doc('view901Btn').addEventListener('click', () => switchView('901'));
            doc('reporteTerminacionesBtn').addEventListener('click', () => switchView('terminaciones'));
            document.querySelectorAll('.backToMenuBtn').forEach(btn => btn.addEventListener('click', () => switchView('menu')));
            let currentTheme = localStorage.getItem('theme') || 'dark';
            function applyTheme(theme) { document.body.className = `${theme}-theme`; doc('themeToggleBtn').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è'; }
            doc('themeToggleBtn').addEventListener('click', () => { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); });

            const modalOverlay = doc('modalOverlay');
            function showModal(title, content) { doc('modalTitle').textContent = title; doc('modalBody').innerHTML = content; modalOverlay.classList.add('visible'); }
            function hideModal() { modalOverlay.classList.remove('visible'); }
            doc('modalClose').addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) hideModal(); });

            document.querySelectorAll('.settingsBtn').forEach(btn => btn.addEventListener('click', () => { session.isMaster ? showParamsModal() : showLoginModal(); }));
            function showLoginModal() { const content = `<p style="text-align: center;">Introduce las credenciales de maestro.</p><input type="text" id="userInput" placeholder="Usuario"><input type="password" id="passInput" placeholder="Contrase√±a"><button id="loginBtn" class="btn" style="margin-top: 16px; width: 100%;">Autenticar</button><div id="login-error-msg"></div>`; showModal('Autenticaci√≥n Maestra', content); doc('loginBtn').addEventListener('click', checkMasterCredentials); }
            function checkMasterCredentials() { const errorMsgEl = doc('login-error-msg'); if (doc('userInput').value === 'LUNAU' && doc('passInput').value === 'Resoner96') { session.isMaster = true; sessionStorage.setItem('reportesMasterSession', 'true'); hideModal(); showParamsModal(); } else { errorMsgEl.textContent = 'Credenciales incorrectas.'; } }

            function showParamsModal() {
                if (activeView === '901') {
                    const config = params['901_config'];
                    const filterText = (config.userFilter || []).join(', ');
                    const paramsHTML = `<ul class="param-list param-list-901">${(config.columns || []).map(p => createParamItem901(p.key, p.startCell)).join('')}</ul>`;
                    const content = `<div class="user-filter-container"><label for="userFilterInput">Filtrar por Usuarios (separados por coma)</label><textarea id="userFilterInput" placeholder="PINTORA2, LUNAU2... (dejar vac√≠o para incluir a todos)">${filterText}</textarea></div><hr style="border-color: var(--border-color); margin: 16px 0;"><p style="text-align:center;">Define los nombres de columna y la celda de inicio de cada una (ej. A2).</p>${paramsHTML}<button id="addParam901Btn" class="btn" style="width: auto; padding: 8px 16px;">A√±adir Columna</button><button id="saveParams901Btn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Mapeo y Filtros</button>`;
                    showModal('Configurar Mapeo y Filtros de 901', content);
                    doc('addParam901Btn').addEventListener('click', () => doc('modalBody').querySelector('.param-list-901').insertAdjacentHTML('beforeend', createParamItem901('', '')));
                    doc('saveParams901Btn').addEventListener('click', saveParams901);
                } else if (activeView === 'terminaciones') {
                    showTerminacionesConfigModal();
                }
            }

            function createParamItem901(key, startCell) { return `<li class="param-item" style="grid-template-columns: 1fr 1fr auto;"><input type="text" class="param-key" placeholder="Nombre de Columna" value="${key || ''}"><input type="text" class="param-cell" placeholder="Celda de Inicio (ej. A2)" value="${startCell || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            
            async function saveParams901() { 
                const newColumns = Array.from(doc('modalBody').querySelectorAll('.param-item')).map(item => ({ key: item.querySelector('.param-key').value.trim(), startCell: item.querySelector('.param-cell').value.trim().toUpperCase() })).filter(p => p.key && p.startCell); 
                const userFilter = doc('userFilterInput').value.split(',').map(u => u.trim()).filter(Boolean);
                const newConfig = { columns: newColumns, userFilter: userFilter }; 
                try { 
                    await db.collection('report_configs').doc('901_params').set(newConfig); 
                    params['901_config'] = newConfig; 
                    showModal('√âxito', '<p>Mapeo y filtros de 901 guardados.</p>'); 
                } catch (e) { 
                    showModal('Error', '<p>No se pudo guardar la configuraci√≥n.</p>'); 
                } 
            }
            
            function showTerminacionesConfigModal() {
                const config = params.terminaciones_config;
                const content = `
                    <div class="modal-tabs">
                        <button class="tab-btn active" data-tab="zpptwc">1. Mapeo Zpptwc</button>
                        <button class="tab-btn" data-tab="coois">2. Mapeo Coois</button>
                        <button class="tab-btn" data-tab="areas">3. Mapeo de √Åreas</button>
                        <button class="tab-btn" data-tab="final">4. Columnas Finales</button>
                    </div>
                    <div id="tab-zpptwc" class="tab-content active"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Zpptwc.</p><ul class="param-list">${(config.zpptwc_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                    <div id="tab-coois" class="tab-content"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Coois.</p><ul class="param-list">${(config.coois_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                    <div id="tab-areas" class="tab-content">
                        <div class="area-source-container">
                            <label for="area-source-col">Columna Clave de Coois con C√≥digo de √Årea</label>
                            <input type="text" id="area-source-col" placeholder="Ej. MRP" value="${(config.area_config || {}).source_col || ''}">
                            <p>Usa el "Nombre Clave" (definido en la pesta√±a 2) de la columna del reporte Coois que contiene el c√≥digo de √°rea (ej. MRP).</p>
                        </div>
                        <ul class="area-list">${((config.area_config || {}).mappings || []).map(a => createAreaItemHTML(a.code, a.name)).join('')}</ul>
                    </div>
                    <div id="tab-final" class="tab-content"><p>Define las columnas que aparecer√°n en el reporte final. Para c√°lculos complejos, usa los tipos autom√°ticos.</p><ul class="param-list">${(config.final_cols || []).map(p => createFinalColHTML(p.key, p.type, p.value)).join('')}</ul></div>
                    <button class="addBtn btn" style="width: auto; padding: 8px 16px;">A√±adir Fila</button>
                    <button id="saveTerminacionesSettingsBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuraci√≥n</button>`;
                showModal('Configurar Automatizaci√≥n de Terminaciones', content);
                const modalBody = doc('modalBody');
                modalBody.querySelectorAll('.tab-btn').forEach(button => button.addEventListener('click', () => { modalBody.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); doc(`tab-${button.dataset.tab}`).classList.add('active'); }));
                modalBody.querySelector('.addBtn').addEventListener('click', () => { const activeTab = modalBody.querySelector('.tab-content.active'); if(activeTab.id === 'tab-areas') { activeTab.querySelector('.area-list').insertAdjacentHTML('beforeend', createAreaItemHTML('', '')); } else if(activeTab.id === 'tab-final') { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createFinalColHTML('', 'source', '')); } else { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createSourceColHTML('', '')); } });
                doc('saveTerminacionesSettingsBtn').addEventListener('click', saveTerminacionesSettings);
            }
            function createSourceColHTML(key, excel_col) { return `<li class="param-item" style="grid-template-columns: 1fr 1fr auto;"><input type="text" class="param-key" placeholder="Nombre Clave (sin espacios)" value="${key||''}"><input type="text" class="param-excel-col" placeholder="Letra de Columna (ej. A, B)" value="${excel_col||''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            function createAreaItemHTML(code, name) { return `<li class="area-item" style="grid-template-columns: 1fr 2fr auto;"><input type="text" class="area-code" placeholder="C√≥digo MRP" value="${code || ''}"><input type="text" class="area-name" placeholder="Nombre de √Årea" value="${name || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            function createFinalColHTML(key, type, value) { const options = `<option value="source">Dato Directo</option><option value="formula">F√≥rmula (Avanzado)</option><option value="fibras_auto">Fibras (Autom√°tico)</option><option value="terminaciones_auto">Terminaciones (Autom√°tico)</option><option value="familia_auto">Familia (Autom√°tico)</option>`; let selectedOptions = options.replace(`value="${type}"`,`value="${type}" selected`); const isFormula = type === 'formula'; const isSource = type === 'source'; const isAuto = !isFormula && !isSource; return `<li class="param-item" style="grid-template-columns:1fr 1fr 2fr auto"><input type="text" class="param-key" placeholder="Nombre Columna Final" value="${key||''}"><select class="param-type">${selectedOptions}</select><div class="${isAuto ? 'hidden' : ''}"><input type="text" class="param-value-input" placeholder="${isFormula ? 'Escribe f√≥rmula...' : 'Nombre Clave de la fuente'}" value="${value||''}" onfocus="populateFormulaHelpers(this, ${isFormula})"><div class="formula-helpers"></div></div><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
            window.populateFormulaHelpers = (inputElement, isFormula) => { const container = inputElement.nextElementSibling; container.innerHTML = ''; if (!isFormula) return; const modalBody = inputElement.closest('#modalBody'); if (!modalBody) return; const currentKey = inputElement.closest('.param-item').querySelector('.param-key').value; const zpptwc_cols = Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => el.querySelector('.param-key').value); const coois_cols = Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => el.querySelector('.param-key').value); const final_cols = Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => el.querySelector('.param-key').value); const availableCols = [...zpptwc_cols, ...coois_cols, ...final_cols.filter(k => k !== currentKey), 'Area'].filter(Boolean); const uniqueCols = [...new Set(availableCols)]; uniqueCols.forEach(colName => { const pill = document.createElement('button'); pill.className = 'helper-pill'; pill.textContent = colName; pill.onclick = (e) => { e.preventDefault(); insertAtCursor(inputElement, `{${colName}}`); }; container.appendChild(pill); }); };
            function insertAtCursor(input, text) { const start = input.selectionStart; input.value = input.value.substring(0, start) + text + input.value.substring(input.selectionEnd); input.focus(); input.selectionEnd = start + text.length; }
            doc('modalOverlay').addEventListener('change', (e) => { if (e.target.classList.contains('param-type')) { const item = e.target.closest('.param-item'); const inputDiv = item.querySelector('div:not(.formula-helpers)'); const isAuto = ['fibras_auto', 'terminaciones_auto', 'familia_auto'].includes(e.target.value); if(inputDiv) inputDiv.classList.toggle('hidden', isAuto); } });
            
            async function saveTerminacionesSettings() {
                try {
                    const modalBody = document.getElementById('modalBody');
                    if (!modalBody) throw new Error("El cuerpo del modal no fue encontrado.");
                    const newConfig = {
                        zpptwc_cols: Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                        coois_cols: Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                        area_config: { 
                            source_col: modalBody.querySelector('#area-source-col').value.trim(), 
                            mappings: Array.from(modalBody.querySelectorAll('#tab-areas .area-item')).map(el => ({ code: el.querySelector('.area-code').value, name: el.querySelector('.area-name').value })) 
                        },
                        final_cols: Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), type: el.querySelector('.param-type').value, value: el.querySelector('.param-value-input').value.trim() })),
                    };
                    await db.collection('report_configs').doc('terminaciones_params_v2').set(newConfig); 
                    params.terminaciones_config = newConfig; 
                    showModal('√âxito', '<p>Configuraci√≥n de Terminaciones guardada.</p>'); 
                } catch(e) { 
                    console.error("Error saving terminaciones settings:", e);
                    showModal('Error', '<p>No se pudo guardar la configuraci√≥n. Detalles: ' + e.message + '</p>'); 
                }
            }
            
            async function loadParams(configKey) {
                const docId = (configKey === '901_config') ? '901_params' : 'terminaciones_params_v2';
                try {
                    const docRef = await db.collection('report_configs').doc(docId).get();
                    if (docRef.exists) {
                        const data = docRef.data();
                        if (configKey === '901_config') {
                            params[configKey] = { columns: data.columns || [], userFilter: data.userFilter || [] };
                        } else {
                            params.terminaciones_config = { zpptwc_cols: [], coois_cols: [], final_cols: [], area_config: { source_col: '', mappings: [] }, ...data };
                        }
                    }
                } catch(e) { console.error(`Error al cargar ${configKey}:`, e); }
            }
            
            function setupFileHandler(dropAreaId, inputId, configKey) {
                const dropArea = doc(dropAreaId); const input = doc(inputId);
                dropArea.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0], configKey); e.target.value = ''; });
                dropArea.addEventListener('dragover', (e) => e.preventDefault());
                dropArea.addEventListener('drop', (e) => { e.preventDefault(); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], configKey); });
            }

            setupFileHandler('fileDropArea901', 'fileInput901', '901');
            setupFileHandler('fileDropAreaZpptwc', 'fileInputZpptwc', 'zpptwc');
            setupFileHandler('fileDropAreaCoois', 'fileInputCoois', 'coois');
            
            function handleFile(file, configKey) {
                if(configKey === '901') { 
                    handle901File(file); 
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const mapping = (configKey === 'zpptwc') ? params.terminaciones_config.zpptwc_cols : params.terminaciones_config.coois_cols;
                            const sheetData = XLSX.utils.sheet_to_json(ws, { header: 'A', defval: null, range: 1 });
                            const data = sheetData.map(row => {
                                let rowData = {};
                                for (const map of mapping) {
                                    if(map.excel_col) {
                                        rowData[map.key] = row[map.excel_col];
                                    }
                                }
                                return rowData;
                            }).filter(row => row.Orden);
                            reportData[configKey] = data;
                            doc(`fileDropArea${configKey.charAt(0).toUpperCase() + configKey.slice(1)}`).style.borderColor = '#4ade80';
                            processTerminacionesReport();
                        } catch (err) { 
                            showModal('Error de Archivo', '<p>No se pudo procesar el archivo Excel. Verifique el mapeo de letras de columna.</p>'); 
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            }
            
            const formulaHelpers = {
                EXTRAER: (text, start, length) => (typeof text !== 'string' || text === null) ? '' : String(text).substring(start - 1, start - 1 + length),
                EXTRAER_FIBRAS: (text, start, length) => {
                    if (typeof text !== 'string' || text === null) return 0;
                    const code = String(text).substring(start - 1, start - 1 + length).toUpperCase();
                    if (!code) return 0;
                    switch (code) {
                        case '1': return 1; case '2': return 2; case '3': return 3; case '4': return 4;
                        case '5': return 5; case '6': return 6; case '7': return 7; case '8': return 8;
                        case '9': return 9; case 'A': return 1; case 'B': return 2; case 'C': return 4;
                        case 'D': return 6; case 'E': return 8; case 'F': return 12; case 'G': return 24;
                        case 'T': return 12; default: const num = parseFloat(code); return isNaN(num) ? 0 : num;
                    }
                },
                IF: (condition, valueIfTrue, valueIfFalse) => condition ? valueIfTrue : valueIfFalse,
            };

            function processTerminacionesReport() {
                if (!reportData.zpptwc || !reportData.coois) return;
                const config = params.terminaciones_config;
                const joinKey = 'Orden';
                if (!config.zpptwc_cols.some(c=>c.key === joinKey) || !config.coois_cols.some(c=>c.key === joinKey)) {
                    showModal('Error de Configuraci√≥n', '<p>Aseg√∫rese de mapear una columna con el nombre clave "Orden" en ambos reportes.</p>');
                    return;
                }
                const cooisMap = new Map(reportData.coois.map(row => [String(row[joinKey] || '').replace(/^0+/, ''), row]));
                const finalData = reportData.zpptwc.map(zpptwcRow => {
                    const cleanOrder = String(zpptwcRow[joinKey] || '').replace(/^0+/, '');
                    const cooisRow = cooisMap.get(cleanOrder) || {};
                    let merged = {...zpptwcRow, ...cooisRow};
                    let finalRow = {};
                    for (const key in merged) {
                        let value = merged[key];
                        if (typeof value === 'string') value = value.trim();
                        if (key === 'Orden' || key === 'Material' || key === 'Operacion') {
                            finalRow[key] = String(value || '').replace(/^0+/, '');
                        } else if (key === 'Fecha' && value instanceof Date) {
                            const d = value;
                            finalRow[key] = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                        } else {
                            finalRow[key] = value;
                        }
                    }
                    const areaCode = finalRow[config.area_config.source_col];
                    const areaMapping = config.area_config.mappings.find(m => String(m.code).trim() === String(areaCode).trim());
                    finalRow['Area'] = areaMapping ? areaMapping.name : 'Desconocida';
                    config.final_cols.filter(c => c.type === 'source').forEach(col => { finalRow[col.key] = finalRow[col.value]; });
                    const autoFibrasCol = config.final_cols.find(c => c.type === 'fibras_auto');
                    if (autoFibrasCol) {
                        const area = (finalRow['Area'] || '').trim();
                        const catalogo = finalRow['Catalogo'] || '';
                        let fibras = 0;
                        if (area === 'UNAP LEGACY') { fibras = catalogo.startsWith('B100') ? formulaHelpers.EXTRAER_FIBRAS(catalogo, 7, 1) : formulaHelpers.EXTRAER_FIBRAS(catalogo, 6, 1); }
                        else if (area === 'MPORT FLEX') { fibras = (catalogo.startsWith('MSA') || catalogo.startsWith('MSF')) ? formulaHelpers.EXTRAER_FIBRAS(catalogo, 6, 1) : formulaHelpers.EXTRAER(catalogo, 5, 2); }
                        else if (area === 'EVOLV MTB RPX' || area === 'MTB RPX') fibras = formulaHelpers.EXTRAER_FIBRAS(catalogo, 6, 1);
                        else if (area === 'NON STD') fibras = 2; else if (area === 'SPECIALTY') fibras = 12;
                        else if (area === 'MULTIPORT') {
                             const extractedFibers = formulaHelpers.EXTRAER_FIBRAS(catalogo, 4, 1);
                             if (catalogo.startsWith('DFB')) {
                                 fibras = extractedFibers * 2;
                             } else {
                                 fibras = extractedFibers;
                             }
                        }
                        else if (area === 'EVOLV MTB DEMARC') fibras = formulaHelpers.EXTRAER_FIBRAS(catalogo, 4, 1);
                        else if (area === 'MOB LEGACY') fibras = formulaHelpers.EXTRAER_FIBRAS(catalogo, 5, 2);
                        else if (area === 'MTB DEMARC') fibras = formulaHelpers.EXTRAER_FIBRAS(catalogo, 5, 2);
                        finalRow[autoFibrasCol.key] = fibras;
                    }
                    const autoFamiliaCol = config.final_cols.find(c => c.type === 'familia_auto');
                    if(autoFamiliaCol) { finalRow[autoFamiliaCol.key] = formulaHelpers.EXTRAER(finalRow['Catalogo'], 1, 3); }
                    const autoTermCol = config.final_cols.find(c => c.type === 'terminaciones_auto');
                    if(autoTermCol) {
                        const fibras = finalRow['Fibras'] || 0;
                        const cantidad = parseFloat(finalRow['Cantidad']) || 0;
                        finalRow[autoTermCol.key] = fibras * cantidad;
                    }
                    if (finalRow['Terminaciones'] !== undefined) {
                        let value = parseFloat(finalRow['Terminaciones']);
                        finalRow['Terminaciones'] = (isNaN(value) || value < 0) ? 0 : value;
                    }
                    return finalRow;
                });
                renderTerminacionesTable(finalData);
                renderTerminacionesSummary(finalData);
            }
            
            function renderTerminacionesTable(data) {
                const config = params.terminaciones_config.final_cols;
                if (!config || config.length === 0) return;
                const allHeaders = config.map(c => c.key);
                const tableElement = doc('dataTableTerminaciones');
                let html = '<thead><tr>';
                allHeaders.forEach(header => { html += `<th>${header}</th>`; });
                html += '</tr></thead><tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    allHeaders.forEach(header => { html += `<td>${row[header] ?? ''}</td>`; });
                    html += '</tr>';
                });
                tableElement.innerHTML = html + '</tbody>';
            }

            function renderTerminacionesSummary(data) {
                const container = doc('summaryContainer');
                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="summary-header"><h3>Resumen de Terminaciones</h3></div><p>No hay datos para mostrar.</p>`;
                    return;
                }
                const pivot = {};
                const dates = new Set();
                data.forEach(row => {
                    const area = row['Area'] || 'Sin √Årea';
                    const fecha = row['Fecha'] || 'Sin Fecha';
                    const terminaciones = row['Terminaciones'] || 0;
                    if (typeof terminaciones === 'number' && terminaciones > 0) {
                        dates.add(fecha);
                        if (!pivot[area]) pivot[area] = {};
                        if (!pivot[area][fecha]) pivot[area][fecha] = 0;
                        pivot[area][fecha] += terminaciones;
                    }
                });
                const sortedDates = [...dates].sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
                let summaryHTML = `<div class="summary-header"><h3>Resumen de Terminaciones</h3><button id="exportSummaryBtn" class="icon-btn" title="Exportar como JPG"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button></div><div id="summaryTableWrapper" class="table-wrapper"><table><thead><tr><th>√Årea</th>`;
                sortedDates.forEach(date => { summaryHTML += `<th>${date}</th>`; });
                summaryHTML += `<th>Total General</th></tr></thead><tbody>`;
                let colTotals = {};
                sortedDates.forEach(date => colTotals[date] = 0);
                let grandTotal = 0;
                const sortedAreas = Object.keys(pivot).sort();
                for(const area of sortedAreas) {
                    let rowTotal = 0;
                    summaryHTML += `<tr><td>${area}</td>`;
                    sortedDates.forEach(date => {
                        const value = pivot[area][date] || 0;
                        summaryHTML += `<td>${value}</td>`;
                        rowTotal += value;
                        colTotals[date] += value;
                    });
                    summaryHTML += `<td class="grand-total">${rowTotal}</td></tr>`;
                    grandTotal += rowTotal;
                }
                summaryHTML += `<tr class="grand-total"><td >Total General</td>`;
                sortedDates.forEach(date => { summaryHTML += `<td>${colTotals[date]}</td>`; });
                summaryHTML += `<td>${grandTotal}</td></tr></tbody></table></div>`;
                container.innerHTML = summaryHTML;
                doc('exportSummaryBtn').addEventListener('click', exportSummaryAsJPG);
            }
            
            function exportSummaryAsJPG() {
                const summaryCard = doc('summaryContainer');
                const exportBtn = doc('exportSummaryBtn');
                if (!summaryCard || typeof html2canvas === 'undefined') { return; }
                exportBtn.disabled = true;
                exportBtn.innerHTML = '...';
                const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
                const bgColor = theme === 'dark' ? '#22252a' : '#f9fafb';
                exportBtn.style.visibility = 'hidden';
                html2canvas(summaryCard, { 
                    backgroundColor: bgColor, scale: 2.5, useCORS: true,
                    onclone: (clonedDoc) => {
                        const clonedCard = clonedDoc.getElementById('summaryContainer');
                        const clonedWrapper = clonedCard.querySelector('.table-wrapper');
                        clonedCard.style.padding = '16px'; 
                        if (clonedWrapper) {
                            clonedWrapper.style.overflow = 'visible';
                            clonedWrapper.style.width = `${clonedWrapper.scrollWidth}px`;
                        }
                    }
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Resumen_Terminaciones.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                }).finally(() => {
                    exportBtn.style.visibility = 'visible';
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
                });
            }

            // --- INICIO: L√≥gica 901 Actualizada y Corregida ---
            
            window.copyToClipboard = (text, element) => {
                if (!text) return;
                const originalText = element.textContent;
                const originalColor = element.style.color;
                navigator.clipboard.writeText(text).then(() => {
                    element.textContent = '¬°Copiado!';
                    element.style.color = 'var(--success-color)';
                    setTimeout(() => {
                        element.textContent = originalText;
                        element.style.color = originalColor;
                    }, 1500);
                }).catch(err => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    element.textContent = '¬°Copiado!';
                    element.style.color = 'var(--success-color)';
                    setTimeout(() => {
                        element.textContent = originalText;
                        element.style.color = originalColor;
                    }, 1500);
                });
            };

            function excelSerialToDateObject(serial) {
                if (typeof serial !== 'number' || isNaN(serial)) return null;
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + serial * 86400000);
                return new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
            }

            async function handle901File(file) { 
                const config = params['901_config'];
                if (!config.columns || config.columns.length === 0) {
                    showModal('Error de Configuraci√≥n', `<p>Por favor, configure el mapeo de columnas para el reporte 901.</p>`);
                    return;
                }
                const dateColumnMap = config.columns.find(p => p.key.toLowerCase() === 'fecha');
                const userColumnMap = config.columns.find(p => p.key.toLowerCase() === 'usuario');

                if (!dateColumnMap) {
                    showModal('Error de Configuraci√≥n', `<p>Debe existir una columna llamada "Fecha" en el mapeo.</p>`);
                    return;
                }
                if (config.userFilter && config.userFilter.length > 0 && !userColumnMap) {
                    showModal('Error de Configuraci√≥n', `<p>Se especificaron filtros de usuario, pero no hay una columna mapeada como "Usuario".</p>`);
                    return;
                }

                const allowedUsers = (config.userFilter || []).map(u => u.toUpperCase());
                const reader = new FileReader(); 
                reader.onload = async (e) => { 
                    try { 
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        
                        const extractedData = [];
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);

                        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                            const dateCol = dateColumnMap.startCell.match(/[A-Z]+/)[0];
                            const dateCellAddress = dateCol + (R + 1);
                            const dateCell = ws[dateCellAddress];
                            
                            if (!dateCell || !dateCell.v) continue;

                            let rowDate;
                            if (dateCell.t === 'n') {
                                rowDate = excelSerialToDateObject(dateCell.v);
                            } else if (dateCell.v instanceof Date) {
                                rowDate = dateCell.v;
                            } else {
                                continue; 
                            }
                            rowDate.setHours(0,0,0,0);
                            
                            const isToday = rowDate.getTime() === today.getTime();
                            const isYesterday = rowDate.getTime() === yesterday.getTime();
                            const isPast = rowDate.getTime() < yesterday.getTime();
                            
                            let userIsAllowed = false;
                            if (userColumnMap) {
                                const userCol = userColumnMap.startCell.match(/[A-Z]+/)[0];
                                const userCellAddress = userCol + (R + 1);
                                const userCell = ws[userCellAddress];
                                const userValue = (userCell ? String(userCell.v) : '').toUpperCase();
                                userIsAllowed = allowedUsers.includes(userValue);
                            }

                            let shouldInclude = false;
                            let colorClass = '';

                            if (isToday) {
                                if (allowedUsers.length === 0 || userIsAllowed) {
                                    shouldInclude = true;
                                    colorClass = 'row-today';
                                }
                            } else if (isYesterday) {
                                if (allowedUsers.length === 0 || userIsAllowed) {
                                    shouldInclude = true;
                                    colorClass = 'row-yesterday';
                                }
                            } else if (isPast) {
                                if (allowedUsers.length === 0 || userIsAllowed) {
                                    shouldInclude = true;
                                    colorClass = 'row-past';
                                }
                            }

                            if (shouldInclude) {
                                let rowData = {};
                                config.columns.forEach(p => {
                                    const col = p.startCell.match(/[A-Z]+/)[0];
                                    const cellAddress = col + (R + 1);
                                    const cell = ws[cellAddress];
                                    let value = cell ? (cell.w || cell.v) : undefined;
                                    rowData[p.key] = value;
                                });
                                rowData.colorClass = colorClass;
                                extractedData.push(rowData);
                            }
                        }
                        
                        if(extractedData.length === 0){ 
                            showModal('Sin Coincidencias', '<p>No se encontraron registros que cumplan con los filtros.</p>'); 
                            renderTable901([]);
                            return; 
                        } 
                        
                        renderTable901(extractedData);
                        showModal('√âxito', `<p>${extractedData.length} registros han sido cargados.</p>`); 
                    } catch (err) { 
                        console.error("Error al procesar archivo 901:", err); 
                        showModal('Error de Archivo', `<p>No se pudo procesar el archivo. Verifique el formato y la configuraci√≥n.</p>`) 
                    } 
                }; 
                reader.readAsArrayBuffer(file); 
            }

            function renderTable901(data) { 
                const tableElement = doc('dataTable901'); 
                const paramConfig = params['901_config'].columns; 
                if (!paramConfig || !paramConfig.length) { 
                    tableElement.innerHTML = `<thead><tr><th>Por favor, configure el mapeo de columnas.</th></tr></thead><tbody></tbody>`; 
                    return; 
                } 
                const headers = paramConfig.map(p => p.key); 
                let html = '<thead><tr>'; 
                headers.forEach(h => html += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`); 
                html += '</tr></thead><tbody>'; 
                data.forEach(row => { 
                    html += `<tr class="${row.colorClass || ''}">`; 
                    headers.forEach(header => { 
                        const value = row[header] ?? '';
                        if (header.toUpperCase() === 'GR') {
                            html += `<td class="copyable" onclick="copyToClipboard('${String(value).replace(/'/g, "\\'")}', this)" title="Haz clic para copiar">${value}</td>`;
                        } else {
                            html += `<td>${value}</td>`; 
                        }
                    }); 
                    html += '</tr>'; 
                }); 
                tableElement.innerHTML = html + '</tbody>'; 
                tableElement.querySelectorAll('.filter-input').forEach(input => { 
                    input.addEventListener('keyup', () => filterTable901()); 
                }); 
            }
            
            function filterTable901() { 
                const table = doc('dataTable901'); 
                const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({ columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')), value: i.value.toLowerCase() })); 
                const rows = table.querySelectorAll('tbody tr'); 
                rows.forEach(row => { 
                    let shouldShow = true; 
                    filters.forEach(filter => { 
                        if (filter.value) { 
                            const cell = row.children[filter.columnIndex]; 
                            if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) { 
                                shouldShow = false; 
                            } 
                        } 
                    }); 
                    row.style.display = shouldShow ? '' : 'none'; 
                }); 
            }
            
            async function initializeApp() {
                if (sessionStorage.getItem('reportesMasterSession') === 'true') session.isMaster = true;
                await Promise.all([ loadParams('901_config'), loadParams('terminaciones_config') ]);
                applyTheme(currentTheme);
                Object.values(views).forEach(v => { v.style.display = 'none'; v.style.opacity = '0'; });
                views.menu.style.display = 'flex'; views.menu.style.opacity = '1';
            }
            initializeApp();
        });
    </script>
</body>
</html>