<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Reportes</title>

    <meta name="theme-color" content="#22252a">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tinos&display=swap" rel="stylesheet">
    
    <style>
        :root {}

        body.dark-theme {
            --bg-gradient: radial-gradient(ellipse at center top, #22252a 0%, #0a0a0a 70%);
            --surface-color: rgba(35, 38, 43, 0.6);
            --surface-hover-color: rgba(55, 58, 63, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #E5E7EB;
            --primary-text-color: #0A0A0A;
            --danger-color: #FB7185;
            --danger-hover-color: #f43f5e;
            --text-primary: #F1F5F9; 
            --text-secondary: #94A3B8;
            --text-dark: #64748B;
            --thead-bg: rgba(55, 65, 81, 0.8);
            --sticky-col-bg: #2a2d32;
            --success-color: #4ade80;
            --row-today-bg: rgba(74, 222, 128, 0.1);
            --row-yesterday-bg: rgba(251, 191, 36, 0.1);
            --row-past-bg: rgba(244, 63, 94, 0.1);
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-tick-color: #94A3B8;
            --glow-green: rgba(74, 222, 128, 0.9);
            --glow-red: rgba(251, 113, 133, 0.9);
        }

        body.light-theme {
            --bg-gradient: linear-gradient(145deg, #f9fafb, #e5e7eb);
            --surface-color: rgba(255, 255, 255, 0.5);
            --surface-hover-color: rgba(243, 244, 246, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #1F2937;
            --primary-text-color: #FFFFFF;
            --danger-color: #EF4444;
            --danger-hover-color: #dc2626;
            --text-primary: #111827; 
            --text-secondary: #4B5563;
            --text-dark: #9CA3AF;
            --branding-color: #0055A5;
            --thead-bg: rgba(229, 231, 235, 0.8);
            --sticky-col-bg: #f1f5f9;
            --success-color: #22c55e;
            --row-today-bg: rgba(34, 197, 94, 0.1);
            --row-yesterday-bg: rgba(245, 158, 11, 0.1);
            --row-past-bg: rgba(239, 68, 68, 0.1);
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-tick-color: #4B5563;
            --glow-green: rgba(34, 197, 94, 0.9);
            --glow-red: rgba(239, 68, 68, 0.9);
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        html { min-height: 100%; background-color: #0a0a0a; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--text-primary); margin: 0; min-height: 100vh;
            display: flex; justify-content: center; transition: background 0.3s ease-in-out;
            background-attachment: fixed; padding: 16px; box-sizing: border-box; overflow-x: hidden;
        }
        .app-container { width: 100%; }
        #menuView, #view901, #viewTerminaciones, #viewProduccionHora, #viewProduccion20, #viewProduccionDaily { transition: opacity 0.3s ease-in-out, display 0.3s; }
        #menuView { display: flex; align-items: center; justify-content: center; height: 100%; }
        .menu-wrapper { width: 100%; max-width: 600px; text-align: center; }
        .animated-startup { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .app-header { text-align: center; margin-bottom: 24px; }
        .app-branding { font-family: 'Tinos', 'Times New Roman', serif; font-weight: 400; font-size: 2.5rem; color: var(--text-primary); letter-spacing: 2px; margin: 0; transition: color 0.3s ease-in-out; }
        body.light-theme .app-branding { color: var(--branding-color); }
        .app-title { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin: 4px 0 0; }

        .card, .modal-content {
            background-color: var(--surface-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 16px; padding: 24px; border-top: 1px solid rgba(255, 255, 255, 0.15); border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3); border-right: 2px solid rgba(0, 0, 0, 0.3); box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        body.light-theme .card, body.light-theme .modal-content {
            border-top: 1px solid rgba(255, 255, 255, 0.8); border-left: 1px solid rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid rgba(0, 0, 0, 0.1); border-right: 2px solid rgba(0, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .menu-container { display: flex; flex-direction: column; gap: 16px; }
        .btn { padding: 16px 24px; border-radius: 12px; cursor: pointer; background-color: var(--primary-color); border: none; color: var(--primary-text-color); font-weight: 700; font-size: 1.1rem; text-align: center; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-glass {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-primary);
            padding: 12px 20px; font-size: 0.95rem; font-weight: 600;
        }
        .btn-glass:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); }
        
        #view901, #viewTerminaciones, #viewProduccionHora, #viewProduccion20, #viewProduccionDaily { display: none; width: 100%; }
        .main-container { display: grid; grid-template-columns: 320px 1fr; gap: 16px; width: 100%; height: calc(100vh - 32px); }
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: var(--text-primary); background-color: var(--surface-hover-color); }
        .main-content { 
            display: flex; flex-direction: column; gap: 16px; min-height: 0;
            min-width: 0;
        }
        #summaryContainer { flex-shrink: 0; padding: 16px; }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .summary-header .title-wrapper { flex-grow: 1; text-align: center; }
        .summary-header h3 { margin: 0; }
        .table-container { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .table-container h5 { margin: 0 0 12px 0; text-align: center; font-size: 1.1rem; color: var(--text-secondary); }
        .table-wrapper { overflow: auto; height: 100%; border-radius: 12px; border: 1px solid var(--border-color); }
        #summaryContainer .table-wrapper { border: none; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed;
        }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; font-size: 0.9rem;}
        thead { position: sticky; top: 0; background-color: var(--thead-bg); backdrop-filter: blur(5px); z-index: 10; }
        th { font-weight: 600; color: var(--text-secondary); font-size: 0.75rem; vertical-align: top; }
        .copyable { cursor: pointer; transition: color 0.2s; }
        .copyable:hover { color: var(--success-color); }
        .filter-input, .control-group input, .control-group select { 
            display: block; width: 100%; box-sizing: border-box; background-color: var(--surface-color); 
            border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; 
            padding: 8px 12px; font-size: 0.9rem; 
        }
        .filter-input { border-radius: 4px; padding: 4px 6px; margin-top: 4px; font-size: 0.8rem; }

        .control-group { margin-bottom: 16px; }
        .control-group label { display: block; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; font-size: 0.9rem; }

        .file-drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 24px 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; margin-top: 16px; }
        .file-drop-area p { margin: 0; color: var(--text-dark); }
        .file-drop-area h4 { margin: 0 0 8px 0; color: var(--text-secondary); }
        #summaryContainer table th, #summaryContainer table td { text-align: right; }
        #summaryContainer table th:first-child, #summaryContainer table td:first-child { 
            text-align: left; font-weight: bold; position: sticky; left: 0; z-index: 1;
            background-color: var(--sticky-col-bg);
        }
        #summaryContainer table .grand-total { font-weight: bold; border-top: 2px solid var(--border-color); }

        .row-today { background-color: var(--row-today-bg) !important; }
        .row-yesterday { background-color: var(--row-yesterday-bg) !important; }
        .row-past { background-color: var(--row-past-bg) !important; }
        
        #chartContainer, #fibraReportContainer, #chartContainer20, #chartContainerDaily { position: relative; padding: 16px; display: flex; flex-direction: column; flex-shrink: 0; }
        #produccionChart, #produccion20Chart, #produccionDailyChart { max-height: 250px; }
        .pie-chart-container { max-height: 180px; margin-bottom: 16px; }
        #chartSummary, #chartSummary20, #chartSummaryDaily { text-align: center; padding-top: 10px; font-weight: 600; color: var(--text-secondary); }
        #chartSummary strong, #chartSummary20 strong, #chartSummaryDaily strong { color: var(--text-primary); }
        #fibraReportContainer .fibra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; }
        #fibraReportContainer h4, #fibraReportContainer h5 { margin-top: 0; text-align: center; }
        
        .table-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            flex-grow: 1;
            min-height: 0;
        }

        .table-grid-container table th,
        .table-grid-container table td {
            white-space: normal;
            overflow-wrap: break-word;
            font-size: 0.8rem;
            padding: 8px 5px;
            text-align: center;
        }
        .table-grid-container table th:nth-child(1), .table-grid-container table td:nth-child(1),
        .table-grid-container table th:nth-child(2), .table-grid-container table td:nth-child(2),
        .table-grid-container table th:nth-child(3), .table-grid-container table td:nth-child(3) {
            text-align: left;
        }
        
        #dataTableTerminaciones, #dataTableProduccion20, #dataTableProduccionDaily {
            table-layout: auto;
            width: 100%;
        }
        #dataTableTerminaciones th,
        #dataTableTerminaciones td,
        #dataTableProduccion20 th,
        #dataTableProduccion20 td,
        #dataTableProduccionDaily th,
        #dataTableProduccionDaily td {
            white-space: nowrap;
            text-align: center;
            vertical-align: middle;
        }
        #dataTable901 {
            table-layout: auto;
        }
        #dataTable901 th, 
        #dataTable901 td {
            white-space: normal;
            word-wrap: break-word;
            vertical-align: top;
        }

        #resumenSemanal h5 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        #resumenSemanal p {
            margin: 4px 0;
            font-size: 0.9rem;
        }
        .summary-bars-wrapper {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }
        .summary-bar-container {
            width: 60px;
            height: 120px;
            background-color: var(--surface-hover-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column-reverse;
            position: relative;
        }
        .summary-bar {
            width: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            position: relative;
            transition: height 0.5s ease-out;
        }
        .summary-bar-label {
            position: absolute;
            bottom: -20px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s; width: 90%; max-width: 800px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin: 0; text-align: center; width: 100%; color: var(--text-primary);}
        .modal-close { font-size: 1.75rem; color: var(--text-dark); cursor: pointer; line-height: 1; position: absolute; top: 16px; right: 16px; }
        #modalBody input, #modalBody select, #modalBody textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-primary); box-sizing: border-box;}
        #modalBody textarea { min-height: 80px; resize: vertical; }
        #modalBody p { font-size: 0.9em; color: var(--text-dark); margin-top:4px; }
        .param-list, .area-list { list-style: none; padding: 0; margin: 16px 0; max-height: 45vh; overflow-y: auto;}
        .param-item { display: grid; grid-template-columns: auto 1fr 1.2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .param-item input, .param-item select { margin: 0; }
        .param-value-container { grid-column: 4; }
        .hidden { display: none; }
        .area-item { display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background-color: var(--surface-hover-color); border: 1px solid var(--border-color); border-radius: 8px; }
        .area-source-container, .user-filter-container { display: flex; flex-direction: column; gap: 4px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
        .area-source-container label, .user-filter-container label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px;}
        .btn-danger { background-color: var(--danger-color); color: white; width: auto; padding: 8px 12px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .drag-handle { cursor: grab; color: var(--text-dark); padding: 4px; display: flex; align-items: center; justify-content: center; }
        .drag-handle:active { cursor: grabbing; }
        .param-item.dragging { opacity: 0.5; background-color: var(--primary-color); }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px;}
        .tab-btn { background: none; border: none; padding: 10px 16px; cursor: pointer; color: var(--text-dark); font-weight: 600; border-bottom: 3px solid transparent;}
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--primary-color);}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .formula-helpers { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .helper-pill { background-color: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .helper-pill:hover { background-color: var(--primary-color); color: var(--primary-text-color); border-color: var(--primary-color); }
        #login-error-msg { color: var(--danger-color); text-align: center; margin-top: 10px; font-weight: 500; height: 1em; }

        .collapsible-section { border: 1px solid var(--border-color); border-radius: 12px; margin-top: 16px; overflow: hidden; background-color: var(--surface-color); }
        .collapsible-header { background-color: transparent; padding: 12px 16px; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid transparent; transition: all 0.2s; }
        .collapsible-section.open .collapsible-header { border-bottom-color: var(--border-color); }
        .collapsible-header:hover { background-color: var(--surface-hover-color); }
        .collapsible-header::after { content: '▼'; transition: transform 0.2s; }
        .collapsible-section.open .collapsible-header::after { transform: rotate(180deg); }
        .collapsible-content { padding: 16px; max-height: 0; overflow-y: auto; transition: max-height 0.4s ease-out, padding 0.4s ease-out; }
        .collapsible-section.open .collapsible-content { max-height: 60vh; }
        #addPackerForm { display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 12px; align-items: end; }
        #packerList { list-style: none; padding: 0; margin-top: 16px; max-height: 250px; overflow-y: auto; }
        #packerList li { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; padding: 8px; border-radius: 6px; }
        #packerList li:nth-child(odd) { background-color: var(--surface-hover-color); }


        @media (max-width: 900px), (max-height: 450px) {
            body { overflow-y: auto; padding: 8px; }
            .app-header { margin-bottom: 16px; }
            .app-branding { font-size: 2rem; }
            .app-title { font-size: 1rem; }
            .main-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; height: auto; gap: 12px; padding-top: 0; }
            .sidebar { height: auto; }
            .main-content { min-height: 50vh; gap: 12px; min-width: 0; }
            .card { padding: 16px; }
            .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table th, table td { padding: 8px 10px; font-size: 0.8rem; text-align: center; }
            #summaryContainer table th:first-child, #summaryContainer table td:first-child { text-align: left; }
            .modal-content { width: 95%; max-height: 85vh; display: flex; flex-direction: column; }
            #modalBody { overflow-y: auto; }
            .param-item, .area-item { grid-template-columns: 1fr; gap: 8px; text-align: left; }
            .param-item .btn-danger, .area-item .btn-danger { justify-self: end; }
            .param-value-container { grid-column: 1; }
            #fibraReportContainer .fibra-grid { grid-template-columns: 1fr; }
            .table-grid-container { grid-template-columns: 1fr; }
            #addPackerForm { grid-template-columns: 1fr; }
            #packerList li { grid-template-columns: 1fr; text-align: center; gap: 4px; }
        }
    </style>
</head>
<body class="dark-theme">

    <div class="app-container">
        <div id="menuView">
            <div class="menu-wrapper">
                <header class="app-header animated-startup"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Centro de Reportes</h2></header>
                <main class="card animated-startup" style="animation-delay: 0.1s;">
                    <div class="menu-container">
                        <button id="reporteProduccionBtn" class="btn">Reporte de Producción</button>
                        <button id="reporteProduccion20Btn" class="btn">Reporte de Producción 20%</button>
                        <button id="reporteProduccionDailyBtn" class="btn">Reporte de Producción por semana Daily</button>
                        <button id="reporteTerminacionesBtn" class="btn">Reporte de Terminaciones</button>
                        <button id="view901Btn" class="btn">Reporte 901</button>
                    </div>
                </main>
            </div>
        </div>

        <div id="viewProduccionHora">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="flex-grow: 1; overflow-y: auto; padding-right: 8px;">
                        <div id="fechaUnicaContainer" class="control-group">
                                <label for="prod_fecha_unica">Fecha</label>
                                <input type="date" id="prod_fecha_unica">
                            </div>

                            <div id="fechaRangoContainer" style="display: none;">
                                <div class="control-group">
                                    <label for="prod_fecha_inicio">Fecha Inicio</label>
                                    <input type="date" id="prod_fecha_inicio">
                                </div>
                                <div class="control-group">
                                    <label for="prod_fecha_fin">Fecha Fin</label>
                                    <input type="date" id="prod_fecha_fin">
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="prod_turno">Turno</label>
                                <select id="prod_turno">
                                    <option value="T45">T45 (L-M, Día)</option>
                                    <option value="T46">T46 (L-M, Noche)</option>
                                    <option value="T47">T47 (J-D, Día)</option>
                                    <option value="T48">T48 (J-D, Noche)</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="prod_area">Área</label>
                                <select id="prod_area">
                                    <option value="ALL">Todas las Áreas</option>
                                </select>
                            </div>
                            <div class="control-group" style="display: none;">
                                <label for="prod_linea1_packer">Empacador Línea 1</label>
                                <select id="prod_linea1_packer"></select>
                            </div>
                            <div class="control-group" style="display: none;">
                                <label for="prod_linea2_packer">Empacador Línea 2</label>
                                <select id="prod_linea2_packer"></select>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 24px 0;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button id="showProduccionHoraBtn" class="btn btn-glass">Producción por Hora</button>
                                <button id="showProduccionFibraBtn" class="btn btn-glass">Producción por Fibra</button>
                                <button id="showProduccionSemanaBtn" class="btn btn-glass">Producción por Semana</button>
                            </div>
                        </div>
                       <button id="generarReporteProduccionBtn" class="btn" style="margin-top: 16px; width: 100%;">Generar Reporte</button>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción</h2></header>

                    <div id="chartContainer" class="card">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción por Hora</h3></div>
                            <button id="exportChartBtn" class="icon-btn" title="Exportar Gráfica como JPG" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        </div>
                        <canvas id="produccionChart"></canvas>
                        <div id="chartSummary"></div>
                    </div>

                    <div id="fibraReportContainer" class="card" style="display: none;">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción por Fibra</h3></div>
                        </div>
                        <div id="fibraReportContent"></div>
                    </div>

                    <div id="semanalContainer" class="card" style="display: none; flex-direction: column;">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción Semanal Comparativa</h3></div>
                            <button id="exportarSemanalBtn" class="icon-btn" title="Exportar como JPG"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        </div>
                        <div style="display: flex; flex-direction: row; gap: 20px; flex-grow: 1;">
                             <div style="flex-grow: 1; position: relative; min-height: 60vh;">
                                <canvas id="produccionSemanalChart"></canvas>
                            </div>
                            <div id="resumenSemanal" style="flex-basis: 220px; flex-shrink: 0;">
                                </div>
                        </div>
                    </div>

                    <div class="table-grid-container" id="produccionTablesGrid">
                        <div class="card table-container">
                            <h5>Producción Línea 1</h5>
                            <div class="table-wrapper">
                                <table id="dataTableProduccionL1">
                                    <thead><tr><th>Configure los filtros y genere el reporte.</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card table-container">
                             <h5>Producción Línea 2</h5>
                            <div class="table-wrapper">
                                <table id="dataTableProduccionL2">
                                    <thead><tr><th>Configure los filtros y genere el reporte.</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="viewProduccion20">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display:flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="padding: 0 10px; flex-grow: 1; display: flex; flex-direction: column;">
                           <div class="control-group">
                                <label for="prod20_fecha">Fecha del Reporte</label>
                                <input type="date" id="prod20_fecha">
                            </div>
                            <div class="control-group">
                                <label for="prod20_turno">Turno</label>
                                <select id="prod20_turno">
                                    <option value="T45">T45 (L-M, Día)</option>
                                    <option value="T46">T46 (L-M, Noche)</option>
                                    <option value="T47">T47 (J-D, Día)</option>
                                    <option value="T48">T48 (J-D, Noche)</option>
                                </select>
                            </div>
                            <button id="consultarProduccion20Btn" class="btn" style="width: 100%;">Consultar Reporte</button>
                               <button id="abrirModalSemanalBtn" class="btn btn-glass" style="width: 100%; margin-top: 12px;">Reporte Semanal</button>
                            <hr style="border-color: var(--border-color); margin: 24px 0;">
                            <div id="fileDropAreaProd20" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center; margin-top: 0;">
                                <h4>Actualizar Datos</h4>
                                <p>Arrastra un archivo para añadir o actualizar registros</p>
                            </div>
                            <input type="file" id="fileInputProd20" accept=".xlsx, .xls" style="display: none;">
                        </div>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción 20%</h2></header>

                    <div id="chartContainer20" class="card">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción de Terminaciones por Hora</h3></div>
                        </div>
                        <canvas id="produccion20Chart"></canvas>
                        <div id="chartSummary20"></div>
                    </div>

                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableProduccion20">
                                <thead><tr><th>Carga o consulta un reporte para ver los datos...</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="viewProduccionDaily" style="display: none;">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%; display:flex; flex-direction: column;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div style="padding: 0 10px; flex-grow: 1; display: flex; flex-direction: column;">
                           <div class="control-group">
                                <label for="prodDaily_fecha">Fecha del Reporte</label>
                                <input type="date" id="prodDaily_fecha">
                            </div>
                            <div class="control-group">
                                <label for="prodDaily_turno">Turno</label>
                                <select id="prodDaily_turno">
                                    <option value="T45">T45 (L-M, Día)</option>
                                    <option value="T46">T46 (L-M, Noche)</option>
                                    <option value="T47">T47 (J-D, Día)</option>
                                    <option value="T48">T48 (J-D, Noche)</option>
                                </select>
                            </div>
                            <button id="consultarProduccionDailyBtn" class="btn" style="width: 100%;">Consultar Reporte</button>
                            <button id="abrirModalSemanalDailyBtn" class="btn btn-glass" style="width: 100%; margin-top: 12px;">Reporte Semanal</button>
                            <hr style="border-color: var(--border-color); margin: 24px 0;">
                            <div id="fileDropAreaProdDaily" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center; margin-top: 0;">
                                <h4>Actualizar Datos</h4>
                                <p>Arrastra un archivo para añadir o actualizar registros</p>
                            </div>
                            <input type="file" id="fileInputProdDaily" accept=".xlsx, .xls" style="display: none;">
                        </div>
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Producción por semana Daily</h2></header>

                    <div id="chartContainerDaily" class="card">
                        <div class="summary-header">
                            <div class="title-wrapper"><h3>Producción de Terminaciones por Hora</h3></div>
                        </div>
                        <canvas id="produccionDailyChart"></canvas>
                        <div id="chartSummaryDaily"></div>
                    </div>

                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableProduccionDaily">
                                <thead><tr><th>Carga o consulta un reporte para ver los datos...</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="view901">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;">
                    <div class="card" style="height: 100%;">
                        <div class="sidebar-header">
                            <h3>Panel de Control</h3>
                            <div>
                                <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                                <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                    <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                                </button>
                                <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                            </div>
                        </div>
                        <div id="fileDropArea901" class="file-drop-area"><p>Arrastra un archivo para añadir registros</p></div>
                        <input type="file" id="fileInput901" accept=".xlsx, .xls" style="display: none;">
                    </div>
                </aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte 901</h2></header>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTable901"><thead><tr><th>Carga un archivo para ver los datos...</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="viewTerminaciones">
            <div class="main-container">
                <aside class="sidebar animated-startup" style="animation-delay: 0.1s;"><div class="card" style="height: 100%; display: flex; flex-direction: column;"><div class="sidebar-header"><h3>Panel de Control</h3><div>
                    <button class="backToMenuBtn icon-btn" title="Regresar al Menú"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                    <button class="themeToggleBtn icon-btn" title="Cambiar Tema">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="settingsBtn icon-btn" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                </div></div>
                    <div id="fileDropAreaZpptwc" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Zpptwc)</h4><p>Arrastra el primer archivo aquí</p></div><input type="file" id="fileInputZpptwc" accept=".xlsx, .xls" style="display: none;">
                    <div id="fileDropAreaCoois" class="file-drop-area" style="flex-grow: 1; display:flex; flex-direction: column; justify-content:center;"><h4>Reporte SAP (Coois)</h4><p>Arrastra el segundo archivo aquí</p></div><input type="file" id="fileInputCoois" accept=".xlsx, .xls" style="display: none;">
                </div></aside>
                <main class="main-content animated-startup" style="animation-delay: 0.2s;">
                    <header class="app-header"><h1 class="app-branding">CORNING</h1><h2 class="app-title">Reporte de Terminaciones</h2></header>
                    <div class="card" id="summaryContainer">
                        <div class="summary-header">
                            <h3>Resumen de Terminaciones</h3>
                        </div>
                        <p>Cargue los archivos para ver el resumen.</p>
                    </div>
                    <div class="card table-container">
                        <div class="table-wrapper">
                            <table id="dataTableTerminaciones"><thead><tr><th>Carga los dos reportes de SAP para generar el informe</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay"><div id="modalContent" class="modal-content"><span id="modalClose" class="modal-close">&times;</span><h2 id="modalTitle" class="modal-title"></h2><div id="modalBody" style="margin-top:16px; color: var(--text-secondary);"></div></div></div>
</body>
   <script>
    // --- INICIO: CONFIGURACIÓN Y VARIABLES GLOBALES ---
    const firebaseConfig = { apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDXO", authDomain: "rastreador-de-ordenes.firebaseapp.com", projectId: "rastreador-de-ordenes", storageBucket: "rastreador-de-ordenes.appspot.com", messagingSenderId: "956052823395", appId: "1:956052823395:web:2ba74d9591d2b24c3cc756" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', () => {
        const doc = (id) => document.getElementById(id);
        const views = {
            menu: doc('menuView'),
            '901': doc('view901'),
            terminaciones: doc('viewTerminaciones'),
            produccionHora: doc('viewProduccionHora'),
            produccion20: doc('viewProduccion20'),
            produccionDaily: doc('viewProduccionDaily')
        };
        let session = { isMaster: false };
        let activeView = 'menu';
        let params = {
            '901_config': { columns: [], userFilter: [] },
            terminaciones_config: {
                zpptwc_cols: [],
                coois_cols: [],
                final_cols: [],
                area_config: { source_col: '', mappings: [] }
            },
            produccion_hora_config: {
                packers: []
            },
            produccion_20_config: {
                startRow: 15,
                columns: [
                    { key: 'Estación', excel_col: 'F' },
                    { key: 'Serial Number', excel_col: 'I' },
                    { key: 'Cantidad', excel_col: 'L' },
                    { key: 'Catalogo', excel_col: 'Q' },
                    { key: 'Orden', excel_col: 'R' },
                    { key: 'Empleado', excel_col: 'S' },
                    { key: 'Fecha y hora', excel_col: 'W' }
                ]
            },
            produccion_daily_config: {
                startRow: 15,
                columns: [
                    { key: 'Linea', excel_col: 'C' },
                    { key: 'Cantidad', excel_col: 'L' },
                    { key: 'Catálogo', excel_col: 'Q' },
                    { key: 'Finish date', excel_col: 'W' },
                    { key: 'Turno', excel_col: 'X' }
                ]
            }
        };
        let reportData = { zpptwc: null, coois: null };
        let productionChart = null;
        let production20Chart = null;
        let productionDailyChart = null;
        let fiberPieChart1 = null;
        let fiberPieChart2 = null;
        let productionReportData = null;
        let graficaSemanalInstance = null;
        let graficaSemanalDailyInstance = null;
        let weeklyProductionChart = null;


        // --- INICIO: LÓGICA DE NAVEGACIÓN Y UI GENERAL ---
        function switchView(viewKey) {
            const currentViewEl = views[activeView];
            const nextViewEl = views[viewKey];
            if (!nextViewEl) return;
            activeView = viewKey;
            currentViewEl.style.opacity = '0';
            setTimeout(() => {
                currentViewEl.style.display = 'none';
                nextViewEl.style.display = 'block';
                if (viewKey === 'menu') {
                    nextViewEl.style.display = 'flex';
                }
                requestAnimationFrame(() => { nextViewEl.style.opacity = '1'; });
                if (viewKey === 'produccionHora') {
                    loadAreasForProductionReport();
                    populatePackerSelects();
                } else if (viewKey === 'produccion20') {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    doc('prod20_fecha').value = `${year}-${month}-${day}`;
                    doc('prod20_turno').value = getAutoCurrentShift();
                    renderProduccion20Table([]);
                    renderProduccion20Chart([], new Date());
                } else if (viewKey === 'produccionDaily') {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    doc('prodDaily_fecha').value = `${year}-${month}-${day}`;
                    doc('prodDaily_turno').value = getAutoCurrentShift();
                    renderProduccionDailyTable([]);
                    renderProduccionDailyChart([], new Date());
                }
            }, 300);
        }

        doc('reporteProduccionBtn').addEventListener('click', () => switchView('produccionHora'));
        doc('reporteProduccion20Btn').addEventListener('click', () => switchView('produccion20'));
        doc('reporteProduccionDailyBtn').addEventListener('click', () => switchView('produccionDaily'));
        doc('view901Btn').addEventListener('click', () => switchView('901'));
        doc('reporteTerminacionesBtn').addEventListener('click', () => switchView('terminaciones'));
        doc('abrirModalSemanalBtn').addEventListener('click', abrirModalReporteSemanal);
        document.querySelectorAll('.backToMenuBtn').forEach(btn => btn.addEventListener('click', () => switchView('menu')));

        let currentTheme = localStorage.getItem('theme') || 'dark';
        function applyTheme(theme) {
            document.body.className = `${theme}-theme`;
            document.querySelectorAll('.themeToggleBtn').forEach(btn => {
                const sunIcon = btn.querySelector('.sun-icon');
                const moonIcon = btn.querySelector('.moon-icon');
                if (sunIcon && moonIcon) {
                    sunIcon.style.display = theme === 'light' ? 'none' : 'block';
                    moonIcon.style.display = theme === 'light' ? 'block' : 'none';
                }
            });
            if (productionChart || fiberPieChart1 || fiberPieChart2 || production20Chart || weeklyProductionChart || productionDailyChart) {
                updateChartTheme();
            }
        }
        document.querySelectorAll('.themeToggleBtn').forEach(btn => btn.addEventListener('click', () => { currentTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem('theme', currentTheme); applyTheme(currentTheme); }));

        const modalOverlay = doc('modalOverlay');
        function showModal(title, content) { doc('modalTitle').textContent = title; doc('modalBody').innerHTML = content; modalOverlay.classList.add('visible'); }
        function hideModal() { modalOverlay.classList.remove('visible'); }
        doc('modalClose').addEventListener('click', hideModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideModal(); });

        document.querySelectorAll('.settingsBtn').forEach(btn => btn.addEventListener('click', () => { session.isMaster ? showParamsModal() : showLoginModal(); }));
        function showLoginModal() { const content = `<p style="text-align: center;">Introduce las credenciales de maestro.</p><input type="text" id="userInput" placeholder="Usuario"><input type="password" id="passInput" placeholder="Contraseña"><button id="loginBtn" class="btn" style="margin-top: 16px; width: 100%;">Autenticar</button><div id="login-error-msg"></div>`; showModal('Autenticación Maestra', content); doc('loginBtn').addEventListener('click', checkMasterCredentials); }
        function checkMasterCredentials() { const errorMsgEl = doc('login-error-msg'); if (doc('userInput').value === 'LUNAU' && doc('passInput').value === 'Resoner96') { session.isMaster = true; sessionStorage.setItem('reportesMasterSession', 'true'); hideModal(); showParamsModal(); } else { errorMsgEl.textContent = 'Credenciales incorrectas.'; } }

        // --- INICIO: LÓGICA DE MODALES DE CONFIGURACIÓN ---
        function showParamsModal() {
            if (activeView === '901') {
                const config = params['901_config'];
                const filterText = (config.userFilter || []).join(', ');
                const paramsHTML = `<ul class="param-list param-list-901">${(config.columns || []).map(p => createParamItem901(p.key, p.startCell)).join('')}</ul>`;
                const content = `<div class="user-filter-container"><label for="userFilterInput">Filtrar por Usuarios (separados por coma)</label><textarea id="userFilterInput" placeholder="PINTORA2, LUNAU2... (dejar vacío para incluir a todos)">${filterText}</textarea></div><hr style="border-color: var(--border-color); margin: 16px 0;"><p style="text-align:center;">Define los nombres de columna y la celda de inicio de cada una (ej. A2).</p>${paramsHTML}<button id="addParam901Btn" class="btn" style="width: auto; padding: 8px 16px;">Añadir Columna</button><button id="saveParams901Btn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Mapeo y Filtros</button>`;
                showModal('Configurar Mapeo y Filtros de 901', content);
                doc('addParam901Btn').addEventListener('click', () => doc('modalBody').querySelector('.param-list-901').insertAdjacentHTML('beforeend', createParamItem901('', '')));
                doc('saveParams901Btn').addEventListener('click', saveParams901);
            } else if (activeView === 'terminaciones') {
                showTerminacionesConfigModal();
            } else if (activeView === 'produccionHora') {
                showProduccionHoraConfigModal();
            } else if (activeView === 'produccion20') {
                showProduccion20ConfigModal();
            } else if (activeView === 'produccionDaily') {
                showProduccionDailyConfigModal();
            }
        }

        function showProduccionHoraConfigModal() {
            const config = params.produccion_hora_config;
            const content = `
                <div class="collapsible-section open" id="packerRegistrySection">
                    <div class="collapsible-header">Base de Datos de Empacadores</div>
                    <div class="collapsible-content">
                        <p>Añada, edite o elimine empacadores para autocompletar en el panel de control. Los cambios se guardan al presionar el botón de abajo.</p>
                        <form id="addPackerForm">
                            <input type="text" id="newPackerId" placeholder="ID Empacador" required>
                            <select id="newPackerArea">${doc('prod_area').innerHTML}</select>
                            <select id="newPackerLinea" required><option value="1">Línea 1</option><option value="2">Línea 2</option></select>
                            <select id="newPackerTurno" required>${doc('prod_turno').innerHTML}</select>
                            <button type="submit" class="btn" style="padding: 8px 12px; font-size: 1rem;">+</button>
                        </form>
                        <ul id="packerList"></ul>
                    </div>
                </div>
                <button id="saveProduccionHoraConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Base de Datos</button>
            `;
            showModal('Configurar Empacadores', content);
            doc('saveProduccionHoraConfigBtn').addEventListener('click', saveProduccionHoraConfig);

            const section = doc('packerRegistrySection');
            section.querySelector('.collapsible-header').addEventListener('click', () => {
                section.classList.toggle('open');
            });

            doc('addPackerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPacker = {
                    id: doc('newPackerId').value.trim().toUpperCase(),
                    area: doc('newPackerArea').value,
                    linea: doc('newPackerLinea').value,
                    turno: doc('newPackerTurno').value
                };
                if (newPacker.id && !params.produccion_hora_config.packers.some(p => p.id === newPacker.id)) {
                    params.produccion_hora_config.packers.push(newPacker);
                    renderPackerListInModal();
                    doc('newPackerId').value = '';
                } else if (newPacker.id) {
                    alert("El ID de empacador ya existe.");
                }
            });

            renderPackerListInModal();
        }

        function renderPackerListInModal() {
            const listEl = doc('packerList');
            if (!listEl) return;
            const packers = params.produccion_hora_config.packers || [];
            packers.sort((a, b) => a.id.localeCompare(b.id));

            listEl.innerHTML = packers.map((p, index) => `
                <li>
                    <span><strong>${p.id}</strong></span>
                    <span>${p.area}</span>
                    <span>Línea ${p.linea}</span>
                    <span>${p.turno}</span>
                    <button class="btn-danger" data-index="${index}" style="font-size: 0.8rem; padding: 4px 8px;">X</button>
                </li>
            `).join('');

            listEl.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    params.produccion_hora_config.packers.splice(index, 1);
                    renderPackerListInModal();
                });
            });
        }

        async function saveProduccionHoraConfig() {
            const newConfig = {
                packers: params.produccion_hora_config.packers || []
            };
            try {
                await db.collection('report_configs').doc('produccion_hora_params').set(newConfig);
                params.produccion_hora_config = newConfig;
                applyProduccionHoraConfig();
                showModal('Éxito', '<p>Base de datos de empacadores guardada.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        function createParamItem901(key, startCell) { return `<li class="param-item" style="grid-template-columns: 1fr 1fr auto;"><input type="text" class="param-key" placeholder="Nombre de Columna" value="${key || ''}"><input type="text" class="param-cell" placeholder="Celda de Inicio (ej. A2)" value="${startCell || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }

        async function saveParams901() {
            const newColumns = Array.from(doc('modalBody').querySelectorAll('.param-item')).map(item => ({ key: item.querySelector('.param-key').value.trim(), startCell: item.querySelector('.param-cell').value.trim().toUpperCase() })).filter(p => p.key && p.startCell);
            const userFilter = doc('userFilterInput').value.split(',').map(u => u.trim()).filter(Boolean);
            const newConfig = { columns: newColumns, userFilter: userFilter };
            try {
                await db.collection('report_configs').doc('901_params').set(newConfig);
                params['901_config'] = newConfig;
                showModal('Éxito', '<p>Mapeo y filtros de 901 guardados.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        function showTerminacionesConfigModal() {
            const config = params.terminaciones_config;
            const content = `
                <div class="modal-tabs">
                    <button class="tab-btn active" data-tab="zpptwc">1. Mapeo Zpptwc</button>
                    <button class="tab-btn" data-tab="coois">2. Mapeo Coois</button>
                    <button class="tab-btn" data-tab="areas">3. Mapeo de Áreas</button>
                    <button class="tab-btn" data-tab="final">4. Columnas Finales</button>
                </div>
                <div id="tab-zpptwc" class="tab-content active"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Zpptwc.</p><ul class="param-list">${(config.zpptwc_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                <div id="tab-coois" class="tab-content"><p>Define un nombre clave y la letra de la columna para cada dato del reporte Coois.</p><ul class="param-list">${(config.coois_cols || []).map(p => createSourceColHTML(p.key, p.excel_col)).join('')}</ul></div>
                <div id="tab-areas" class="tab-content">
                    <div class="area-source-container">
                        <label for="area-source-col">Columna Clave de Coois con Código de Área</label>
                        <input type="text" id="area-source-col" placeholder="Ej. MRP" value="${(config.area_config || {}).source_col || ''}">
                        <p>Usa el "Nombre Clave" (definido en la pestaña 2) de la columna del reporte Coois que contiene el código de área (ej. MRP).</p>
                    </div>
                    <ul class="area-list">${((config.area_config || {}).mappings || []).map(a => createAreaItemHTML(a.code, a.name)).join('')}</ul>
                </div>
                <div id="tab-final" class="tab-content"><p>Define las columnas que aparecerán en el reporte final. Para cálculos complejos, usa los tipos automáticos.</p><ul class="param-list">${(config.final_cols || []).map(p => createFinalColHTML(p.key, p.type, p.value)).join('')}</ul></div>
                <button class="addBtn btn" style="width: auto; padding: 8px 16px;">Añadir Fila</button>
                <button id="saveTerminacionesSettingsBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>`;
            showModal('Configurar Automatización de Terminaciones', content);
            const modalBody = doc('modalBody');
            modalBody.querySelectorAll('.tab-btn').forEach(button => button.addEventListener('click', () => { modalBody.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); doc(`tab-${button.dataset.tab}`).classList.add('active'); }));
            modalBody.querySelector('.addBtn').addEventListener('click', () => { const activeTab = modalBody.querySelector('.tab-content.active'); if(activeTab.id === 'tab-areas') { activeTab.querySelector('.area-list').insertAdjacentHTML('beforeend', createAreaItemHTML('', '')); } else if(activeTab.id === 'tab-final') { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createFinalColHTML('', 'source', '')); } else { activeTab.querySelector('.param-list').insertAdjacentHTML('beforeend', createSourceColHTML('', '')); } });

            const lists = modalBody.querySelectorAll('.param-list');
            lists.forEach(list => {
                list.addEventListener('dragstart', e => { if (e.target.classList.contains('param-item')) e.target.classList.add('dragging'); });
                list.addEventListener('dragend', e => { if (e.target.classList.contains('param-item')) e.target.classList.remove('dragging'); });
                list.addEventListener('dragover', e => {
                    e.preventDefault();
                    const draggingItem = list.querySelector('.dragging');
                    if (!draggingItem) return;
                    const afterElement = getDragAfterElement(list, e.clientY);
                    if (afterElement == null) { list.appendChild(draggingItem); }
                    else { list.insertBefore(draggingItem, afterElement); }
                });
            });
            doc('saveTerminacionesSettingsBtn').addEventListener('click', saveTerminacionesSettings);
        }

        function showProduccion20ConfigModal() {
            const config = params.produccion_20_config;
            const columnsHTML = config.columns.map(p => createSourceColHTML(p.key, p.excel_col)).join('');
            const content = `
                <div class="control-group">
                     <label for="prod20StartRow">Fila de inicio de datos</label>
                     <input type="number" id="prod20StartRow" value="${config.startRow || 15}">
                </div>
                <hr style="border-color: var(--border-color); margin: 16px 0;">
                <p style="text-align:center;">Arrastra para reordenar. Define el nombre de cada columna y la letra de la columna en Excel.</p>
                <ul class="param-list" id="prod20ParamList">${columnsHTML}</ul>
                <button id="addProd20ColBtn" class="btn" style="width: auto; padding: 8px 16px;">Añadir Columna</button>
                <button id="saveProd20ConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>
            `;
            showModal('Configurar Reporte Producción 20%', content);

            const paramList = doc('prod20ParamList');
            paramList.addEventListener('dragstart', e => { if (e.target.classList.contains('param-item')) e.target.classList.add('dragging'); });
            paramList.addEventListener('dragend', e => { if (e.target.classList.contains('param-item')) e.target.classList.remove('dragging'); });
            paramList.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingItem = paramList.querySelector('.dragging');
                if (!draggingItem) return;
                const afterElement = getDragAfterElement(paramList, e.clientY);
                if (afterElement == null) { paramList.appendChild(draggingItem); }
                else { paramList.insertBefore(draggingItem, afterElement); }
            });

            doc('addProd20ColBtn').addEventListener('click', () => {
                paramList.insertAdjacentHTML('beforeend', createSourceColHTML('', ''));
            });
            doc('saveProd20ConfigBtn').addEventListener('click', saveProduccion20Config);
        }
        
        function showProduccionDailyConfigModal() {
            const config = params.produccion_daily_config;
            const columnsHTML = config.columns.map(p => createSourceColHTML(p.key, p.excel_col)).join('');
            const content = `
                <div class="control-group">
                     <label for="prodDailyStartRow">Fila de inicio de datos</label>
                     <input type="number" id="prodDailyStartRow" value="${config.startRow || 15}">
                </div>
                <hr style="border-color: var(--border-color); margin: 16px 0;">
                <p style="text-align:center;">Define el nombre de cada columna y la letra de la columna en Excel.</p>
                <ul class="param-list" id="prodDailyParamList">${columnsHTML}</ul>
                <button id="addProdDailyColBtn" class="btn" style="width: auto; padding: 8px 16px;">Añadir Columna</button>
                <button id="saveProdDailyConfigBtn" class="btn" style="margin-top: 20px; width: 100%;">Guardar Configuración</button>
            `;
            showModal('Configurar Reporte Producción Daily', content);
            
            doc('addProdDailyColBtn').addEventListener('click', () => {
                doc('prodDailyParamList').insertAdjacentHTML('beforeend', createSourceColHTML('', ''));
            });
            doc('saveProdDailyConfigBtn').addEventListener('click', saveProduccionDailyConfig);
        }

        async function saveProduccionDailyConfig() {
            const newColumns = Array.from(doc('prodDailyParamList').querySelectorAll('.param-item')).map(item => ({
                key: item.querySelector('.param-key').value.trim(),
                excel_col: item.querySelector('.param-excel-col').value.trim().toUpperCase()
            })).filter(p => p.key && p.excel_col);

            const newConfig = {
                startRow: parseInt(doc('prodDailyStartRow').value, 10) || 15,
                columns: newColumns
            };

            try {
                await db.collection('report_configs').doc('produccion_daily_params').set(newConfig);
                params.produccion_daily_config = newConfig;
                showModal('Éxito', '<p>Configuración del Reporte Producción Daily guardada.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        async function saveProduccion20Config() {
            const newColumns = Array.from(doc('prod20ParamList').querySelectorAll('.param-item')).map(item => ({
                key: item.querySelector('.param-key').value.trim(),
                excel_col: item.querySelector('.param-excel-col').value.trim().toUpperCase()
            })).filter(p => p.key && p.excel_col);

            const newConfig = {
                startRow: parseInt(doc('prod20StartRow').value, 10) || 15,
                columns: newColumns
            };

            try {
                await db.collection('report_configs').doc('produccion_20_params').set(newConfig);
                params.produccion_20_config = newConfig;
                showModal('Éxito', '<p>Configuración del Reporte Producción 20% guardada.</p>');
            } catch (e) {
                showModal('Error', '<p>No se pudo guardar la configuración.</p>');
            }
        }

        function createSourceColHTML(key, excel_col) { return `<li class="param-item" draggable="true" style="grid-template-columns: auto 1fr 1fr auto;"><span class="drag-handle" title="Arrastrar para reordenar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle><circle cx="19" cy="5" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="19" cy="19" r="1"></circle></svg></span><input type="text" class="param-key" placeholder="Nombre de Columna" value="${key||''}"><input type="text" class="param-excel-col" placeholder="Letra de Columna (ej. A)" value="${excel_col||''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
        function createAreaItemHTML(code, name) { return `<li class="area-item" style="grid-template-columns: 1fr 2fr auto;"><input type="text" class="area-code" placeholder="Código MRP" value="${code || ''}"><input type="text" class="area-name" placeholder="Nombre de Área" value="${name || ''}"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }
        function createFinalColHTML(key, type, value) { const options = `<option value="source">Dato Directo</option><option value="formula">Fórmula (Avanzado)</option><option value="fibras_auto">Fibras (Automático)</option><option value="terminaciones_auto">Terminaciones (Automático)</option><option value="familia_auto">Familia (Automático)</option>`; let selectedOptions = options.replace(`value="${type}"`,`value="${type}" selected`); const isFormula = type === 'formula'; const isSource = type === 'source'; const isAuto = !isFormula && !isSource; return `<li class="param-item" draggable="true" style="grid-template-columns:auto 1fr 1.2fr 2fr auto"><span class="drag-handle" title="Arrastrar para reordenar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle><circle cx="19" cy="5" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="19" cy="19" r="1"></circle></svg></span><input type="text" class="param-key" placeholder="Nombre Columna Final" value="${key||''}"><select class="param-type">${selectedOptions}</select><div class="${isAuto ? 'hidden' : ''}"><input type="text" class="param-value-input" placeholder="${isFormula ? 'Escribe fórmula...' : 'Nombre Clave de la fuente'}" value="${value||''}" onfocus="populateFormulaHelpers(this, ${isFormula})"><div class="formula-helpers"></div></div><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button></li>`; }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.param-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; }
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        window.populateFormulaHelpers = (inputElement, isFormula) => { const container = inputElement.nextElementSibling; container.innerHTML = ''; if (!isFormula) return; const modalBody = inputElement.closest('#modalBody'); if (!modalBody) return; const currentKey = inputElement.closest('.param-item').querySelector('.param-key').value; const zpptwc_cols = Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => el.querySelector('.param-key').value); const coois_cols = Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => el.querySelector('.param-key').value); const final_cols = Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => el.querySelector('.param-key').value); const availableCols = [...zpptwc_cols, ...coois_cols, ...final_cols.filter(k => k !== currentKey), 'Area'].filter(Boolean); const uniqueCols = [...new Set(availableCols)]; uniqueCols.forEach(colName => { const pill = document.createElement('button'); pill.className = 'helper-pill'; pill.textContent = colName; pill.onclick = (e) => { e.preventDefault(); insertAtCursor(inputElement, `{${colName}}`); }; container.appendChild(pill); }); };
        function insertAtCursor(input, text) { const start = input.selectionStart; input.value = input.value.substring(0, start) + text + input.value.substring(input.selectionEnd); input.focus(); input.selectionEnd = start + text.length; }
        doc('modalOverlay').addEventListener('change', (e) => { if (e.target.classList.contains('param-type')) { const item = e.target.closest('.param-item'); const inputDiv = item.querySelector('div:not(.formula-helpers)'); const isAuto = ['fibras_auto', 'terminaciones_auto', 'familia_auto'].includes(e.target.value); if(inputDiv) inputDiv.classList.toggle('hidden', isAuto); } });

        async function saveTerminacionesSettings() {
            try {
                const modalBody = document.getElementById('modalBody');
                if (!modalBody) throw new Error("El cuerpo del modal no fue encontrado.");
                const newConfig = {
                    zpptwc_cols: Array.from(modalBody.querySelectorAll('#tab-zpptwc .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                    coois_cols: Array.from(modalBody.querySelectorAll('#tab-coois .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), excel_col: el.querySelector('.param-excel-col').value.trim().toUpperCase() })),
                    area_config: {
                        source_col: modalBody.querySelector('#area-source-col').value.trim(),
                        mappings: Array.from(modalBody.querySelectorAll('#tab-areas .area-item')).map(el => ({ code: el.querySelector('.area-code').value, name: el.querySelector('.area-name').value }))
                    },
                    final_cols: Array.from(modalBody.querySelectorAll('#tab-final .param-item')).map(el => ({ key: el.querySelector('.param-key').value.trim(), type: el.querySelector('.param-type').value, value: el.querySelector('.param-value-input').value.trim() })),
                };
                await db.collection('report_configs').doc('terminaciones_params_v2').set(newConfig);
                params.terminaciones_config = newConfig;
                showModal('Éxito', '<p>Configuración de Terminaciones guardada.</p>');
            } catch(e) {
                console.error("Error saving terminaciones settings:", e);
                showModal('Error', '<p>No se pudo guardar la configuración. Detalles: ' + e.message + '</p>');
            }
        }

        // --- INICIO: CARGA DE DATOS (PARAMS Y ARCHIVOS) ---
        async function loadParams(configKey) {
            const docIdMap = {
                '901_config': '901_params',
                'terminaciones_config': 'terminaciones_params_v2',
                'produccion_hora_config': 'produccion_hora_params',
                'produccion_20_config': 'produccion_20_params',
                'produccion_daily_config': 'produccion_daily_params'
            };
            const docId = docIdMap[configKey];
            if (!docId) return;

            try {
                const docRef = await db.collection('report_configs').doc(docId).get();
                if (docRef.exists) {
                    const data = docRef.data();
                    if (configKey === 'produccion_20_config' || configKey === 'produccion_daily_config') {
                        params[configKey] = { ...params[configKey], ...data };
                    } else if (configKey === '901_config') {
                        params[configKey] = { columns: data.columns || [], userFilter: data.userFilter || [] };
                    } else if (configKey === 'terminaciones_config') {
                        params.terminaciones_config = { zpptwc_cols: [], coois_cols: [], final_cols: [], area_config: { source_col: '', mappings: [] }, ...data };
                    } else if (configKey === 'produccion_hora_config') {
                        params.produccion_hora_config = { packers: [], ...data };
                        applyProduccionHoraConfig();
                    }
                }
            } catch(e) { console.error(`Error al cargar ${configKey}:`, e); }
        }

        function applyProduccionHoraConfig() {
            populatePackerSelects();
        }

        function populatePackerSelects() {
            const turno = doc('prod_turno').value;
            const area = doc('prod_area').value;
            const packers = params.produccion_hora_config.packers || [];

            const filterAndPopulate = (linea, selectId) => {
                const select = doc(selectId);
                const currentSelection = select.value;
                select.innerHTML = '<option value="" disabled selected>Seleccionar...</option>';
                const filteredPackers = packers.filter(p => p.linea === linea && p.turno === turno && (p.area === area || area === 'ALL' || p.area === 'ALL'));
                filteredPackers.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.id}</option>`;
                });
                if (filteredPackers.some(p => p.id === currentSelection)) {
                    select.value = currentSelection;
                }
            };

            filterAndPopulate('1', 'prod_linea1_packer');
            filterAndPopulate('2', 'prod_linea2_packer');
        }
        doc('prod_turno').addEventListener('change', populatePackerSelects);
        doc('prod_area').addEventListener('change', populatePackerSelects);


        function setupFileHandler(dropAreaId, inputId, configKey) {
            const dropArea = doc(dropAreaId); const input = doc(inputId);
            if (!dropArea || !input) return;
            dropArea.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0], configKey); e.target.value = ''; });
            dropArea.addEventListener('dragover', (e) => e.preventDefault());
            dropArea.addEventListener('drop', (e) => { e.preventDefault(); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], configKey); });
        }

        setupFileHandler('fileDropArea901', 'fileInput901', '901');
        setupFileHandler('fileDropAreaZpptwc', 'fileInputZpptwc', 'zpptwc');
        setupFileHandler('fileDropAreaCoois', 'fileInputCoois', 'coois');
        setupFileHandler('fileDropAreaProd20', 'fileInputProd20', 'produccion20');
        setupFileHandler('fileDropAreaProdDaily', 'fileInputProdDaily', 'produccionDaily');

        function handleFile(file, configKey) {
            if(configKey === '901') {
                handle901File(file);
            } else if (configKey === 'produccion20') {
                handleProduccion20File(file);
            } else if (configKey === 'produccionDaily') {
                handleProduccionDailyFile(file);
            } else {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const mapping = (configKey === 'zpptwc') ? params.terminaciones_config.zpptwc_cols : params.terminaciones_config.coois_cols;
                        const sheetData = XLSX.utils.sheet_to_json(ws, { header: 'A', defval: null, range: 1 });
                        const data = sheetData.map(row => {
                            let rowData = {};
                            for (const map of mapping) {
                                if(map.excel_col) {
                                    rowData[map.key] = row[map.excel_col];
                                }
                            }
                            return rowData;
                        }).filter(row => row.Orden);
                        reportData[configKey] = data;
                        doc(`fileDropArea${configKey.charAt(0).toUpperCase() + configKey.slice(1)}`).style.borderColor = '#4ade80';

                        if (configKey === 'coois') {
                            const batch = db.batch();
                            data.forEach(row => {
                                const orderId = String(row.Orden || '').replace(/^0+/, '');
                                if(orderId) {
                                    const docRef = db.collection('coois_historico').doc(orderId);
                                    batch.set(docRef, row, { merge: true });
                                }
                            });
                            await batch.commit();
                        }

                        processTerminacionesReport();
                    } catch (err) {
                        console.error("Error al procesar archivo:", err);
                        showModal('Error de Archivo', '<p>No se pudo procesar el archivo Excel. Verifique el mapeo de letras de columna y la conexión a la base de datos.</p>');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        const formulaHelpers = {
            EXTRAER: (text, start, length) => (typeof text !== 'string' || text === null) ? '' : String(text).substring(start - 1, start - 1 + length),
            EXTRAER_FIBRAS: (text, start, length) => {
                if (typeof text !== 'string' || text === null) return 0;
                const code = String(text).substring(start - 1, start - 1 + length).toUpperCase();
                if (!code) return 0;
                switch (code) {
                    case '1': return 1; case '2': return 2; case '3': return 3; case '4': return 4;
                    case '5': return 5; case '6': return 6; case '7': return 7; case '8': return 8;
                    case '9': return 9; case 'A': return 1; case 'B': return 2; case 'C': return 4;
                    case 'D': return 6; case 'E': return 8; case 'F': return 12; case 'G': return 24;
                    case 'T': return 12; default: const num = parseFloat(code); return isNaN(num) ? 0 : num;
                }
            },
            IF: (condition, valueIfTrue, valueIfFalse) => condition ? valueIfTrue : valueIfFalse,
        };

        function excelSerialToDateObject(serial) {
            if (serial instanceof Date) return serial;
            if (typeof serial !== 'number' || isNaN(serial)) return null;
            const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
            return new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
        }

        function formatShortDateTime(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${month}/${day} ${hour}:${minute}`;
        }
        
        // =======================================================================================
        // --- INICIO: LÓGICA REPORTE PRODUCCIÓN POR SEMANA DAILY ---
        // =======================================================================================

        doc('consultarProduccionDailyBtn').addEventListener('click', consultarReporteProduccionDaily);
        doc('abrirModalSemanalDailyBtn').addEventListener('click', abrirModalReporteSemanalDaily);

        async function handleProduccionDailyFile(file) {
            const config = params.produccion_daily_config;
            if (!config || !config.columns || config.columns.length === 0) {
                showModal('Configuración Requerida', '<p>La configuración para este reporte no ha sido cargada. Contacte al administrador.</p>');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: config.startRow - 1, blankrows: false });

                    const colMap = {};
                    config.columns.forEach(col => {
                        colMap[col.key] = XLSX.utils.decode_col(col.excel_col);
                    });

                    const dataToSave = [];
                    jsonData.forEach((row, index) => {
                        const rowData = {};
                        let hasData = false;
                        config.columns.forEach(col => {
                            const value = row[colMap[col.key]];
                            rowData[col.key] = value;
                            if (value !== undefined && value !== null && String(value).trim() !== '') {
                                hasData = true;
                            }
                        });

                        if (hasData) {
                            let fechaHora = null;
                            if (rowData['Finish date'] instanceof Date) {
                                fechaHora = rowData['Finish date'];
                            } else if (typeof rowData['Finish date'] === 'number') {
                                fechaHora = excelSerialToDateObject(rowData['Finish date']);
                            }
                            
                            if (fechaHora) {
                                const docId = `${fechaHora.getTime()}-${rowData['Linea'] || 'N/A'}-${index}`;
                                dataToSave.push({ 
                                    docId: docId, 
                                    data: { ...rowData, 'Finish date': firebase.firestore.Timestamp.fromDate(fechaHora) } 
                                });
                            }
                        }
                    });

                    if (dataToSave.length === 0) {
                        showModal('Sin Datos', `<p>No se encontraron datos válidos a partir de la fila ${config.startRow}.</p>`);
                        return;
                    }

                    const batch = db.batch();
                    dataToSave.forEach(item => {
                        const docRef = db.collection('produccion_daily_historico').doc(item.docId);
                        batch.set(docRef, item.data);
                    });
                    await batch.commit();

                    doc('fileDropAreaProdDaily').style.borderColor = 'var(--success-color)';
                    showModal('Éxito', `<p>${dataToSave.length} registros han sido guardados. Vuelva a consultar la fecha para ver los datos.</p>`);
                    consultarReporteProduccionDaily();

                } catch (err) {
                    console.error("Error al procesar archivo Daily:", err);
                    doc('fileDropAreaProdDaily').style.borderColor = 'var(--danger-color)';
                    showModal('Error de Archivo', `<p>No se pudo procesar o guardar el archivo. Verifique el formato y la configuración.</p>`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function consultarReporteProduccionDaily() {
            const fechaInput = doc('prodDaily_fecha').value;
            const turnoInput = doc('prodDaily_turno').value;

            if (!fechaInput) {
                showModal('Fecha Requerida', '<p>Por favor, seleccione una fecha.</p>');
                return;
            }
            const btn = doc('consultarProduccionDailyBtn');
            btn.disabled = true;
            btn.textContent = 'Consultando...';

            const { startTime, endTime } = getShiftDateRange(fechaInput, turnoInput);

            try {
                const snapshot = await db.collection('produccion_daily_historico')
                    .where('Finish date', '>=', startTime)
                    .where('Finish date', '<=', endTime)
                    .get();

                const data = [];
                snapshot.forEach(docSnap => {
                    const docData = docSnap.data();
                    data.push({
                        ...docData,
                        'Finish date': docData['Finish date'] ? docData['Finish date'].toDate() : null
                    });
                });

                if (data.length === 0) {
                    showModal('Sin Datos', `<p>No se encontraron registros para la fecha y turno seleccionados.</p>`);
                    renderProduccionDailyTable([]);
                    renderProduccionDailyChart([], startTime);
                    return;
                }

                const processedData = data.map(row => {
                    const catalogo = row['Catálogo'] || '';
                    const cuartoDigito = catalogo.substring(3, 4).toUpperCase();
                    const fibras = cuartoDigito === 'T' ? 12 : parseInt(cuartoDigito, 10) || 0;
                    const terminaciones = fibras * (Number(row['Cantidad']) || 0);
                    return { ...row, Fibras: fibras, Terminaciones: terminaciones };
                });

                renderProduccionDailyTable(processedData);
                renderProduccionDailyChart(processedData, startTime);

            } catch (e) {
                console.error("Error consultando reporte Daily:", e);
                showModal('Error de Consulta', '<p>No se pudo obtener el reporte de la base de datos.</p>');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Consultar Reporte';
            }
        }

        function renderProduccionDailyTable(data) {
            const table = doc('dataTableProduccionDaily');
            if (!data || data.length === 0) {
                table.innerHTML = `<thead><tr><th>Sin datos para mostrar.</th></tr></thead><tbody></tbody>`;
                return;
            }

            const headers = [...params.produccion_daily_config.columns.map(c => c.key), 'Fibras', 'Terminaciones'];
            
            let headerHtml = '<thead><tr>';
            headers.forEach(h => headerHtml += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
            headerHtml += '</tr></thead>';

            let bodyHtml = '<tbody>';
            data.sort((a, b) => (b['Finish date'] || 0) - (a['Finish date'] || 0));

            data.forEach(row => {
                bodyHtml += `<tr>`;
                headers.forEach(header => {
                    let value = row[header];
                    if (header === 'Finish date' && value instanceof Date) {
                        value = formatShortDateTime(value);
                    }
                    bodyHtml += `<td>${value ?? ''}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            bodyHtml += '</tbody>';
            table.innerHTML = headerHtml + bodyHtml;
            
            table.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keyup', () => {
                    const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({
                        columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')),
                        value: i.value.toLowerCase()
                    }));
                    table.querySelectorAll('tbody tr').forEach(row => {
                        let shouldShow = true;
                        filters.forEach(filter => {
                            if (filter.value) {
                                const cell = row.children[filter.columnIndex];
                                if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) {
                                    shouldShow = false;
                                }
                            }
                        });
                        row.style.display = shouldShow ? '' : 'none';
                    });
                });
            });
        }

        function renderProduccionDailyChart(data, shiftStartTime) {
            const ctx = doc('produccionDailyChart').getContext('2d');
            if (productionDailyChart) {
                productionDailyChart.destroy();
            }
            if (!data || data.length === 0 || !shiftStartTime) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                doc('chartSummaryDaily').innerHTML = '';
                return;
            }

            const hourlyBins = Array.from({ length: 12 }, () => ({}));
            let totalTerminaciones = 0;
            
            data.forEach(item => {
                const linea = item['Linea'] || 'N/A';
                const terminaciones = Number(item['Terminaciones']) || 0;
                totalTerminaciones += terminaciones;
                
                if (item['Finish date'] instanceof Date) {
                    const diffMillis = item['Finish date'] - shiftStartTime;
                    if (diffMillis >= 0) {
                        const hourIndex = Math.floor(diffMillis / (1000 * 60 * 60));
                        if (hourIndex >= 0 && hourIndex < 12) {
                            hourlyBins[hourIndex][linea] = (hourlyBins[hourIndex][linea] || 0) + terminaciones;
                        }
                    }
                }
            });

            doc('chartSummaryDaily').innerHTML = `Total Terminaciones del Turno: <strong>${totalTerminaciones.toLocaleString()}</strong>`;

            const allLineas = [...new Set(data.map(item => item['Linea'] || 'N/A'))].sort();
            const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)'];
            const datasets = allLineas.map((linea, index) => ({
                label: `Línea ${linea}`,
                data: hourlyBins.map(hourData => hourData[linea] || 0),
                backgroundColor: colors[index % colors.length],
            }));

            const labels = [];
            for (let i = 0; i < 12; i++) {
                const start = new Date(shiftStartTime);
                start.setHours(start.getHours() + i);
                const end = new Date(start);
                end.setHours(end.getHours() + 1);
                const format = { hour: '2-digit', minute: '2-digit', hour12: false };
                labels.push(`${start.toLocaleTimeString([], format)} - ${end.toLocaleTimeString([], format)}`);
            }

            productionDailyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)'}},
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            color: 'var(--text-primary)',
                            font: { weight: 'bold' },
                            formatter: (value) => value > 0 ? value.toLocaleString() : ''
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' } },
                        y: { stacked: true, beginAtZero: true, grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' } }
                    }
                },
                plugins: [ChartDataLabels]
            });
            updateChartTheme();
        }

        // --- Lógica para el Reporte Semanal del Reporte Daily ---
        function abrirModalReporteSemanalDaily() {
            const modalHTML = `
                <div class="controles-semanales" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; align-items: end;">
                    <div>
                        <label for="semanalDaily_fecha_inicio">Fecha de Inicio</label>
                        <input type="date" id="semanalDaily_fecha_inicio">
                    </div>
                    <div>
                        <label for="semanalDaily_fecha_fin">Fecha de Fin</label>
                        <input type="date" id="semanalDaily_fecha_fin">
                    </div>
                </div>
                <button id="generarReporteSemanalDailyBtn" class="btn" style="width: 100%;">Generar Gráfica Comparativa</button>
                <div id="chartContainerSemanalDaily" style="margin-top: 20px; height: 45vh; position: relative;">
                    <canvas id="graficaSemanalDaily"></canvas>
                </div>
            `;
            showModal('Reporte Semanal de Terminaciones (Daily)', modalHTML);

            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 6);
            doc('semanalDaily_fecha_fin').value = hoy.toISOString().split('T')[0];
            doc('semanalDaily_fecha_inicio').value = haceUnaSemana.toISOString().split('T')[0];

            doc('generarReporteSemanalDailyBtn').addEventListener('click', consultarReporteSemanalDaily);
        }

        async function consultarReporteSemanalDaily() {
            const btn = doc('generarReporteSemanalDailyBtn');
            btn.disabled = true;
            btn.textContent = 'Generando...';

            const fechaInicio = doc('semanalDaily_fecha_inicio').value;
            const fechaFin = doc('semanalDaily_fecha_fin').value;

            if (!fechaInicio || !fechaFin) {
                alert('Por favor, selecciona un rango de fechas.');
                btn.disabled = false;
                btn.textContent = 'Generar Gráfica Comparativa';
                return;
            }

            const fechaInicioDate = new Date(`${fechaInicio}T00:00:00`);
            const fechaFinDate = new Date(`${fechaFin}T23:59:59`);

            try {
                const snapshot = await db.collection('produccion_daily_historico')
                    .where('Finish date', '>=', fechaInicioDate)
                    .where('Finish date', '<=', fechaFinDate)
                    .get();

                const datosAgrupados = {};
                const labelsFechas = new Set();
                const allLineas = new Set();

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const fechaHora = data['Finish date'].toDate();
                    
                    const dateKey = fechaHora.toISOString().split('T')[0];
                    labelsFechas.add(dateKey);
                    
                    const linea = data['Linea'] || 'N/A';
                    allLineas.add(linea);

                    if (!datosAgrupados[dateKey]) datosAgrupados[dateKey] = {};
                    if (!datosAgrupados[dateKey][linea]) datosAgrupados[dateKey][linea] = 0;
                    
                    const catalogo = data['Catálogo'] || '';
                    const cuartoDigito = catalogo.substring(3, 4).toUpperCase();
                    const fibras = cuartoDigito === 'T' ? 12 : parseInt(cuartoDigito, 10) || 0;
                    const terminaciones = fibras * (Number(data['Cantidad']) || 0);

                    datosAgrupados[dateKey][linea] += terminaciones;
                });

                const fechasOrdenadas = Array.from(labelsFechas).sort();
                renderGraficaSemanalDaily(datosAgrupados, fechasOrdenadas, Array.from(allLineas).sort());

            } catch (e) {
                console.error("Error consultando reporte semanal daily:", e);
                alert("No se pudo generar el reporte semanal. Revisa la consola.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generar Gráfica Comparativa';
            }
        }

        function renderGraficaSemanalDaily(datos, labels, lineas) {
            const ctx = doc('graficaSemanalDaily').getContext('2d');
            if (graficaSemanalDailyInstance) {
                graficaSemanalDailyInstance.destroy();
            }

            const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)'];
            const datasets = lineas.map((linea, index) => ({
                label: `Línea ${linea}`,
                data: labels.map(fecha => (datos[fecha] && datos[fecha][linea]) ? datos[fecha][linea] : 0),
                backgroundColor: colors[index % colors.length]
            }));

            graficaSemanalDailyInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(f => new Date(f + 'T12:00:00').toLocaleDateString('es-MX', { weekday: 'short', month: 'short', day: 'numeric' })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { stacked: true, beginAtZero: true, ticks: { color: 'var(--chart-tick-color)' }, grid: { color: 'var(--chart-grid-color)' } },
                        x: { stacked: true, ticks: { color: 'var(--chart-tick-color)' }, grid: { color: 'var(--chart-grid-color)' } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)' } },
                        datalabels: {
                            color: 'white',
                            font: { weight: 'bold' },
                            formatter: (value) => value > 0 ? value.toLocaleString() : ''
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            updateChartTheme();
        }

        // =======================================================================================
        // --- FIN: LÓGICA REPORTE PRODUCCIÓN POR SEMANA DAILY ---
        // =======================================================================================
        

        // --- INICIO: LÓGICA DEL REPORTE SEMANAL 20% ---
        function abrirModalReporteSemanal() {
            const modalHTML = `
                <div class="controles-semanales" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; align-items: end;">
                    <div>
                        <label for="semanal_fecha_inicio" style="font-size: 0.9rem; font-weight: 500;">Fecha de Inicio</label>
                        <input type="date" id="semanal_fecha_inicio">
                    </div>
                    <div>
                        <label for="semanal_fecha_fin" style="font-size: 0.9rem; font-weight: 500;">Fecha de Fin</label>
                        <input type="date" id="semanal_fecha_fin">
                    </div>
                </div>
                <div class="turnos-semanales" style="margin-bottom: 20px;">
                    <label style="font-size: 0.9rem; font-weight: 500;">Turnos a Comparar:</label>
                    <div style="display: flex; justify-content: space-around; margin-top: 8px; background-color: var(--surface-hover-color); padding: 8px; border-radius: 8px;">
                        <label><input type="checkbox" class="turno-checkbox" value="T45" checked> T45</label>
                        <label><input type="checkbox" class="turno-checkbox" value="T46" checked> T46</label>
                        <label><input type="checkbox" class="turno-checkbox" value="T47" checked> T47</label>
                        <label><input type="checkbox" class="turno-checkbox" value="T48" checked> T48</label>
                    </div>
                </div>
                <button id="generarReporteSemanalBtn" class="btn" style="width: 100%;">Generar Gráfica Comparativa</button>
                <div id="chartContainerSemanal" style="margin-top: 20px; height: 40vh; position: relative;">
                    <canvas id="graficaSemanal"></canvas>
                </div>
            `;
            showModal('Reporte Semanal Comparativo', modalHTML);

            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 6);
            doc('semanal_fecha_fin').value = hoy.toISOString().split('T')[0];
            doc('semanal_fecha_inicio').value = haceUnaSemana.toISOString().split('T')[0];

            doc('generarReporteSemanalBtn').addEventListener('click', consultarReporteSemanal);
        }

        async function consultarReporteSemanal() {
            const btn = doc('generarReporteSemanalBtn');
            btn.disabled = true;
            btn.textContent = 'Generando...';

            const fechaInicio = doc('semanal_fecha_inicio').value;
            const fechaFin = doc('semanal_fecha_fin').value;
            const turnosSeleccionados = Array.from(document.querySelectorAll('.turno-checkbox:checked')).map(cb => cb.value);

            if (!fechaInicio || !fechaFin || turnosSeleccionados.length === 0) {
                alert('Por favor, selecciona un rango de fechas y al menos un turno.');
                btn.disabled = false;
                btn.textContent = 'Generar Gráfica Comparativa';
                return;
            }

            const fechaInicioDate = new Date(`${fechaInicio}T06:30:00`);
            const fechaFinDate = new Date(`${fechaFin}T23:59:59`);
             fechaFinDate.setDate(fechaFinDate.getDate() + 1);
             fechaFinDate.setHours(6, 29, 59, 999);

            try {
                const snapshot = await db.collection('produccion_20_historico')
                    .where('Fecha y hora', '>=', fechaInicioDate)
                    .where('Fecha y hora', '<=', fechaFinDate)
                    .get();

                const datosAgrupados = {};
                const labelsFechas = new Set();

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const fechaHora = data['Fecha y hora'].toDate();

                    const { shift, dateKey } = getWorkShiftAndDate(fechaHora);

                    if (turnosSeleccionados.includes(shift) && dateKey >= fechaInicio && dateKey <= fechaFin) {
                        labelsFechas.add(dateKey);

                        if (!datosAgrupados[dateKey]) datosAgrupados[dateKey] = {};
                        if (!datosAgrupados[dateKey][shift]) datosAgrupados[dateKey][shift] = 0;

                        const catalogo = data['Catalogo'] || '';
                        const digit = catalogo.substring(3, 4).toUpperCase();
                        const terminacionesPorPieza = digit === 'T' ? 12 : parseInt(digit, 10) || 0;
                        const cantidad = Number(data['Cantidad']) || 1;

                        datosAgrupados[dateKey][shift] += terminacionesPorPieza * cantidad;
                    }
                });

                const fechasOrdenadas = Array.from(labelsFechas).sort();
                renderGraficaSemanal(datosAgrupados, fechasOrdenadas, turnosSeleccionados);

            } catch (e) {
                console.error("Error consultando reporte semanal:", e);
                alert("No se pudo generar el reporte. Revisa la consola para más detalles.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generar Gráfica Comparativa';
            }
        }

        function renderGraficaSemanal(datos, labels, turnos) {
            const ctx = doc('graficaSemanal').getContext('2d');
            if (graficaSemanalInstance) {
                graficaSemanalInstance.destroy();
            }

            const colores = {
                T45: 'rgba(54, 162, 235, 0.7)',
                T46: 'rgba(255, 99, 132, 0.7)',
                T47: 'rgba(75, 192, 192, 0.7)',
                T48: 'rgba(255, 206, 86, 0.7)'
            };

            const datasets = turnos.map(turno => {
                return {
                    label: `Terminaciones ${turno}`,
                    data: labels.map(fecha => (datos[fecha] && datos[fecha][turno]) ? datos[fecha][turno] : 0),
                    backgroundColor: colores[turno] || 'rgba(153, 102, 255, 0.7)',
                    borderWidth: 1
                };
            });

            const chartGridColor = getComputedStyle(document.body).getPropertyValue('--chart-grid-color').trim();
            const chartTickColor = getComputedStyle(document.body).getPropertyValue('--chart-tick-color').trim();
            const textPrimaryColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();

            graficaSemanalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(f => {
                        const parts = f.split('-');
                        const year = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const day = parseInt(parts[2], 10);
                        const date = new Date(Date.UTC(year, month, day));
                        return date.toLocaleDateString('es-MX', { timeZone: 'UTC', weekday: 'short', month: 'short', day: 'numeric' });
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: chartTickColor },
                            grid: { color: chartGridColor }
                        },
                        x: {
                            ticks: { color: chartTickColor },
                            grid: { color: chartGridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: textPrimaryColor }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            color: textPrimaryColor,
                            font: {
                                weight: 'bold',
                                size: 10,
                            },
                            formatter: (value) => {
                                if (value === 0) {
                                    return '';
                                }
                                return value.toLocaleString('es-MX');
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function getWorkShiftAndDate(date) {
            const hour = date.getHours();
            const minute = date.getMinutes();

            let workDate = new Date(date.getTime());

            if (hour < 6 || (hour === 6 && minute < 30)) {
                workDate.setDate(workDate.getDate() - 1);
            }

            const year = workDate.getFullYear();
            const month = String(workDate.getMonth() + 1).padStart(2, '0');
            const dayOfMonth = String(workDate.getDate()).padStart(2, '0');
            const dateKey = `${year}-${month}-${dayOfMonth}`;
            
            const referenceDate = new Date('2025-10-06T00:00:00');
            const diffTime = workDate.getTime() - referenceDate.getTime();
            const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
            const isShortWeek = diffWeeks % 2 === 0;

            const workDay = workDate.getDay();

            const isDayTime = (hour > 6 || (hour === 6 && minute >= 30)) && (hour < 18 || (hour === 18 && minute < 30));

            let shift;

            if (isShortWeek) {
                if (workDay >= 1 && workDay <= 3) {
                    shift = isDayTime ? 'T45' : 'T46';
                } else {
                    shift = isDayTime ? 'T47' : 'T48';
                }
            } else {
                if (workDay >= 1 && workDay <= 4) {
                    shift = isDayTime ? 'T45' : 'T46';
                } else {
                    shift = isDayTime ? 'T47' : 'T48';
                }
            }

            return {
                shift: shift,
                dateKey: dateKey 
            };
        }
        
        // --- INICIO: LÓGICA REPORTE PRODUCCIÓN 20% ---
        doc('consultarProduccion20Btn').addEventListener('click', consultarReporteProduccion20);

        async function handleProduccion20File(file) {
            const config = params.produccion_20_config;
            if (!config || !config.columns || !config.columns.length === 0) {
                showModal('Configuración Requerida', '<p>Por favor, configure el mapeo de columnas para este reporte en el panel de configuración (icono de engrane).</p>');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, range: config.startRow - 1, blankrows: false });

                    const colMap = {};
                    config.columns.forEach(col => {
                       colMap[col.key] = XLSX.utils.decode_col(col.excel_col);
                    });

                    const data = jsonData.map(row => {
                        const rowData = {};
                        config.columns.forEach(col => {
                            rowData[col.key] = row[colMap[col.key]];
                        });
                        return rowData;
                    }).filter(row => row['Serial Number'] !== undefined && String(row['Serial Number']).trim() !== '');

                    if (data.length === 0) {
                      showModal('Sin Datos', `<p>No se encontraron datos válidos a partir de la fila ${config.startRow} en el archivo Excel.</p>`);
                      return;
                    }

                    const batch = db.batch();
                    let processedCount = 0;
                    data.forEach(row => {
                        const serial = String(row['Serial Number']).trim();
                        if(serial){
                            const docRef = db.collection('produccion_20_historico').doc(serial);
                            let fechaHora = null;
                            if (row['Fecha y hora'] instanceof Date) {
                                fechaHora = row['Fecha y hora'];
                            } else if (typeof row['Fecha y hora'] === 'number') {
                                fechaHora = excelSerialToDateObject(row['Fecha y hora']);
                            }

                            if (fechaHora) {
                                batch.set(docRef, { ...row, 'Fecha y hora': firebase.firestore.Timestamp.fromDate(fechaHora) });
                                processedCount++;
                            }
                        }
                    });
                    await batch.commit();

                    doc('fileDropAreaProd20').style.borderColor = 'var(--success-color)';
                    showModal('Éxito', `<p>${processedCount} registros han sido guardados en la base de datos. Vuelva a consultar la fecha para ver los datos actualizados.</p>`);
                    consultarReporteProduccion20();

                } catch (err) {
                    console.error("Error al procesar y guardar archivo de Producción 20%:", err);
                    doc('fileDropAreaProd20').style.borderColor = 'var(--danger-color)';
                    showModal('Error de Archivo', `<p>No se pudo procesar o guardar el archivo. Verifique el formato, la configuración y la conexión a la base de datos.</p>`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function consultarReporteProduccion20() {
            const fechaInput = doc('prod20_fecha').value;
            const turnoInput = doc('prod20_turno').value;

            if (!fechaInput) {
                showModal('Fecha Requerida', '<p>Por favor, seleccione una fecha para consultar el reporte.</p>');
                return;
            }
            const btn = doc('consultarProduccion20Btn');
            btn.disabled = true;
            btn.textContent = 'Consultando...';

            const { startTime, endTime } = getShiftDateRange(fechaInput, turnoInput);

            try {
                const snapshot = await db.collection('produccion_20_historico')
                    .where('Fecha y hora', '>=', startTime)
                    .where('Fecha y hora', '<=', endTime)
                    .get();

                const data = [];
                snapshot.forEach(doc => {
                    const docData = doc.data();
                    data.push({
                        ...docData,
                        'Fecha y hora': docData['Fecha y hora'] ? docData['Fecha y hora'].toDate() : null
                    });
                });

                if (data.length === 0) {
                    showModal('Sin Datos', `<p>No se encontraron registros para la fecha y turno seleccionados.</p>`);
                    renderProduccion20Table([]);
                    renderProduccion20Chart([], startTime);
                    return;
                }

                const processedData = data.map(row => {
                    const catalogo = row['Catalogo'];
                    const digit = (catalogo || '').substring(3, 4).toUpperCase();
                    const terminaciones = digit === 'T' ? 12 : parseInt(digit, 10) || 0;
                    return { ...row, fechaHora: row['Fecha y hora'], terminaciones };
                });

                renderProduccion20Table(processedData);
                renderProduccion20Chart(processedData, startTime);

            } catch (e) {
                console.error("Error al consultar datos de Firestore:", e);
                showModal('Error de Consulta', '<p>No se pudo obtener el reporte de la base de datos.</p>');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Consultar Reporte';
            }
        }


        function renderProduccion20Table(data) {
            const table = doc('dataTableProduccion20');
             if (!data || data.length === 0) {
                 table.innerHTML = `<thead><tr><th>Sin datos para mostrar. Consulte una fecha o cargue un archivo.</th></tr></thead><tbody></tbody>`;
                 return;
             }

            let headers = params.produccion_20_config.columns.map(c => c.key);

            if (!headers.map(h => h.toLowerCase()).includes('terminaciones')) {
                 headers.push('Terminaciones');
            }

            let headerHtml = '<thead><tr>';
            headers.forEach(h => headerHtml += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
            headerHtml += '</tr></thead>';

            let bodyHtml = '<tbody>';
            data.sort((a, b) => (b.fechaHora || 0) - (a.fechaHora || 0));

            data.forEach(row => {
                bodyHtml += `<tr>`;
                headers.forEach(header => {
                    let value;
                    const headerLower = header.toLowerCase();
                    if (headerLower === 'fecha y hora') {
                        value = row.fechaHora ? formatShortDateTime(row.fechaHora) : row[header];
                    } else if (headerLower === 'terminaciones') {
                        value = row.terminaciones * (Number(row['Cantidad']) || 1);
                    } else {
                        value = row[header];
                    }
                    bodyHtml += `<td>${value ?? ''}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            bodyHtml += '</tbody>';
            table.innerHTML = headerHtml + bodyHtml;
            addProduccion20FilterListeners();
        }

        function addProduccion20FilterListeners(){
            doc('dataTableProduccion20').querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keyup', filterProduccion20Table);
            });
        }

        function filterProduccion20Table() {
            const table = doc('dataTableProduccion20');
            const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => {
                const th = i.closest('th');
                return {
                    columnIndex: Array.from(th.parentNode.children).indexOf(th),
                    value: i.value.toLowerCase()
                };
            });
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                let shouldShow = true;
                filters.forEach(filter => {
                    if (filter.value) {
                        const cell = row.children[filter.columnIndex];
                        if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) {
                            shouldShow = false;
                        }
                    }
                });
                row.style.display = shouldShow ? '' : 'none';
            });
        }

        function renderProduccion20Chart(data, shiftStartTime) {
            const ctx = doc('produccion20Chart').getContext('2d');
            if (production20Chart) {
                production20Chart.destroy();
            }

            if (!data || data.length === 0 || !shiftStartTime) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                doc('chartSummary20').innerHTML = '';
                return;
            }

            const hourlyBins = Array.from({ length: 12 }, () => ({}));
            const allStations = new Set();
            const totalTerminacionesPorEstacion = {};

            data.forEach(item => {
                const estacion = item['Estación'] || 'N/A';
                allStations.add(estacion);
                const cantidad = Number(item['Cantidad']) || 1;
                const totalTerm = item.terminaciones * cantidad;
                totalTerminacionesPorEstacion[estacion] = (totalTerminacionesPorEstacion[estacion] || 0) + totalTerm;

                if (item.fechaHora instanceof Date) {
                    const diffMillis = item.fechaHora - shiftStartTime;
                    if (diffMillis >= 0) {
                        const hourIndex = Math.floor(diffMillis / (1000 * 60 * 60));
                        if (hourIndex >= 0 && hourIndex < 12) {
                            if (!hourlyBins[hourIndex][estacion]) {
                                hourlyBins[hourIndex][estacion] = { piezas: 0, terminaciones: 0 };
                            }
                            hourlyBins[hourIndex][estacion].piezas += cantidad;
                            hourlyBins[hourIndex][estacion].terminaciones += totalTerm;
                        }
                    }
                }
            });

            const totalPiezas = data.reduce((sum, item) => sum + (Number(item['Cantidad']) || 1), 0);
            const totalTerminaciones = Object.values(totalTerminacionesPorEstacion).reduce((sum, count) => sum + count, 0);

            let summaryHTML = `<div style="margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Total Piezas: <strong>${totalPiezas.toLocaleString()}</strong> / Total Terminaciones: <strong>${totalTerminaciones.toLocaleString()}</strong></div>`;

            let stationSummaryHtml = '<div style="font-size: 0.85rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px;">';
            for (const [station, count] of Object.entries(totalTerminacionesPorEstacion).sort()) {
                stationSummaryHtml += `<span><strong>${station}:</strong> ${count.toLocaleString()} term</span>`;
            }
            stationSummaryHtml += '</div>';
            doc('chartSummary20').innerHTML = summaryHTML + stationSummaryHtml;

            const sortedStations = [...allStations].sort();
            const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'];
            const datasets = sortedStations.map((station, index) => ({
                label: station,
                data: hourlyBins.map(hourData => hourData[station]?.terminaciones || 0),
                backgroundColor: colors[index % colors.length],
            }));

            const hourlyTotals = hourlyBins.map(hourData => {
                let totalPzs = 0;
                let totalTerm = 0;
                for (const station in hourData) {
                    totalPzs += hourData[station].piezas;
                    totalTerm += hourData[station].terminaciones;
                }
                return { piezas: totalPzs, terminaciones: totalTerm };
            });

            const labels = [];
            for (let i = 0; i < 12; i++) {
                const start = new Date(shiftStartTime);
                start.setHours(start.getHours() + i);
                const end = new Date(start);
                end.setHours(end.getHours() + 1);
                const format = { hour: '2-digit', minute: '2-digit', hour12: false };
                labels.push(`${start.toLocaleTimeString([], format)} - ${end.toLocaleTimeString([], format)}`);
            }

            production20Chart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)'}},
                        title: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const stationName = context.dataset.label;
                                    const hourData = hourlyBins[context.dataIndex];
                                    if (hourData && hourData[stationName]) {
                                        const { piezas, terminaciones } = hourData[stationName];
                                        return `${stationName}: ${terminaciones} term. (${piezas} pzs)`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)', font: { size: 10 }, maxRotation: 45, minRotation: 45 } },
                        y: { beginAtZero: true, grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' }, afterDataLimits: (scale) => { scale.max *= 1.25; } }
                    }
                },
                plugins: [
                    {
                        id: 'totalLabels',
                        afterDatasetsDraw: (chart) => {
                            const { ctx, data, scales: { x, y } } = chart;
                            ctx.save();
                            ctx.font = 'bold 10px Inter';
                            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                            ctx.textAlign = 'center';

                            hourlyTotals.forEach((total, index) => {
                                if (total.piezas > 0 || total.terminaciones > 0) {
                                    const text = `Pzs: ${total.piezas} / Term: ${total.terminaciones}`;

                                    let maxVal = 0;
                                    chart.data.datasets.forEach((dataset, i) => {
                                        if (chart.isDatasetVisible(i)) {
                                            const value = dataset.data[index] || 0;
                                            if (value > maxVal) {
                                                maxVal = value;
                                            }
                                        }
                                    });

                                    const yPos = y.getPixelForValue(maxVal);
                                    ctx.fillText(text, x.getPixelForTick(index), yPos - 8);
                                }
                            });
                            ctx.restore();
                        }
                    }
                ]
            });
            updateChartTheme();
        }


        // --- INICIO: LÓGICA REPORTE DE PRODUCCIÓN POR HORA ---
        function getAutoCurrentShift() {
            const now = new Date();

            const referenceDate = new Date('2025-10-06T00:00:00');
            const diffTime = now.getTime() - referenceDate.getTime();
            const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
            const isShortWeek = diffWeeks % 2 === 0;

            let day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();

            if (hour < 6 || (hour === 6 && minute < 30)) {
                day = (day === 0) ? 6 : day - 1;
            }

            const isDayTime = hour >= 6 && (hour < 18 || (hour === 18 && minute < 30));

            if (isShortWeek) {
                if (day >= 1 && day <= 3) {
                    return isDayTime ? 'T45' : 'T46';
                } else {
                    return isDayTime ? 'T47' : 'T48';
                }
            } else {
                if (day >= 1 && day <= 4) {
                    return isDayTime ? 'T45' : 'T46';
                } else {
                    return isDayTime ? 'T47' : 'T48';
                }
            }
        }

        function getShiftDateRange(selectedDateStr, selectedShift) {
            const date = new Date(`${selectedDateStr}T00:00:00`);
            let startTime, endTime;
            switch(selectedShift) {
                case 'T45': case 'T47':
                    startTime = new Date(date.getTime()); startTime.setHours(6, 30, 0, 0);
                    endTime = new Date(date.getTime()); endTime.setHours(18, 29, 59, 999);
                    break;
                case 'T46': case 'T48':
                    startTime = new Date(date.getTime()); startTime.setHours(18, 30, 0, 0);
                    endTime = new Date(date.getTime()); endTime.setDate(endTime.getDate() + 1);
                    endTime.setHours(6, 29, 59, 999);
                    break;
            }
            return { startTime, endTime };
        }

        doc('generarReporteProduccionBtn').addEventListener('click', generateProductionReport);
        doc('exportChartBtn').addEventListener('click', exportChartAsJPG);
        doc('exportarSemanalBtn').addEventListener('click', exportarSemanalComoJPG);

        function hideAllProductionViews() {
            doc('chartContainer').style.display = 'none';
            doc('fibraReportContainer').style.display = 'none';
            doc('semanalContainer').style.display = 'none';
            doc('produccionTablesGrid').style.display = 'none';
        }

        doc('showProduccionHoraBtn').addEventListener('click', () => {
            hideAllProductionViews();
            doc('fechaUnicaContainer').style.display = 'block';
            doc('fechaRangoContainer').style.display = 'none';
            doc('chartContainer').style.display = 'flex';
            doc('produccionTablesGrid').style.display = 'grid';
            doc('generarReporteProduccionBtn').textContent = 'Generar Reporte por Hora';
        });

        doc('showProduccionFibraBtn').addEventListener('click', () => {
            if (!productionReportData) {
                showModal('Datos no disponibles', '<p>Primero debe generar un reporte de producción por hora.</p>');
                return;
            }
            hideAllProductionViews();
            doc('fechaUnicaContainer').style.display = 'block';
            doc('fechaRangoContainer').style.display = 'none';
            renderFiberReport(productionReportData);
            doc('fibraReportContainer').style.display = 'flex';
            doc('generarReporteProduccionBtn').textContent = 'Generar Reporte por Hora';
        });
        
        doc('showProduccionSemanaBtn').addEventListener('click', () => {
            hideAllProductionViews();
            doc('fechaUnicaContainer').style.display = 'none';
            doc('fechaRangoContainer').style.display = 'block';
            doc('semanalContainer').style.display = 'flex';
            doc('generarReporteProduccionBtn').textContent = 'Generar Reporte Semanal';
            if (weeklyProductionChart) weeklyProductionChart.destroy();
            doc('resumenSemanal').innerHTML = '<h4 style="text-align:center;">Configure filtros y presione "Generar Reporte".</h4>';
        });

    async function loadAreasForProductionReport() {
            try {
                const areasSnapshot = await db.collection('areas').get();
                const areaSelect = doc('prod_area');
                const currentVal = areaSelect.value;
                const existingOptions = new Set(Array.from(areaSelect.options).map(o => o.value));
                let areas = [];
                areasSnapshot.forEach(doc => { if (doc.id !== 'CONFIG') areas.push(doc.id); });
                areas.sort();
                areas.forEach(areaId => {
                    if (!existingOptions.has(areaId)) {
                        const option = document.createElement('option');
                        option.value = areaId; option.textContent = areaId;
                        areaSelect.appendChild(option);
                    }
                });
                areaSelect.value = currentVal;
            } catch (e) { console.error("Error cargando áreas:", e); }
        }


        async function generateProductionReport() {
            if (doc('semanalContainer').style.display === 'flex') {
                await generarReporteSemanalProduccion();
            } else {
                await generarReportePorHora();
            }
        }

        async function generarReportePorHora() {
            const btn = doc('generarReporteProduccionBtn');
            btn.disabled = true; btn.textContent = 'Cargando datos...';
            doc('exportChartBtn').style.display = 'none';
            try {
                const selectedDateStr = doc('prod_fecha_unica').value;
                const selectedTurno = doc('prod_turno').value;
                const selectedArea = doc('prod_area').value;
                
                const todosLosEmpacadores = params.produccion_hora_config.packers || [];
                const empacadoresFiltrados = todosLosEmpacadores.filter(p => 
                    (p.area === selectedArea || selectedArea === 'ALL') && p.turno === selectedTurno
                );
                const empacadoresL1 = empacadoresFiltrados.filter(p => p.linea === '1').map(p => p.id);
                const empacadoresL2 = empacadoresFiltrados.filter(p => p.linea === '2').map(p => p.id);

                if (!selectedDateStr) { showModal('Error', '<p>Por favor, selecciona una fecha.</p>'); return; }
                
                const { startTime, endTime } = getShiftDateRange(selectedDateStr, selectedTurno);
                const query = selectedArea === 'ALL' ? db.collectionGroup('orders') : db.collection('areas').doc(selectedArea).collection('orders');
                
                const snapshot = await query.get();
                if (snapshot.empty) {
                    showModal('Sin Datos', '<p>No se encontraron órdenes para el área seleccionada.</p>');
                    renderProductionTable([], 'dataTableProduccionL1', 'Línea 1');
                    renderProductionTable([], 'dataTableProduccionL2', 'Línea 2');
                    renderProductionChart([], startTime, selectedTurno);
                    productionReportData = [];
                    return;
                }
                
                let allPackedItems = [];
                snapshot.forEach(orderDoc => {
                    const orderData = orderDoc.data();
                    if (Array.isArray(orderData.empaqueData)) {
                        orderData.empaqueData.forEach(box => {
                            if (Array.isArray(box.serials)) {
                                box.serials.forEach(item => {
                                    const packedDate = excelSerialToDateObject(item['Finish Packed Date']);
                                    if (packedDate && packedDate >= startTime && packedDate <= endTime) {
                                        const empacador = (item['Employee ID'] || '').toString().toUpperCase();
                                        let linea = null;
                                        if (empacadoresL1.includes(empacador)) {
                                            linea = 'Línea 1';
                                        } else if (empacadoresL2.includes(empacador)) {
                                            linea = 'Línea 2';
                                        }

                                        if (linea) {
                                            allPackedItems.push({
                                                orden: orderDoc.id, catalogo: orderData.catalogNumber || 'N/A',
                                                empacador: empacador, timestamp: packedDate,
                                                linea: linea,
                                                boxId: box.boxId || 'SIN_CAJA'
                                            });
                                        }
                                    }
                                });
                            }
                        });
                    }
                });
                
                const detailedData = allPackedItems.map(item => {
                    const char = (item.catalogo || '').substring(3, 4).toUpperCase();
                    const fibras = (char === 'T') ? 12 : (parseInt(char, 10) || 0);
                    return { ...item, fibras, terminaciones: fibras };
                });
                productionReportData = detailedData;
                const groupedByBox = new Map();
                detailedData.forEach(item => {
                    const key = `${item.orden}-${item.boxId}`;
                    if (!groupedByBox.has(key)) {
                        groupedByBox.set(key, { ...item, piezas: 0, terminaciones: 0 });
                    }
                    const group = groupedByBox.get(key);
                    group.piezas++;
                    group.terminaciones += item.terminaciones;
                    if (item.timestamp > group.timestamp) { group.timestamp = item.timestamp; }
                });
                
                const aggregatedData = Array.from(groupedByBox.values()).sort((a, b) => b.timestamp - a.timestamp);
                const dataL1 = aggregatedData.filter(row => row.linea === 'Línea 1');
                const dataL2 = aggregatedData.filter(row => row.linea === 'Línea 2');
                renderProductionTable(dataL1, 'dataTableProduccionL1', 'Línea 1');
                renderProductionTable(dataL2, 'dataTableProduccionL2', 'Línea 2');
                renderProductionChart(detailedData, startTime, selectedTurno);

            } catch (e) {
                console.error("Error generando reporte por hora:", e);
                showModal('Error', `<p>Ocurrió un error: ${e.message}</p>`);
                productionReportData = null;
            } finally {
                btn.disabled = false; btn.textContent = 'Generar Reporte';
            }
        }
    async function generarReporteSemanalProduccion() {
            const btn = doc('generarReporteProduccionBtn');
            btn.disabled = true;
            btn.textContent = 'Cargando datos...';
            
            try {
                const fechaInicioStr = doc('prod_fecha_inicio').value;
                const fechaFinStr = doc('prod_fecha_fin').value;
                const selectedArea = doc('prod_area').value;
                const selectedTurno = doc('prod_turno').value;

                if (!fechaInicioStr || !fechaFinStr) {
                    showModal('Error', '<p>Por favor, selecciona un rango de fechas.</p>');
                    btn.disabled = false; btn.textContent = 'Generar Reporte';
                    return;
                }

                const empacadoresFiltrados = (params.produccion_hora_config.packers || []).filter(p => 
                    (p.area === selectedArea || selectedArea === 'ALL') && p.turno === selectedTurno
                );
                const empacadoresL1 = empacadoresFiltrados.filter(p => p.linea === '1').map(p => p.id);
                const empacadoresL2 = empacadoresFiltrados.filter(p => p.linea === '2').map(p => p.id);
                
                const queryStartTime = new Date(`${fechaInicioStr}T06:30:00`);
                queryStartTime.setDate(queryStartTime.getDate() - 1);
                
                const queryEndTime = new Date(`${fechaFinStr}T00:00:00`);
                queryEndTime.setDate(queryEndTime.getDate() + 1);
                queryEndTime.setHours(6, 29, 59, 999);

                const query = selectedArea === 'ALL' ? db.collectionGroup('orders') : db.collection('areas').doc(selectedArea).collection('orders');
                const snapshot = await query.get();

                if (snapshot.empty) {
                    showModal('Sin Datos', '<p>No se encontraron órdenes para el área seleccionada.</p>');
                    renderGraficaSemanalProduccion({}, []);
                    renderResumenSemanalProduccion({ 'Línea 1': { term: 0, pzas: 0 }, 'Línea 2': { term: 0, pzas: 0 } }, 0);
                    return;
                }

                let datosAgrupadosPorDia = {};
                let totales = { 'Línea 1': { term: 0, pzas: 0 }, 'Línea 2': { term: 0, pzas: 0 } };

                snapshot.forEach(orderDoc => {
                    const orderData = orderDoc.data();
                    if (Array.isArray(orderData.empaqueData)) {
                        orderData.empaqueData.forEach(box => {
                            if (Array.isArray(box.serials)) {
                                box.serials.forEach(item => {
                                    const packedDate = excelSerialToDateObject(item['Finish Packed Date']);
                                    
                                    if (packedDate) {
                                        const { shift, dateKey } = getWorkShiftAndDate(packedDate);
                                        const esTurnoValido = (selectedTurno === shift);
                                        const esFechaValida = dateKey >= fechaInicioStr && dateKey <= fechaFinStr;

                                        if (esTurnoValido && esFechaValida) {
                                            const empacador = (item['Employee ID'] || '').toString().toUpperCase();
                                            let linea = null;
                                            if (empacadoresL1.includes(empacador)) linea = 'Línea 1';
                                            else if (empacadoresL2.includes(empacador)) linea = 'Línea 2';

                                            if (linea) {
                                                const char = (orderData.catalogNumber || '').substring(3, 4).toUpperCase();
                                                const terminaciones = (char === 'T') ? 12 : (parseInt(char, 10) || 0);

                                                if (!datosAgrupadosPorDia[dateKey]) {
                                                    datosAgrupadosPorDia[dateKey] = { 'Línea 1': { term: 0, pzas: 0 }, 'Línea 2': { term: 0, pzas: 0 } };
                                                }
                                                datosAgrupadosPorDia[dateKey][linea].term += terminaciones;
                                                datosAgrupadosPorDia[dateKey][linea].pzas++;
                                                totales[linea].term += terminaciones;
                                                totales[linea].pzas++;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    }
                });
                
                const labelsFechas = Object.keys(datosAgrupadosPorDia).sort();
                renderGraficaSemanalProduccion(datosAgrupadosPorDia, labelsFechas);
                renderResumenSemanalProduccion(totales, labelsFechas.length);

            } catch (e) {
                console.error("Error generando reporte semanal:", e);
                showModal('Error', `<p>Ocurrió un error: ${e.message}</p>`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generar Reporte';
            }
        }

        function renderGraficaSemanalProduccion(datos, labels) {
            const ctx = doc('produccionSemanalChart').getContext('2d');
            if (weeklyProductionChart) {
                weeklyProductionChart.destroy();
            }

            const meta = 5280;

            weeklyProductionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(f => new Date(f + 'T00:00:00').toLocaleDateString('es-MX', { weekday: 'short', month: 'short', day: 'numeric' })),
                    datasets: [
                        {
                            label: 'Línea 1',
                            data: labels.map(fecha => datos[fecha]['Línea 1'].term),
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        },
                        {
                            label: 'Línea 2',
                            data: labels.map(fecha => datos[fecha]['Línea 2'].term),
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        },
                        {
                            type: 'line',
                            label: 'Meta',
                            data: Array(labels.length).fill(meta),
                            borderColor: 'var(--success-color)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'var(--chart-tick-color)' }, grid: { color: 'var(--chart-grid-color)' } },
                        x: { ticks: { color: 'var(--chart-tick-color)' }, grid: { color: 'var(--chart-grid-color)' } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)' } },
                        datalabels: {
                            display: true,
                            labels: {
                                terminaciones: {
                                    anchor: 'end',
                                    align: 'top',
                                    formatter: (value) => value > 0 ? value.toLocaleString('es-MX') : '',
                                    color: 'var(--text-primary)',
                                    font: { weight: 'bold' }
                                },
                                eficiencia: {
                                    anchor: 'center',
                                    align: 'center',
                                    formatter: (value) => {
                                        if (value === 0) return '';
                                        const percentage = ((value / meta) * 100).toFixed(0) + '%';
                                        return percentage;
                                    },
                                    color: 'white',
                                    font: { weight: 'bold', size: 12 }
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
             updateChartTheme();
        }

        function renderResumenSemanalProduccion(totales, diasTrabajados) {
            const container = doc('resumenSemanal');
            const metaDiaria = 5280;
            const metaTotal = metaDiaria * diasTrabajados;

            const eficienciaL1 = metaTotal > 0 ? ((totales['Línea 1'].term / metaTotal) * 100) : 0;
            const eficienciaL2 = metaTotal > 0 ? ((totales['Línea 2'].term / metaTotal) * 100) : 0;
            
            const alturaBarraL1 = Math.min(eficienciaL1, 100);
            const alturaBarraL2 = Math.min(eficienciaL2, 100);

            container.innerHTML = `
                <h4 style="text-align: center; margin-top: 0;">Resumen del Periodo</h4>
                
                <div style="background-color: var(--surface-hover-color); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <h5>Meta Total de la Semana</h5>
                    <p><strong>Terminaciones:</strong> ${metaTotal.toLocaleString('es-MX')}</p>
                </div>

                <div style="background-color: var(--surface-hover-color); padding: 12px; border-radius: 8px;">
                    <h5>Línea 1</h5>
                    <p><strong>Terminaciones:</strong> ${totales['Línea 1'].term.toLocaleString('es-MX')}</p>
                    <p><strong>Eficiencia:</strong> ${eficienciaL1.toFixed(1)}%</p>
                </div>

                <div style="background-color: var(--surface-hover-color); padding: 12px; border-radius: 8px; margin-top: 16px;">
                    <h5>Línea 2</h5>
                    <p><strong>Terminaciones:</strong> ${totales['Línea 2'].term.toLocaleString('es-MX')}</p>
                    <p><strong>Eficiencia:</strong> ${eficienciaL2.toFixed(1)}%</p>
                </div>

                <div class="summary-bars-wrapper">
                    <div class="summary-bar-container">
                        <div class="summary-bar" style="height: ${alturaBarraL1}%; background-color: rgba(54, 162, 235, 0.7);">
                            <span>${eficienciaL1.toFixed(0)}%</span>
                        </div>
                        <div class="summary-bar-label">Línea 1</div>
                    </div>
                    <div class="summary-bar-container">
                        <div class="summary-bar" style="height: ${alturaBarraL2}%; background-color: rgba(255, 99, 132, 0.7);">
                            <span>${eficienciaL2.toFixed(0)}%</span>
                        </div>
                        <div class="summary-bar-label">Línea 2</div>
                    </div>
                </div>
            `;
        }

        function renderProductionTable(data, tableId, lineName) {
            const table = doc(tableId);
            if (!data || data.length === 0) {
                table.innerHTML = `<thead><tr><th>Sin registros para ${lineName}.</th></tr></thead><tbody></tbody>`;
                return;
            }
            const headers = ['Orden', 'Box ID', 'Catálogo', 'Piezas', 'Fecha/Hora', 'Term.'];
            let html = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            data.forEach(row => {
                html += `<tr><td>${row.orden}</td><td>${row.boxId}</td><td>${row.catalogo}</td><td>${row.piezas}</td><td>${formatShortDateTime(row.timestamp)}</td><td>${row.terminaciones}</td></tr>`;
            });
            table.innerHTML = html + `</tbody>`;
        }

        function renderProductionChart(data, shiftStartTime, turno) {
            const ctx = doc('produccionChart').getContext('2d');
            if (productionChart) productionChart.destroy();
            if(data.length === 0){
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                doc('chartSummary').innerHTML = ''; doc('exportChartBtn').style.display = 'none'; return;
            }
            const hourlyData = {}; const labels = [];
            const totalSummary = { linea1: { piezas: 0, terminaciones: 0 }, linea2: { piezas: 0, terminaciones: 0 } };
            for (let i = 0; i < 12; i++) {
                const startHour = new Date(shiftStartTime); startHour.setHours(startHour.getHours() + i);
                const endHour = new Date(startHour); endHour.setHours(endHour.getHours() + 1);
                const format = { hour: '2-digit', minute: '2-digit', hour12: false };
                labels.push(`${startHour.toLocaleTimeString('es-ES', format)} - ${endHour.toLocaleTimeString('es-ES', format)}`);
                hourlyData[i] = { 'Línea 1': 0, 'Línea 2': 0 };
            }
            data.forEach(item => {
                const diffHours = Math.floor((item.timestamp - shiftStartTime) / (1000 * 60 * 60));
                if(diffHours >= 0 && diffHours < 12){
                    if(item.linea === 'Línea 1') hourlyData[diffHours]['Línea 1'] += item.terminaciones;
                    else hourlyData[diffHours]['Línea 2'] += item.terminaciones;
                }
                if (item.linea === 'Línea 1') { totalSummary.linea1.piezas++; totalSummary.linea1.terminaciones += item.terminaciones; }
                else { totalSummary.linea2.piezas++; totalSummary.linea2.terminaciones += item.terminaciones; }
            });
            doc('chartSummary').innerHTML = `Línea 1: <strong>${totalSummary.linea1.piezas} pzas / ${totalSummary.linea1.terminaciones} term.</strong> | Línea 2: <strong>${totalSummary.linea2.piezas} pzas / ${totalSummary.linea2.terminaciones} term.</strong>`;

            productionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { type: 'line', label: 'Meta', data: Array(12).fill(480), borderColor: getComputedStyle(document.body).getPropertyValue('--success-color'), borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false, order: 0 },
                        { label: 'Línea 1', data: Object.values(hourlyData).map(d => d['Línea 1']), backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1, order: 1 },
                        { label: 'Línea 2', data: Object.values(hourlyData).map(d => d['Línea 2']), backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1, order: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'var(--text-primary)', filter: item => item.datasetIndex > 0 } },
                        title: { display: true, text: `Producción de Terminaciones - ${turno}`, color: 'var(--text-primary)', font: { size: 16 } },
                        datalabels: {
                            display: context => context.dataset.type !== 'line',
                            labels: {
                                value: {
                                    anchor: 'end', align: 'top',
                                    formatter: (value) => value > 0 ? value : '',
                                    color: (ctx) => ctx.dataset.data[ctx.dataIndex] >= 480 ? getComputedStyle(document.body).getPropertyValue('--success-color') : getComputedStyle(document.body).getPropertyValue('--danger-color'),
                                    textShadowColor: (ctx) => ctx.dataset.data[ctx.dataIndex] >= 480 ? getComputedStyle(document.body).getPropertyValue('--glow-green') : getComputedStyle(document.body).getPropertyValue('--glow-red'),
                                    textShadowBlur: 12,
                                    font: { weight: 'bold' }
                                },
                                percentage: {
                                    align: 'center', anchor: 'center',
                                    color: (ctx) => {
                                        const barHeight = ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.dataIndex].height;
                                        return barHeight > 18 ? 'rgba(255, 255, 255, 0.9)' : 'transparent';
                                    },
                                    font: { weight: 'bold', size: 11 },
                                    formatter: (value) => {
                                        if (value <= 0) return '';
                                        const percentage = (value / 480) * 100;
                                        return percentage.toFixed(0) + '%';
                                    },
                                    textStrokeColor: 'rgba(0,0,0,0.6)',
                                    textStrokeWidth: 2
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)', maxRotation: 0, minRotation: 0, autoSkip: true, font: { size: 10 } } },
                        y: { beginAtZero: true, grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-tick-color)' }, title: { display: true, text: 'Total de Terminaciones', color: 'var(--chart-tick-color)' } }
                    }
                },
                plugins: [ChartDataLabels]
            });
            doc('exportChartBtn').style.display = 'block';
            updateChartTheme();
        }

        function renderFiberReport(data) {
            const container = doc('fibraReportContent');
            if (fiberPieChart1) fiberPieChart1.destroy();
            if (fiberPieChart2) fiberPieChart2.destroy();
            if (!data || data.length === 0) { container.innerHTML = '<p>No hay datos de producción para analizar.</p>'; return; }
            const dataL1 = data.filter(item => item.linea === 'Línea 1');
            const dataL2 = data.filter(item => item.linea === 'Línea 2');
            const generateHtmlForLine = (lineData, lineName, chartId) => {
                if (lineData.length === 0) return `<div><h5>${lineName}</h5><p>Sin producción registrada.</p></div>`;
                const fibraData = {};
                lineData.forEach(item => {
                    const fibraKey = `${item.fibras} Fibras`;
                    const catalogo = item.catalogo;
                    if (!fibraData[fibraKey]) fibraData[fibraKey] = {};
                    if (!fibraData[fibraKey][catalogo]) fibraData[fibraKey][catalogo] = 0;
                    fibraData[fibraKey][catalogo]++;
                });
                let tableHTML = `<div class="table-wrapper" style="max-height: 200px;"><table class="sub-table"><thead><tr><th>Fibra</th><th>Catálogo</th><th>Piezas</th></tr></thead><tbody>`;
                Object.entries(fibraData).forEach(([fibra, catalogos]) => {
                    Object.entries(catalogos).forEach(([catalogo, piezas]) => { tableHTML += `<tr><td>${fibra}</td><td>${catalogo}</td><td>${piezas}</td></tr>`; });
                });
                tableHTML += '</tbody></table></div>';
                return `<div><h5>${lineName}</h5><div class="pie-chart-container"><canvas id="${chartId}"></canvas></div>${tableHTML}</div>`;
            };
            container.innerHTML = `<div class="fibra-grid">${generateHtmlForLine(dataL1, 'Línea 1', 'fibraPieChart1')}${generateHtmlForLine(dataL2, 'Línea 2', 'fibraPieChart2')}</div>`;

            const createPieChart = (chartId, lineData) => {
                const ctx = doc(chartId)?.getContext('2d');
                if (!ctx || lineData.length === 0) return null;
                const pieData = {};
                lineData.forEach(item => {
                    const fibraKey = `${item.fibras} Fibras`;
                    if (!pieData[fibraKey]) pieData[fibraKey] = 0;
                    pieData[fibraKey]++;
                });
                const pieLabels = Object.keys(pieData);
                const colors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
                return new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: pieLabels,
                        datasets: [{ data: Object.values(pieData), backgroundColor: pieLabels.map((_, i) => colors[i % colors.length]) }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return (value * 100 / sum).toFixed(1) + '%';
                                },
                                color: '#fff',
                                textShadowColor: 'rgba(0,0,0,0.7)', textShadowBlur: 5,
                                font: { weight: 'bold' }
                            }
                        }
                    },
                     plugins: [ChartDataLabels]
                });
            };
            fiberPieChart1 = createPieChart('fibraPieChart1', dataL1);
            fiberPieChart2 = createPieChart('fibraPieChart2', dataL2);
            updateChartTheme();
        }

        function updateChartTheme() {
            const charts = [productionChart, fiberPieChart1, fiberPieChart2, production20Chart, productionDailyChart, weeklyProductionChart, graficaSemanalDailyInstance].filter(Boolean);
            if (charts.length === 0) return;
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            const tickColor = getComputedStyle(document.body).getPropertyValue('--chart-tick-color').trim();
            const gridColor = getComputedStyle(document.body).getPropertyValue('--chart-grid-color').trim();
            const successColor = getComputedStyle(document.body).getPropertyValue('--success-color').trim();
            const dangerColor = getComputedStyle(document.body).getPropertyValue('--danger-color').trim();
            const glowGreen = getComputedStyle(document.body).getPropertyValue('--glow-green').trim();
            const glowRed = getComputedStyle(document.body).getPropertyValue('--glow-red').trim();

            charts.forEach(chart => {
                if (chart.options.plugins.legend) chart.options.plugins.legend.labels.color = textColor;
                if (chart.options.plugins.title) chart.options.plugins.title.color = textColor;
                if(chart.config.type.includes('bar') || chart.config.type.includes('line')) {
                    if (chart.options.plugins.datalabels) {
                        if(chart.options.plugins.datalabels.labels) {
                            if(chart.options.plugins.datalabels.labels.terminaciones) chart.options.plugins.datalabels.labels.terminaciones.color = textColor;
                        } else {
                            chart.options.plugins.datalabels.color = textColor;
                        }
                    }
                    if (chart.data.datasets.some(ds => ds.type === 'line')) {
                        let lineDataset = chart.data.datasets.find(ds => ds.type === 'line');
                        if (lineDataset) lineDataset.borderColor = successColor;
                    }
                    if(chart.options.plugins.datalabels && chart.options.plugins.datalabels.labels && chart.options.plugins.datalabels.labels.value){
                         chart.options.plugins.datalabels.labels.value.color = (ctx) => ctx.dataset.data[ctx.dataIndex] >= 480 ? successColor : dangerColor;
                         chart.options.plugins.datalabels.labels.value.textShadowColor = (ctx) => ctx.dataset.data[ctx.dataIndex] >= 480 ? glowGreen : glowRed;
                    }
                    if (chart.options.scales.x) { chart.options.scales.x.ticks.color = tickColor; chart.options.scales.x.grid.color = gridColor; }
                    if (chart.options.scales.y) { chart.options.scales.y.ticks.color = tickColor; chart.options.scales.y.grid.color = gridColor; }
                    if (chart.options.scales.y.title) chart.options.scales.y.title.color = tickColor;
                }
                chart.update();
            });
        }

        function exportChartAsJPG() {
            const chartContainer = doc('chartContainer');
            if (!productionChart || !chartContainer) { showModal('Error', '<p>No hay una gráfica para exportar.</p>'); return; }
            const exportBtn = doc('exportChartBtn');
            exportBtn.style.visibility = 'hidden';
            const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const bgColor = theme === 'dark' ? '#2a2d32' : '#f9fafb';
            html2canvas(chartContainer, { backgroundColor: bgColor, scale: 2.5, useCORS: true })
            .then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                const fecha = doc('prod_fecha_inicio').value || 'fecha';
                const turno = doc('prod_turno').value;
                link.download = `Reporte_Produccion_${turno}_${fecha}.jpg`;
                link.click();
            }).finally(() => { exportBtn.style.visibility = 'visible'; });
        }
        
        function exportarSemanalComoJPG() {
            const container = doc('semanalContainer');
            if (!weeklyProductionChart || !container) {
                showModal('Error', '<p>No hay una gráfica semanal para exportar. Genere el reporte primero.</p>');
                return;
            }
            
            const exportBtn = doc('exportarSemanalBtn');
            exportBtn.style.visibility = 'hidden';

            const theme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const bgColor = theme === 'dark' ? '#22252a' : '#f9fafb';

            html2canvas(container, { backgroundColor: bgColor, scale: 2, useCORS: true })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    
                    const fechaInicio = doc('prod_fecha_inicio').value;
                    const fechaFin = doc('prod_fecha_fin').value;
                    
                    link.download = `Reporte_Semanal_Produccion_${fechaInicio}_al_${fechaFin}.jpg`;
                    link.click();
                }).finally(() => {
                    exportBtn.style.visibility = 'visible';
                });
        }
        

        // --- INICIO: LÓGICA REPORTE TERMINACIONES ---
        async function processTerminacionesReport(){/*...tu código original...*/ }
        function evaluateFormula(formula, row){/*...tu código original...*/ }
        function evaluateAuto(type, row){/*...tu código original...*/ }
        function renderTerminacionesTable(data){/*...tu código original...*/ }
        function filterTerminacionesTable(){/*...tu código original...*/ }
        window.copyToClipboard = (text, element) => {/*...tu código original...*/};
        function renderTerminacionesSummary(data){/*...tu código original...*/ }
        function exportSummaryAsJPG(){/*...tu código original...*/ }
        // --- FIN: LÓGICA REPORTE TERMINACIONES ---


        // --- INICIO: LÓGICA REPORTE 901 ---
        async function handle901File(file) {
            const config = params['901_config'];
            if (!config.columns || config.columns.length === 0) { showModal('Error de Configuración', `<p>Por favor, configure el mapeo de columnas para el reporte 901.</p>`); return; }
            const dateColumnMap = config.columns.find(p => p.key.toLowerCase() === 'fecha');
            const userColumnMap = config.columns.find(p => p.key.toLowerCase() === 'usuario');
            if (!dateColumnMap) { showModal('Error de Configuración', `<p>Debe existir una columna llamada "Fecha" en el mapeo.</p>`); return; }
            if (config.userFilter && config.userFilter.length > 0 && !userColumnMap) { showModal('Error de Configuración', `<p>Se especificaron filtros de usuario, pero no hay una columna mapeada como "Usuario".</p>`); return; }
            const allowedUsers = (config.userFilter || []).map(u => u.toUpperCase());
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                    const ws = wb.Sheets[wb.SheetNames[0]]; const range = XLSX.utils.decode_range(ws['!ref']);
                    const extractedData = []; const today = new Date(); today.setHours(0, 0, 0, 0);
                    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                        const dateCol = dateColumnMap.startCell.match(/[A-Z]+/)[0];
                        const dateCell = ws[dateCol + (R + 1)];
                        if (!dateCell || !dateCell.v) continue;
                        let rowDate = dateCell.t === 'n' ? excelSerialToDateObject(dateCell.v) : dateCell.v instanceof Date ? dateCell.v : null;
                        if (!rowDate) continue; rowDate.setHours(0,0,0,0);
                        const isToday = rowDate.getTime() === today.getTime(); const isPast = rowDate.getTime() < today.getTime();
                        let userValue = '';
                        if (userColumnMap) {
                            const userCol = userColumnMap.startCell.match(/[A-Z]+/)[0]; const userCell = ws[userCol + (R + 1)];
                            userValue = (userCell ? String(userCell.v) : '').toUpperCase();
                        }
                        const userIsOnFilterList = allowedUsers.length === 0 || allowedUsers.includes(userValue);
                        if (isPast || (isToday && userIsOnFilterList)) {
                            let rowData = {};
                            config.columns.forEach(p => {
                                const cellConfig = p.startCell.trim().toUpperCase(); let value;
                                if (cellConfig.includes(',')) {
                                    const cols = cellConfig.split(',').map(c => c.trim().match(/[A-Z]+/)[0]); const values = [];
                                    cols.forEach(col => {
                                        const cell = ws[col + (R + 1)]; const cellValue = cell ? (cell.w || cell.v) : undefined;
                                        if (cellValue !== undefined && cellValue !== null && cellValue !== 0 && String(cellValue).trim() !== '') values.push(cellValue);
                                    }); value = values.join(' / ');
                                } else {
                                    const col = cellConfig.match(/[A-Z]+/)[0]; const cell = ws[col + (R + 1)];
                                    value = cell ? (cell.w || cell.v) : undefined;
                                }

                                if (p.key.toLowerCase() === 'qty' && value !== undefined && value !== null) {
                                    const num = parseInt(value, 10);
                                    if (!isNaN(num)) {
                                        value = num;
                                    }
                                }

                                if (p.key.toLowerCase().includes('special stock')) {
                                    if (value === 0 || value === '0') {
                                        value = '';
                                    }
                                }
                                rowData[p.key] = value;
                            });
                            if (userIsOnFilterList) {
                                if (isToday) rowData.colorClass = 'row-today';
                                else if (rowDate.getTime() === yesterday.getTime()) rowData.colorClass = 'row-yesterday';
                                else rowData.colorClass = 'row-past';
                            }
                            extractedData.push(rowData);
                        }
                    }
                    if(extractedData.length === 0){ showModal('Sin Coincidencias', '<p>No se encontraron registros que cumplan con los filtros.</p>'); renderTable901([]); return; }
                    renderTable901(extractedData);
                    showModal('Éxito', `<p>${extractedData.length} registros han sido cargados.</p>`);
                } catch (err) { console.error("Error al procesar archivo 901:", err); showModal('Error de Archivo', `<p>No se pudo procesar el archivo. Verifique el formato y la configuración.</p>`) }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTable901(data) {
            const tableElement = doc('dataTable901'); const paramConfig = params['901_config'].columns;
            if (!paramConfig || !paramConfig.length) { tableElement.innerHTML = `<thead><tr><th>Por favor, configure el mapeo de columnas.</th></tr></thead><tbody></tbody>`; return; }
            const headers = paramConfig.map(p => p.key); let html = '<thead><tr>';
            headers.forEach(h => html += `<th><span>${h}</span><input type="text" class="filter-input" placeholder="Filtrar..." data-column="${h}"></th>`);
            html += '</tr></thead><tbody>';
            data.forEach(row => {
                html += `<tr class="${row.colorClass || ''}">`;
                headers.forEach(header => {
                    const value = row[header] ?? '';
                    if (header.toUpperCase() === 'GR') html += `<td class="copyable" onclick="copyToClipboard('${String(value).replace(/'/g, "\\'")}', this)" title="Haz clic para copiar">${value}</td>`;
                    else html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            tableElement.innerHTML = html + '</tbody>';
            tableElement.querySelectorAll('.filter-input').forEach(input => { input.addEventListener('keyup', () => filterTable901()); });
        }

        function filterTable901() {
            const table = doc('dataTable901');
            const filters = Array.from(table.querySelectorAll('.filter-input')).map(i => ({ columnIndex: Array.from(i.closest('tr').children).indexOf(i.closest('th')), value: i.value.toLowerCase() }));
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                let shouldShow = true;
                filters.forEach(filter => { if (filter.value) { const cell = row.children[filter.columnIndex]; if (!cell || !cell.textContent.toLowerCase().includes(filter.value)) shouldShow = false; } });
                row.style.display = shouldShow ? '' : 'none';
            });
        }

        // --- INICIO: INICIALIZACIÓN DE LA APP ---
        function initializeApp() {
            if (sessionStorage.getItem('reportesMasterSession') === 'true') session.isMaster = true;
            Promise.all([
                loadParams('901_config'),
                loadParams('terminaciones_config'),
                loadParams('produccion_hora_config'),
                loadParams('produccion_20_config'),
                loadParams('produccion_daily_config')
            ]).then(() => {
                const today = new Date();
                const pastDate = new Date();
                pastDate.setDate(today.getDate() - 6);

                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                doc('prod_fecha_unica').value = formatDate(today);
                doc('prod_fecha_inicio').value = formatDate(pastDate);
                doc('prod_fecha_fin').value = formatDate(today);
                doc('prod20_fecha').value = formatDate(today);
                doc('prodDaily_fecha').value = formatDate(today);
                
                const currentShift = getAutoCurrentShift();
                doc('prod_turno').value = currentShift;
                doc('prod20_turno').value = currentShift;
                doc('prodDaily_turno').value = currentShift;

                applyTheme(currentTheme);
                Object.values(views).forEach(v => { v.style.display = 'none'; v.style.opacity = '0'; });
                views.menu.style.display = 'flex'; views.menu.style.opacity = '1';
            });
        }
        initializeApp();
    });
</script>
</body>
</html>